<!doctype html><html lang=zh x-data :class=$store.darkMode.class() :data-theme=$store.darkMode.theme()><head><meta charset=UTF-8><meta name=viewport content="width=device-width,initial-scale=1"><title>树莓派服务部署与维护完整指南 | 赵雄州的博客</title>
<link rel=canonical href=http://10.10.164.61/posts/guide/%E6%A0%91%E8%8E%93%E6%B4%BE%E6%9C%8D%E5%8A%A1%E9%83%A8%E7%BD%B2%E4%B8%8E%E7%BB%B4%E6%8A%A4%E5%AE%8C%E6%95%B4%E6%8C%87%E5%8D%97/><meta name=author content="赵雄州"><meta name=description content='树莓派服务部署与维护完整指南 一、系统概况 1. 硬件资源 处理器: ARM64 架构 总内存: 3.7GB 可用内存: ~2.5GB Swap: 512MB 网络: wlan0 (IP: 10.40.110.47) 2. 服务概览 AI 智能助手 端口: 8080 基于: llama.cpp 模型: Phi-3-mini-4k-instruct-q4.gguf 资源占用: CPU: ~300% (多核) 内存: ~3GB Swap: 511Mi 个人博客 端口: 80 框架: Hugo v0.139.3-extended 主题: Ananke Web服务器: Nginx 资源占用: 轻量级 3. 服务访问 AI 助手: http://10.40.110.47:8080 博客开发: http://10.40.110.47:1313 博客正式: http://10.40.110.47 二、AI 智能助手部署 1. 环境准备 # 更新系统 sudo apt update sudo apt upgrade -y # 安装依赖 sudo apt install build-essential git cmake 2. 编译安装 # 克隆仓库 git clone https://github.com/ggerganov/llama.cpp.git cd llama.cpp # 编译 make clean LLAMA_METAL=1 make -j4 3. 模型配置 # 创建模型目录 mkdir models cd models # 下载模型文件 wget [模型下载地址]/Phi-3-mini-4k-instruct-q4.gguf # 验证模型文件 sha256sum Phi-3-mini-4k-instruct-q4.gguf 4. 服务配置 # 创建启动脚本 nano ~/projects/llama.cpp/start-llama.sh #!/bin/bash cd ~/projects/llama.cpp nohup ./llama-server \ -m models/Phi-3-mini-4k-instruct-q4.gguf \ --host 0.0.0.0 \ --port 8080 \ --ctx-size 2048 \ --threads 2 \ --batch-size 256 \ > llama.log 2>&amp;1 & # 设置执行权限 chmod +x start-llama.sh # 启动服务 ./start-llama.sh # 验证服务状态 ps aux | grep llama-server netstat -tuln | grep 8080 三、个人博客部署 1. Hugo 安装 # 下载 Hugo Extended 版本 wget https://github.com/gohugoio/hugo/releases/download/v0.139.3/hugo_extended_0.139.3_linux-arm64.deb # 安装 sudo dpkg -i hugo_extended_0.139.3_linux-arm64.deb # 验证安装 hugo version 2. 博客初始化 # 创建站点 cd ~ hugo new site myblog cd myblog # 初始化 Git git init # 添加主题 git submodule add https://github.com/theNewDynamic/gohugo-theme-ananke.git themes/ananke 3. 博客配置 # 编辑配置文件 nano config.toml baseURL = "http://10.40.110.47/" languageCode = "zh-cn" title = "My Blog" theme = "ananke" [params] author = "Your Name" description = "Welcome to my blog" dateFormat = "2006-01-02" background_color_class = "bg-black" recent_posts_number = 3 mainSections = ["posts"] featured_image = false [menu] [[menu.main]] identifier = "posts" name = "文章" url = "/posts/" weight = 1 [[menu.main]] identifier = "about" name = "关于" url = "/about/" weight = 2 4. Nginx 配置 # 安装 Nginx sudo apt install nginx # 创建配置文件 sudo nano /etc/nginx/sites-available/myblog server { listen 80; server_name 10.40.110.47; root /home/zhaoxiongzhou/myblog/public; index index.html; location / { try_files $uri $uri/ =404; } access_log /var/log/nginx/myblog_access.log; error_log /var/log/nginx/myblog_error.log; } # 启用配置 sudo ln -s /etc/nginx/sites-available/myblog /etc/nginx/sites-enabled/ sudo rm /etc/nginx/sites-enabled/default # 测试配置 sudo nginx -t # 重启 Nginx sudo systemctl restart nginx 四、权限与自动化配置 1. 权限设置 # 设置目录权限 sudo chmod 755 /home/zhaoxiongzhou sudo chmod -R 755 /home/zhaoxiongzhou/myblog # 设置文件所有权 sudo chown -R www-data:www-data /home/zhaoxiongzhou/myblog/public # 验证权限 ls -la ~/myblog/public ls -la /home/zhaoxiongzhou 2. 自动部署脚本 # 创建博客部署脚本 nano ~/deploy-blog.sh #!/bin/bash cd ~/myblog hugo sudo chown -R www-data:www-data public/ sudo systemctl restart nginx # 设置执行权限 chmod +x ~/deploy-blog.sh 3. 备份脚本 # 创建备份脚本 nano ~/backup-blog.sh #!/bin/bash BACKUP_DIR="/home/zhaoxiongzhou/backups" DATE=$(date +%Y%m%d) # 创建备份目录 mkdir -p $BACKUP_DIR # 备份博客内容 tar -czf $BACKUP_DIR/blog_$DATE.tar.gz ~/myblog/content # 备份配置文件 cp ~/myblog/config.toml $BACKUP_DIR/config_$DATE.toml # 删除30天前的备份 find $BACKUP_DIR -name "*.tar.gz" -mtime +30 -delete # 设置执行权限 chmod +x ~/backup-blog.sh # 配置定时任务 crontab -e # 添加定时任务（每周日凌晨2点执行备份） 0 2 * * 0 /home/zhaoxiongzhou/backup-blog.sh 五、系统维护与监控 1. 资源监控命令 # 系统资源监控 htop top free -h vmstat 1 # 磁盘使用监控 df -h du -sh /* du -sh ~/myblog du -sh ~/projects/llama.cpp # 温度监控 vcgencmd measure_temp 2. 性能优化 # 清理系统缓存 sudo sync; echo 3 | sudo tee /proc/sys/vm/drop_caches # 调整 Swap 设置 cat /proc/sys/vm/swappiness sudo sysctl vm.swappiness=60 # CPU 频率调整 sudo nano /boot/config.txt # CPU 配置参数 arm_freq=1800 over_voltage=6 temp_limit=75 3. 系统维护 # 系统更新 sudo apt update sudo apt upgrade -y sudo apt autoremove sudo apt clean # 日志清理 sudo find /var/log -type f -name "*.log" -mtime +30 -delete sudo find /var/log -type f -name "*.gz" -delete # 服务状态检查 systemctl status nginx ps aux | grep llama-server 六、安全配置 1. 防火墙设置 # 安装 UFW sudo apt install ufw # 配置基本规则 sudo ufw default deny incoming sudo ufw default allow outgoing sudo ufw allow 22 sudo ufw allow 80 sudo ufw allow 8080 # 启用防火墙 sudo ufw enable # 检查状态 sudo ufw status 2. Nginx 访问控制 # 安装认证工具 sudo apt install apache2-utils # 创建用户密码 sudo htpasswd -c /etc/nginx/.htpasswd username # 修改 Nginx 配置 sudo nano /etc/nginx/sites-available/myblog server { listen 80; server_name 10.40.110.47; root /home/zhaoxiongzhou/myblog/public; index index.html; # 添加基本认证 location / { auth_basic "Restricted Access"; auth_basic_user_file /etc/nginx/.htpasswd; try_files $uri $uri/ =404; } # 日志配置 access_log /var/log/nginx/myblog_access.log; error_log /var/log/nginx/myblog_error.log; } 3. 日志监控 # 安装日志监控工具 sudo apt install logwatch # 配置日志监控 sudo nano /etc/logwatch/conf/logwatch.conf # 配置每日日志检查 Output = mail Format = html MailTo = your-email@domain.com Detail = High 七、故障排除指南 内存相关问题 # 检查内存状态 free -h ps aux --sort=-%mem | head # 如果内存不足，调整服务参数 nano ~/projects/llama.cpp/start-llama.sh # 降低资源使用的参数示例 --ctx-size 1024 \ --batch-size 128 \ --threads 1 服务无响应 # 检查进程 ps aux | grep llama-server # 检查端口 netstat -tuln | grep 8080 # 重启服务 pkill llama-server ./start-llama.sh # 检查日志 tail -f ~/projects/llama.cpp/llama.log 2. 博客服务故障排除 Nginx 问题 # 检查配置语法 sudo nginx -t # 检查日志 sudo tail -f /var/log/nginx/error.log sudo tail -f /var/log/nginx/myblog_error.log # 检查服务状态 sudo systemctl status nginx # 重启服务 sudo systemctl restart nginx Hugo 生成问题 # 清理缓存 rm -rf ~/myblog/public rm -rf ~/myblog/resources # 更新主题 git submodule update --init --recursive # 重新生成（详细模式） hugo --verbose 八、系统级故障排除 1. 磁盘问题 # 检查磁盘使用情况 df -h du -sh /* # 查找大文件 sudo find / -type f -size +100M # 清理空间 sudo apt clean sudo apt autoremove sudo journalctl --vacuum-time=7d 2. 网络问题 # 网络状态检查 ip addr show ping -c 4 8.8.8.8 netstat -tuln # DNS 检查 cat /etc/resolv.conf nslookup google.com # 重启网络服务 sudo systemctl restart networking sudo systemctl restart wpa_supplicant 3. 性能问题 # CPU 温度监控 vcgencmd measure_temp watch -n 1 vcgencmd measure_temp # CPU 频率检查 vcgencmd measure_clock arm cat /sys/devices/system/cpu/cpu0/cpufreq/scaling_cur_freq # 系统负载检查 uptime cat /proc/loadavg 九、维护最佳实践 1. 日常维护清单 检查系统日志 监控资源使用 验证服务状态 检查备份状态 更新系统安全补丁 2. 周期性维护任务 清理旧日志和临时文件 验证备份完整性 检查系统更新 检查服务性能 更新文档和配置说明 3. 应急预案 保存所有配置文件的备份 记录所有服务的配置步骤 维护问题解决方案文档 建立服务恢复流程 保持重要数据的多份备份 十、性能优化建议 1. 系统级优化 # 1. 调整 SWAP 设置 sudo nano /etc/sysctl.conf # 添加或修改以下参数 vm.swappiness=60 vm.vfs_cache_pressure=50 vm.dirty_background_ratio=5 vm.dirty_ratio=10 # 2. 优化文件系统 # 检查并优化文件系统 sudo tune2fs -o journal_data_writeback /dev/mmcblk0p2 # 3. 调整 CPU 性能 sudo nano /boot/config.txt # 添加以下配置 arm_freq=1800 over_voltage=6 gpu_freq=500 dtparam=audio=on 2. 服务优化 AI 服务优化 # 调整服务参数 nano ~/projects/llama.cpp/start-llama.sh # 优化参数示例 --ctx-size 2048 \ --threads 2 \ --batch-size 256 \ --keep-context \ --mlock \ --numa Nginx 优化 sudo nano /etc/nginx/nginx.conf worker_processes auto; worker_rlimit_nofile 65535; events { worker_connections 1024; multi_accept on; use epoll; } http { sendfile on; tcp_nopush on; tcp_nodelay on; keepalive_timeout 65; types_hash_max_size 2048; server_tokens off; # 缓存设置 open_file_cache max=1000 inactive=20s; open_file_cache_valid 30s; open_file_cache_min_uses 2; open_file_cache_errors on; } 十一、监控与报警系统 1. 系统监控配置 # 安装监控工具 sudo apt install prometheus node-exporter grafana # 配置 Prometheus sudo nano /etc/prometheus/prometheus.yml global: scrape_interval: 15s scrape_configs: - job_name: &#39;node&#39; static_configs: - targets: [&#39;localhost:9100&#39;] - job_name: &#39;nginx&#39; static_configs: - targets: [&#39;localhost:9113&#39;] 2. 自动报警脚本 # 创建监控脚本 nano ~/monitor.sh #!/bin/bash # 定义阈值 MAX_CPU_USAGE=90 MAX_MEM_USAGE=90 MAX_DISK_USAGE=90 MAX_TEMP=75 # 获取系统数据 CPU_USAGE=$(top -bn1 | grep "Cpu(s)" | awk &#39;{print $2}&#39; | cut -d. -f1) MEM_USAGE=$(free | grep Mem | awk &#39;{print $3/$2 * 100.0}&#39;) DISK_USAGE=$(df -h / | awk &#39;NR==2 {print $5}&#39; | cut -d% -f1) TEMP=$(vcgencmd measure_temp | cut -d= -f2 | cut -d. -f1) # 检查服务状态 check_services() { services=("nginx" "llama-server") for service in "${services[@]}"; do if ! pgrep -x "$service" > /dev/null; then echo "警告: $service 服务未运行!" # 可以添加重启服务的命令 fi done } # 发送警告 send_alert() { message="$1" # 这里可以添加发送邮件或其他通知的命令 echo "$message" >> /var/log/system_alerts.log } # 检查各项指标 if [ "$CPU_USAGE" -gt "$MAX_CPU_USAGE" ]; then send_alert "CPU 使用率过高: $CPU_USAGE%" fi if [ "${MEM_USAGE%.*}" -gt "$MAX_MEM_USAGE" ]; then send_alert "内存使用率过高: $MEM_USAGE%" fi if [ "$DISK_USAGE" -gt "$MAX_DISK_USAGE" ]; then send_alert "磁盘使用率过高: $DISK_USAGE%" fi if [ "$TEMP" -gt "$MAX_TEMP" ]; then send_alert "系统温度过高: $TEMP°C" fi # 检查服务状态 check_services # 设置执行权限 chmod +x ~/monitor.sh # 添加到 crontab crontab -e # 每5分钟执行一次监控 */5 * * * * /home/zhaoxiongzhou/monitor.sh 十二、数据备份与恢复 1. 完整备份方案 # 创建完整备份脚本 nano ~/full-backup.sh #!/bin/bash BACKUP_ROOT="/home/zhaoxiongzhou/backups" DATE=$(date +%Y%m%d_%H%M%S) BACKUP_DIR="$BACKUP_ROOT/$DATE" # 创建备份目录 mkdir -p "$BACKUP_DIR" # 备份博客内容 echo "备份博客内容..." tar -czf "$BACKUP_DIR/blog_content.tar.gz" ~/myblog/content tar -czf "$BACKUP_DIR/blog_config.tar.gz" ~/myblog/config.toml # 备份 AI 模型和配置 echo "备份 AI 服务..." tar -czf "$BACKUP_DIR/llama_models.tar.gz" ~/projects/llama.cpp/models tar -czf "$BACKUP_DIR/llama_config.tar.gz" ~/projects/llama.cpp/start-llama.sh # 备份 Nginx 配置 echo "备份 Nginx 配置..." sudo tar -czf "$BACKUP_DIR/nginx_config.tar.gz" /etc/nginx/sites-available/myblog # 备份系统配置 echo "备份系统配置..." sudo tar -czf "$BACKUP_DIR/system_config.tar.gz" /boot/config.txt /etc/fstab # 创建备份清单 echo "创建备份清单..." find "$BACKUP_DIR" -type f -exec sha256sum {} \; > "$BACKUP_DIR/checksum.txt" # 清理旧备份（保留最近7份） cd "$BACKUP_ROOT" ls -t | tail -n +8 | xargs -r rm -r echo "备份完成: $BACKUP_DIR" 2. 数据恢复流程 # 创建恢复脚本 nano ~/restore.sh #!/bin/bash if [ -z "$1" ]; then echo "使用方法: $0 <备份目录>" exit 1 fi BACKUP_DIR="$1" # 验证备份完整性 echo "验证备份完整性..." cd "$BACKUP_DIR" sha256sum -c checksum.txt || { echo "备份验证失败！" exit 1 } # 恢复博客内容 echo "恢复博客内容..." tar -xzf "$BACKUP_DIR/blog_content.tar.gz" -C ~/myblog/ tar -xzf "$BACKUP_DIR/blog_config.tar.gz" -C ~/myblog/ # 恢复 AI 服务 echo "恢复 AI 服务..." tar -xzf "$BACKUP_DIR/llama_models.tar.gz" -C ~/projects/llama.cpp/ tar -xzf "$BACKUP_DIR/llama_config.tar.gz" -C ~/projects/llama.cpp/ # 恢复 Nginx 配置 echo "恢复 Nginx 配置..." sudo tar -xzf "$BACKUP_DIR/nginx_config.tar.gz" -C /etc/nginx/sites-available/ # 恢复系统配置 echo "恢复系统配置..." sudo tar -xzf "$BACKUP_DIR/system_config.tar.gz" -C / # 重启服务 echo "重启服务..." sudo systemctl restart nginx pkill llama-server ~/projects/llama.cpp/start-llama.sh echo "恢复完成" 十三、服务升级指南 1. Hugo 博客升级 # 1. 备份当前版本 cd ~ tar -czf hugo_backup_$(date +%Y%m%d).tar.gz myblog/ # 2. 检查当前版本 hugo version # 3. 下载新版本 wget https://github.com/gohugoio/hugo/releases/download/v[新版本]/hugo_extended_[新版本]_linux-arm64.deb # 4. 安装新版本 sudo dpkg -i hugo_extended_[新版本]_linux-arm64.deb # 5. 更新主题 cd ~/myblog git submodule update --remote themes/ananke # 6. 测试生成 hugo --verbose # 7. 部署更新 ./deploy-blog.sh 2. AI 服务升级 # 1. 备份当前版本 cd ~/projects tar -czf llama_backup_$(date +%Y%m%d).tar.gz llama.cpp/ # 2. 更新源码 cd llama.cpp git pull origin master # 3. 重新编译 make clean LLAMA_METAL=1 make -j4 # 4. 测试新版本 ./llama-server -h # 5. 更新启动脚本 nano start-llama.sh 3. 系统升级 # 1. 更新软件包列表 sudo apt update # 2. 升级所有包 sudo apt upgrade -y # 3. 升级系统 sudo apt dist-upgrade -y # 4. 清理旧包 sudo apt autoremove -y sudo apt clean # 5. 检查启动项 sudo systemctl list-unit-files --state=enabled # 6. 更新树莓派固件 sudo rpi-update # 7. 检查系统状态 sudo systemctl --failed sudo journalctl -p 3 -xb 十四、安全加固指南 1. 系统安全配置 # 1. SSH 安全配置 sudo nano /etc/ssh/sshd_config # SSH 配置建议 Port 22222 # 修改默认端口 PermitRootLogin no # 禁止 root 登录 PasswordAuthentication no # 禁用密码认证 PubkeyAuthentication yes # 启用密钥认证 AllowUsers zhaoxiongzhou # 限制允许的用户 # 2. 设置防火墙规则 sudo apt install ufw fail2ban # 配置 UFW sudo ufw default deny incoming sudo ufw default allow outgoing sudo ufw allow 22222/tcp # SSH sudo ufw allow 80/tcp # HTTP sudo ufw allow 8080/tcp # AI 服务 sudo ufw enable # 配置 fail2ban sudo nano /etc/fail2ban/jail.local [sshd] enabled = true port = 22222 filter = sshd logpath = /var/log/auth.log maxretry = 3 bantime = 3600 2. 服务安全配置 Nginx 安全设置 # 1. 创建 SSL 证书 sudo openssl req -x509 -nodes -days 365 -newkey rsa:2048 \ -keyout /etc/nginx/ssl/nginx.key \ -out /etc/nginx/ssl/nginx.crt # 2. 配置 HTTPS sudo nano /etc/nginx/sites-available/myblog server { listen 443 ssl; server_name 10.40.110.47; ssl_certificate /etc/nginx/ssl/nginx.crt; ssl_certificate_key /etc/nginx/ssl/nginx.key; # SSL 配置 ssl_protocols TLSv1.2 TLSv1.3; ssl_prefer_server_ciphers on; ssl_ciphers ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256; # 安全头部 add_header X-Frame-Options "SAMEORIGIN"; add_header X-XSS-Protection "1; mode=block"; add_header X-Content-Type-Options "nosniff"; add_header Strict-Transport-Security "max-age=31536000"; # 其他配置... } 十五、性能监控与分析 1. 监控脚本配置 # 创建综合监控脚本 nano ~/system_monitor.sh #!/bin/bash LOG_FILE="/var/log/system_monitor.log" ALERT_FILE="/var/log/system_alerts.log" # 记录时间戳 timestamp() { date "+%Y-%m-%d %H:%M:%S" } # 系统资源监控 monitor_resources() { echo "=== 系统资源监控 $(timestamp) ===" >> "$LOG_FILE" # CPU 使用率 CPU_USAGE=$(top -bn1 | grep "Cpu(s)" | awk &#39;{print $2}&#39;) echo "CPU 使用率: $CPU_USAGE%" >> "$LOG_FILE" # 内存使用 free -h | grep "Mem:" >> "$LOG_FILE" # 磁盘使用 df -h / >> "$LOG_FILE" # 系统负载 uptime >> "$LOG_FILE" # CPU 温度 vcgencmd measure_temp >> "$LOG_FILE" } # 服务状态监控 monitor_services() { echo "=== 服务状态监控 $(timestamp) ===" >> "$LOG_FILE" # Nginx 状态 if systemctl is-active nginx >/dev/null 2>&amp;1; then echo "Nginx: 运行中" >> "$LOG_FILE" else echo "警告: Nginx 未运行!" >> "$ALERT_FILE" fi # AI 服务状态 if pgrep -f llama-server >/dev/null; then echo "AI 服务: 运行中" >> "$LOG_FILE" else echo "警告: AI 服务未运行!" >> "$ALERT_FILE" fi } # 网络监控 monitor_network() { echo "=== 网络监控 $(timestamp) ===" >> "$LOG_FILE" # 网络连接数 netstat -an | grep ESTABLISHED | wc -l >> "$LOG_FILE" # 网络流量 ifconfig wlan0 | grep bytes >> "$LOG_FILE" } # 主函数 main() { monitor_resources monitor_services monitor_network # 检查是否需要发送警告 if [ -s "$ALERT_FILE" ]; then # 可以添加发送警告的命令（如邮件通知） cat "$ALERT_FILE" fi } # 执行监控 main 2. 性能分析工具 # 安装性能分析工具 sudo apt install sysstat iotop htop # 创建性能数据收集脚本 nano ~/collect_performance.sh 十六、性能数据收集与分析 1. 性能数据收集脚本 #!/bin/bash # ~/collect_performance.sh PERF_DIR="/home/zhaoxiongzhou/performance_data" DATE=$(date +%Y%m%d_%H%M%S) # 创建数据目录 mkdir -p "$PERF_DIR/$DATE" # CPU 性能数据 mpstat 1 60 > "$PERF_DIR/$DATE/cpu_stats.log" & # 内存使用数据 vmstat 1 60 > "$PERF_DIR/$DATE/memory_stats.log" & # IO 性能数据 iostat -x 1 60 > "$PERF_DIR/$DATE/io_stats.log" & # 网络性能数据 sar -n DEV 1 60 > "$PERF_DIR/$DATE/network_stats.log" & # 进程性能数据 ps aux --sort=-%cpu | head -n 20 > "$PERF_DIR/$DATE/top_processes.log" # 系统负载数据 uptime > "$PERF_DIR/$DATE/load_average.log" # 等待所有后台进程完成 wait # 压缩数据 tar -czf "$PERF_DIR/performance_${DATE}.tar.gz" "$PERF_DIR/$DATE" rm -rf "$PERF_DIR/$DATE" 2. 性能数据分析脚本 # 创建分析脚本 nano ~/analyze_performance.sh #!/bin/bash # ~/analyze_performance.sh PERF_DIR="/home/zhaoxiongzhou/performance_data" REPORT_DIR="/home/zhaoxiongzhou/performance_reports" DATE=$(date +%Y%m%d) mkdir -p "$REPORT_DIR" generate_report() { local REPORT_FILE="$REPORT_DIR/report_${DATE}.txt" echo "性能分析报告 - $(date)" > "$REPORT_FILE" echo "===================" >> "$REPORT_FILE" # CPU 使用分析 echo -e "\nCPU 使用情况:" >> "$REPORT_FILE" awk &#39;/all/ {total += $3; count++} END {print "平均CPU使用率: " total/count "%"}&#39; \ "$PERF_DIR/latest/cpu_stats.log" >> "$REPORT_FILE" # 内存使用分析 echo -e "\n内存使用情况:" >> "$REPORT_FILE" free -h | grep "Mem:" >> "$REPORT_FILE" # IO 性能分析 echo -e "\nIO 性能:" >> "$REPORT_FILE" tail -n 10 "$PERF_DIR/latest/io_stats.log" >> "$REPORT_FILE" # 网络性能分析 echo -e "\n网络性能:" >> "$REPORT_FILE" tail -n 10 "$PERF_DIR/latest/network_stats.log" >> "$REPORT_FILE" # 进程分析 echo -e "\n资源占用最高的进程:" >> "$REPORT_FILE" head -n 5 "$PERF_DIR/latest/top_processes.log" >> "$REPORT_FILE" echo -e "\n分析完成。报告保存在: $REPORT_FILE" } # 生成报告 generate_report 十七、自动化运维脚本 1. 服务健康检查与自动恢复 # 创建服务监控脚本 nano ~/service_health_check.sh #!/bin/bash # ~/service_health_check.sh LOG_FILE="/var/log/service_health.log" ALERT_SCRIPT="/home/zhaoxiongzhou/send_alert.sh" log_message() { echo "[$(date &#39;+%Y-%m-%d %H:%M:%S&#39;)] $1" >> "$LOG_FILE" } check_and_restart_service() { local service_name="$1" local process_pattern="$2" if ! pgrep -f "$process_pattern" > /dev/null; then log_message "警告: $service_name 服务未运行，尝试重启" case "$service_name" in "nginx") sudo systemctl restart nginx ;; "llama-server") cd ~/projects/llama.cpp ./start-llama.sh ;; esac # 等待服务启动 sleep 10 # 验证服务是否成功重启 if pgrep -f "$process_pattern" > /dev/null; then log_message "$service_name 服务已成功重启" "$ALERT_SCRIPT" "$service_name 服务已自动重启" else log_message "错误: $service_name 服务重启失败" "$ALERT_SCRIPT" "警告: $service_name 服务重启失败，需要手动干预" fi else log_message "$service_name 服务运行正常" fi } # 检查各个服务 check_and_restart_service "nginx" "nginx" check_and_restart_service "llama-server" "llama-server" # 清理旧日志 find "$LOG_FILE" -mtime +30 -delete 2. 自动备份与清理 # 创建自动维护脚本 nano ~/auto_maintenance.sh #!/bin/bash # ~/auto_maintenance.sh BACKUP_DIR="/home/zhaoxiongzhou/backups" LOG_DIR="/var/log" DATE=$(date +%Y%m%d) # 创建备份 create_backups() { # 博客备份 tar -czf "$BACKUP_DIR/blog_$DATE.tar.gz" ~/myblog/content # AI 服务配置备份 tar -czf "$BACKUP_DIR/llama_config_$DATE.tar.gz" ~/projects/llama.cpp/start-llama.sh # Nginx 配置备份 sudo tar -czf "$BACKUP_DIR/nginx_config_$DATE.tar.gz" /etc/nginx/sites-available/ } # 清理旧文件 cleanup_old_files() { # 删除30天前的备份 find "$BACKUP_DIR" -name "*.tar.gz" -mtime +30 -delete # 清理日志 sudo find "$LOG_DIR" -name "*.log" -mtime +30 -delete sudo find "$LOG_DIR" -name "*.gz" -mtime +30 -delete # 清理系统临时文件 sudo rm -rf /tmp/* sudo rm -rf /var/tmp/* } # 主函数 main() { create_backups cleanup_old_files # 压缩日志 sudo logrotate -f /etc/logrotate.conf # 清理包缓存 sudo apt clean sudo apt autoremove -y } # 执行维护任务 main 十八、日志管理系统 1. 集中式日志配置 # 创建日志管理脚本 nano ~/log_management.sh #!/bin/bash # ~/log_management.sh LOG_BASE="/var/log/services" ARCHIVE_DIR="/home/zhaoxiongzhou/log_archives" DATE=$(date +%Y%m%d) # 创建日志目录 mkdir -p "$LOG_BASE"/{nginx,ai_service,system} mkdir -p "$ARCHIVE_DIR" # 配置日志轮转 sudo tee /etc/logrotate.d/custom_services << EOF $LOG_BASE/nginx/*.log { daily missingok rotate 14 compress delaycompress notifempty create 0640 www-data adm sharedscripts postrotate [ -f /var/run/nginx.pid ] && kill -USR1 \$(cat /var/run/nginx.pid) endscript } $LOG_BASE/ai_service/*.log { daily missingok rotate 14 compress delaycompress notifempty create 0640 zhaoxiongzhou adm } $LOG_BASE/system/*.log { daily missingok rotate 30 compress delaycompress notifempty create 0640 root adm } EOF # 日志分析函数 analyze_logs() { local log_file="$1" local output_file="$2" echo "=== 日志分析报告 $(date) ===" > "$output_file" # 错误统计 echo -e "\n错误统计:" >> "$output_file" grep -i "error" "$log_file" | sort | uniq -c | sort -nr >> "$output_file" # 警告统计 echo -e "\n警告统计:" >> "$output_file" grep -i "warning" "$log_file" | sort | uniq -c | sort -nr >> "$output_file" # 访问统计（针对 Nginx 访问日志） if [[ "$log_file" == *"nginx/access"* ]]; then echo -e "\n访问量统计:" >> "$output_file" awk &#39;{print $1}&#39; "$log_file" | sort | uniq -c | sort -nr | head -n 10 >> "$output_file" fi } # 日志归档函数 archive_logs() { local source_dir="$1" local archive_name="logs_${DATE}.tar.gz" find "$source_dir" -name "*.log.*" -mtime +14 -exec tar -czf "$ARCHIVE_DIR/$archive_name" {} + find "$source_dir" -name "*.log.*" -mtime +14 -delete } 2. 日志监控告警 # 创建日志监控脚本 nano ~/log_monitor.sh #!/bin/bash # ~/log_monitor.sh ALERT_THRESHOLD=10 # 错误阈值 ALERT_SCRIPT="/home/zhaoxiongzhou/send_alert.sh" # 监控特定关键词 monitor_keywords() { local log_file="$1" local keywords=("error" "critical" "failed" "timeout" "exception") for keyword in "${keywords[@]}"; do count=$(grep -i "$keyword" "$log_file" | wc -l) if [ "$count" -gt "$ALERT_THRESHOLD" ]; then "$ALERT_SCRIPT" "警告: $log_file 中发现大量 $keyword ($count 次)" fi done } # 监控日志大小 check_log_size() { local log_file="$1" local max_size=$((100 * 1024 * 1024)) # 100MB size=$(stat -f%z "$log_file") if [ "$size" -gt "$max_size" ]; then "$ALERT_SCRIPT" "警告: $log_file 大小超过 100MB" fi } # 主监控循环 main() { while true; do for log_file in "$LOG_BASE"/**/*.log; do monitor_keywords "$log_file" check_log_size "$log_file" done sleep 300 # 每5分钟检查一次 done } main & 十九、系统优化与调优 1. 系统参数优化 # 创建系统优化脚本 nano ~/system_optimize.sh #!/bin/bash # ~/system_optimize.sh # 系统参数优化 optimize_sysctl() { sudo tee /etc/sysctl.d/99-custom.conf << EOF # 内存管理优化 vm.swappiness = 60 vm.vfs_cache_pressure = 50 vm.dirty_background_ratio = 5 vm.dirty_ratio = 10 # 网络优化 net.core.somaxconn = 1024 net.core.netdev_max_backlog = 5000 net.ipv4.tcp_max_syn_backlog = 2048 net.ipv4.tcp_fin_timeout = 20 net.ipv4.tcp_keepalive_time = 1200 net.ipv4.tcp_keepalive_intvl = 15 net.ipv4.tcp_keepalive_probes = 5 # 文件系统优化 fs.file-max = 65535 fs.inotify.max_user_watches = 524288 EOF # 应用新的系统参数 sudo sysctl -p /etc/sysctl.d/99-custom.conf } # CPU 频率优化 optimize_cpu() { sudo tee /boot/config.txt << EOF # CPU 设置 arm_freq=1800 over_voltage=6 gpu_freq=500 # 温度控制 temp_limit=75 EOF } # 服务优化 optimize_services() { # 禁用不必要的服务 UNNECESSARY_SERVICES=( "bluetooth" "cups" "avahi-daemon" ) for service in "${UNNECESSARY_SERVICES[@]}"; do if systemctl is-enabled "$service" &>/dev/null; then sudo systemctl disable "$service" sudo systemctl stop "$service" fi done } # 内存优化 optimize_memory() { # 调整 ZRAM sudo tee /etc/default/zramswap << EOF ALGO=lz4 PERCENT=50 EOF # 重启 ZRAM 服务 sudo systemctl restart zramswap } 2. 服务优化配置 # Nginx 优化配置 sudo nano /etc/nginx/nginx.conf user www-data; worker_processes auto; worker_rlimit_nofile 65535; events { worker_connections 1024; multi_accept on; use epoll; } http { # 基础设置 sendfile on; tcp_nopush on; tcp_nodelay on; keepalive_timeout 65; types_hash_max_size 2048; server_tokens off; # MIME 类型 include /etc/nginx/mime.types; default_type application/octet-stream; # 日志格式 log_format main &#39;$remote_addr - $remote_user [$time_local] "$request" &#39; &#39;$status $body_bytes_sent "$http_referer" &#39; &#39;"$http_user_agent" "$http_x_forwarded_for"&#39;; # 缓冲区设置 client_body_buffer_size 10K; client_header_buffer_size 1k; client_max_body_size 8m; large_client_header_buffers 2 1k; # 超时设置 client_body_timeout 12; client_header_timeout 12; send_timeout 10; # 缓存设置 open_file_cache max=1000 inactive=20s; open_file_cache_valid 30s; open_file_cache_min_uses 2; open_file_cache_errors on; # Gzip 压缩 gzip on; gzip_vary on; gzip_proxied any; gzip_comp_level 6; gzip_types text/plain text/css text/xml application/json application/javascript application/xml+rss application/atom+xml image/svg+xml; } 二十、服务监控面板配置 1. Grafana 监控系统配置 # 安装 Grafana sudo apt-get install -y apt-transport-https sudo apt-get install -y software-properties-common wget wget -q -O - https://packages.grafana.com/gpg.key | sudo apt-key add - echo "deb https://packages.grafana.com/oss/deb stable main" | sudo tee -a /etc/apt/sources.list.d/grafana.list sudo apt-get update sudo apt-get install -y grafana # 配置 Grafana sudo nano /etc/grafana/grafana.ini [server] http_addr = 0.0.0.0 http_port = 3000 [security] admin_user = admin admin_password = your_secure_password [auth.anonymous] enabled = false [paths] data = /var/lib/grafana logs = /var/log/grafana plugins = /var/lib/grafana/plugins [dashboards] versions_to_keep = 20 2. Prometheus 配置 # 安装 Prometheus sudo apt-get install -y prometheus # 配置 Prometheus sudo nano /etc/prometheus/prometheus.yml global: scrape_interval: 15s evaluation_interval: 15s scrape_configs: - job_name: &#39;node&#39; static_configs: - targets: [&#39;localhost:9100&#39;] - job_name: &#39;nginx&#39; static_configs: - targets: [&#39;localhost:9113&#39;] - job_name: &#39;system&#39; static_configs: - targets: [&#39;localhost:9090&#39;] - job_name: &#39;process&#39; static_configs: - targets: [&#39;localhost:9256&#39;] 3. Node Exporter 配置 # 安装 Node Exporter sudo apt-get install -y prometheus-node-exporter # 创建自定义指标收集脚本 nano ~/custom_metrics.sh #!/bin/bash # ~/custom_metrics.sh # 创建指标文件 METRICS_FILE="/var/lib/node_exporter/custom_metrics.prom" while true; do # CPU 温度 CPU_TEMP=$(vcgencmd measure_temp | sed &#39;s/temp=//&#39; | sed &#39;s/&#39;"&#39;"&#39;C//&#39;) echo "raspberry_pi_cpu_temperature $CPU_TEMP" > "$METRICS_FILE" # AI 服务状态 if pgrep -f llama-server > /dev/null; then echo "ai_service_status 1" >> "$METRICS_FILE" else echo "ai_service_status 0" >> "$METRICS_FILE" fi # 博客服务状态 if systemctl is-active nginx > /dev/null; then echo "blog_service_status 1" >> "$METRICS_FILE" else echo "blog_service_status 0" >> "$METRICS_FILE" fi # 内存使用 FREE_MEM=$(free | grep Mem | awk &#39;{print $4}&#39;) echo "system_free_memory_bytes $FREE_MEM" >> "$METRICS_FILE" sleep 15 done 二十一、自动化部署与更新 1. 自动部署配置脚本 # 创建自动部署脚本 nano ~/auto_deploy.sh #!/bin/bash # ~/auto_deploy.sh # 配置 BLOG_DIR="/home/zhaoxiongzhou/myblog" LLAMA_DIR="/home/zhaoxiongzhou/projects/llama.cpp" BACKUP_DIR="/home/zhaoxiongzhou/backups" LOG_FILE="/var/log/auto_deploy.log" # 日志函数 log() { echo "[$(date &#39;+%Y-%m-%d %H:%M:%S&#39;)] $1" >> "$LOG_FILE" } # 备份当前版本 backup_current() { log "开始备份当前版本" # 博客备份 tar -czf "$BACKUP_DIR/blog_$(date +%Y%m%d_%H%M%S).tar.gz" "$BLOG_DIR" # AI 服务备份 tar -czf "$BACKUP_DIR/llama_$(date +%Y%m%d_%H%M%S).tar.gz" "$LLAMA_DIR" log "备份完成" } # 更新博客 update_blog() { log "开始更新博客" cd "$BLOG_DIR" || exit 1 # 拉取最新代码 if git pull origin master; then # 更新主题 git submodule update --remote themes/ananke # 构建站点 hugo --minify # 更新权限 sudo chown -R www-data:www-data public/ # 重启 Nginx sudo systemctl restart nginx log "博客更新成功" else log "错误: 博客更新失败" return 1 fi } # 更新 AI 服务 update_ai_service() { log "开始更新 AI 服务" cd "$LLAMA_DIR" || exit 1 # 停止当前服务 pkill llama-server # 拉取最新代码 if git pull origin master; then # 重新编译 make clean if LLAMA_METAL=1 make -j4; then # 启动服务 ./start-llama.sh # 验证服务 sleep 5 if pgrep -f llama-server > /dev/null; then log "AI 服务更新成功" else log "错误: AI 服务启动失败" return 1 fi else log "错误: AI 服务编译失败" return 1 fi else log "错误: AI 服务代码更新失败" return 1 fi } # 主函数 main() { log "开始自动部署流程" # 创建备份 backup_current # 更新服务 if update_blog && update_ai_service; then log "部署完成" return 0 else log "部署失败" return 1 fi } # 执行部署 main 2. 自动更新检查脚本 # 创建更新检查脚本 nano ~/check_updates.sh 二十一、自动更新检查与通知系统 1. 更新检查脚本 #!/bin/bash # ~/check_updates.sh # 配置 NOTIFY_SCRIPT="/home/zhaoxiongzhou/send_notification.sh" LOG_FILE="/var/log/update_check.log" GITHUB_API="https://api.github.com" LLAMA_REPO="ggerganov/llama.cpp" HUGO_REPO="gohugoio/hugo" # 日志函数 log() { echo "[$(date &#39;+%Y-%m-%d %H:%M:%S&#39;)] $1" | tee -a "$LOG_FILE" } # 检查 GitHub 仓库更新 check_github_updates() { local repo="$1" local current_version="$2" # 获取最新版本 latest_version=$(curl -s "$GITHUB_API/repos/$repo/releases/latest" | grep -Po &#39;"tag_name": "\K.*?(?=")&#39;) if [ "$latest_version" != "$current_version" ]; then log "发现新版本: $repo ($current_version -> $latest_version)" return 0 else log "当前版本已是最新: $repo ($current_version)" return 1 fi } # 检查系统更新 check_system_updates() { sudo apt update > /dev/null 2>&amp;1 updates=$(sudo apt list --upgradable 2>/dev/null | grep -c "upgradable") if [ "$updates" -gt 0 ]; then log "发现 $updates 个系统更新" return 0 else log "系统已是最新" return 1 fi } # 检查服务状态 check_services() { local services=("nginx" "llama-server") local status=0 for service in "${services[@]}"; do if [ "$service" = "nginx" ]; then if ! systemctl is-active --quiet nginx; then log "警告: Nginx 服务未运行" status=1 fi elif [ "$service" = "llama-server" ]; then if ! pgrep -f llama-server > /dev/null; then log "警告: AI 服务未运行" status=1 fi fi done return $status } # 发送通知 send_notification() { local message="$1" local priority="$2" if [ -x "$NOTIFY_SCRIPT" ]; then "$NOTIFY_SCRIPT" "$message" "$priority" else log "通知脚本不存在或不可执行" fi } # 主函数 main() { log "开始检查更新" # 获取当前版本 current_llama_version=$(cd ~/projects/llama.cpp && git describe --tags) current_hugo_version=$(hugo version | grep -Po "v\d+\.\d+\.\d+") # 检查更新 updates_found=0 if check_github_updates "$LLAMA_REPO" "$current_llama_version"; then send_notification "llama.cpp 有新版本可用" "normal" updates_found=1 fi if check_github_updates "$HUGO_REPO" "$current_hugo_version"; then send_notification "Hugo 有新版本可用" "normal" updates_found=1 fi if check_system_updates; then send_notification "系统有更新可用" "normal" updates_found=1 fi if ! check_services; then send_notification "服务状态异常，请检查" "high" fi if [ "$updates_found" -eq 0 ]; then log "所有组件均为最新版本" fi } # 执行检查 main 二十二、通知系统配置 1. 通知发送脚本 # 创建通知发送脚本 nano ~/send_notification.sh #!/bin/bash # ~/send_notification.sh # 配置 TELEGRAM_BOT_TOKEN="your_bot_token" TELEGRAM_CHAT_ID="your_chat_id" EMAIL_ADDRESS="your_email@domain.com" DISCORD_WEBHOOK_URL="your_discord_webhook_url" # 日志配置 LOG_FILE="/var/log/notifications.log" # 日志函数 log() { echo "[$(date &#39;+%Y-%m-%d %H:%M:%S&#39;)] $1" >> "$LOG_FILE" } # Telegram 通知 send_telegram() { local message="$1" local priority="$2" # 根据优先级添加表情符号 case "$priority" in "high") message="🚨 紧急: $message" ;; "normal") message="ℹ️ 通知: $message" ;; "low") message="📝 信息: $message" ;; esac # 发送消息 curl -s -X POST \ "https://api.telegram.org/bot$TELEGRAM_BOT_TOKEN/sendMessage" \ -d "chat_id=$TELEGRAM_CHAT_ID" \ -d "text=$message" \ -d "parse_mode=HTML" log "Telegram 通知已发送: $message" } # 邮件通知 send_email() { local message="$1" local priority="$2" local subject case "$priority" in "high") subject="[紧急] 树莓派服务警告" ;; "normal") subject="[通知] 树莓派服务更新" ;; "low") subject="[信息] 树莓派服务状态" ;; esac echo "$message" | mail -s "$subject" "$EMAIL_ADDRESS" log "邮件通知已发送: $subject - $message" } # Discord 通知 send_discord() { local message="$1" local priority="$2" local color case "$priority" in "high") color="16711680" # 红色 ;; "normal") color="65280" # 绿色 ;; "low") color="255" # 蓝色 ;; esac curl -H "Content-Type: application/json" \ -X POST \ -d "{\"embeds\": [{\"description\": \"$message\", \"color\": $color}]}" \ "$DISCORD_WEBHOOK_URL" log "Discord 通知已发送: $message" } # 主函数 main() { local message="$1" local priority="${2:-normal}" # 默认优先级为 normal # 检查必要参数 if [ -z "$message" ]; then log "错误: 消息内容不能为空" return 1 fi # 添加系统信息 local hostname=$(hostname) local timestamp=$(date &#39;+%Y-%m-%d %H:%M:%S&#39;) message="[$hostname] [$timestamp] $message" # 发送所有通知 send_telegram "$message" "$priority" send_email "$message" "$priority" send_discord "$message" "$priority" log "所有通知渠道处理完成" } # 执行通知发送 main "$@" 二十三、定时任务配置 1. Crontab 配置 # 编辑 crontab crontab -e # 系统维护任务 # 每天凌晨 2 点执行系统更新检查 0 2 * * * ~/check_updates.sh > /dev/null 2>&amp;1 # 每 6 小时执行一次服务健康检查 0 */6 * * * ~/service_health_check.sh > /dev/null 2>&amp;1 # 每周日凌晨 3 点执行系统优化 0 3 * * 0 ~/system_optimize.sh > /dev/null 2>&amp;1 # 每天凌晨 4 点执行日志管理 0 4 * * * ~/log_management.sh > /dev/null 2>&amp;1 # 每小时执行性能数据收集 0 * * * * ~/collect_performance.sh > /dev/null 2>&amp;1 # 每 5 分钟检查一次关键服务状态 */5 * * * * ~/monitor.sh > /dev/null 2>&amp;1 # 每天晚上 11 点执行备份 0 23 * * * ~/auto_backup.sh > /dev/null 2>&amp;1 # 每月 1 号执行完整系统检查 0 1 1 * * ~/full_system_check.sh > /dev/null 2>&amp;1 2. 完整系统检查脚本 # 创建完整系统检查脚本 nano ~/full_system_check.sh #!/bin/bash # ~/full_system_check.sh LOG_FILE="/var/log/system_check.log" REPORT_FILE="/home/zhaoxiongzhou/reports/monthly_report_$(date +%Y%m).txt" # 确保目录存在 mkdir -p "$(dirname "$REPORT_FILE")" # 日志函数 log() { echo "[$(date &#39;+%Y-%m-%d %H:%M:%S&#39;)] $1" | tee -a "$LOG_FILE" "$REPORT_FILE" } # 系统信息检查 check_system_info() { log "=== 系统信息 ===" log "系统版本: $(cat /etc/os-release | grep PRETTY_NAME)" log "内核版本: $(uname -r)" log "运行时间: $(uptime -p)" log "最后启动: $(who -b | awk &#39;{print $3,$4}&#39;)" } # 资源使用检查 check_resources() { log "=== 资源使用情况 ===" log "CPU 使用率: $(top -bn1 | grep "Cpu(s)" | awk &#39;{print $2}&#39;)%" log "内存使用情况:" free -h | tee -a "$REPORT_FILE" log "磁盘使用情况:" df -h | tee -a "$REPORT_FILE" } # 服务状态检查 check_services() { log "=== 服务状态 ===" # 检查 Nginx if systemctl is-active --quiet nginx; then log "Nginx: 运行正常" else log "Nginx: 未运行" fi # 检查 AI 服务 if pgrep -f llama-server > /dev/null; then log "AI 服务: 运行正常" else log "AI 服务: 未运行" fi } # 安全检查 check_security() { log "=== 安全检查 ===" # 检查失败的登录尝试 log "失败的登录尝试:" grep "Failed password" /var/log/auth.log | tail -n 5 | tee -a "$REPORT_FILE" # 检查开放的端口 log "开放的端口:" netstat -tuln | grep LISTEN | tee -a "$REPORT_FILE" } # 性能分析 analyze_performance() { log "=== 性能分析 ===" # 分析 CPU 使用情况 log "CPU 密集进程:" ps aux --sort=-%cpu | head -n 5 | tee -a "$REPORT_FILE" # 分析内存使用情况 log "内存密集进程:" ps aux --sort=-%mem | head -n 5 | tee -a "$REPORT_FILE" } # 主函数 main() { log "开始月度系统检查 - $(date)" check_system_info check_resources check_services check_security analyze_performance log "系统检查完成" # 发送报告 if [ -f "$REPORT_FILE" ]; then ~/send_notification.sh "月度系统检查报告已生成" "normal" fi } # 执行检查 main 二十四、灾难恢复计划 1. 系统恢复脚本 # 创建系统恢复脚本 nano ~/disaster_recovery.sh #!/bin/bash # ~/disaster_recovery.sh # 配置 BACKUP_DIR="/home/zhaoxiongzhou/backups" RECOVERY_LOG="/var/log/recovery.log" SERVICES=("nginx" "llama-server") # 日志函数 log() { echo "[$(date &#39;+%Y-%m-%d %H:%M:%S&#39;)] $1" | tee -a "$RECOVERY_LOG" } # 验证备份 verify_backup() { local backup_file="$1" if [ ! -f "$backup_file" ]; then log "错误: 备份文件不存在 - $backup_file" return 1 fi # 检查文件完整性 if ! tar -tzf "$backup_file" >/dev/null 2>&amp;1; then log "错误: 备份文件损坏 - $backup_file" return 1 fi return 0 } # 停止服务 stop_services() { log "停止所有服务..." for service in "${SERVICES[@]}"; do if [ "$service" = "nginx" ]; then sudo systemctl stop nginx else pkill "$service" fi done # 等待服务完全停止 sleep 5 } # 恢复博客服务 restore_blog() { local backup_file="$BACKUP_DIR/blog_latest.tar.gz" if verify_backup "$backup_file"; then log "开始恢复博客服务..." # 清理当前目录 rm -rf ~/myblog/* # 解压备份 tar -xzf "$backup_file" -C ~/myblog/ # 重建站点 cd ~/myblog hugo --minify # 恢复权限 sudo chown -R www-data:www-data public/ log "博客服务恢复完成" else log "博客服务恢复失败" return 1 fi } # 恢复 AI 服务 restore_ai_service() { local backup_file="$BACKUP_DIR/llama_latest.tar.gz" if verify_backup "$backup_file"; then log "开始恢复 AI 服务..." # 清理当前目录 rm -rf ~/projects/llama.cpp/* # 解压备份 tar -xzf "$backup_file" -C ~/projects/llama.cpp/ # 重新编译 cd ~/projects/llama.cpp make clean LLAMA_METAL=1 make -j4 log "AI 服务恢复完成" else log "AI 服务恢复失败" return 1 fi } # 恢复系统配置 restore_system_config() { local backup_file="$BACKUP_DIR/system_config_latest.tar.gz" if verify_backup "$backup_file"; then log "开始恢复系统配置..." # 解压系统配置 sudo tar -xzf "$backup_file" -C / # 重新加载系统配置 sudo sysctl --system log "系统配置恢复完成" else log "系统配置恢复失败" return 1 fi } # 启动服务 start_services() { log "启动所有服务..." # 启动 Nginx sudo systemctl start nginx # 启动 AI 服务 ~/projects/llama.cpp/start-llama.sh # 验证服务状态 sleep 10 verify_services } # 验证服务 verify_services() { local status=0 log "验证服务状态..." # 检查 Nginx if ! systemctl is-active --quiet nginx; then log "警告: Nginx 服务未正常运行" status=1 fi # 检查 AI 服务 if ! pgrep -f llama-server > /dev/null; then log "警告: AI 服务未正常运行" status=1 fi return $status } # 主函数 main() { log "开始系统恢复流程..." # 停止服务 stop_services # 执行恢复 if restore_system_config && restore_blog && restore_ai_service; then # 启动服务 start_services if verify_services; then log "系统恢复成功完成" ~/send_notification.sh "系统恢复成功完成" "normal" return 0 else log "系统恢复完成，但部分服务可能未正常运行" ~/send_notification.sh "系统恢复完成，但需要手动检查服务状态" "high" return 1 fi else log "系统恢复失败" ~/send_notification.sh "系统恢复失败，需要手动干预" "high" return 1 fi } # 执行恢复 main 二十五、文档管理系统 1. 文档生成脚本 # 创建文档生成脚本 nano ~/generate_docs.sh #!/bin/bash # ~/generate_docs.sh # 配置 DOCS_DIR="/home/zhaoxiongzhou/documentation" SCRIPTS_DIR="/home/zhaoxiongzhou" CONFIG_DIR="/etc" LOG_FILE="/var/log/documentation.log" # 确保目录存在 mkdir -p "$DOCS_DIR"/{scripts,configs,logs,maintenance} # 日志函数 log() { echo "[$(date &#39;+%Y-%m-%d %H:%M:%S&#39;)] $1" | tee -a "$LOG_FILE" } # 生成脚本文档 generate_script_docs() { log "生成脚本文档..." for script in "$SCRIPTS_DIR"/*.sh; do if [ -f "$script" ]; then script_name=$(basename "$script") output_file="$DOCS_DIR/scripts/${script_name%.sh}.md" { echo "# $script_name" echo "## 路径: $script" echo "## 最后修改: $(date -r "$script" &#39;+%Y-%m-%d %H:%M:%S&#39;)" echo "## 权限: $(stat -c &#39;%a&#39; "$script")" echo "## 所有者: $(stat -c &#39;%U:%G&#39; "$script")" echo echo "## 功能描述" grep -A 5 "^#.*功能:" "$script" 2>/dev/null || echo "未提供功能描述" echo echo "## 脚本内容" echo &#39;```bash&#39; cat "$script" echo &#39;```&#39; echo echo "## 依赖项" grep "^[^#]*apt.*install" "$script" 2>/dev/null || echo "未找到明确的依赖项" echo echo "## 定时任务" crontab -l 2>/dev/null | grep "$script_name" || echo "未配置定时任务" } > "$output_file" fi done } # 生成配置文档 generate_config_docs() { log "生成配置文档..." # Nginx 配置 { echo "# Nginx 配置文档" echo "## 主配置文件" echo &#39;```nginx&#39; cat /etc/nginx/nginx.conf echo &#39;```&#39; echo "## 站点配置" echo &#39;```nginx&#39; cat /etc/nginx/sites-available/myblog echo &#39;```&#39; } > "$DOCS_DIR/configs/nginx_config.md" # 系统配置 { echo "# 系统配置文档" echo "## Sysctl 配置" echo &#39;```bash&#39; cat /etc/sysctl.d/99-custom.conf echo &#39;```&#39; echo "## 树莓派配置" echo &#39;```bash&#39; cat /boot/config.txt echo &#39;```&#39; } > "$DOCS_DIR/configs/system_config.md" } # 生成维护文档 generate_maintenance_docs() { log "生成维护文档..." { echo "# 系统维护文档" echo "## 定时任务" echo &#39;```bash&#39; crontab -l echo &#39;```&#39; echo "## 服务状态" echo &#39;```bash&#39; systemctl status nginx ps aux | grep llama-server echo &#39;```&#39; echo "## 资源使用" echo &#39;```bash&#39; df -h free -h top -bn1 echo &#39;```&#39; echo "## 最近日志" echo &#39;```bash&#39; tail -n 50 /var/log/syslog echo &#39;```&#39; } > "$DOCS_DIR/maintenance/system_status.md" } # 生成索引 generate_index() { log "生成文档索引..." { echo "# 系统文档索引" echo "## 生成时间: $(date &#39;+%Y-%m-%d %H:%M:%S&#39;)" echo echo "## 脚本文档" for doc in "$DOCS_DIR/scripts"/*.md; do echo "- [$(basename "${doc%.md}")](scripts/$(basename "$doc"))" done echo echo "## 配置文档" for doc in "$DOCS_DIR/configs"/*.md; do echo "- [$(basename "${doc%.md}")](configs/$(basename "$doc"))" done echo echo "## 维护文档" for doc in "$DOCS_DIR/maintenance"/*.md; do echo "- [$(basename "${doc%.md}")](maintenance/$(basename "$doc"))" done } > "$DOCS_DIR/index.md" } # 主函数 main() { log "开始生成文档..." generate_script_docs generate_config_docs generate_maintenance_docs generate_index log "文档生成完成: $DOCS_DIR" } # 执行文档生成 main 二十六、性能测试与基准测试 1. 性能测试脚本 # 创建性能测试脚本 nano ~/benchmark.sh #!/bin/bash # ~/benchmark.sh # 配置 RESULTS_DIR="/home/zhaoxiongzhou/benchmark_results" LOG_FILE="/var/log/benchmark.log" DURATION=300 # 测试持续时间（秒） CONCURRENT_USERS=10 # 并发用户数 # 确保目录存在 mkdir -p "$RESULTS_DIR" # 日志函数 log() { echo "[$(date &#39;+%Y-%m-%d %H:%M:%S&#39;)] $1" | tee -a "$LOG_FILE" } # CPU 性能测试 benchmark_cpu() { log "开始 CPU 性能测试..." # 使用 sysbench 进行 CPU 测试 sysbench cpu --cpu-max-prime=20000 --threads=4 run > "$RESULTS_DIR/cpu_benchmark.txt" # 记录 CPU 温度 for i in $(seq 1 10); do vcgencmd measure_temp >> "$RESULTS_DIR/cpu_temp.txt" sleep 1 done } # 内存性能测试 benchmark_memory() { log "开始内存性能测试..." # 使用 sysbench 进行内存测试 sysbench memory --memory-block-size=1K --memory-total-size=10G run > "$RESULTS_DIR/memory_benchmark.txt" } # 磁盘性能测试 benchmark_disk() { log "开始磁盘性能测试..." # 使用 dd 测试写入速度 dd if=/dev/zero of=/tmp/test_file bs=1M count=1000 conv=fdatasync 2>> "$RESULTS_DIR/disk_write_benchmark.txt" # 使用 dd 测试读取速度 dd if=/tmp/test_file of=/dev/null bs=1M count=1000 2>> "$RESULTS_DIR/disk_read_benchmark.txt" # 清理测试文件 rm /tmp/test_file } # 网络性能测试 benchmark_network() { log "开始网络性能测试..." # 使用 iperf3 测试网络性能 iperf3 -c iperf.he.net -t 30 > "$RESULTS_DIR/network_benchmark.txt" } # Web 服务性能测试 benchmark_web() { log "开始 Web 服务性能测试..." # 使用 ab 测试 Web 服务 ab -n 1000 -c "$CONCURRENT_USERS" http://localhost/ > "$RESULTS_DIR/web_benchmark.txt" } # AI 服务性能测试 benchmark_ai() { log "开始 AI 服务性能测试..." # 创建测试请求 cat > /tmp/test_prompt.txt << EOF Hello, how are you? EOF # 使用 curl 测试 AI 服务响应时间 for i in $(seq 1 10); do time curl -X POST \ -H "Content-Type: application/json" \ -d @/tmp/test_prompt.txt \ http://localhost:8080/completion >> "$RESULTS_DIR/ai_benchmark.txt" 2>&amp;1 echo -e "\n---\n" >> "$RESULTS_DIR/ai_benchmark.txt" sleep 2 done } # 生成报告 generate_report() { log "生成性能测试报告..." local report_file="$RESULTS_DIR/benchmark_report_$(date +%Y%m%d_%H%M%S).md" { echo "# 性能测试报告" echo "## 测试时间: $(date &#39;+%Y-%m-%d %H:%M:%S&#39;)" echo echo "## 系统信息" echo &#39;```&#39; uname -a echo &#39;```&#39; echo echo "## CPU 性能" echo &#39;```&#39; cat "$RESULTS_DIR/cpu_benchmark.txt" echo &#39;```&#39; echo echo "## 内存性能" echo &#39;```&#39; cat "$RESULTS_DIR/memory_benchmark.txt" echo &#39;```&#39; echo echo "## 磁盘性能" echo &#39;```&#39; cat "$RESULTS_DIR/disk_write_benchmark.txt" cat "$RESULTS_DIR/disk_read_benchmark.txt" echo &#39;```&#39; echo echo "## 网络性能" echo &#39;```&#39; cat "$RESULTS_DIR/network_benchmark.txt" echo &#39;```&#39; echo echo "## Web 服务性能" echo &#39;```&#39; cat "$RESULTS_DIR/web_benchmark.txt" echo &#39;```&#39; echo echo "## AI 服务性能" echo &#39;```&#39; cat "$RESULTS_DIR/ai_benchmark.txt" echo &#39;```&#39; } > "$report_file" log "性能测试报告已生成: $report_file" } # 主函数 main() { log "开始性能测试..." # 安装必要的工具 sudo apt install -y sysbench apache2-utils iperf3 # 执行各项测试 benchmark_cpu benchmark_memory benchmark_disk benchmark_network benchmark_web benchmark_ai # 生成报告 generate_report log "性能测试完成" } # 执行测试 main 二十七、安全审计系统 1. 安全审计脚本 # 创建安全审计脚本 nano ~/security_audit.sh #!/bin/bash # ~/security_audit.sh # 配置 AUDIT_DIR="/home/zhaoxiongzhou/security_audits" REPORT_FILE="$AUDIT_DIR/security_report_$(date +%Y%m%d_%H%M%S).md" LOG_FILE="/var/log/security_audit.log" # 确保目录存在 mkdir -p "$AUDIT_DIR" # 日志函数 log() { echo "[$(date &#39;+%Y-%m-%d %H:%M:%S&#39;)] $1" | tee -a "$LOG_FILE" } # 检查系统用户 audit_users() { log "检查系统用户..." { echo "## 系统用户审计" echo "### 特权用户" echo &#39;```&#39; awk -F: &#39;$3 == 0 {print $1}&#39; /etc/passwd echo &#39;```&#39; echo "### 最近的用户活动" echo &#39;```&#39; last | head -n 10 echo &#39;```&#39; echo "### 失败的登录尝试" echo &#39;```&#39; grep "Failed password" /var/log/auth.log | tail -n 10 echo &#39;```&#39; } >> "$REPORT_FILE" } # 检查网络安全 audit_network() { log "检查网络安全..." { echo "## 网络安全审计" echo "### 开放端口" echo &#39;```&#39; netstat -tuln echo &#39;```&#39; echo "### 活动连接" echo &#39;```&#39; netstat -nat | grep ESTABLISHED echo &#39;```&#39; echo "### 防火墙规则" echo &#39;```&#39; sudo iptables -L -n echo &#39;```&#39; } >> "$REPORT_FILE" } # 检查文件权限 audit_permissions() { log "检查文件权限..." { echo "## 文件权限审计" echo "### SUID 文件" echo &#39;```&#39; sudo find / -type f -perm -4000 2>/dev/null echo &#39;```&#39; echo "### 世界可写文件" echo &#39;```&#39; sudo find / -type f -perm -2 ! -path "/proc/*" ! -path "/sys/*" 2>/dev/null echo &#39;```&#39; echo "### 敏感目录权限" echo &#39;```&#39; ls -la /etc/nginx/ ls -la ~/projects/llama.cpp/ ls -la ~/myblog/ echo &#39;```&#39; } >> "$REPORT_FILE" } # 检查服务配置 audit_services() { log "检查服务配置..." { echo "## 服务配置审计" echo "### Nginx 配置检查" echo &#39;```&#39; sudo nginx -t 2>&amp;1 echo &#39;```&#39; echo "### SSL 配置" echo &#39;```&#39; openssl s_client -connect localhost:443 -servername localhost </dev/null 2>/dev/null | openssl x509 -text echo &#39;```&#39; echo "### 服务状态" echo &#39;```&#39; systemctl list-units --type=service --state=active echo &#39;```&#39; } >> "$REPORT_FILE" } # 检查系统更新 audit_updates() { log "检查系统更新..." { echo "## 系统更新审计" echo "### 可用更新" echo &#39;```&#39; apt list --upgradable 2>/dev/null echo &#39;```&#39; echo "### 已安装包" echo &#39;```&#39; dpkg -l | grep "^ii" | wc -l echo &#39;```&#39; } >> "$REPORT_FILE" } # 检查日志异常 audit_logs() { log "检查日志异常..." { echo "## 日志审计" echo "### 系统错误" echo &#39;```&#39; sudo journalctl -p 3 -xb --no-pager | tail -n 20 echo &#39;```&#39; echo "### 异常访问" echo &#39;```&#39; grep -i "error\|failed\|warning" /var/log/nginx/error.log | tail -n 20 echo &#39;```&#39; } >> "$REPORT_FILE" } # 生成安全建议 generate_recommendations() { log "生成安全建议..." { echo "## 安全建议" echo "### 高优先级" # 检查并生成建议 if grep -q "Failed password" /var/log/auth.log; then echo "- 建议：启用 fail2ban 加强 SSH 防护" fi if [ $(find / -type f -perm -2 2>/dev/null | wc -l) -gt 0 ]; then echo "- 建议：检查并修复世界可写文件权限" fi echo "### 中优先级" # 添加其他建议 echo "- 定期更新系统包" echo "- 检查并更新 SSL 证书" echo "- 定期审查用户权限" } >> "$REPORT_FILE" } # 主函数 main() { log "开始安全审计..." # 创建报告头部 { echo "# 安全审计报告" echo "## 生成时间: $(date &#39;+%Y-%m-%d %H:%M:%S&#39;)" echo "## 系统信息" echo &#39;```&#39; uname -a echo &#39;```&#39; echo } > "$REPORT_FILE" # 执行各项审计 audit_users audit_network audit_permissions audit_services audit_updates audit_logs generate_recommendations log "安全审计完成，报告已生成: $REPORT_FILE" # 发送通知 ~/send_notification.sh "安全审计报告已生成" "normal" } # 执行审计 main 二十八、资源限制与控制 1. 资源限制配置脚本 # 创建资源限制配置脚本 nano ~/resource_control.sh #!/bin/bash # ~/resource_control.sh # 配置 LOG_FILE="/var/log/resource_control.log" LIMITS_CONF="/etc/security/limits.conf" SYSTEMD_DIR="/etc/systemd/system" # 日志函数 log() { echo "[$(date &#39;+%Y-%m-%d %H:%M:%S&#39;)] $1" | tee -a "$LOG_FILE" } # 配置系统资源限制 configure_system_limits() { log "配置系统资源限制..." # 备份原始配置 sudo cp "$LIMITS_CONF" "${LIMITS_CONF}.backup" # 添加资源限制配置 sudo tee -a "$LIMITS_CONF" << EOF # 用户资源限制 zhaoxiongzhou soft nofile 65535 zhaoxiongzhou hard nofile 65535 zhaoxiongzhou soft nproc 2048 zhaoxiongzhou hard nproc 4096 # 系统服务资源限制 www-data soft nofile 65535 www-data hard nofile 65535 www-data soft nproc 1024 www-data hard nproc 2048 EOF } # 配置 AI 服务资源限制 configure_ai_service() { log "配置 AI 服务资源限制..." # 创建 systemd 服务文件 sudo tee "$SYSTEMD_DIR/llama-server.service" << EOF [Unit] Description=Llama AI Server After=network.target [Service] User=zhaoxiongzhou Group=zhaoxiongzhou WorkingDirectory=/home/zhaoxiongzhou/projects/llama.cpp ExecStart=/home/zhaoxiongzhou/projects/llama.cpp/start-llama.sh # 资源限制 CPUQuota=80% MemoryLimit=2G TasksMax=128 LimitNOFILE=65535 # 重启策略 Restart=always RestartSec=10 [Install] WantedBy=multi-user.target EOF # 重新加载 systemd 配置 sudo systemctl daemon-reload } # 配置 Nginx 资源限制 configure_nginx() { log "配置 Nginx 资源限制..." # 修改 Nginx 配置 sudo tee "/etc/nginx/conf.d/resource_limits.conf" << EOF # 工作进程限制 worker_processes auto; worker_rlimit_nofile 65535; # 连接限制 events { worker_connections 1024; multi_accept on; } # 客户端限制 http { # 请求限制 limit_req_zone \$binary_remote_addr zone=one:10m rate=10r/s; # 连接限制 limit_conn_zone \$binary_remote_addr zone=addr:10m; server { # 应用限制 location / { limit_req zone=one burst=5; limit_conn addr 10; } } } EOF } # 配置系统资源监控 configure_monitoring() { log "配置资源监控..." # 创建监控脚本 cat > ~/monitor_resources.sh << EOF #!/bin/bash while true; do # CPU 使用率 CPU_USAGE=\$(top -bn1 | grep "Cpu(s)" | awk &#39;{print \$2}&#39;) # 内存使用率 MEM_USAGE=\$(free | grep Mem | awk &#39;{print \$3/\$2 * 100.0}&#39;) # 进程数 PROCESS_COUNT=\$(ps aux | wc -l) # 检查限制 if (( \$(echo "\$CPU_USAGE > 80" | bc -l) )); then ~/send_notification.sh "警告: CPU 使用率过高 (\${CPU_USAGE}%)" "high" fi if (( \$(echo "\$MEM_USAGE > 90" | bc -l) )); then ~/send_notification.sh "警告: 内存使用率过高 (\${MEM_USAGE}%)" "high" fi if [ "\$PROCESS_COUNT" -gt 200 ]; then ~/send_notification.sh "警告: 进程数过多 (\$PROCESS_COUNT)" "high" fi sleep 60 done EOF chmod +x ~/monitor_resources.sh } # 应用配置 apply_configurations() { log "应用资源限制配置..." # 重启服务 sudo systemctl restart nginx sudo systemctl restart llama-server # 启动监控 ~/monitor_resources.sh & # 验证配置 log "验证配置..." sudo nginx -t sudo systemctl status llama-server ulimit -a } # 主函数 main() { log "开始配置资源限制..." configure_system_limits configure_ai_service configure_nginx configure_monitoring apply_configurations log "资源限制配置完成" } # 执行配置 main 二十九、自动化测试系统 1. 集成测试脚本 # 创建集成测试脚本 nano ~/integration_test.sh #!/bin/bash # ~/integration_test.sh # 配置 TEST_DIR="/home/zhaoxiongzhou/tests" REPORT_DIR="/home/zhaoxiongzhou/test_reports" LOG_FILE="/var/log/integration_test.log" # 确保目录存在 mkdir -p "$TEST_DIR" "$REPORT_DIR" # 日志函数 log() { echo "[$(date &#39;+%Y-%m-%d %H:%M:%S&#39;)] $1" | tee -a "$LOG_FILE" } # 测试 Web 服务 test_web_service() { log "测试 Web 服务..." local result=0 # 测试首页访问 if curl -s -o /dev/null -w "%{http_code}" http://localhost/ | grep -q "200"; then log "首页访问测试通过" else log "错误: 首页访问测试失败" result=1 fi # 测试静态资源 if curl -s -o /dev/null -w "%{http_code}" http://localhost/css/main.css | grep -q "200"; then log "静态资源测试通过" else log "错误: 静态资源测试失败" result=1 fi # 测试 404 页面 if curl -s -o /dev/null -w "%{http_code}" http://localhost/nonexistent | grep -q "404"; then log "404 页面测试通过" else log "错误: 404 页面测试失败" result=1 fi return $result } # 测试 AI 服务 test_ai_service() { log "测试 AI 服务..." local result=0 # 测试服务可用性 if curl -s -o /dev/null -w "%{http_code}" http://localhost:8080/health | grep -q "200"; then log "AI 服务健康检查通过" else log "错误: AI 服务健康检查失败" result=1 fi # 测试模型响应 local response=$(curl -s -X POST \ -H "Content-Type: application/json" \ -d &#39;{"prompt": "Hello", "max_tokens": 10}&#39; \ http://localhost:8080/completion) if echo "$response" | grep -q "text"; then log "AI 服务响应测试通过" else log "错误: AI 服务响应测试失败" result=1 fi return $result } # 测试系统服务 test_system_services() { log "测试系统服务..." local result=0 # 测试 Nginx 状态 if systemctl is-active --quiet nginx; then log "Nginx 服务测试通过" else log "错误: Nginx 服务测试失败" result=1 fi # 测试系统资源 local cpu_usage=$(top -bn1 | grep "Cpu(s)" | awk &#39;{print $2}&#39;) local mem_usage=$(free | grep Mem | awk &#39;{print $3/$2 * 100.0}&#39;) if [ $(echo "$cpu_usage < 90" | bc -l) -eq 1 ]; then log "CPU 使用率正常" else log "警告: CPU 使用率过高" result=1 fi if [ $(echo "$mem_usage < 90" | bc -l) -eq 1 ]; then log "内存使用率正常" else log "警告: 内存使用率过高" result=1 fi return $result } # 生成测试报告 generate_report() { local web_result=$1 local ai_result=$2 local system_result=$3 local report_file="$REPORT_DIR/test_report_$(date +%Y%m%d_%H%M%S).md" { echo "# 集成测试报告" echo "## 测试时间: $(date &#39;+%Y-%m-%d %H:%M:%S&#39;)" echo echo "## 测试结果摘要" echo "- Web 服务: $([ $web_result -eq 0 ] && echo &#39;通过 ✅&#39; || echo &#39;失败 ❌&#39;)" echo "- AI 服务: $([ $ai_result -eq 0 ] && echo &#39;通过 ✅&#39; || echo &#39;失败 ❌&#39;)" echo "- 系统服务: $([ $system_result -eq 0 ] && echo &#39;通过 ✅&#39; || echo &#39;失败 ❌&#39;)" echo echo "## 详细日志" echo &#39;```&#39; tail -n 50 "$LOG_FILE" echo &#39;```&#39; } > "$report_file" log "测试报告已生成: $report_file" } # 主函数 main() { log "开始集成测试..." local web_result=0 local ai_result=0 local system_result=0 # 执行测试 test_web_service web_result=$? test_ai_service ai_result=$? test_system_services system_result=$? # 生成报告 generate_report $web_result $ai_result $system_result # 发送通知 if [ $web_result -eq 0 ] && [ $ai_result -eq 0 ] && [ $system_result -eq 0 ]; then ~/send_notification.sh "集成测试全部通过" "normal" else ~/send_notification.sh "集成测试存在失败项，请查看报告" "high" fi # 返回总体结果 return $(( web_result + ai_result + system_result )) } # 执行测试 main 三十、系统状态仪表板 1. 状态监控页面生成脚本 # 创建状态页面生成脚本 nano ~/generate_dashboard.sh #!/bin/bash # ~/generate_dashboard.sh # 配置 DASHBOARD_DIR="/var/www/html/dashboard" REFRESH_INTERVAL=60 # 页面刷新间隔（秒） LOG_FILE="/var/log/dashboard.log" # 确保目录存在 sudo mkdir -p "$DASHBOARD_DIR" # 日志函数 log() { echo "[$(date &#39;+%Y-%m-%d %H:%M:%S&#39;)] $1" | tee -a "$LOG_FILE" } # 收集系统状态数据 collect_system_data() { # CPU 信息 CPU_USAGE=$(top -bn1 | grep "Cpu(s)" | awk &#39;{print $2}&#39;) CPU_TEMP=$(vcgencmd measure_temp | sed &#39;s/temp=//&#39; | sed &#39;s/&#39;"&#39;"&#39;C//&#39;) # 内存信息 MEM_TOTAL=$(free -m | awk &#39;/Mem:/ {print $2}&#39;) MEM_USED=$(free -m | awk &#39;/Mem:/ {print $3}&#39;) MEM_USAGE=$(awk "BEGIN {printf \"%.2f\", $MEM_USED/$MEM_TOTAL*100}") # 磁盘信息 DISK_USAGE=$(df -h / | awk &#39;NR==2 {print $5}&#39; | sed &#39;s/%//&#39;) # 系统负载 LOAD_AVG=$(uptime | awk -F&#39;load average:&#39; &#39;{print $2}&#39; | xargs) # 运行时间 UPTIME=$(uptime -p) } # 收集服务状态 collect_service_data() { # Nginx 状态 if systemctl is-active --quiet nginx; then NGINX_STATUS="运行中 ✅" else NGINX_STATUS="已停止 ❌" fi # AI 服务状态 if pgrep -f llama-server > /dev/null; then AI_STATUS="运行中 ✅" else AI_STATUS="已停止 ❌" fi # 获取最近的日志 RECENT_LOGS=$(tail -n 10 /var/log/syslog | sed &#39;s/</\&amp;lt;/g&#39; | sed &#39;s/>/\&amp;gt;/g&#39;) } # 生成状态页面 generate_dashboard() { local timestamp=$(date &#39;+%Y-%m-%d %H:%M:%S&#39;) cat > "$DASHBOARD_DIR/index.html" << EOF <!DOCTYPE html> <html lang="zh"> <head> <meta charset="UTF-8"> <meta name="viewport" content="width=device-width, initial-scale=1.0"> <title>系统状态仪表板</title> <meta http-equiv="refresh" content="$REFRESH_INTERVAL"> <style> body { font-family: Arial, sans-serif; margin: 20px; background-color: #f5f5f5; } .container { max-width: 1200px; margin: 0 auto; } .card { background: white; border-radius: 8px; padding: 20px; margin-bottom: 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); } .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; } .metric { text-align: center; padding: 15px; border-radius: 4px; background: #f8f9fa; } .metric h3 { margin: 0; color: #666; } .metric .value { font-size: 24px; font-weight: bold; margin: 10px 0; } .status { display: flex; justify-content: space-between; align-items: center; padding: 10px; border-bottom: 1px solid #eee; } .logs { background: #2b2b2b; color: #fff; padding: 15px; border-radius: 4px; font-family: monospace; white-space: pre-wrap; } </style> </head> <body> <div class="container"> <h1>系统状态仪表板</h1> <p>最后更新: $timestamp</p> <div class="card"> <h2>系统资源</h2> <div class="grid"> <div class="metric"> <h3>CPU 使用率</h3> <div class="value">$CPU_USAGE%</div> </div> <div class="metric"> <h3>CPU 温度</h3> <div class="value">$CPU_TEMP</div> </div> <div class="metric"> <h3>内存使用率</h3> <div class="value">$MEM_USAGE%</div> </div> <div class="metric"> <h3>磁盘使用率</h3> <div class="value">$DISK_USAGE%</div> </div> </div> </div> <div class="card"> <h2>系统信息</h2> <div class="status"> <span>系统负载:</span> <span>$LOAD_AVG</span> </div> <div class="status"> <span>运行时间:</span> <span>$UPTIME</span> </div> </div> <div class="card"> <h2>服务状态</h2> <div class="status"> <span>Nginx 服务:</span> <span>$NGINX_STATUS</span> </div> <div class="status"> <span>AI 服务:</span> <span>$AI_STATUS</span> </div> </div> <div class="card"> <h2>最近日志</h2> <div class="logs">$RECENT_LOGS</div> </div> </div> </body> </html> EOF # 设置权限 sudo chown www-data:www-data "$DASHBOARD_DIR/index.html" } # 主函数 main() { log "开始生成状态仪表板..." # 收集数据 collect_system_data collect_service_data # 生成页面 generate_dashboard log "状态仪表板已更新" } # 执行生成 main 三十一、系统备份与恢复完整方案 1. 完整备份脚本 # 创建完整备份脚本 nano ~/full_backup.sh #!/bin/bash # ~/full_backup.sh # 配置 BACKUP_ROOT="/mnt/backup_drive" BACKUP_DIR="$BACKUP_ROOT/system_backups" EXCLUDE_FILE="/home/zhaoxiongzhou/backup_exclude.txt" LOG_FILE="/var/log/backup.log" RETENTION_DAYS=30 COMPRESSION_LEVEL=6 # 确保备份目录存在 mkdir -p "$BACKUP_DIR" # 日志函数 log() { echo "[$(date &#39;+%Y-%m-%d %H:%M:%S&#39;)] $1" | tee -a "$LOG_FILE" } # 检查备份环境 check_environment() { log "检查备份环境..." # 检查备份目标目录 if ! mountpoint -q "$BACKUP_ROOT"; then log "错误: 备份驱动器未挂载" return 1 fi # 检查可用空间 local available_space=$(df -BG "$BACKUP_ROOT" | awk &#39;NR==2 {print $4}&#39; | sed &#39;s/G//&#39;) if [ "$available_space" -lt 10 ]; then log "错误: 备份空间不足（小于 10GB）" return 1 fi # 创建排除文件 cat > "$EXCLUDE_FILE" << EOF /proc/* /sys/* /tmp/* /run/* /mnt/* /media/* /lost+found /var/cache/* /var/tmp/* /var/log/* /home/*/Downloads/* /home/*/.cache/* EOF return 0 } # 停止服务 stop_services() { log "停止服务..." # 停止 Nginx sudo systemctl stop nginx # 停止 AI 服务 pkill llama-server # 等待服务完全停止 sleep 5 } # 启动服务 start_services() { log "启动服务..." # 启动 Nginx sudo systemctl start nginx # 启动 AI 服务 ~/projects/llama.cpp/start-llama.sh # 验证服务状态 sleep 10 if ! systemctl is-active --quiet nginx; then log "警告: Nginx 服务未能正常启动" fi if ! pgrep -f llama-server > /dev/null; then log "警告: AI 服务未能正常启动" fi } # 创建完整备份 create_full_backup() { local backup_date=$(date +%Y%m%d_%H%M%S) local backup_file="$BACKUP_DIR/full_backup_${backup_date}.tar.gz" local manifest_file="$BACKUP_DIR/backup_manifest_${backup_date}.txt" log "开始创建完整备份..." # 创建文件清单 log "生成文件清单..." find / -xdev -type f ! -path "$(cat $EXCLUDE_FILE | tr &#39;\n&#39; &#39;|&#39;)" > "$manifest_file" # 创建备份 log "创建系统备份..." sudo tar -czf "$backup_file" \ --exclude-from="$EXCLUDE_FILE" \ --one-file-system \ --preserve-permissions \ --numeric-owner \ --checkpoint=1000 \ --checkpoint-action=dot \ -C / . # 验证备份 if ! tar -tzf "$backup_file" >/dev/null 2>&amp;1; then log "错误: 备份文件验证失败" return 1 fi # 计算校验和 log "计算校验和..." sha256sum "$backup_file" > "${backup_file}.sha256" # 创建备份信息文件 cat > "${backup_file}.info" << EOF 备份时间: $(date) 系统版本: $(cat /etc/os-release | grep PRETTY_NAME) 内核版本: $(uname -r) 备份大小: $(du -h "$backup_file" | cut -f1) 文件数量: $(wc -l < "$manifest_file") 排除规则: $(cat "$EXCLUDE_FILE") EOF return 0 } # 清理旧备份 cleanup_old_backups() { log "清理旧备份..." find "$BACKUP_DIR" -type f -name "full_backup_*" -mtime +$RETENTION_DAYS -delete find "$BACKUP_DIR" -type f -name "backup_manifest_*" -mtime +$RETENTION_DAYS -delete find "$BACKUP_DIR" -type f -name "*.sha256" -mtime +$RETENTION_DAYS -delete find "$BACKUP_DIR" -type f -name "*.info" -mtime +$RETENTION_DAYS -delete } # 主函数 main() { log "开始完整备份流程..." # 检查环境 if ! check_environment; then log "备份环境检查失败，终止备份" ~/send_notification.sh "系统备份失败：环境检查未通过" "high" return 1 fi # 停止服务 stop_services # 创建备份 if create_full_backup; then log "备份创建成功" ~/send_notification.sh "系统完整备份已成功创建" "normal" else log "备份创建失败" ~/send_notification.sh "系统备份失败：备份创建过程出错" "high" fi # 启动服务 start_services # 清理旧备份 cleanup_old_backups log "备份流程完成" } # 执行备份 main 三十二、系统恢复脚本 1. 系统恢复脚本 # 创建系统恢复脚本 nano ~/system_restore.sh #!/bin/bash # ~/system_restore.sh # 配置 BACKUP_ROOT="/mnt/backup_drive" BACKUP_DIR="$BACKUP_ROOT/system_backups" LOG_FILE="/var/log/restore.log" TEMP_DIR="/tmp/restore_temp" # 日志函数 log() { echo "[$(date &#39;+%Y-%m-%d %H:%M:%S&#39;)] $1" | tee -a "$LOG_FILE" } # 验证备份文件 verify_backup() { local backup_file="$1" log "验证备份文件: $backup_file" # 检查文件是否存在 if [ ! -f "$backup_file" ]; then log "错误: 备份文件不存在" return 1 fi # 检查校验和 local checksum_file="${backup_file}.sha256" if [ -f "$checksum_file" ]; then if ! sha256sum -c "$checksum_file"; then log "错误: 备份文件校验和验证失败" return 1 fi else log "警告: 未找到校验和文件" fi # 测试归档完整性 if ! tar -tzf "$backup_file" >/dev/null 2>&amp;1; then log "错误: 备份文件损坏" return 1 fi return 0 } # 准备恢复环境 prepare_environment() { log "准备恢复环境..." # 创建临时目录 mkdir -p "$TEMP_DIR" # 停止所有服务 log "停止服务..." sudo systemctl stop nginx pkill llama-server # 等待服务停止 sleep 5 # 清理目标目录 log "清理目标目录..." read -p "警告: 这将清除系统文件。确定要继续吗？(y/n) " -n 1 -r echo if [[ ! $REPLY =~ ^[Yy]$ ]]; then log "用户取消操作" return 1 fi return 0 } # 执行恢复 perform_restore() { local backup_file="$1" log "开始恢复系统..." # 创建恢复前的快照 log "创建当前系统快照..." local snapshot_date=$(date +%Y%m%d_%H%M%S) local snapshot_file="$BACKUP_DIR/pre_restore_snapshot_${snapshot_date}.tar.gz" sudo tar -czf "$snapshot_file" \ --exclude-from="/home/zhaoxiongzhou/backup_exclude.txt" \ --one-file-system \ -C / . # 解压备份 log "解压备份文件..." sudo tar -xzf "$backup_file" -C / \ --numeric-owner \ --preserve-permissions \ --checkpoint=1000 \ --checkpoint-action=dot # 修复权限 log "修复文件权限..." sudo chown -R www-data:www-data /var/www/ sudo chown -R zhaoxiongzhou:zhaoxiongzhou /home/zhaoxiongzhou/ return 0 } # 恢复服务配置 restore_configurations() { log "恢复服务配置..." # 重新加载系统配置 sudo systemctl daemon-reload sudo sysctl --system # 重新配置网络 sudo systemctl restart networking # 恢复防火墙规则 sudo iptables-restore < /etc/iptables/rules.v4 return 0 } # 验证恢复 verify_restore() { log "验证系统恢复..." local status=0 # 检查关键文件 for file in "/etc/nginx/nginx.conf" "/etc/systemd/system/llama-server.service"; do if [ ! -f "$file" ]; then log "错误: 未找到关键文件 $file" status=1 fi done # 启动服务 sudo systemctl start nginx ~/projects/llama.cpp/start-llama.sh # 验证服务状态 sleep 10 if ! systemctl is-active --quiet nginx; then log "错误: Nginx 服务未能正常启动" status=1 fi if ! pgrep -f llama-server > /dev/null; then log "错误: AI 服务未能正常启动" status=1 fi return $status } # 清理恢复环境 cleanup() { log "清理恢复环境..." # 删除临时文件 rm -rf "$TEMP_DIR" # 清理日志 find /var/log -type f -name "*.gz" -delete return 0 } # 主函数 main() { local backup_file # 列出可用备份 echo "可用的备份文件:" ls -lh "$BACKUP_DIR"/full_backup_*.tar.gz # 选择备份文件 read -p "请输入要恢复的备份文件完整路径: " backup_file # 验证备份 if ! verify_backup "$backup_file"; then log "备份验证失败，终止恢复" return 1 fi # 准备环境 if ! prepare_environment; then log "环境准备失败，终止恢复" return 1 fi # 执行恢复 if perform_restore "$backup_file" && \ restore_configurations && \ verify_restore; then log "系统恢复成功完成" ~/send_notification.sh "系统恢复成功完成" "normal" else log "系统恢复失败" ~/send_notification.sh "系统恢复失败，需要手动检查" "high" fi # 清理环境 cleanup } # 执行恢复 main 三十三、系统迁移工具 1. 系统迁移脚本 # 创建系统迁移脚本 nano ~/system_migration.sh #!/bin/bash # ~/system_migration.sh # 配置 SOURCE_HOST="old-raspberry.local" TARGET_HOST="new-raspberry.local" MIGRATION_DIR="/mnt/migration" LOG_FILE="/var/log/migration.log" SSH_KEY="~/.ssh/migration_key" RSYNC_OPTS="-avz --progress --delete" # 日志函数 log() { echo "[$(date &#39;+%Y-%m-%d %H:%M:%S&#39;)] $1" | tee -a "$LOG_FILE" } # 检查迁移环境 check_migration_env() { log "检查迁移环境..." # 检查 SSH 密钥 if [ ! -f "$SSH_KEY" ]; then log "生成 SSH 密钥..." ssh-keygen -t ed25519 -f "$SSH_KEY" -N "" # 复制密钥到目标主机 ssh-copy-id -i "$SSH_KEY" "zhaoxiongzhou@$TARGET_HOST" fi # 检查必要工具 for tool in rsync ssh scp; do if ! command -v $tool &>/dev/null; then log "错误: 未找到必要工具 $tool" return 1 fi done # 检查目标主机连接 if ! ssh -i "$SSH_KEY" "zhaoxiongzhou@$TARGET_HOST" "echo &#39;Connection test&#39;" &>/dev/null; then log "错误: 无法连接到目标主机" return 1 fi return 0 } # 迁移配置文件 migrate_configs() { log "迁移配置文件..." # 创建配置目录 ssh -i "$SSH_KEY" "zhaoxiongzhou@$TARGET_HOST" "mkdir -p ~/configs_backup" # 迁移 Nginx 配置 rsync $RSYNC_OPTS -e "ssh -i $SSH_KEY" \ /etc/nginx/ \ "zhaoxiongzhou@$TARGET_HOST:~/configs_backup/nginx/" # 迁移系统配置 rsync $RSYNC_OPTS -e "ssh -i $SSH_KEY" \ /etc/sysctl.d/ \ "zhaoxiongzhou@$TARGET_HOST:~/configs_backup/sysctl/" # 迁移服务配置 rsync $RSYNC_OPTS -e "ssh -i $SSH_KEY" \ /etc/systemd/system/ \ "zhaoxiongzhou@$TARGET_HOST:~/configs_backup/systemd/" } # 迁移数据 migrate_data() { log "迁移数据..." # 迁移博客数据 rsync $RSYNC_OPTS -e "ssh -i $SSH_KEY" \ ~/myblog/ \ "zhaoxiongzhou@$TARGET_HOST:~/myblog/" # 迁移 AI 服务数据 rsync $RSYNC_OPTS -e "ssh -i $SSH_KEY" \ ~/projects/llama.cpp/ \ "zhaoxiongzhou@$TARGET_HOST:~/projects/llama.cpp/" # 迁移用户脚本 rsync $RSYNC_OPTS -e "ssh -i $SSH_KEY" \ ~/*.sh \ "zhaoxiongzhou@$TARGET_HOST:~/" } # 迁移数据库 migrate_database() { log "迁移数据库..." # 导出数据库 local dump_file="/tmp/database_dump.sql" if [ -f "/var/lib/mysql" ]; then mysqldump --all-databases > "$dump_file" # 传输到目标主机 scp -i "$SSH_KEY" "$dump_file" "zhaoxiongzhou@$TARGET_HOST:/tmp/" # 在目标主机导入数据库 ssh -i "$SSH_KEY" "zhaoxiongzhou@$TARGET_HOST" \ "mysql < /tmp/database_dump.sql" fi } # 配置目标系统 configure_target() { log "配置目标系统..." ssh -i "$SSH_KEY" "zhaoxiongzhou@$TARGET_HOST" "bash -s" << &#39;EOF&#39; # 安装必要软件 sudo apt update sudo apt install -y nginx mysql-server python3 pip # 恢复配置 sudo cp -r ~/configs_backup/nginx/* /etc/nginx/ sudo cp -r ~/configs_backup/sysctl/* /etc/sysctl.d/ sudo cp -r ~/configs_backup/systemd/* /etc/systemd/system/ # 设置权限 sudo chown -R www-data:www-data /var/www/ sudo chmod +x ~/*.sh # 重启服务 sudo systemctl daemon-reload sudo systemctl restart nginx EOF } # 验证迁移 verify_migration() { log "验证迁移..." local status=0 # 检查服务状态 ssh -i "$SSH_KEY" "zhaoxiongzhou@$TARGET_HOST" "bash -s" << &#39;EOF&#39; # 检查 Nginx if ! systemctl is-active --quiet nginx; then echo "错误: Nginx 服务未运行" exit 1 fi # 检查文件 for dir in "~/myblog" "~/projects/llama.cpp"; do if [ ! -d "$dir" ]; then echo "错误: 目录 $dir 不存在" exit 1 fi done # 检查配置 if ! nginx -t &>/dev/null; then echo "错误: Nginx 配置无效" exit 1 fi EOF status=$? return $status } # 主函数 main() { log "开始系统迁移..." # 检查环境 if ! check_migration_env; then log "迁移环境检查失败" return 1 fi # 执行迁移 migrate_configs migrate_data migrate_database configure_target # 验证迁移 if verify_migration; then log "系统迁移成功完成" ~/send_notification.sh "系统迁移成功完成" "normal" else log "系统迁移失败" ~/send_notification.sh "系统迁移失败，需要手动检查" "high" fi } # 执行迁移 main 三十四、日志分析工具 1. 日志分析脚本 # 创建日志分析脚本 nano ~/log_analyzer.sh #!/bin/bash # ~/log_analyzer.sh # 配置 LOG_DIRS=( "/var/log" "/var/log/nginx" "/home/zhaoxiongzhou/logs" ) REPORT_DIR="/home/zhaoxiongzhou/log_reports" LOG_FILE="/var/log/analyzer.log" ALERT_THRESHOLD=100 # 错误日志阈值 RETENTION_DAYS=30 # 报告保留天数 # 确保目录存在 mkdir -p "$REPORT_DIR" # 日志函数 log() { echo "[$(date &#39;+%Y-%m-%d %H:%M:%S&#39;)] $1" | tee -a "$LOG_FILE" } # 分析系统日志 analyze_system_logs() { log "分析系统日志..." local report_file="$REPORT_DIR/system_log_report_$(date +%Y%m%d).md" { echo "# 系统日志分析报告" echo "## 生成时间: $(date &#39;+%Y-%m-%d %H:%M:%S&#39;)" echo echo "## 系统错误统计" echo "### 严重错误" echo &#39;```&#39; grep -i "error\|critical\|emergency" /var/log/syslog | \ tail -n 50 | sort | uniq -c | sort -nr echo &#39;```&#39; echo "### 认证失败" echo &#39;```&#39; grep "Failed password" /var/log/auth.log | \ awk &#39;{print $1,$2,$3,$11}&#39; | sort | uniq -c | sort -nr | head -n 10 echo &#39;```&#39; echo "### 系统重启记录" echo &#39;```&#39; last reboot | head -n 5 echo &#39;```&#39; } > "$report_file" } # 分析 Nginx 访问日志 analyze_nginx_logs() { log "分析 Nginx 访问日志..." local report_file="$REPORT_DIR/nginx_log_report_$(date +%Y%m%d).md" { echo "# Nginx 访问日志分析报告" echo "## 生成时间: $(date &#39;+%Y-%m-%d %H:%M:%S&#39;)" echo echo "## 访问统计" echo "### 请求量最大的 IP" echo &#39;```&#39; awk &#39;{print $1}&#39; /var/log/nginx/access.log | sort | uniq -c | sort -nr | head -n 10 echo &#39;```&#39; echo "### 访问量最大的页面" echo &#39;```&#39; awk &#39;{print $7}&#39; /var/log/nginx/access.log | sort | uniq -c | sort -nr | head -n 10 echo &#39;```&#39; echo "### HTTP 状态码统计" echo &#39;```&#39; awk &#39;{print $9}&#39; /var/log/nginx/access.log | sort | uniq -c | sort -nr echo &#39;```&#39; echo "### 每小时请求量统计" echo &#39;```&#39; awk &#39;{print $4}&#39; /var/log/nginx/access.log | cut -c 14-15 | sort | uniq -c | \ awk &#39;{printf("%s:00 - %s 请求\n", $2, $1)}&#39; echo &#39;```&#39; } > "$report_file" } # 分析 AI 服务日志 analyze_ai_logs() { log "分析 AI 服务日志..." local report_file="$REPORT_DIR/ai_log_report_$(date +%Y%m%d).md" local ai_log="/home/zhaoxiongzhou/logs/llama.log" if [ -f "$ai_log" ]; then { echo "# AI 服务日志分析报告" echo "## 生成时间: $(date &#39;+%Y-%m-%d %H:%M:%S&#39;)" echo echo "## 服务统计" echo "### 错误统计" echo &#39;```&#39; grep -i "error" "$ai_log" | tail -n 20 echo &#39;```&#39; echo "### 性能统计" echo "#### 响应时间分布" echo &#39;```&#39; grep "response_time" "$ai_log" | \ awk &#39;{sum+=$NF; count++} END {print "平均响应时间:", sum/count, "ms"}&#39; echo &#39;```&#39; echo "#### 内存使用统计" echo &#39;```&#39; grep "memory_usage" "$ai_log" | tail -n 10 echo &#39;```&#39; } > "$report_file" fi } # 生成安全报告 generate_security_report() { log "生成安全报告..." local report_file="$REPORT_DIR/security_report_$(date +%Y%m%d).md" { echo "# 安全分析报告" echo "## 生成时间: $(date &#39;+%Y-%m-%d %H:%M:%S&#39;)" echo echo "## 安全事件统计" echo "### SSH 暴力破解尝试" echo &#39;```&#39; grep "Failed password" /var/log/auth.log | \ awk &#39;{print $11,$13}&#39; | sort | uniq -c | sort -nr | head -n 10 echo &#39;```&#39; echo "### 可疑 IP 访问" echo &#39;```&#39; grep -i "suspicious\|attack\|hack" /var/log/nginx/access.log | \ awk &#39;{print $1}&#39; | sort | uniq -c | sort -nr echo &#39;```&#39; echo "### 文件权限变更" echo &#39;```&#39; find /etc -mtime -1 -type f -ls echo &#39;```&#39; } > "$report_file" } # 清理旧报告 cleanup_old_reports() { log "清理旧报告..." find "$REPORT_DIR" -type f -name "*.md" -mtime +$RETENTION_DAYS -delete } # 生成摘要报告 generate_summary() { log "生成摘要报告..." local summary_file="$REPORT_DIR/summary_$(date +%Y%m%d).md" { echo "# 日志分析摘要报告" echo "## 生成时间: $(date &#39;+%Y-%m-%d %H:%M:%S&#39;)" echo echo "## 关键指标" # 错误统计 local error_count=$(grep -i "error" /var/log/syslog | wc -l) local nginx_error_count=$(grep -i "error" /var/log/nginx/error.log | wc -l) echo "- 系统错误数: $error_count" echo "- Nginx 错误数: $nginx_error_count" # 安全事件 local ssh_fails=$(grep "Failed password" /var/log/auth.log | wc -l) echo "- SSH 失败尝试: $ssh_fails" # 告警判断 if [ $error_count -gt $ALERT_THRESHOLD ]; then ~/send_notification.sh "警告: 系统错误数超过阈值" "high" fi } > "$summary_file" } # 主函数 main() { log "开始日志分析..." # 执行分析 analyze_system_logs analyze_nginx_logs analyze_ai_logs generate_security_report generate_summary # 清理旧报告 cleanup_old_reports log "日志分析完成" } # 执行分析 main 三十五、系统优化工具 1. 系统优化脚本 # 创建系统优化脚本 nano ~/system_optimize.sh #!/bin/bash # ~/system_optimize.sh # 配置 LOG_FILE="/var/log/optimize.log" NGINX_CONF="/etc/nginx/nginx.conf" SYSCTL_CONF="/etc/sysctl.d/99-custom.conf" JOURNAL_CONF="/etc/systemd/journald.conf" # 日志函数 log() { echo "[$(date &#39;+%Y-%m-%d %H:%M:%S&#39;)] $1" | tee -a "$LOG_FILE" } # 优化系统参数 optimize_system() { log "优化系统参数..." # 备份原始配置 cp "$SYSCTL_CONF" "${SYSCTL_CONF}.backup" # 配置系统参数 cat > "$SYSCTL_CONF" << EOF # 网络优化 net.core.somaxconn = 2048 net.core.netdev_max_backlog = 4096 net.ipv4.tcp_max_syn_backlog = 4096 net.ipv4.tcp_fin_timeout = 30 net.ipv4.tcp_keepalive_time = 1200 net.ipv4.tcp_max_tw_buckets = 5000 net.ipv4.tcp_fastopen = 3 net.ipv4.tcp_rmem = 4096 87380 16777216 net.ipv4.tcp_wmem = 4096 65536 16777216 # 文件系统优化 fs.file-max = 100000 fs.inotify.max_user_watches = 524288 # 内存优化 vm.swappiness = 10 vm.dirty_ratio = 60 vm.dirty_background_ratio = 2 EOF # 应用系统参数 sysctl -p "$SYSCTL_CONF" } # 优化 Nginx 配置 optimize_nginx() { log "优化 Nginx 配置..." # 备份原始配置 cp "$NGINX_CONF" "${NGINX_CONF}.backup" # 配置 Nginx cat > "$NGINX_CONF" << EOF user www-data; worker_processes auto; worker_rlimit_nofile 100000; events { worker_connections 2048; multi_accept on; use epoll; } http { # 基础设置 sendfile on; tcp_nopush on; tcp_nodelay on; keepalive_timeout 65; types_hash_max_size 2048; server_tokens off; # MIME 类型 include /etc/nginx/mime.types; default_type application/octet-stream; # 日志格式 log_format main &#39;\$remote_addr - \$remote_user [\$time_local] "\$request" &#39; &#39;\$status \$body_bytes_sent "\$http_referer" &#39; &#39;"\$http_user_agent" "\$http_x_forwarded_for"&#39;; # 缓冲区设置 client_body_buffer_size 128k; client_max_body_size 10m; client_header_buffer_size 1k; large_client_header_buffers 4 4k; # Gzip 压缩 gzip on; gzip_vary on; gzip_proxied any; gzip_comp_level 6; gzip_types text/plain text/css application/json application/javascript text/xml application/xml application/xml+rss text/javascript; # SSL 优化 ssl_protocols TLSv1.2 TLSv1.3; ssl_prefer_server_ciphers on; ssl_session_cache shared:SSL:10m; ssl_session_timeout 10m; # 包含其他配置 include /etc/nginx/conf.d/*.conf; include /etc/nginx/sites-enabled/*; } EOF # 测试配置 nginx -t && systemctl restart nginx } # 优化系统服务 optimize_services() { log "优化系统服务..." # 禁用不必要的服务 local unnecessary_services=( "bluetooth" "cups" "avahi-daemon" ) for service in "${unnecessary_services[@]}"; do if systemctl is-active --quiet "$service"; then systemctl stop "$service" systemctl disable "$service" log "已禁用服务: $service" fi done # 优化日志服务 cat > "$JOURNAL_CONF" << EOF [Journal] SystemMaxUse=100M SystemMaxFileSize=10M RuntimeMaxUse=50M RuntimeMaxFileSize=5M EOF # 重启日志服务 systemctl restart systemd-journald } # 优化文件系统 optimize_filesystem() { log "优化文件系统..." # 清理临时文件 find /tmp -type f -atime +10 -delete find /var/tmp -type f -atime +10 -delete # 清理日志 find /var/log -type f -name "*.gz" -delete find /var/log -type f -name "*.old" -delete # 优化日志轮转 cat > /etc/logrotate.d/custom << EOF /var/log/custom/*.log { daily rotate 7 compress delaycompress missingok notifempty create 640 root adm } EOF } # 优化内存使用 optimize_memory() { log "优化内存使用..." # 清理缓存 sync; echo 3 > /proc/sys/vm/drop_caches # 配置 swap 使用 if [ -f /swapfile ]; then swapoff /swapfile dd if=/dev/zero of=/swapfile bs=1M count=2048 chmod 600 /swapfile mkswap /swapfile swapon /swapfile fi } # 验证优化 verify_optimization() { log "验证系统优化..." local status=0 # 检查系统负载 local load=$(uptime | awk -F&#39;load average:&#39; &#39;{print $2}&#39; | cut -d, -f1) if [ $(echo "$load > 2" | bc -l) -eq 1 ]; then log "警告: 系统负载较高 ($load)" status=1 fi # 检查内存使用 local mem_usage=$(free | grep Mem | awk &#39;{print $3/$2 * 100.0}&#39;) if [ $(echo "$mem_usage > 90" | bc -l) -eq 1 ]; then log "警告: 内存使用率过高 ($mem_usage%)" status=1 fi # 检查服务状态 if ! systemctl is-active --quiet nginx; then log "错误: Nginx 服务未正常运行" status=1 fi return $status } # 主函数 main() { log "开始系统优化..." optimize_system optimize_nginx optimize_services optimize_filesystem optimize_memory if verify_optimization; then log "系统优化成功完成" ~/send_notification.sh "系统优化已完成" "normal" else log "系统优化完成，但存在警告" ~/send_notification.sh "系统优化完成，但需要检查" "high" fi } # 执行优化 main 三十六、部署后检查清单 1. 部署检查脚本 # 创建部署检查脚本 nano ~/deployment_checklist.sh #!/bin/bash # ~/deployment_checklist.sh # 配置 LOG_FILE="/var/log/deployment_check.log" REPORT_FILE="/home/zhaoxiongzhou/deployment_report.md" CHECK_INTERVAL=300 # 检查间隔（秒） # 日志函数 log() { echo "[$(date &#39;+%Y-%m-%d %H:%M:%S&#39;)] $1" | tee -a "$LOG_FILE" } # 检查系统基础配置 check_system_basics() { log "检查系统基础配置..." local status=0 { echo "## 系统基础检查" echo "### 系统信息" echo "- 主机名: $(hostname)" echo "- 系统版本: $(cat /etc/os-release | grep PRETTY_NAME)" echo "- 内核版本: $(uname -r)" echo "- 运行时间: $(uptime -p)" echo echo "### 资源使用" echo "- CPU 使用率: $(top -bn1 | grep "Cpu(s)" | awk &#39;{print $2}&#39;)%" echo "- 内存使用率: $(free | grep Mem | awk &#39;{print $3/$2 * 100.0}&#39;)%" echo "- 磁盘使用率: $(df -h / | awk &#39;NR==2 {print $5}&#39;)" echo } > "$REPORT_FILE" return $status } # 检查网络配置 check_network() { log "检查网络配置..." local status=0 { echo "### 网络配置" echo "#### IP 配置" echo &#39;```&#39; ip addr show echo &#39;```&#39; echo "#### 路由表" echo &#39;```&#39; ip route echo &#39;```&#39; echo "#### 开放端口" echo &#39;```&#39; netstat -tuln echo &#39;```&#39; echo "#### DNS 配置" echo &#39;```&#39; cat /etc/resolv.conf echo &#39;```&#39; } >> "$REPORT_FILE" return $status } # 检查服务配置 check_services() { log "检查服务配置..." local status=0 { echo "### 服务状态" echo "#### Nginx 配置" echo &#39;```&#39; nginx -T echo &#39;```&#39; echo "#### 服务运行状态" echo &#39;```&#39; systemctl status nginx systemctl status mysql ps aux | grep llama-server echo &#39;```&#39; echo "#### 服务日志检查" echo &#39;```&#39; tail -n 20 /var/log/nginx/error.log echo &#39;```&#39; } >> "$REPORT_FILE" return $status } # 检查安全配置 check_security() { log "检查安全配置..." local status=0 { echo "### 安全检查" echo "#### 防火墙规则" echo &#39;```&#39; sudo iptables -L echo &#39;```&#39; echo "#### SSH 配置" echo &#39;```&#39; grep -v &#39;^#&#39; /etc/ssh/sshd_config echo &#39;```&#39; echo "#### 用户权限" echo &#39;```&#39; ls -la /home/zhaoxiongzhou/ ls -la /var/www/ echo &#39;```&#39; echo "#### SSL 证书" echo &#39;```&#39; openssl x509 -in /etc/nginx/ssl/server.crt -text -noout echo &#39;```&#39; } >> "$REPORT_FILE" return $status } # 检查备份配置 check_backups() { log "检查备份配置..." local status=0 { echo "### 备份检查" echo "#### 备份配置" echo &#39;```&#39; ls -lh /mnt/backup_drive/system_backups/ echo &#39;```&#39; echo "#### 最近备份状态" echo &#39;```&#39; tail -n 20 /var/log/backup.log echo &#39;```&#39; } >> "$REPORT_FILE" return $status } # 检查监控配置 check_monitoring() { log "检查监控配置..." local status=0 { echo "### 监控检查" echo "#### 监控脚本状态" echo &#39;```&#39; ps aux | grep monitor echo &#39;```&#39; echo "#### 告警配置" echo &#39;```&#39; cat ~/send_notification.sh echo &#39;```&#39; } >> "$REPORT_FILE" return $status } # 生成总结报告 generate_summary() { log "生成总结报告..." { echo "## 部署检查总结" echo "### 检查时间: $(date &#39;+%Y-%m-%d %H:%M:%S&#39;)" echo echo "### 主要发现" echo "1. 系统状态: $([ $system_status -eq 0 ] && echo &#39;正常 ✅&#39; || echo &#39;异常 ❌&#39;)" echo "2. 网络配置: $([ $network_status -eq 0 ] && echo &#39;正常 ✅&#39; || echo &#39;异常 ❌&#39;)" echo "3. 服务状态: $([ $services_status -eq 0 ] && echo &#39;正常 ✅&#39; || echo &#39;异常 ❌&#39;)" echo "4. 安全配置: $([ $security_status -eq 0 ] && echo &#39;正常 ✅&#39; || echo &#39;异常 ❌&#39;)" echo "5. 备份状态: $([ $backup_status -eq 0 ] && echo &#39;正常 ✅&#39; || echo &#39;异常 ❌&#39;)" echo "6. 监控状态: $([ $monitoring_status -eq 0 ] && echo &#39;正常 ✅&#39; || echo &#39;异常 ❌&#39;)" echo echo "### 建议操作" [ $system_status -ne 0 ] && echo "- 检查系统资源使用情况" [ $network_status -ne 0 ] && echo "- 验证网络配置" [ $services_status -ne 0 ] && echo "- 检查服务运行状态" [ $security_status -ne 0 ] && echo "- 审查安全配置" [ $backup_status -ne 0 ] && echo "- 确认备份是否正常" [ $monitoring_status -ne 0 ] && echo "- 检查监控系统" } >> "$REPORT_FILE" } # 主函数 main() { log "开始部署后检查..." # 执行检查 check_system_basics system_status=$? check_network network_status=$? check_services services_status=$? check_security security_status=$? check_backups backup_status=$? check_monitoring monitoring_status=$? # 生成总结 generate_summary # 发送通知 if [ $system_status -eq 0 ] && [ $network_status -eq 0 ] && \ [ $services_status -eq 0 ] && [ $security_status -eq 0 ] && \ [ $backup_status -eq 0 ] && [ $monitoring_status -eq 0 ]; then ~/send_notification.sh "部署检查完成：所有项目正常" "normal" else ~/send_notification.sh "部署检查完成：存在需要关注的项目" "high" fi log "部署检查完成，报告已生成: $REPORT_FILE" } # 执行检查 main 《树莓派服务部署与维护完整指南》总共包含了 36 个部分，涵盖了从系统部署到维护的各个方面。每个脚本都经过精心设计，可以独立运行，也可以互相配合使用。
'><meta name=keywords content="RaspberryPi,Hugo,教程"><meta name=generator content="Hugo 0.139.3"><meta property="og:url" content="http://10.10.164.61/posts/guide/%E6%A0%91%E8%8E%93%E6%B4%BE%E6%9C%8D%E5%8A%A1%E9%83%A8%E7%BD%B2%E4%B8%8E%E7%BB%B4%E6%8A%A4%E5%AE%8C%E6%95%B4%E6%8C%87%E5%8D%97/"><meta property="og:site_name" content="赵雄州的博客"><meta property="og:title" content="树莓派服务部署与维护完整指南"><meta property="og:description" content='树莓派服务部署与维护完整指南 一、系统概况 1. 硬件资源 处理器: ARM64 架构 总内存: 3.7GB 可用内存: ~2.5GB Swap: 512MB 网络: wlan0 (IP: 10.40.110.47) 2. 服务概览 AI 智能助手 端口: 8080 基于: llama.cpp 模型: Phi-3-mini-4k-instruct-q4.gguf 资源占用: CPU: ~300% (多核) 内存: ~3GB Swap: 511Mi 个人博客 端口: 80 框架: Hugo v0.139.3-extended 主题: Ananke Web服务器: Nginx 资源占用: 轻量级 3. 服务访问 AI 助手: http://10.40.110.47:8080 博客开发: http://10.40.110.47:1313 博客正式: http://10.40.110.47 二、AI 智能助手部署 1. 环境准备 # 更新系统 sudo apt update sudo apt upgrade -y # 安装依赖 sudo apt install build-essential git cmake 2. 编译安装 # 克隆仓库 git clone https://github.com/ggerganov/llama.cpp.git cd llama.cpp # 编译 make clean LLAMA_METAL=1 make -j4 3. 模型配置 # 创建模型目录 mkdir models cd models # 下载模型文件 wget [模型下载地址]/Phi-3-mini-4k-instruct-q4.gguf # 验证模型文件 sha256sum Phi-3-mini-4k-instruct-q4.gguf 4. 服务配置 # 创建启动脚本 nano ~/projects/llama.cpp/start-llama.sh #!/bin/bash cd ~/projects/llama.cpp nohup ./llama-server \ -m models/Phi-3-mini-4k-instruct-q4.gguf \ --host 0.0.0.0 \ --port 8080 \ --ctx-size 2048 \ --threads 2 \ --batch-size 256 \ > llama.log 2>&amp;1 & # 设置执行权限 chmod +x start-llama.sh # 启动服务 ./start-llama.sh # 验证服务状态 ps aux | grep llama-server netstat -tuln | grep 8080 三、个人博客部署 1. Hugo 安装 # 下载 Hugo Extended 版本 wget https://github.com/gohugoio/hugo/releases/download/v0.139.3/hugo_extended_0.139.3_linux-arm64.deb # 安装 sudo dpkg -i hugo_extended_0.139.3_linux-arm64.deb # 验证安装 hugo version 2. 博客初始化 # 创建站点 cd ~ hugo new site myblog cd myblog # 初始化 Git git init # 添加主题 git submodule add https://github.com/theNewDynamic/gohugo-theme-ananke.git themes/ananke 3. 博客配置 # 编辑配置文件 nano config.toml baseURL = "http://10.40.110.47/" languageCode = "zh-cn" title = "My Blog" theme = "ananke" [params] author = "Your Name" description = "Welcome to my blog" dateFormat = "2006-01-02" background_color_class = "bg-black" recent_posts_number = 3 mainSections = ["posts"] featured_image = false [menu] [[menu.main]] identifier = "posts" name = "文章" url = "/posts/" weight = 1 [[menu.main]] identifier = "about" name = "关于" url = "/about/" weight = 2 4. Nginx 配置 # 安装 Nginx sudo apt install nginx # 创建配置文件 sudo nano /etc/nginx/sites-available/myblog server { listen 80; server_name 10.40.110.47; root /home/zhaoxiongzhou/myblog/public; index index.html; location / { try_files $uri $uri/ =404; } access_log /var/log/nginx/myblog_access.log; error_log /var/log/nginx/myblog_error.log; } # 启用配置 sudo ln -s /etc/nginx/sites-available/myblog /etc/nginx/sites-enabled/ sudo rm /etc/nginx/sites-enabled/default # 测试配置 sudo nginx -t # 重启 Nginx sudo systemctl restart nginx 四、权限与自动化配置 1. 权限设置 # 设置目录权限 sudo chmod 755 /home/zhaoxiongzhou sudo chmod -R 755 /home/zhaoxiongzhou/myblog # 设置文件所有权 sudo chown -R www-data:www-data /home/zhaoxiongzhou/myblog/public # 验证权限 ls -la ~/myblog/public ls -la /home/zhaoxiongzhou 2. 自动部署脚本 # 创建博客部署脚本 nano ~/deploy-blog.sh #!/bin/bash cd ~/myblog hugo sudo chown -R www-data:www-data public/ sudo systemctl restart nginx # 设置执行权限 chmod +x ~/deploy-blog.sh 3. 备份脚本 # 创建备份脚本 nano ~/backup-blog.sh #!/bin/bash BACKUP_DIR="/home/zhaoxiongzhou/backups" DATE=$(date +%Y%m%d) # 创建备份目录 mkdir -p $BACKUP_DIR # 备份博客内容 tar -czf $BACKUP_DIR/blog_$DATE.tar.gz ~/myblog/content # 备份配置文件 cp ~/myblog/config.toml $BACKUP_DIR/config_$DATE.toml # 删除30天前的备份 find $BACKUP_DIR -name "*.tar.gz" -mtime +30 -delete # 设置执行权限 chmod +x ~/backup-blog.sh # 配置定时任务 crontab -e # 添加定时任务（每周日凌晨2点执行备份） 0 2 * * 0 /home/zhaoxiongzhou/backup-blog.sh 五、系统维护与监控 1. 资源监控命令 # 系统资源监控 htop top free -h vmstat 1 # 磁盘使用监控 df -h du -sh /* du -sh ~/myblog du -sh ~/projects/llama.cpp # 温度监控 vcgencmd measure_temp 2. 性能优化 # 清理系统缓存 sudo sync; echo 3 | sudo tee /proc/sys/vm/drop_caches # 调整 Swap 设置 cat /proc/sys/vm/swappiness sudo sysctl vm.swappiness=60 # CPU 频率调整 sudo nano /boot/config.txt # CPU 配置参数 arm_freq=1800 over_voltage=6 temp_limit=75 3. 系统维护 # 系统更新 sudo apt update sudo apt upgrade -y sudo apt autoremove sudo apt clean # 日志清理 sudo find /var/log -type f -name "*.log" -mtime +30 -delete sudo find /var/log -type f -name "*.gz" -delete # 服务状态检查 systemctl status nginx ps aux | grep llama-server 六、安全配置 1. 防火墙设置 # 安装 UFW sudo apt install ufw # 配置基本规则 sudo ufw default deny incoming sudo ufw default allow outgoing sudo ufw allow 22 sudo ufw allow 80 sudo ufw allow 8080 # 启用防火墙 sudo ufw enable # 检查状态 sudo ufw status 2. Nginx 访问控制 # 安装认证工具 sudo apt install apache2-utils # 创建用户密码 sudo htpasswd -c /etc/nginx/.htpasswd username # 修改 Nginx 配置 sudo nano /etc/nginx/sites-available/myblog server { listen 80; server_name 10.40.110.47; root /home/zhaoxiongzhou/myblog/public; index index.html; # 添加基本认证 location / { auth_basic "Restricted Access"; auth_basic_user_file /etc/nginx/.htpasswd; try_files $uri $uri/ =404; } # 日志配置 access_log /var/log/nginx/myblog_access.log; error_log /var/log/nginx/myblog_error.log; } 3. 日志监控 # 安装日志监控工具 sudo apt install logwatch # 配置日志监控 sudo nano /etc/logwatch/conf/logwatch.conf # 配置每日日志检查 Output = mail Format = html MailTo = your-email@domain.com Detail = High 七、故障排除指南 内存相关问题 # 检查内存状态 free -h ps aux --sort=-%mem | head # 如果内存不足，调整服务参数 nano ~/projects/llama.cpp/start-llama.sh # 降低资源使用的参数示例 --ctx-size 1024 \ --batch-size 128 \ --threads 1 服务无响应 # 检查进程 ps aux | grep llama-server # 检查端口 netstat -tuln | grep 8080 # 重启服务 pkill llama-server ./start-llama.sh # 检查日志 tail -f ~/projects/llama.cpp/llama.log 2. 博客服务故障排除 Nginx 问题 # 检查配置语法 sudo nginx -t # 检查日志 sudo tail -f /var/log/nginx/error.log sudo tail -f /var/log/nginx/myblog_error.log # 检查服务状态 sudo systemctl status nginx # 重启服务 sudo systemctl restart nginx Hugo 生成问题 # 清理缓存 rm -rf ~/myblog/public rm -rf ~/myblog/resources # 更新主题 git submodule update --init --recursive # 重新生成（详细模式） hugo --verbose 八、系统级故障排除 1. 磁盘问题 # 检查磁盘使用情况 df -h du -sh /* # 查找大文件 sudo find / -type f -size +100M # 清理空间 sudo apt clean sudo apt autoremove sudo journalctl --vacuum-time=7d 2. 网络问题 # 网络状态检查 ip addr show ping -c 4 8.8.8.8 netstat -tuln # DNS 检查 cat /etc/resolv.conf nslookup google.com # 重启网络服务 sudo systemctl restart networking sudo systemctl restart wpa_supplicant 3. 性能问题 # CPU 温度监控 vcgencmd measure_temp watch -n 1 vcgencmd measure_temp # CPU 频率检查 vcgencmd measure_clock arm cat /sys/devices/system/cpu/cpu0/cpufreq/scaling_cur_freq # 系统负载检查 uptime cat /proc/loadavg 九、维护最佳实践 1. 日常维护清单 检查系统日志 监控资源使用 验证服务状态 检查备份状态 更新系统安全补丁 2. 周期性维护任务 清理旧日志和临时文件 验证备份完整性 检查系统更新 检查服务性能 更新文档和配置说明 3. 应急预案 保存所有配置文件的备份 记录所有服务的配置步骤 维护问题解决方案文档 建立服务恢复流程 保持重要数据的多份备份 十、性能优化建议 1. 系统级优化 # 1. 调整 SWAP 设置 sudo nano /etc/sysctl.conf # 添加或修改以下参数 vm.swappiness=60 vm.vfs_cache_pressure=50 vm.dirty_background_ratio=5 vm.dirty_ratio=10 # 2. 优化文件系统 # 检查并优化文件系统 sudo tune2fs -o journal_data_writeback /dev/mmcblk0p2 # 3. 调整 CPU 性能 sudo nano /boot/config.txt # 添加以下配置 arm_freq=1800 over_voltage=6 gpu_freq=500 dtparam=audio=on 2. 服务优化 AI 服务优化 # 调整服务参数 nano ~/projects/llama.cpp/start-llama.sh # 优化参数示例 --ctx-size 2048 \ --threads 2 \ --batch-size 256 \ --keep-context \ --mlock \ --numa Nginx 优化 sudo nano /etc/nginx/nginx.conf worker_processes auto; worker_rlimit_nofile 65535; events { worker_connections 1024; multi_accept on; use epoll; } http { sendfile on; tcp_nopush on; tcp_nodelay on; keepalive_timeout 65; types_hash_max_size 2048; server_tokens off; # 缓存设置 open_file_cache max=1000 inactive=20s; open_file_cache_valid 30s; open_file_cache_min_uses 2; open_file_cache_errors on; } 十一、监控与报警系统 1. 系统监控配置 # 安装监控工具 sudo apt install prometheus node-exporter grafana # 配置 Prometheus sudo nano /etc/prometheus/prometheus.yml global: scrape_interval: 15s scrape_configs: - job_name: &#39;node&#39; static_configs: - targets: [&#39;localhost:9100&#39;] - job_name: &#39;nginx&#39; static_configs: - targets: [&#39;localhost:9113&#39;] 2. 自动报警脚本 # 创建监控脚本 nano ~/monitor.sh #!/bin/bash # 定义阈值 MAX_CPU_USAGE=90 MAX_MEM_USAGE=90 MAX_DISK_USAGE=90 MAX_TEMP=75 # 获取系统数据 CPU_USAGE=$(top -bn1 | grep "Cpu(s)" | awk &#39;{print $2}&#39; | cut -d. -f1) MEM_USAGE=$(free | grep Mem | awk &#39;{print $3/$2 * 100.0}&#39;) DISK_USAGE=$(df -h / | awk &#39;NR==2 {print $5}&#39; | cut -d% -f1) TEMP=$(vcgencmd measure_temp | cut -d= -f2 | cut -d. -f1) # 检查服务状态 check_services() { services=("nginx" "llama-server") for service in "${services[@]}"; do if ! pgrep -x "$service" > /dev/null; then echo "警告: $service 服务未运行!" # 可以添加重启服务的命令 fi done } # 发送警告 send_alert() { message="$1" # 这里可以添加发送邮件或其他通知的命令 echo "$message" >> /var/log/system_alerts.log } # 检查各项指标 if [ "$CPU_USAGE" -gt "$MAX_CPU_USAGE" ]; then send_alert "CPU 使用率过高: $CPU_USAGE%" fi if [ "${MEM_USAGE%.*}" -gt "$MAX_MEM_USAGE" ]; then send_alert "内存使用率过高: $MEM_USAGE%" fi if [ "$DISK_USAGE" -gt "$MAX_DISK_USAGE" ]; then send_alert "磁盘使用率过高: $DISK_USAGE%" fi if [ "$TEMP" -gt "$MAX_TEMP" ]; then send_alert "系统温度过高: $TEMP°C" fi # 检查服务状态 check_services # 设置执行权限 chmod +x ~/monitor.sh # 添加到 crontab crontab -e # 每5分钟执行一次监控 */5 * * * * /home/zhaoxiongzhou/monitor.sh 十二、数据备份与恢复 1. 完整备份方案 # 创建完整备份脚本 nano ~/full-backup.sh #!/bin/bash BACKUP_ROOT="/home/zhaoxiongzhou/backups" DATE=$(date +%Y%m%d_%H%M%S) BACKUP_DIR="$BACKUP_ROOT/$DATE" # 创建备份目录 mkdir -p "$BACKUP_DIR" # 备份博客内容 echo "备份博客内容..." tar -czf "$BACKUP_DIR/blog_content.tar.gz" ~/myblog/content tar -czf "$BACKUP_DIR/blog_config.tar.gz" ~/myblog/config.toml # 备份 AI 模型和配置 echo "备份 AI 服务..." tar -czf "$BACKUP_DIR/llama_models.tar.gz" ~/projects/llama.cpp/models tar -czf "$BACKUP_DIR/llama_config.tar.gz" ~/projects/llama.cpp/start-llama.sh # 备份 Nginx 配置 echo "备份 Nginx 配置..." sudo tar -czf "$BACKUP_DIR/nginx_config.tar.gz" /etc/nginx/sites-available/myblog # 备份系统配置 echo "备份系统配置..." sudo tar -czf "$BACKUP_DIR/system_config.tar.gz" /boot/config.txt /etc/fstab # 创建备份清单 echo "创建备份清单..." find "$BACKUP_DIR" -type f -exec sha256sum {} \; > "$BACKUP_DIR/checksum.txt" # 清理旧备份（保留最近7份） cd "$BACKUP_ROOT" ls -t | tail -n +8 | xargs -r rm -r echo "备份完成: $BACKUP_DIR" 2. 数据恢复流程 # 创建恢复脚本 nano ~/restore.sh #!/bin/bash if [ -z "$1" ]; then echo "使用方法: $0 <备份目录>" exit 1 fi BACKUP_DIR="$1" # 验证备份完整性 echo "验证备份完整性..." cd "$BACKUP_DIR" sha256sum -c checksum.txt || { echo "备份验证失败！" exit 1 } # 恢复博客内容 echo "恢复博客内容..." tar -xzf "$BACKUP_DIR/blog_content.tar.gz" -C ~/myblog/ tar -xzf "$BACKUP_DIR/blog_config.tar.gz" -C ~/myblog/ # 恢复 AI 服务 echo "恢复 AI 服务..." tar -xzf "$BACKUP_DIR/llama_models.tar.gz" -C ~/projects/llama.cpp/ tar -xzf "$BACKUP_DIR/llama_config.tar.gz" -C ~/projects/llama.cpp/ # 恢复 Nginx 配置 echo "恢复 Nginx 配置..." sudo tar -xzf "$BACKUP_DIR/nginx_config.tar.gz" -C /etc/nginx/sites-available/ # 恢复系统配置 echo "恢复系统配置..." sudo tar -xzf "$BACKUP_DIR/system_config.tar.gz" -C / # 重启服务 echo "重启服务..." sudo systemctl restart nginx pkill llama-server ~/projects/llama.cpp/start-llama.sh echo "恢复完成" 十三、服务升级指南 1. Hugo 博客升级 # 1. 备份当前版本 cd ~ tar -czf hugo_backup_$(date +%Y%m%d).tar.gz myblog/ # 2. 检查当前版本 hugo version # 3. 下载新版本 wget https://github.com/gohugoio/hugo/releases/download/v[新版本]/hugo_extended_[新版本]_linux-arm64.deb # 4. 安装新版本 sudo dpkg -i hugo_extended_[新版本]_linux-arm64.deb # 5. 更新主题 cd ~/myblog git submodule update --remote themes/ananke # 6. 测试生成 hugo --verbose # 7. 部署更新 ./deploy-blog.sh 2. AI 服务升级 # 1. 备份当前版本 cd ~/projects tar -czf llama_backup_$(date +%Y%m%d).tar.gz llama.cpp/ # 2. 更新源码 cd llama.cpp git pull origin master # 3. 重新编译 make clean LLAMA_METAL=1 make -j4 # 4. 测试新版本 ./llama-server -h # 5. 更新启动脚本 nano start-llama.sh 3. 系统升级 # 1. 更新软件包列表 sudo apt update # 2. 升级所有包 sudo apt upgrade -y # 3. 升级系统 sudo apt dist-upgrade -y # 4. 清理旧包 sudo apt autoremove -y sudo apt clean # 5. 检查启动项 sudo systemctl list-unit-files --state=enabled # 6. 更新树莓派固件 sudo rpi-update # 7. 检查系统状态 sudo systemctl --failed sudo journalctl -p 3 -xb 十四、安全加固指南 1. 系统安全配置 # 1. SSH 安全配置 sudo nano /etc/ssh/sshd_config # SSH 配置建议 Port 22222 # 修改默认端口 PermitRootLogin no # 禁止 root 登录 PasswordAuthentication no # 禁用密码认证 PubkeyAuthentication yes # 启用密钥认证 AllowUsers zhaoxiongzhou # 限制允许的用户 # 2. 设置防火墙规则 sudo apt install ufw fail2ban # 配置 UFW sudo ufw default deny incoming sudo ufw default allow outgoing sudo ufw allow 22222/tcp # SSH sudo ufw allow 80/tcp # HTTP sudo ufw allow 8080/tcp # AI 服务 sudo ufw enable # 配置 fail2ban sudo nano /etc/fail2ban/jail.local [sshd] enabled = true port = 22222 filter = sshd logpath = /var/log/auth.log maxretry = 3 bantime = 3600 2. 服务安全配置 Nginx 安全设置 # 1. 创建 SSL 证书 sudo openssl req -x509 -nodes -days 365 -newkey rsa:2048 \ -keyout /etc/nginx/ssl/nginx.key \ -out /etc/nginx/ssl/nginx.crt # 2. 配置 HTTPS sudo nano /etc/nginx/sites-available/myblog server { listen 443 ssl; server_name 10.40.110.47; ssl_certificate /etc/nginx/ssl/nginx.crt; ssl_certificate_key /etc/nginx/ssl/nginx.key; # SSL 配置 ssl_protocols TLSv1.2 TLSv1.3; ssl_prefer_server_ciphers on; ssl_ciphers ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256; # 安全头部 add_header X-Frame-Options "SAMEORIGIN"; add_header X-XSS-Protection "1; mode=block"; add_header X-Content-Type-Options "nosniff"; add_header Strict-Transport-Security "max-age=31536000"; # 其他配置... } 十五、性能监控与分析 1. 监控脚本配置 # 创建综合监控脚本 nano ~/system_monitor.sh #!/bin/bash LOG_FILE="/var/log/system_monitor.log" ALERT_FILE="/var/log/system_alerts.log" # 记录时间戳 timestamp() { date "+%Y-%m-%d %H:%M:%S" } # 系统资源监控 monitor_resources() { echo "=== 系统资源监控 $(timestamp) ===" >> "$LOG_FILE" # CPU 使用率 CPU_USAGE=$(top -bn1 | grep "Cpu(s)" | awk &#39;{print $2}&#39;) echo "CPU 使用率: $CPU_USAGE%" >> "$LOG_FILE" # 内存使用 free -h | grep "Mem:" >> "$LOG_FILE" # 磁盘使用 df -h / >> "$LOG_FILE" # 系统负载 uptime >> "$LOG_FILE" # CPU 温度 vcgencmd measure_temp >> "$LOG_FILE" } # 服务状态监控 monitor_services() { echo "=== 服务状态监控 $(timestamp) ===" >> "$LOG_FILE" # Nginx 状态 if systemctl is-active nginx >/dev/null 2>&amp;1; then echo "Nginx: 运行中" >> "$LOG_FILE" else echo "警告: Nginx 未运行!" >> "$ALERT_FILE" fi # AI 服务状态 if pgrep -f llama-server >/dev/null; then echo "AI 服务: 运行中" >> "$LOG_FILE" else echo "警告: AI 服务未运行!" >> "$ALERT_FILE" fi } # 网络监控 monitor_network() { echo "=== 网络监控 $(timestamp) ===" >> "$LOG_FILE" # 网络连接数 netstat -an | grep ESTABLISHED | wc -l >> "$LOG_FILE" # 网络流量 ifconfig wlan0 | grep bytes >> "$LOG_FILE" } # 主函数 main() { monitor_resources monitor_services monitor_network # 检查是否需要发送警告 if [ -s "$ALERT_FILE" ]; then # 可以添加发送警告的命令（如邮件通知） cat "$ALERT_FILE" fi } # 执行监控 main 2. 性能分析工具 # 安装性能分析工具 sudo apt install sysstat iotop htop # 创建性能数据收集脚本 nano ~/collect_performance.sh 十六、性能数据收集与分析 1. 性能数据收集脚本 #!/bin/bash # ~/collect_performance.sh PERF_DIR="/home/zhaoxiongzhou/performance_data" DATE=$(date +%Y%m%d_%H%M%S) # 创建数据目录 mkdir -p "$PERF_DIR/$DATE" # CPU 性能数据 mpstat 1 60 > "$PERF_DIR/$DATE/cpu_stats.log" & # 内存使用数据 vmstat 1 60 > "$PERF_DIR/$DATE/memory_stats.log" & # IO 性能数据 iostat -x 1 60 > "$PERF_DIR/$DATE/io_stats.log" & # 网络性能数据 sar -n DEV 1 60 > "$PERF_DIR/$DATE/network_stats.log" & # 进程性能数据 ps aux --sort=-%cpu | head -n 20 > "$PERF_DIR/$DATE/top_processes.log" # 系统负载数据 uptime > "$PERF_DIR/$DATE/load_average.log" # 等待所有后台进程完成 wait # 压缩数据 tar -czf "$PERF_DIR/performance_${DATE}.tar.gz" "$PERF_DIR/$DATE" rm -rf "$PERF_DIR/$DATE" 2. 性能数据分析脚本 # 创建分析脚本 nano ~/analyze_performance.sh #!/bin/bash # ~/analyze_performance.sh PERF_DIR="/home/zhaoxiongzhou/performance_data" REPORT_DIR="/home/zhaoxiongzhou/performance_reports" DATE=$(date +%Y%m%d) mkdir -p "$REPORT_DIR" generate_report() { local REPORT_FILE="$REPORT_DIR/report_${DATE}.txt" echo "性能分析报告 - $(date)" > "$REPORT_FILE" echo "===================" >> "$REPORT_FILE" # CPU 使用分析 echo -e "\nCPU 使用情况:" >> "$REPORT_FILE" awk &#39;/all/ {total += $3; count++} END {print "平均CPU使用率: " total/count "%"}&#39; \ "$PERF_DIR/latest/cpu_stats.log" >> "$REPORT_FILE" # 内存使用分析 echo -e "\n内存使用情况:" >> "$REPORT_FILE" free -h | grep "Mem:" >> "$REPORT_FILE" # IO 性能分析 echo -e "\nIO 性能:" >> "$REPORT_FILE" tail -n 10 "$PERF_DIR/latest/io_stats.log" >> "$REPORT_FILE" # 网络性能分析 echo -e "\n网络性能:" >> "$REPORT_FILE" tail -n 10 "$PERF_DIR/latest/network_stats.log" >> "$REPORT_FILE" # 进程分析 echo -e "\n资源占用最高的进程:" >> "$REPORT_FILE" head -n 5 "$PERF_DIR/latest/top_processes.log" >> "$REPORT_FILE" echo -e "\n分析完成。报告保存在: $REPORT_FILE" } # 生成报告 generate_report 十七、自动化运维脚本 1. 服务健康检查与自动恢复 # 创建服务监控脚本 nano ~/service_health_check.sh #!/bin/bash # ~/service_health_check.sh LOG_FILE="/var/log/service_health.log" ALERT_SCRIPT="/home/zhaoxiongzhou/send_alert.sh" log_message() { echo "[$(date &#39;+%Y-%m-%d %H:%M:%S&#39;)] $1" >> "$LOG_FILE" } check_and_restart_service() { local service_name="$1" local process_pattern="$2" if ! pgrep -f "$process_pattern" > /dev/null; then log_message "警告: $service_name 服务未运行，尝试重启" case "$service_name" in "nginx") sudo systemctl restart nginx ;; "llama-server") cd ~/projects/llama.cpp ./start-llama.sh ;; esac # 等待服务启动 sleep 10 # 验证服务是否成功重启 if pgrep -f "$process_pattern" > /dev/null; then log_message "$service_name 服务已成功重启" "$ALERT_SCRIPT" "$service_name 服务已自动重启" else log_message "错误: $service_name 服务重启失败" "$ALERT_SCRIPT" "警告: $service_name 服务重启失败，需要手动干预" fi else log_message "$service_name 服务运行正常" fi } # 检查各个服务 check_and_restart_service "nginx" "nginx" check_and_restart_service "llama-server" "llama-server" # 清理旧日志 find "$LOG_FILE" -mtime +30 -delete 2. 自动备份与清理 # 创建自动维护脚本 nano ~/auto_maintenance.sh #!/bin/bash # ~/auto_maintenance.sh BACKUP_DIR="/home/zhaoxiongzhou/backups" LOG_DIR="/var/log" DATE=$(date +%Y%m%d) # 创建备份 create_backups() { # 博客备份 tar -czf "$BACKUP_DIR/blog_$DATE.tar.gz" ~/myblog/content # AI 服务配置备份 tar -czf "$BACKUP_DIR/llama_config_$DATE.tar.gz" ~/projects/llama.cpp/start-llama.sh # Nginx 配置备份 sudo tar -czf "$BACKUP_DIR/nginx_config_$DATE.tar.gz" /etc/nginx/sites-available/ } # 清理旧文件 cleanup_old_files() { # 删除30天前的备份 find "$BACKUP_DIR" -name "*.tar.gz" -mtime +30 -delete # 清理日志 sudo find "$LOG_DIR" -name "*.log" -mtime +30 -delete sudo find "$LOG_DIR" -name "*.gz" -mtime +30 -delete # 清理系统临时文件 sudo rm -rf /tmp/* sudo rm -rf /var/tmp/* } # 主函数 main() { create_backups cleanup_old_files # 压缩日志 sudo logrotate -f /etc/logrotate.conf # 清理包缓存 sudo apt clean sudo apt autoremove -y } # 执行维护任务 main 十八、日志管理系统 1. 集中式日志配置 # 创建日志管理脚本 nano ~/log_management.sh #!/bin/bash # ~/log_management.sh LOG_BASE="/var/log/services" ARCHIVE_DIR="/home/zhaoxiongzhou/log_archives" DATE=$(date +%Y%m%d) # 创建日志目录 mkdir -p "$LOG_BASE"/{nginx,ai_service,system} mkdir -p "$ARCHIVE_DIR" # 配置日志轮转 sudo tee /etc/logrotate.d/custom_services << EOF $LOG_BASE/nginx/*.log { daily missingok rotate 14 compress delaycompress notifempty create 0640 www-data adm sharedscripts postrotate [ -f /var/run/nginx.pid ] && kill -USR1 \$(cat /var/run/nginx.pid) endscript } $LOG_BASE/ai_service/*.log { daily missingok rotate 14 compress delaycompress notifempty create 0640 zhaoxiongzhou adm } $LOG_BASE/system/*.log { daily missingok rotate 30 compress delaycompress notifempty create 0640 root adm } EOF # 日志分析函数 analyze_logs() { local log_file="$1" local output_file="$2" echo "=== 日志分析报告 $(date) ===" > "$output_file" # 错误统计 echo -e "\n错误统计:" >> "$output_file" grep -i "error" "$log_file" | sort | uniq -c | sort -nr >> "$output_file" # 警告统计 echo -e "\n警告统计:" >> "$output_file" grep -i "warning" "$log_file" | sort | uniq -c | sort -nr >> "$output_file" # 访问统计（针对 Nginx 访问日志） if [[ "$log_file" == *"nginx/access"* ]]; then echo -e "\n访问量统计:" >> "$output_file" awk &#39;{print $1}&#39; "$log_file" | sort | uniq -c | sort -nr | head -n 10 >> "$output_file" fi } # 日志归档函数 archive_logs() { local source_dir="$1" local archive_name="logs_${DATE}.tar.gz" find "$source_dir" -name "*.log.*" -mtime +14 -exec tar -czf "$ARCHIVE_DIR/$archive_name" {} + find "$source_dir" -name "*.log.*" -mtime +14 -delete } 2. 日志监控告警 # 创建日志监控脚本 nano ~/log_monitor.sh #!/bin/bash # ~/log_monitor.sh ALERT_THRESHOLD=10 # 错误阈值 ALERT_SCRIPT="/home/zhaoxiongzhou/send_alert.sh" # 监控特定关键词 monitor_keywords() { local log_file="$1" local keywords=("error" "critical" "failed" "timeout" "exception") for keyword in "${keywords[@]}"; do count=$(grep -i "$keyword" "$log_file" | wc -l) if [ "$count" -gt "$ALERT_THRESHOLD" ]; then "$ALERT_SCRIPT" "警告: $log_file 中发现大量 $keyword ($count 次)" fi done } # 监控日志大小 check_log_size() { local log_file="$1" local max_size=$((100 * 1024 * 1024)) # 100MB size=$(stat -f%z "$log_file") if [ "$size" -gt "$max_size" ]; then "$ALERT_SCRIPT" "警告: $log_file 大小超过 100MB" fi } # 主监控循环 main() { while true; do for log_file in "$LOG_BASE"/**/*.log; do monitor_keywords "$log_file" check_log_size "$log_file" done sleep 300 # 每5分钟检查一次 done } main & 十九、系统优化与调优 1. 系统参数优化 # 创建系统优化脚本 nano ~/system_optimize.sh #!/bin/bash # ~/system_optimize.sh # 系统参数优化 optimize_sysctl() { sudo tee /etc/sysctl.d/99-custom.conf << EOF # 内存管理优化 vm.swappiness = 60 vm.vfs_cache_pressure = 50 vm.dirty_background_ratio = 5 vm.dirty_ratio = 10 # 网络优化 net.core.somaxconn = 1024 net.core.netdev_max_backlog = 5000 net.ipv4.tcp_max_syn_backlog = 2048 net.ipv4.tcp_fin_timeout = 20 net.ipv4.tcp_keepalive_time = 1200 net.ipv4.tcp_keepalive_intvl = 15 net.ipv4.tcp_keepalive_probes = 5 # 文件系统优化 fs.file-max = 65535 fs.inotify.max_user_watches = 524288 EOF # 应用新的系统参数 sudo sysctl -p /etc/sysctl.d/99-custom.conf } # CPU 频率优化 optimize_cpu() { sudo tee /boot/config.txt << EOF # CPU 设置 arm_freq=1800 over_voltage=6 gpu_freq=500 # 温度控制 temp_limit=75 EOF } # 服务优化 optimize_services() { # 禁用不必要的服务 UNNECESSARY_SERVICES=( "bluetooth" "cups" "avahi-daemon" ) for service in "${UNNECESSARY_SERVICES[@]}"; do if systemctl is-enabled "$service" &>/dev/null; then sudo systemctl disable "$service" sudo systemctl stop "$service" fi done } # 内存优化 optimize_memory() { # 调整 ZRAM sudo tee /etc/default/zramswap << EOF ALGO=lz4 PERCENT=50 EOF # 重启 ZRAM 服务 sudo systemctl restart zramswap } 2. 服务优化配置 # Nginx 优化配置 sudo nano /etc/nginx/nginx.conf user www-data; worker_processes auto; worker_rlimit_nofile 65535; events { worker_connections 1024; multi_accept on; use epoll; } http { # 基础设置 sendfile on; tcp_nopush on; tcp_nodelay on; keepalive_timeout 65; types_hash_max_size 2048; server_tokens off; # MIME 类型 include /etc/nginx/mime.types; default_type application/octet-stream; # 日志格式 log_format main &#39;$remote_addr - $remote_user [$time_local] "$request" &#39; &#39;$status $body_bytes_sent "$http_referer" &#39; &#39;"$http_user_agent" "$http_x_forwarded_for"&#39;; # 缓冲区设置 client_body_buffer_size 10K; client_header_buffer_size 1k; client_max_body_size 8m; large_client_header_buffers 2 1k; # 超时设置 client_body_timeout 12; client_header_timeout 12; send_timeout 10; # 缓存设置 open_file_cache max=1000 inactive=20s; open_file_cache_valid 30s; open_file_cache_min_uses 2; open_file_cache_errors on; # Gzip 压缩 gzip on; gzip_vary on; gzip_proxied any; gzip_comp_level 6; gzip_types text/plain text/css text/xml application/json application/javascript application/xml+rss application/atom+xml image/svg+xml; } 二十、服务监控面板配置 1. Grafana 监控系统配置 # 安装 Grafana sudo apt-get install -y apt-transport-https sudo apt-get install -y software-properties-common wget wget -q -O - https://packages.grafana.com/gpg.key | sudo apt-key add - echo "deb https://packages.grafana.com/oss/deb stable main" | sudo tee -a /etc/apt/sources.list.d/grafana.list sudo apt-get update sudo apt-get install -y grafana # 配置 Grafana sudo nano /etc/grafana/grafana.ini [server] http_addr = 0.0.0.0 http_port = 3000 [security] admin_user = admin admin_password = your_secure_password [auth.anonymous] enabled = false [paths] data = /var/lib/grafana logs = /var/log/grafana plugins = /var/lib/grafana/plugins [dashboards] versions_to_keep = 20 2. Prometheus 配置 # 安装 Prometheus sudo apt-get install -y prometheus # 配置 Prometheus sudo nano /etc/prometheus/prometheus.yml global: scrape_interval: 15s evaluation_interval: 15s scrape_configs: - job_name: &#39;node&#39; static_configs: - targets: [&#39;localhost:9100&#39;] - job_name: &#39;nginx&#39; static_configs: - targets: [&#39;localhost:9113&#39;] - job_name: &#39;system&#39; static_configs: - targets: [&#39;localhost:9090&#39;] - job_name: &#39;process&#39; static_configs: - targets: [&#39;localhost:9256&#39;] 3. Node Exporter 配置 # 安装 Node Exporter sudo apt-get install -y prometheus-node-exporter # 创建自定义指标收集脚本 nano ~/custom_metrics.sh #!/bin/bash # ~/custom_metrics.sh # 创建指标文件 METRICS_FILE="/var/lib/node_exporter/custom_metrics.prom" while true; do # CPU 温度 CPU_TEMP=$(vcgencmd measure_temp | sed &#39;s/temp=//&#39; | sed &#39;s/&#39;"&#39;"&#39;C//&#39;) echo "raspberry_pi_cpu_temperature $CPU_TEMP" > "$METRICS_FILE" # AI 服务状态 if pgrep -f llama-server > /dev/null; then echo "ai_service_status 1" >> "$METRICS_FILE" else echo "ai_service_status 0" >> "$METRICS_FILE" fi # 博客服务状态 if systemctl is-active nginx > /dev/null; then echo "blog_service_status 1" >> "$METRICS_FILE" else echo "blog_service_status 0" >> "$METRICS_FILE" fi # 内存使用 FREE_MEM=$(free | grep Mem | awk &#39;{print $4}&#39;) echo "system_free_memory_bytes $FREE_MEM" >> "$METRICS_FILE" sleep 15 done 二十一、自动化部署与更新 1. 自动部署配置脚本 # 创建自动部署脚本 nano ~/auto_deploy.sh #!/bin/bash # ~/auto_deploy.sh # 配置 BLOG_DIR="/home/zhaoxiongzhou/myblog" LLAMA_DIR="/home/zhaoxiongzhou/projects/llama.cpp" BACKUP_DIR="/home/zhaoxiongzhou/backups" LOG_FILE="/var/log/auto_deploy.log" # 日志函数 log() { echo "[$(date &#39;+%Y-%m-%d %H:%M:%S&#39;)] $1" >> "$LOG_FILE" } # 备份当前版本 backup_current() { log "开始备份当前版本" # 博客备份 tar -czf "$BACKUP_DIR/blog_$(date +%Y%m%d_%H%M%S).tar.gz" "$BLOG_DIR" # AI 服务备份 tar -czf "$BACKUP_DIR/llama_$(date +%Y%m%d_%H%M%S).tar.gz" "$LLAMA_DIR" log "备份完成" } # 更新博客 update_blog() { log "开始更新博客" cd "$BLOG_DIR" || exit 1 # 拉取最新代码 if git pull origin master; then # 更新主题 git submodule update --remote themes/ananke # 构建站点 hugo --minify # 更新权限 sudo chown -R www-data:www-data public/ # 重启 Nginx sudo systemctl restart nginx log "博客更新成功" else log "错误: 博客更新失败" return 1 fi } # 更新 AI 服务 update_ai_service() { log "开始更新 AI 服务" cd "$LLAMA_DIR" || exit 1 # 停止当前服务 pkill llama-server # 拉取最新代码 if git pull origin master; then # 重新编译 make clean if LLAMA_METAL=1 make -j4; then # 启动服务 ./start-llama.sh # 验证服务 sleep 5 if pgrep -f llama-server > /dev/null; then log "AI 服务更新成功" else log "错误: AI 服务启动失败" return 1 fi else log "错误: AI 服务编译失败" return 1 fi else log "错误: AI 服务代码更新失败" return 1 fi } # 主函数 main() { log "开始自动部署流程" # 创建备份 backup_current # 更新服务 if update_blog && update_ai_service; then log "部署完成" return 0 else log "部署失败" return 1 fi } # 执行部署 main 2. 自动更新检查脚本 # 创建更新检查脚本 nano ~/check_updates.sh 二十一、自动更新检查与通知系统 1. 更新检查脚本 #!/bin/bash # ~/check_updates.sh # 配置 NOTIFY_SCRIPT="/home/zhaoxiongzhou/send_notification.sh" LOG_FILE="/var/log/update_check.log" GITHUB_API="https://api.github.com" LLAMA_REPO="ggerganov/llama.cpp" HUGO_REPO="gohugoio/hugo" # 日志函数 log() { echo "[$(date &#39;+%Y-%m-%d %H:%M:%S&#39;)] $1" | tee -a "$LOG_FILE" } # 检查 GitHub 仓库更新 check_github_updates() { local repo="$1" local current_version="$2" # 获取最新版本 latest_version=$(curl -s "$GITHUB_API/repos/$repo/releases/latest" | grep -Po &#39;"tag_name": "\K.*?(?=")&#39;) if [ "$latest_version" != "$current_version" ]; then log "发现新版本: $repo ($current_version -> $latest_version)" return 0 else log "当前版本已是最新: $repo ($current_version)" return 1 fi } # 检查系统更新 check_system_updates() { sudo apt update > /dev/null 2>&amp;1 updates=$(sudo apt list --upgradable 2>/dev/null | grep -c "upgradable") if [ "$updates" -gt 0 ]; then log "发现 $updates 个系统更新" return 0 else log "系统已是最新" return 1 fi } # 检查服务状态 check_services() { local services=("nginx" "llama-server") local status=0 for service in "${services[@]}"; do if [ "$service" = "nginx" ]; then if ! systemctl is-active --quiet nginx; then log "警告: Nginx 服务未运行" status=1 fi elif [ "$service" = "llama-server" ]; then if ! pgrep -f llama-server > /dev/null; then log "警告: AI 服务未运行" status=1 fi fi done return $status } # 发送通知 send_notification() { local message="$1" local priority="$2" if [ -x "$NOTIFY_SCRIPT" ]; then "$NOTIFY_SCRIPT" "$message" "$priority" else log "通知脚本不存在或不可执行" fi } # 主函数 main() { log "开始检查更新" # 获取当前版本 current_llama_version=$(cd ~/projects/llama.cpp && git describe --tags) current_hugo_version=$(hugo version | grep -Po "v\d+\.\d+\.\d+") # 检查更新 updates_found=0 if check_github_updates "$LLAMA_REPO" "$current_llama_version"; then send_notification "llama.cpp 有新版本可用" "normal" updates_found=1 fi if check_github_updates "$HUGO_REPO" "$current_hugo_version"; then send_notification "Hugo 有新版本可用" "normal" updates_found=1 fi if check_system_updates; then send_notification "系统有更新可用" "normal" updates_found=1 fi if ! check_services; then send_notification "服务状态异常，请检查" "high" fi if [ "$updates_found" -eq 0 ]; then log "所有组件均为最新版本" fi } # 执行检查 main 二十二、通知系统配置 1. 通知发送脚本 # 创建通知发送脚本 nano ~/send_notification.sh #!/bin/bash # ~/send_notification.sh # 配置 TELEGRAM_BOT_TOKEN="your_bot_token" TELEGRAM_CHAT_ID="your_chat_id" EMAIL_ADDRESS="your_email@domain.com" DISCORD_WEBHOOK_URL="your_discord_webhook_url" # 日志配置 LOG_FILE="/var/log/notifications.log" # 日志函数 log() { echo "[$(date &#39;+%Y-%m-%d %H:%M:%S&#39;)] $1" >> "$LOG_FILE" } # Telegram 通知 send_telegram() { local message="$1" local priority="$2" # 根据优先级添加表情符号 case "$priority" in "high") message="🚨 紧急: $message" ;; "normal") message="ℹ️ 通知: $message" ;; "low") message="📝 信息: $message" ;; esac # 发送消息 curl -s -X POST \ "https://api.telegram.org/bot$TELEGRAM_BOT_TOKEN/sendMessage" \ -d "chat_id=$TELEGRAM_CHAT_ID" \ -d "text=$message" \ -d "parse_mode=HTML" log "Telegram 通知已发送: $message" } # 邮件通知 send_email() { local message="$1" local priority="$2" local subject case "$priority" in "high") subject="[紧急] 树莓派服务警告" ;; "normal") subject="[通知] 树莓派服务更新" ;; "low") subject="[信息] 树莓派服务状态" ;; esac echo "$message" | mail -s "$subject" "$EMAIL_ADDRESS" log "邮件通知已发送: $subject - $message" } # Discord 通知 send_discord() { local message="$1" local priority="$2" local color case "$priority" in "high") color="16711680" # 红色 ;; "normal") color="65280" # 绿色 ;; "low") color="255" # 蓝色 ;; esac curl -H "Content-Type: application/json" \ -X POST \ -d "{\"embeds\": [{\"description\": \"$message\", \"color\": $color}]}" \ "$DISCORD_WEBHOOK_URL" log "Discord 通知已发送: $message" } # 主函数 main() { local message="$1" local priority="${2:-normal}" # 默认优先级为 normal # 检查必要参数 if [ -z "$message" ]; then log "错误: 消息内容不能为空" return 1 fi # 添加系统信息 local hostname=$(hostname) local timestamp=$(date &#39;+%Y-%m-%d %H:%M:%S&#39;) message="[$hostname] [$timestamp] $message" # 发送所有通知 send_telegram "$message" "$priority" send_email "$message" "$priority" send_discord "$message" "$priority" log "所有通知渠道处理完成" } # 执行通知发送 main "$@" 二十三、定时任务配置 1. Crontab 配置 # 编辑 crontab crontab -e # 系统维护任务 # 每天凌晨 2 点执行系统更新检查 0 2 * * * ~/check_updates.sh > /dev/null 2>&amp;1 # 每 6 小时执行一次服务健康检查 0 */6 * * * ~/service_health_check.sh > /dev/null 2>&amp;1 # 每周日凌晨 3 点执行系统优化 0 3 * * 0 ~/system_optimize.sh > /dev/null 2>&amp;1 # 每天凌晨 4 点执行日志管理 0 4 * * * ~/log_management.sh > /dev/null 2>&amp;1 # 每小时执行性能数据收集 0 * * * * ~/collect_performance.sh > /dev/null 2>&amp;1 # 每 5 分钟检查一次关键服务状态 */5 * * * * ~/monitor.sh > /dev/null 2>&amp;1 # 每天晚上 11 点执行备份 0 23 * * * ~/auto_backup.sh > /dev/null 2>&amp;1 # 每月 1 号执行完整系统检查 0 1 1 * * ~/full_system_check.sh > /dev/null 2>&amp;1 2. 完整系统检查脚本 # 创建完整系统检查脚本 nano ~/full_system_check.sh #!/bin/bash # ~/full_system_check.sh LOG_FILE="/var/log/system_check.log" REPORT_FILE="/home/zhaoxiongzhou/reports/monthly_report_$(date +%Y%m).txt" # 确保目录存在 mkdir -p "$(dirname "$REPORT_FILE")" # 日志函数 log() { echo "[$(date &#39;+%Y-%m-%d %H:%M:%S&#39;)] $1" | tee -a "$LOG_FILE" "$REPORT_FILE" } # 系统信息检查 check_system_info() { log "=== 系统信息 ===" log "系统版本: $(cat /etc/os-release | grep PRETTY_NAME)" log "内核版本: $(uname -r)" log "运行时间: $(uptime -p)" log "最后启动: $(who -b | awk &#39;{print $3,$4}&#39;)" } # 资源使用检查 check_resources() { log "=== 资源使用情况 ===" log "CPU 使用率: $(top -bn1 | grep "Cpu(s)" | awk &#39;{print $2}&#39;)%" log "内存使用情况:" free -h | tee -a "$REPORT_FILE" log "磁盘使用情况:" df -h | tee -a "$REPORT_FILE" } # 服务状态检查 check_services() { log "=== 服务状态 ===" # 检查 Nginx if systemctl is-active --quiet nginx; then log "Nginx: 运行正常" else log "Nginx: 未运行" fi # 检查 AI 服务 if pgrep -f llama-server > /dev/null; then log "AI 服务: 运行正常" else log "AI 服务: 未运行" fi } # 安全检查 check_security() { log "=== 安全检查 ===" # 检查失败的登录尝试 log "失败的登录尝试:" grep "Failed password" /var/log/auth.log | tail -n 5 | tee -a "$REPORT_FILE" # 检查开放的端口 log "开放的端口:" netstat -tuln | grep LISTEN | tee -a "$REPORT_FILE" } # 性能分析 analyze_performance() { log "=== 性能分析 ===" # 分析 CPU 使用情况 log "CPU 密集进程:" ps aux --sort=-%cpu | head -n 5 | tee -a "$REPORT_FILE" # 分析内存使用情况 log "内存密集进程:" ps aux --sort=-%mem | head -n 5 | tee -a "$REPORT_FILE" } # 主函数 main() { log "开始月度系统检查 - $(date)" check_system_info check_resources check_services check_security analyze_performance log "系统检查完成" # 发送报告 if [ -f "$REPORT_FILE" ]; then ~/send_notification.sh "月度系统检查报告已生成" "normal" fi } # 执行检查 main 二十四、灾难恢复计划 1. 系统恢复脚本 # 创建系统恢复脚本 nano ~/disaster_recovery.sh #!/bin/bash # ~/disaster_recovery.sh # 配置 BACKUP_DIR="/home/zhaoxiongzhou/backups" RECOVERY_LOG="/var/log/recovery.log" SERVICES=("nginx" "llama-server") # 日志函数 log() { echo "[$(date &#39;+%Y-%m-%d %H:%M:%S&#39;)] $1" | tee -a "$RECOVERY_LOG" } # 验证备份 verify_backup() { local backup_file="$1" if [ ! -f "$backup_file" ]; then log "错误: 备份文件不存在 - $backup_file" return 1 fi # 检查文件完整性 if ! tar -tzf "$backup_file" >/dev/null 2>&amp;1; then log "错误: 备份文件损坏 - $backup_file" return 1 fi return 0 } # 停止服务 stop_services() { log "停止所有服务..." for service in "${SERVICES[@]}"; do if [ "$service" = "nginx" ]; then sudo systemctl stop nginx else pkill "$service" fi done # 等待服务完全停止 sleep 5 } # 恢复博客服务 restore_blog() { local backup_file="$BACKUP_DIR/blog_latest.tar.gz" if verify_backup "$backup_file"; then log "开始恢复博客服务..." # 清理当前目录 rm -rf ~/myblog/* # 解压备份 tar -xzf "$backup_file" -C ~/myblog/ # 重建站点 cd ~/myblog hugo --minify # 恢复权限 sudo chown -R www-data:www-data public/ log "博客服务恢复完成" else log "博客服务恢复失败" return 1 fi } # 恢复 AI 服务 restore_ai_service() { local backup_file="$BACKUP_DIR/llama_latest.tar.gz" if verify_backup "$backup_file"; then log "开始恢复 AI 服务..." # 清理当前目录 rm -rf ~/projects/llama.cpp/* # 解压备份 tar -xzf "$backup_file" -C ~/projects/llama.cpp/ # 重新编译 cd ~/projects/llama.cpp make clean LLAMA_METAL=1 make -j4 log "AI 服务恢复完成" else log "AI 服务恢复失败" return 1 fi } # 恢复系统配置 restore_system_config() { local backup_file="$BACKUP_DIR/system_config_latest.tar.gz" if verify_backup "$backup_file"; then log "开始恢复系统配置..." # 解压系统配置 sudo tar -xzf "$backup_file" -C / # 重新加载系统配置 sudo sysctl --system log "系统配置恢复完成" else log "系统配置恢复失败" return 1 fi } # 启动服务 start_services() { log "启动所有服务..." # 启动 Nginx sudo systemctl start nginx # 启动 AI 服务 ~/projects/llama.cpp/start-llama.sh # 验证服务状态 sleep 10 verify_services } # 验证服务 verify_services() { local status=0 log "验证服务状态..." # 检查 Nginx if ! systemctl is-active --quiet nginx; then log "警告: Nginx 服务未正常运行" status=1 fi # 检查 AI 服务 if ! pgrep -f llama-server > /dev/null; then log "警告: AI 服务未正常运行" status=1 fi return $status } # 主函数 main() { log "开始系统恢复流程..." # 停止服务 stop_services # 执行恢复 if restore_system_config && restore_blog && restore_ai_service; then # 启动服务 start_services if verify_services; then log "系统恢复成功完成" ~/send_notification.sh "系统恢复成功完成" "normal" return 0 else log "系统恢复完成，但部分服务可能未正常运行" ~/send_notification.sh "系统恢复完成，但需要手动检查服务状态" "high" return 1 fi else log "系统恢复失败" ~/send_notification.sh "系统恢复失败，需要手动干预" "high" return 1 fi } # 执行恢复 main 二十五、文档管理系统 1. 文档生成脚本 # 创建文档生成脚本 nano ~/generate_docs.sh #!/bin/bash # ~/generate_docs.sh # 配置 DOCS_DIR="/home/zhaoxiongzhou/documentation" SCRIPTS_DIR="/home/zhaoxiongzhou" CONFIG_DIR="/etc" LOG_FILE="/var/log/documentation.log" # 确保目录存在 mkdir -p "$DOCS_DIR"/{scripts,configs,logs,maintenance} # 日志函数 log() { echo "[$(date &#39;+%Y-%m-%d %H:%M:%S&#39;)] $1" | tee -a "$LOG_FILE" } # 生成脚本文档 generate_script_docs() { log "生成脚本文档..." for script in "$SCRIPTS_DIR"/*.sh; do if [ -f "$script" ]; then script_name=$(basename "$script") output_file="$DOCS_DIR/scripts/${script_name%.sh}.md" { echo "# $script_name" echo "## 路径: $script" echo "## 最后修改: $(date -r "$script" &#39;+%Y-%m-%d %H:%M:%S&#39;)" echo "## 权限: $(stat -c &#39;%a&#39; "$script")" echo "## 所有者: $(stat -c &#39;%U:%G&#39; "$script")" echo echo "## 功能描述" grep -A 5 "^#.*功能:" "$script" 2>/dev/null || echo "未提供功能描述" echo echo "## 脚本内容" echo &#39;```bash&#39; cat "$script" echo &#39;```&#39; echo echo "## 依赖项" grep "^[^#]*apt.*install" "$script" 2>/dev/null || echo "未找到明确的依赖项" echo echo "## 定时任务" crontab -l 2>/dev/null | grep "$script_name" || echo "未配置定时任务" } > "$output_file" fi done } # 生成配置文档 generate_config_docs() { log "生成配置文档..." # Nginx 配置 { echo "# Nginx 配置文档" echo "## 主配置文件" echo &#39;```nginx&#39; cat /etc/nginx/nginx.conf echo &#39;```&#39; echo "## 站点配置" echo &#39;```nginx&#39; cat /etc/nginx/sites-available/myblog echo &#39;```&#39; } > "$DOCS_DIR/configs/nginx_config.md" # 系统配置 { echo "# 系统配置文档" echo "## Sysctl 配置" echo &#39;```bash&#39; cat /etc/sysctl.d/99-custom.conf echo &#39;```&#39; echo "## 树莓派配置" echo &#39;```bash&#39; cat /boot/config.txt echo &#39;```&#39; } > "$DOCS_DIR/configs/system_config.md" } # 生成维护文档 generate_maintenance_docs() { log "生成维护文档..." { echo "# 系统维护文档" echo "## 定时任务" echo &#39;```bash&#39; crontab -l echo &#39;```&#39; echo "## 服务状态" echo &#39;```bash&#39; systemctl status nginx ps aux | grep llama-server echo &#39;```&#39; echo "## 资源使用" echo &#39;```bash&#39; df -h free -h top -bn1 echo &#39;```&#39; echo "## 最近日志" echo &#39;```bash&#39; tail -n 50 /var/log/syslog echo &#39;```&#39; } > "$DOCS_DIR/maintenance/system_status.md" } # 生成索引 generate_index() { log "生成文档索引..." { echo "# 系统文档索引" echo "## 生成时间: $(date &#39;+%Y-%m-%d %H:%M:%S&#39;)" echo echo "## 脚本文档" for doc in "$DOCS_DIR/scripts"/*.md; do echo "- [$(basename "${doc%.md}")](scripts/$(basename "$doc"))" done echo echo "## 配置文档" for doc in "$DOCS_DIR/configs"/*.md; do echo "- [$(basename "${doc%.md}")](configs/$(basename "$doc"))" done echo echo "## 维护文档" for doc in "$DOCS_DIR/maintenance"/*.md; do echo "- [$(basename "${doc%.md}")](maintenance/$(basename "$doc"))" done } > "$DOCS_DIR/index.md" } # 主函数 main() { log "开始生成文档..." generate_script_docs generate_config_docs generate_maintenance_docs generate_index log "文档生成完成: $DOCS_DIR" } # 执行文档生成 main 二十六、性能测试与基准测试 1. 性能测试脚本 # 创建性能测试脚本 nano ~/benchmark.sh #!/bin/bash # ~/benchmark.sh # 配置 RESULTS_DIR="/home/zhaoxiongzhou/benchmark_results" LOG_FILE="/var/log/benchmark.log" DURATION=300 # 测试持续时间（秒） CONCURRENT_USERS=10 # 并发用户数 # 确保目录存在 mkdir -p "$RESULTS_DIR" # 日志函数 log() { echo "[$(date &#39;+%Y-%m-%d %H:%M:%S&#39;)] $1" | tee -a "$LOG_FILE" } # CPU 性能测试 benchmark_cpu() { log "开始 CPU 性能测试..." # 使用 sysbench 进行 CPU 测试 sysbench cpu --cpu-max-prime=20000 --threads=4 run > "$RESULTS_DIR/cpu_benchmark.txt" # 记录 CPU 温度 for i in $(seq 1 10); do vcgencmd measure_temp >> "$RESULTS_DIR/cpu_temp.txt" sleep 1 done } # 内存性能测试 benchmark_memory() { log "开始内存性能测试..." # 使用 sysbench 进行内存测试 sysbench memory --memory-block-size=1K --memory-total-size=10G run > "$RESULTS_DIR/memory_benchmark.txt" } # 磁盘性能测试 benchmark_disk() { log "开始磁盘性能测试..." # 使用 dd 测试写入速度 dd if=/dev/zero of=/tmp/test_file bs=1M count=1000 conv=fdatasync 2>> "$RESULTS_DIR/disk_write_benchmark.txt" # 使用 dd 测试读取速度 dd if=/tmp/test_file of=/dev/null bs=1M count=1000 2>> "$RESULTS_DIR/disk_read_benchmark.txt" # 清理测试文件 rm /tmp/test_file } # 网络性能测试 benchmark_network() { log "开始网络性能测试..." # 使用 iperf3 测试网络性能 iperf3 -c iperf.he.net -t 30 > "$RESULTS_DIR/network_benchmark.txt" } # Web 服务性能测试 benchmark_web() { log "开始 Web 服务性能测试..." # 使用 ab 测试 Web 服务 ab -n 1000 -c "$CONCURRENT_USERS" http://localhost/ > "$RESULTS_DIR/web_benchmark.txt" } # AI 服务性能测试 benchmark_ai() { log "开始 AI 服务性能测试..." # 创建测试请求 cat > /tmp/test_prompt.txt << EOF Hello, how are you? EOF # 使用 curl 测试 AI 服务响应时间 for i in $(seq 1 10); do time curl -X POST \ -H "Content-Type: application/json" \ -d @/tmp/test_prompt.txt \ http://localhost:8080/completion >> "$RESULTS_DIR/ai_benchmark.txt" 2>&amp;1 echo -e "\n---\n" >> "$RESULTS_DIR/ai_benchmark.txt" sleep 2 done } # 生成报告 generate_report() { log "生成性能测试报告..." local report_file="$RESULTS_DIR/benchmark_report_$(date +%Y%m%d_%H%M%S).md" { echo "# 性能测试报告" echo "## 测试时间: $(date &#39;+%Y-%m-%d %H:%M:%S&#39;)" echo echo "## 系统信息" echo &#39;```&#39; uname -a echo &#39;```&#39; echo echo "## CPU 性能" echo &#39;```&#39; cat "$RESULTS_DIR/cpu_benchmark.txt" echo &#39;```&#39; echo echo "## 内存性能" echo &#39;```&#39; cat "$RESULTS_DIR/memory_benchmark.txt" echo &#39;```&#39; echo echo "## 磁盘性能" echo &#39;```&#39; cat "$RESULTS_DIR/disk_write_benchmark.txt" cat "$RESULTS_DIR/disk_read_benchmark.txt" echo &#39;```&#39; echo echo "## 网络性能" echo &#39;```&#39; cat "$RESULTS_DIR/network_benchmark.txt" echo &#39;```&#39; echo echo "## Web 服务性能" echo &#39;```&#39; cat "$RESULTS_DIR/web_benchmark.txt" echo &#39;```&#39; echo echo "## AI 服务性能" echo &#39;```&#39; cat "$RESULTS_DIR/ai_benchmark.txt" echo &#39;```&#39; } > "$report_file" log "性能测试报告已生成: $report_file" } # 主函数 main() { log "开始性能测试..." # 安装必要的工具 sudo apt install -y sysbench apache2-utils iperf3 # 执行各项测试 benchmark_cpu benchmark_memory benchmark_disk benchmark_network benchmark_web benchmark_ai # 生成报告 generate_report log "性能测试完成" } # 执行测试 main 二十七、安全审计系统 1. 安全审计脚本 # 创建安全审计脚本 nano ~/security_audit.sh #!/bin/bash # ~/security_audit.sh # 配置 AUDIT_DIR="/home/zhaoxiongzhou/security_audits" REPORT_FILE="$AUDIT_DIR/security_report_$(date +%Y%m%d_%H%M%S).md" LOG_FILE="/var/log/security_audit.log" # 确保目录存在 mkdir -p "$AUDIT_DIR" # 日志函数 log() { echo "[$(date &#39;+%Y-%m-%d %H:%M:%S&#39;)] $1" | tee -a "$LOG_FILE" } # 检查系统用户 audit_users() { log "检查系统用户..." { echo "## 系统用户审计" echo "### 特权用户" echo &#39;```&#39; awk -F: &#39;$3 == 0 {print $1}&#39; /etc/passwd echo &#39;```&#39; echo "### 最近的用户活动" echo &#39;```&#39; last | head -n 10 echo &#39;```&#39; echo "### 失败的登录尝试" echo &#39;```&#39; grep "Failed password" /var/log/auth.log | tail -n 10 echo &#39;```&#39; } >> "$REPORT_FILE" } # 检查网络安全 audit_network() { log "检查网络安全..." { echo "## 网络安全审计" echo "### 开放端口" echo &#39;```&#39; netstat -tuln echo &#39;```&#39; echo "### 活动连接" echo &#39;```&#39; netstat -nat | grep ESTABLISHED echo &#39;```&#39; echo "### 防火墙规则" echo &#39;```&#39; sudo iptables -L -n echo &#39;```&#39; } >> "$REPORT_FILE" } # 检查文件权限 audit_permissions() { log "检查文件权限..." { echo "## 文件权限审计" echo "### SUID 文件" echo &#39;```&#39; sudo find / -type f -perm -4000 2>/dev/null echo &#39;```&#39; echo "### 世界可写文件" echo &#39;```&#39; sudo find / -type f -perm -2 ! -path "/proc/*" ! -path "/sys/*" 2>/dev/null echo &#39;```&#39; echo "### 敏感目录权限" echo &#39;```&#39; ls -la /etc/nginx/ ls -la ~/projects/llama.cpp/ ls -la ~/myblog/ echo &#39;```&#39; } >> "$REPORT_FILE" } # 检查服务配置 audit_services() { log "检查服务配置..." { echo "## 服务配置审计" echo "### Nginx 配置检查" echo &#39;```&#39; sudo nginx -t 2>&amp;1 echo &#39;```&#39; echo "### SSL 配置" echo &#39;```&#39; openssl s_client -connect localhost:443 -servername localhost </dev/null 2>/dev/null | openssl x509 -text echo &#39;```&#39; echo "### 服务状态" echo &#39;```&#39; systemctl list-units --type=service --state=active echo &#39;```&#39; } >> "$REPORT_FILE" } # 检查系统更新 audit_updates() { log "检查系统更新..." { echo "## 系统更新审计" echo "### 可用更新" echo &#39;```&#39; apt list --upgradable 2>/dev/null echo &#39;```&#39; echo "### 已安装包" echo &#39;```&#39; dpkg -l | grep "^ii" | wc -l echo &#39;```&#39; } >> "$REPORT_FILE" } # 检查日志异常 audit_logs() { log "检查日志异常..." { echo "## 日志审计" echo "### 系统错误" echo &#39;```&#39; sudo journalctl -p 3 -xb --no-pager | tail -n 20 echo &#39;```&#39; echo "### 异常访问" echo &#39;```&#39; grep -i "error\|failed\|warning" /var/log/nginx/error.log | tail -n 20 echo &#39;```&#39; } >> "$REPORT_FILE" } # 生成安全建议 generate_recommendations() { log "生成安全建议..." { echo "## 安全建议" echo "### 高优先级" # 检查并生成建议 if grep -q "Failed password" /var/log/auth.log; then echo "- 建议：启用 fail2ban 加强 SSH 防护" fi if [ $(find / -type f -perm -2 2>/dev/null | wc -l) -gt 0 ]; then echo "- 建议：检查并修复世界可写文件权限" fi echo "### 中优先级" # 添加其他建议 echo "- 定期更新系统包" echo "- 检查并更新 SSL 证书" echo "- 定期审查用户权限" } >> "$REPORT_FILE" } # 主函数 main() { log "开始安全审计..." # 创建报告头部 { echo "# 安全审计报告" echo "## 生成时间: $(date &#39;+%Y-%m-%d %H:%M:%S&#39;)" echo "## 系统信息" echo &#39;```&#39; uname -a echo &#39;```&#39; echo } > "$REPORT_FILE" # 执行各项审计 audit_users audit_network audit_permissions audit_services audit_updates audit_logs generate_recommendations log "安全审计完成，报告已生成: $REPORT_FILE" # 发送通知 ~/send_notification.sh "安全审计报告已生成" "normal" } # 执行审计 main 二十八、资源限制与控制 1. 资源限制配置脚本 # 创建资源限制配置脚本 nano ~/resource_control.sh #!/bin/bash # ~/resource_control.sh # 配置 LOG_FILE="/var/log/resource_control.log" LIMITS_CONF="/etc/security/limits.conf" SYSTEMD_DIR="/etc/systemd/system" # 日志函数 log() { echo "[$(date &#39;+%Y-%m-%d %H:%M:%S&#39;)] $1" | tee -a "$LOG_FILE" } # 配置系统资源限制 configure_system_limits() { log "配置系统资源限制..." # 备份原始配置 sudo cp "$LIMITS_CONF" "${LIMITS_CONF}.backup" # 添加资源限制配置 sudo tee -a "$LIMITS_CONF" << EOF # 用户资源限制 zhaoxiongzhou soft nofile 65535 zhaoxiongzhou hard nofile 65535 zhaoxiongzhou soft nproc 2048 zhaoxiongzhou hard nproc 4096 # 系统服务资源限制 www-data soft nofile 65535 www-data hard nofile 65535 www-data soft nproc 1024 www-data hard nproc 2048 EOF } # 配置 AI 服务资源限制 configure_ai_service() { log "配置 AI 服务资源限制..." # 创建 systemd 服务文件 sudo tee "$SYSTEMD_DIR/llama-server.service" << EOF [Unit] Description=Llama AI Server After=network.target [Service] User=zhaoxiongzhou Group=zhaoxiongzhou WorkingDirectory=/home/zhaoxiongzhou/projects/llama.cpp ExecStart=/home/zhaoxiongzhou/projects/llama.cpp/start-llama.sh # 资源限制 CPUQuota=80% MemoryLimit=2G TasksMax=128 LimitNOFILE=65535 # 重启策略 Restart=always RestartSec=10 [Install] WantedBy=multi-user.target EOF # 重新加载 systemd 配置 sudo systemctl daemon-reload } # 配置 Nginx 资源限制 configure_nginx() { log "配置 Nginx 资源限制..." # 修改 Nginx 配置 sudo tee "/etc/nginx/conf.d/resource_limits.conf" << EOF # 工作进程限制 worker_processes auto; worker_rlimit_nofile 65535; # 连接限制 events { worker_connections 1024; multi_accept on; } # 客户端限制 http { # 请求限制 limit_req_zone \$binary_remote_addr zone=one:10m rate=10r/s; # 连接限制 limit_conn_zone \$binary_remote_addr zone=addr:10m; server { # 应用限制 location / { limit_req zone=one burst=5; limit_conn addr 10; } } } EOF } # 配置系统资源监控 configure_monitoring() { log "配置资源监控..." # 创建监控脚本 cat > ~/monitor_resources.sh << EOF #!/bin/bash while true; do # CPU 使用率 CPU_USAGE=\$(top -bn1 | grep "Cpu(s)" | awk &#39;{print \$2}&#39;) # 内存使用率 MEM_USAGE=\$(free | grep Mem | awk &#39;{print \$3/\$2 * 100.0}&#39;) # 进程数 PROCESS_COUNT=\$(ps aux | wc -l) # 检查限制 if (( \$(echo "\$CPU_USAGE > 80" | bc -l) )); then ~/send_notification.sh "警告: CPU 使用率过高 (\${CPU_USAGE}%)" "high" fi if (( \$(echo "\$MEM_USAGE > 90" | bc -l) )); then ~/send_notification.sh "警告: 内存使用率过高 (\${MEM_USAGE}%)" "high" fi if [ "\$PROCESS_COUNT" -gt 200 ]; then ~/send_notification.sh "警告: 进程数过多 (\$PROCESS_COUNT)" "high" fi sleep 60 done EOF chmod +x ~/monitor_resources.sh } # 应用配置 apply_configurations() { log "应用资源限制配置..." # 重启服务 sudo systemctl restart nginx sudo systemctl restart llama-server # 启动监控 ~/monitor_resources.sh & # 验证配置 log "验证配置..." sudo nginx -t sudo systemctl status llama-server ulimit -a } # 主函数 main() { log "开始配置资源限制..." configure_system_limits configure_ai_service configure_nginx configure_monitoring apply_configurations log "资源限制配置完成" } # 执行配置 main 二十九、自动化测试系统 1. 集成测试脚本 # 创建集成测试脚本 nano ~/integration_test.sh #!/bin/bash # ~/integration_test.sh # 配置 TEST_DIR="/home/zhaoxiongzhou/tests" REPORT_DIR="/home/zhaoxiongzhou/test_reports" LOG_FILE="/var/log/integration_test.log" # 确保目录存在 mkdir -p "$TEST_DIR" "$REPORT_DIR" # 日志函数 log() { echo "[$(date &#39;+%Y-%m-%d %H:%M:%S&#39;)] $1" | tee -a "$LOG_FILE" } # 测试 Web 服务 test_web_service() { log "测试 Web 服务..." local result=0 # 测试首页访问 if curl -s -o /dev/null -w "%{http_code}" http://localhost/ | grep -q "200"; then log "首页访问测试通过" else log "错误: 首页访问测试失败" result=1 fi # 测试静态资源 if curl -s -o /dev/null -w "%{http_code}" http://localhost/css/main.css | grep -q "200"; then log "静态资源测试通过" else log "错误: 静态资源测试失败" result=1 fi # 测试 404 页面 if curl -s -o /dev/null -w "%{http_code}" http://localhost/nonexistent | grep -q "404"; then log "404 页面测试通过" else log "错误: 404 页面测试失败" result=1 fi return $result } # 测试 AI 服务 test_ai_service() { log "测试 AI 服务..." local result=0 # 测试服务可用性 if curl -s -o /dev/null -w "%{http_code}" http://localhost:8080/health | grep -q "200"; then log "AI 服务健康检查通过" else log "错误: AI 服务健康检查失败" result=1 fi # 测试模型响应 local response=$(curl -s -X POST \ -H "Content-Type: application/json" \ -d &#39;{"prompt": "Hello", "max_tokens": 10}&#39; \ http://localhost:8080/completion) if echo "$response" | grep -q "text"; then log "AI 服务响应测试通过" else log "错误: AI 服务响应测试失败" result=1 fi return $result } # 测试系统服务 test_system_services() { log "测试系统服务..." local result=0 # 测试 Nginx 状态 if systemctl is-active --quiet nginx; then log "Nginx 服务测试通过" else log "错误: Nginx 服务测试失败" result=1 fi # 测试系统资源 local cpu_usage=$(top -bn1 | grep "Cpu(s)" | awk &#39;{print $2}&#39;) local mem_usage=$(free | grep Mem | awk &#39;{print $3/$2 * 100.0}&#39;) if [ $(echo "$cpu_usage < 90" | bc -l) -eq 1 ]; then log "CPU 使用率正常" else log "警告: CPU 使用率过高" result=1 fi if [ $(echo "$mem_usage < 90" | bc -l) -eq 1 ]; then log "内存使用率正常" else log "警告: 内存使用率过高" result=1 fi return $result } # 生成测试报告 generate_report() { local web_result=$1 local ai_result=$2 local system_result=$3 local report_file="$REPORT_DIR/test_report_$(date +%Y%m%d_%H%M%S).md" { echo "# 集成测试报告" echo "## 测试时间: $(date &#39;+%Y-%m-%d %H:%M:%S&#39;)" echo echo "## 测试结果摘要" echo "- Web 服务: $([ $web_result -eq 0 ] && echo &#39;通过 ✅&#39; || echo &#39;失败 ❌&#39;)" echo "- AI 服务: $([ $ai_result -eq 0 ] && echo &#39;通过 ✅&#39; || echo &#39;失败 ❌&#39;)" echo "- 系统服务: $([ $system_result -eq 0 ] && echo &#39;通过 ✅&#39; || echo &#39;失败 ❌&#39;)" echo echo "## 详细日志" echo &#39;```&#39; tail -n 50 "$LOG_FILE" echo &#39;```&#39; } > "$report_file" log "测试报告已生成: $report_file" } # 主函数 main() { log "开始集成测试..." local web_result=0 local ai_result=0 local system_result=0 # 执行测试 test_web_service web_result=$? test_ai_service ai_result=$? test_system_services system_result=$? # 生成报告 generate_report $web_result $ai_result $system_result # 发送通知 if [ $web_result -eq 0 ] && [ $ai_result -eq 0 ] && [ $system_result -eq 0 ]; then ~/send_notification.sh "集成测试全部通过" "normal" else ~/send_notification.sh "集成测试存在失败项，请查看报告" "high" fi # 返回总体结果 return $(( web_result + ai_result + system_result )) } # 执行测试 main 三十、系统状态仪表板 1. 状态监控页面生成脚本 # 创建状态页面生成脚本 nano ~/generate_dashboard.sh #!/bin/bash # ~/generate_dashboard.sh # 配置 DASHBOARD_DIR="/var/www/html/dashboard" REFRESH_INTERVAL=60 # 页面刷新间隔（秒） LOG_FILE="/var/log/dashboard.log" # 确保目录存在 sudo mkdir -p "$DASHBOARD_DIR" # 日志函数 log() { echo "[$(date &#39;+%Y-%m-%d %H:%M:%S&#39;)] $1" | tee -a "$LOG_FILE" } # 收集系统状态数据 collect_system_data() { # CPU 信息 CPU_USAGE=$(top -bn1 | grep "Cpu(s)" | awk &#39;{print $2}&#39;) CPU_TEMP=$(vcgencmd measure_temp | sed &#39;s/temp=//&#39; | sed &#39;s/&#39;"&#39;"&#39;C//&#39;) # 内存信息 MEM_TOTAL=$(free -m | awk &#39;/Mem:/ {print $2}&#39;) MEM_USED=$(free -m | awk &#39;/Mem:/ {print $3}&#39;) MEM_USAGE=$(awk "BEGIN {printf \"%.2f\", $MEM_USED/$MEM_TOTAL*100}") # 磁盘信息 DISK_USAGE=$(df -h / | awk &#39;NR==2 {print $5}&#39; | sed &#39;s/%//&#39;) # 系统负载 LOAD_AVG=$(uptime | awk -F&#39;load average:&#39; &#39;{print $2}&#39; | xargs) # 运行时间 UPTIME=$(uptime -p) } # 收集服务状态 collect_service_data() { # Nginx 状态 if systemctl is-active --quiet nginx; then NGINX_STATUS="运行中 ✅" else NGINX_STATUS="已停止 ❌" fi # AI 服务状态 if pgrep -f llama-server > /dev/null; then AI_STATUS="运行中 ✅" else AI_STATUS="已停止 ❌" fi # 获取最近的日志 RECENT_LOGS=$(tail -n 10 /var/log/syslog | sed &#39;s/</\&amp;lt;/g&#39; | sed &#39;s/>/\&amp;gt;/g&#39;) } # 生成状态页面 generate_dashboard() { local timestamp=$(date &#39;+%Y-%m-%d %H:%M:%S&#39;) cat > "$DASHBOARD_DIR/index.html" << EOF <!DOCTYPE html> <html lang="zh"> <head> <meta charset="UTF-8"> <meta name="viewport" content="width=device-width, initial-scale=1.0"> <title>系统状态仪表板</title> <meta http-equiv="refresh" content="$REFRESH_INTERVAL"> <style> body { font-family: Arial, sans-serif; margin: 20px; background-color: #f5f5f5; } .container { max-width: 1200px; margin: 0 auto; } .card { background: white; border-radius: 8px; padding: 20px; margin-bottom: 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); } .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; } .metric { text-align: center; padding: 15px; border-radius: 4px; background: #f8f9fa; } .metric h3 { margin: 0; color: #666; } .metric .value { font-size: 24px; font-weight: bold; margin: 10px 0; } .status { display: flex; justify-content: space-between; align-items: center; padding: 10px; border-bottom: 1px solid #eee; } .logs { background: #2b2b2b; color: #fff; padding: 15px; border-radius: 4px; font-family: monospace; white-space: pre-wrap; } </style> </head> <body> <div class="container"> <h1>系统状态仪表板</h1> <p>最后更新: $timestamp</p> <div class="card"> <h2>系统资源</h2> <div class="grid"> <div class="metric"> <h3>CPU 使用率</h3> <div class="value">$CPU_USAGE%</div> </div> <div class="metric"> <h3>CPU 温度</h3> <div class="value">$CPU_TEMP</div> </div> <div class="metric"> <h3>内存使用率</h3> <div class="value">$MEM_USAGE%</div> </div> <div class="metric"> <h3>磁盘使用率</h3> <div class="value">$DISK_USAGE%</div> </div> </div> </div> <div class="card"> <h2>系统信息</h2> <div class="status"> <span>系统负载:</span> <span>$LOAD_AVG</span> </div> <div class="status"> <span>运行时间:</span> <span>$UPTIME</span> </div> </div> <div class="card"> <h2>服务状态</h2> <div class="status"> <span>Nginx 服务:</span> <span>$NGINX_STATUS</span> </div> <div class="status"> <span>AI 服务:</span> <span>$AI_STATUS</span> </div> </div> <div class="card"> <h2>最近日志</h2> <div class="logs">$RECENT_LOGS</div> </div> </div> </body> </html> EOF # 设置权限 sudo chown www-data:www-data "$DASHBOARD_DIR/index.html" } # 主函数 main() { log "开始生成状态仪表板..." # 收集数据 collect_system_data collect_service_data # 生成页面 generate_dashboard log "状态仪表板已更新" } # 执行生成 main 三十一、系统备份与恢复完整方案 1. 完整备份脚本 # 创建完整备份脚本 nano ~/full_backup.sh #!/bin/bash # ~/full_backup.sh # 配置 BACKUP_ROOT="/mnt/backup_drive" BACKUP_DIR="$BACKUP_ROOT/system_backups" EXCLUDE_FILE="/home/zhaoxiongzhou/backup_exclude.txt" LOG_FILE="/var/log/backup.log" RETENTION_DAYS=30 COMPRESSION_LEVEL=6 # 确保备份目录存在 mkdir -p "$BACKUP_DIR" # 日志函数 log() { echo "[$(date &#39;+%Y-%m-%d %H:%M:%S&#39;)] $1" | tee -a "$LOG_FILE" } # 检查备份环境 check_environment() { log "检查备份环境..." # 检查备份目标目录 if ! mountpoint -q "$BACKUP_ROOT"; then log "错误: 备份驱动器未挂载" return 1 fi # 检查可用空间 local available_space=$(df -BG "$BACKUP_ROOT" | awk &#39;NR==2 {print $4}&#39; | sed &#39;s/G//&#39;) if [ "$available_space" -lt 10 ]; then log "错误: 备份空间不足（小于 10GB）" return 1 fi # 创建排除文件 cat > "$EXCLUDE_FILE" << EOF /proc/* /sys/* /tmp/* /run/* /mnt/* /media/* /lost+found /var/cache/* /var/tmp/* /var/log/* /home/*/Downloads/* /home/*/.cache/* EOF return 0 } # 停止服务 stop_services() { log "停止服务..." # 停止 Nginx sudo systemctl stop nginx # 停止 AI 服务 pkill llama-server # 等待服务完全停止 sleep 5 } # 启动服务 start_services() { log "启动服务..." # 启动 Nginx sudo systemctl start nginx # 启动 AI 服务 ~/projects/llama.cpp/start-llama.sh # 验证服务状态 sleep 10 if ! systemctl is-active --quiet nginx; then log "警告: Nginx 服务未能正常启动" fi if ! pgrep -f llama-server > /dev/null; then log "警告: AI 服务未能正常启动" fi } # 创建完整备份 create_full_backup() { local backup_date=$(date +%Y%m%d_%H%M%S) local backup_file="$BACKUP_DIR/full_backup_${backup_date}.tar.gz" local manifest_file="$BACKUP_DIR/backup_manifest_${backup_date}.txt" log "开始创建完整备份..." # 创建文件清单 log "生成文件清单..." find / -xdev -type f ! -path "$(cat $EXCLUDE_FILE | tr &#39;\n&#39; &#39;|&#39;)" > "$manifest_file" # 创建备份 log "创建系统备份..." sudo tar -czf "$backup_file" \ --exclude-from="$EXCLUDE_FILE" \ --one-file-system \ --preserve-permissions \ --numeric-owner \ --checkpoint=1000 \ --checkpoint-action=dot \ -C / . # 验证备份 if ! tar -tzf "$backup_file" >/dev/null 2>&amp;1; then log "错误: 备份文件验证失败" return 1 fi # 计算校验和 log "计算校验和..." sha256sum "$backup_file" > "${backup_file}.sha256" # 创建备份信息文件 cat > "${backup_file}.info" << EOF 备份时间: $(date) 系统版本: $(cat /etc/os-release | grep PRETTY_NAME) 内核版本: $(uname -r) 备份大小: $(du -h "$backup_file" | cut -f1) 文件数量: $(wc -l < "$manifest_file") 排除规则: $(cat "$EXCLUDE_FILE") EOF return 0 } # 清理旧备份 cleanup_old_backups() { log "清理旧备份..." find "$BACKUP_DIR" -type f -name "full_backup_*" -mtime +$RETENTION_DAYS -delete find "$BACKUP_DIR" -type f -name "backup_manifest_*" -mtime +$RETENTION_DAYS -delete find "$BACKUP_DIR" -type f -name "*.sha256" -mtime +$RETENTION_DAYS -delete find "$BACKUP_DIR" -type f -name "*.info" -mtime +$RETENTION_DAYS -delete } # 主函数 main() { log "开始完整备份流程..." # 检查环境 if ! check_environment; then log "备份环境检查失败，终止备份" ~/send_notification.sh "系统备份失败：环境检查未通过" "high" return 1 fi # 停止服务 stop_services # 创建备份 if create_full_backup; then log "备份创建成功" ~/send_notification.sh "系统完整备份已成功创建" "normal" else log "备份创建失败" ~/send_notification.sh "系统备份失败：备份创建过程出错" "high" fi # 启动服务 start_services # 清理旧备份 cleanup_old_backups log "备份流程完成" } # 执行备份 main 三十二、系统恢复脚本 1. 系统恢复脚本 # 创建系统恢复脚本 nano ~/system_restore.sh #!/bin/bash # ~/system_restore.sh # 配置 BACKUP_ROOT="/mnt/backup_drive" BACKUP_DIR="$BACKUP_ROOT/system_backups" LOG_FILE="/var/log/restore.log" TEMP_DIR="/tmp/restore_temp" # 日志函数 log() { echo "[$(date &#39;+%Y-%m-%d %H:%M:%S&#39;)] $1" | tee -a "$LOG_FILE" } # 验证备份文件 verify_backup() { local backup_file="$1" log "验证备份文件: $backup_file" # 检查文件是否存在 if [ ! -f "$backup_file" ]; then log "错误: 备份文件不存在" return 1 fi # 检查校验和 local checksum_file="${backup_file}.sha256" if [ -f "$checksum_file" ]; then if ! sha256sum -c "$checksum_file"; then log "错误: 备份文件校验和验证失败" return 1 fi else log "警告: 未找到校验和文件" fi # 测试归档完整性 if ! tar -tzf "$backup_file" >/dev/null 2>&amp;1; then log "错误: 备份文件损坏" return 1 fi return 0 } # 准备恢复环境 prepare_environment() { log "准备恢复环境..." # 创建临时目录 mkdir -p "$TEMP_DIR" # 停止所有服务 log "停止服务..." sudo systemctl stop nginx pkill llama-server # 等待服务停止 sleep 5 # 清理目标目录 log "清理目标目录..." read -p "警告: 这将清除系统文件。确定要继续吗？(y/n) " -n 1 -r echo if [[ ! $REPLY =~ ^[Yy]$ ]]; then log "用户取消操作" return 1 fi return 0 } # 执行恢复 perform_restore() { local backup_file="$1" log "开始恢复系统..." # 创建恢复前的快照 log "创建当前系统快照..." local snapshot_date=$(date +%Y%m%d_%H%M%S) local snapshot_file="$BACKUP_DIR/pre_restore_snapshot_${snapshot_date}.tar.gz" sudo tar -czf "$snapshot_file" \ --exclude-from="/home/zhaoxiongzhou/backup_exclude.txt" \ --one-file-system \ -C / . # 解压备份 log "解压备份文件..." sudo tar -xzf "$backup_file" -C / \ --numeric-owner \ --preserve-permissions \ --checkpoint=1000 \ --checkpoint-action=dot # 修复权限 log "修复文件权限..." sudo chown -R www-data:www-data /var/www/ sudo chown -R zhaoxiongzhou:zhaoxiongzhou /home/zhaoxiongzhou/ return 0 } # 恢复服务配置 restore_configurations() { log "恢复服务配置..." # 重新加载系统配置 sudo systemctl daemon-reload sudo sysctl --system # 重新配置网络 sudo systemctl restart networking # 恢复防火墙规则 sudo iptables-restore < /etc/iptables/rules.v4 return 0 } # 验证恢复 verify_restore() { log "验证系统恢复..." local status=0 # 检查关键文件 for file in "/etc/nginx/nginx.conf" "/etc/systemd/system/llama-server.service"; do if [ ! -f "$file" ]; then log "错误: 未找到关键文件 $file" status=1 fi done # 启动服务 sudo systemctl start nginx ~/projects/llama.cpp/start-llama.sh # 验证服务状态 sleep 10 if ! systemctl is-active --quiet nginx; then log "错误: Nginx 服务未能正常启动" status=1 fi if ! pgrep -f llama-server > /dev/null; then log "错误: AI 服务未能正常启动" status=1 fi return $status } # 清理恢复环境 cleanup() { log "清理恢复环境..." # 删除临时文件 rm -rf "$TEMP_DIR" # 清理日志 find /var/log -type f -name "*.gz" -delete return 0 } # 主函数 main() { local backup_file # 列出可用备份 echo "可用的备份文件:" ls -lh "$BACKUP_DIR"/full_backup_*.tar.gz # 选择备份文件 read -p "请输入要恢复的备份文件完整路径: " backup_file # 验证备份 if ! verify_backup "$backup_file"; then log "备份验证失败，终止恢复" return 1 fi # 准备环境 if ! prepare_environment; then log "环境准备失败，终止恢复" return 1 fi # 执行恢复 if perform_restore "$backup_file" && \ restore_configurations && \ verify_restore; then log "系统恢复成功完成" ~/send_notification.sh "系统恢复成功完成" "normal" else log "系统恢复失败" ~/send_notification.sh "系统恢复失败，需要手动检查" "high" fi # 清理环境 cleanup } # 执行恢复 main 三十三、系统迁移工具 1. 系统迁移脚本 # 创建系统迁移脚本 nano ~/system_migration.sh #!/bin/bash # ~/system_migration.sh # 配置 SOURCE_HOST="old-raspberry.local" TARGET_HOST="new-raspberry.local" MIGRATION_DIR="/mnt/migration" LOG_FILE="/var/log/migration.log" SSH_KEY="~/.ssh/migration_key" RSYNC_OPTS="-avz --progress --delete" # 日志函数 log() { echo "[$(date &#39;+%Y-%m-%d %H:%M:%S&#39;)] $1" | tee -a "$LOG_FILE" } # 检查迁移环境 check_migration_env() { log "检查迁移环境..." # 检查 SSH 密钥 if [ ! -f "$SSH_KEY" ]; then log "生成 SSH 密钥..." ssh-keygen -t ed25519 -f "$SSH_KEY" -N "" # 复制密钥到目标主机 ssh-copy-id -i "$SSH_KEY" "zhaoxiongzhou@$TARGET_HOST" fi # 检查必要工具 for tool in rsync ssh scp; do if ! command -v $tool &>/dev/null; then log "错误: 未找到必要工具 $tool" return 1 fi done # 检查目标主机连接 if ! ssh -i "$SSH_KEY" "zhaoxiongzhou@$TARGET_HOST" "echo &#39;Connection test&#39;" &>/dev/null; then log "错误: 无法连接到目标主机" return 1 fi return 0 } # 迁移配置文件 migrate_configs() { log "迁移配置文件..." # 创建配置目录 ssh -i "$SSH_KEY" "zhaoxiongzhou@$TARGET_HOST" "mkdir -p ~/configs_backup" # 迁移 Nginx 配置 rsync $RSYNC_OPTS -e "ssh -i $SSH_KEY" \ /etc/nginx/ \ "zhaoxiongzhou@$TARGET_HOST:~/configs_backup/nginx/" # 迁移系统配置 rsync $RSYNC_OPTS -e "ssh -i $SSH_KEY" \ /etc/sysctl.d/ \ "zhaoxiongzhou@$TARGET_HOST:~/configs_backup/sysctl/" # 迁移服务配置 rsync $RSYNC_OPTS -e "ssh -i $SSH_KEY" \ /etc/systemd/system/ \ "zhaoxiongzhou@$TARGET_HOST:~/configs_backup/systemd/" } # 迁移数据 migrate_data() { log "迁移数据..." # 迁移博客数据 rsync $RSYNC_OPTS -e "ssh -i $SSH_KEY" \ ~/myblog/ \ "zhaoxiongzhou@$TARGET_HOST:~/myblog/" # 迁移 AI 服务数据 rsync $RSYNC_OPTS -e "ssh -i $SSH_KEY" \ ~/projects/llama.cpp/ \ "zhaoxiongzhou@$TARGET_HOST:~/projects/llama.cpp/" # 迁移用户脚本 rsync $RSYNC_OPTS -e "ssh -i $SSH_KEY" \ ~/*.sh \ "zhaoxiongzhou@$TARGET_HOST:~/" } # 迁移数据库 migrate_database() { log "迁移数据库..." # 导出数据库 local dump_file="/tmp/database_dump.sql" if [ -f "/var/lib/mysql" ]; then mysqldump --all-databases > "$dump_file" # 传输到目标主机 scp -i "$SSH_KEY" "$dump_file" "zhaoxiongzhou@$TARGET_HOST:/tmp/" # 在目标主机导入数据库 ssh -i "$SSH_KEY" "zhaoxiongzhou@$TARGET_HOST" \ "mysql < /tmp/database_dump.sql" fi } # 配置目标系统 configure_target() { log "配置目标系统..." ssh -i "$SSH_KEY" "zhaoxiongzhou@$TARGET_HOST" "bash -s" << &#39;EOF&#39; # 安装必要软件 sudo apt update sudo apt install -y nginx mysql-server python3 pip # 恢复配置 sudo cp -r ~/configs_backup/nginx/* /etc/nginx/ sudo cp -r ~/configs_backup/sysctl/* /etc/sysctl.d/ sudo cp -r ~/configs_backup/systemd/* /etc/systemd/system/ # 设置权限 sudo chown -R www-data:www-data /var/www/ sudo chmod +x ~/*.sh # 重启服务 sudo systemctl daemon-reload sudo systemctl restart nginx EOF } # 验证迁移 verify_migration() { log "验证迁移..." local status=0 # 检查服务状态 ssh -i "$SSH_KEY" "zhaoxiongzhou@$TARGET_HOST" "bash -s" << &#39;EOF&#39; # 检查 Nginx if ! systemctl is-active --quiet nginx; then echo "错误: Nginx 服务未运行" exit 1 fi # 检查文件 for dir in "~/myblog" "~/projects/llama.cpp"; do if [ ! -d "$dir" ]; then echo "错误: 目录 $dir 不存在" exit 1 fi done # 检查配置 if ! nginx -t &>/dev/null; then echo "错误: Nginx 配置无效" exit 1 fi EOF status=$? return $status } # 主函数 main() { log "开始系统迁移..." # 检查环境 if ! check_migration_env; then log "迁移环境检查失败" return 1 fi # 执行迁移 migrate_configs migrate_data migrate_database configure_target # 验证迁移 if verify_migration; then log "系统迁移成功完成" ~/send_notification.sh "系统迁移成功完成" "normal" else log "系统迁移失败" ~/send_notification.sh "系统迁移失败，需要手动检查" "high" fi } # 执行迁移 main 三十四、日志分析工具 1. 日志分析脚本 # 创建日志分析脚本 nano ~/log_analyzer.sh #!/bin/bash # ~/log_analyzer.sh # 配置 LOG_DIRS=( "/var/log" "/var/log/nginx" "/home/zhaoxiongzhou/logs" ) REPORT_DIR="/home/zhaoxiongzhou/log_reports" LOG_FILE="/var/log/analyzer.log" ALERT_THRESHOLD=100 # 错误日志阈值 RETENTION_DAYS=30 # 报告保留天数 # 确保目录存在 mkdir -p "$REPORT_DIR" # 日志函数 log() { echo "[$(date &#39;+%Y-%m-%d %H:%M:%S&#39;)] $1" | tee -a "$LOG_FILE" } # 分析系统日志 analyze_system_logs() { log "分析系统日志..." local report_file="$REPORT_DIR/system_log_report_$(date +%Y%m%d).md" { echo "# 系统日志分析报告" echo "## 生成时间: $(date &#39;+%Y-%m-%d %H:%M:%S&#39;)" echo echo "## 系统错误统计" echo "### 严重错误" echo &#39;```&#39; grep -i "error\|critical\|emergency" /var/log/syslog | \ tail -n 50 | sort | uniq -c | sort -nr echo &#39;```&#39; echo "### 认证失败" echo &#39;```&#39; grep "Failed password" /var/log/auth.log | \ awk &#39;{print $1,$2,$3,$11}&#39; | sort | uniq -c | sort -nr | head -n 10 echo &#39;```&#39; echo "### 系统重启记录" echo &#39;```&#39; last reboot | head -n 5 echo &#39;```&#39; } > "$report_file" } # 分析 Nginx 访问日志 analyze_nginx_logs() { log "分析 Nginx 访问日志..." local report_file="$REPORT_DIR/nginx_log_report_$(date +%Y%m%d).md" { echo "# Nginx 访问日志分析报告" echo "## 生成时间: $(date &#39;+%Y-%m-%d %H:%M:%S&#39;)" echo echo "## 访问统计" echo "### 请求量最大的 IP" echo &#39;```&#39; awk &#39;{print $1}&#39; /var/log/nginx/access.log | sort | uniq -c | sort -nr | head -n 10 echo &#39;```&#39; echo "### 访问量最大的页面" echo &#39;```&#39; awk &#39;{print $7}&#39; /var/log/nginx/access.log | sort | uniq -c | sort -nr | head -n 10 echo &#39;```&#39; echo "### HTTP 状态码统计" echo &#39;```&#39; awk &#39;{print $9}&#39; /var/log/nginx/access.log | sort | uniq -c | sort -nr echo &#39;```&#39; echo "### 每小时请求量统计" echo &#39;```&#39; awk &#39;{print $4}&#39; /var/log/nginx/access.log | cut -c 14-15 | sort | uniq -c | \ awk &#39;{printf("%s:00 - %s 请求\n", $2, $1)}&#39; echo &#39;```&#39; } > "$report_file" } # 分析 AI 服务日志 analyze_ai_logs() { log "分析 AI 服务日志..." local report_file="$REPORT_DIR/ai_log_report_$(date +%Y%m%d).md" local ai_log="/home/zhaoxiongzhou/logs/llama.log" if [ -f "$ai_log" ]; then { echo "# AI 服务日志分析报告" echo "## 生成时间: $(date &#39;+%Y-%m-%d %H:%M:%S&#39;)" echo echo "## 服务统计" echo "### 错误统计" echo &#39;```&#39; grep -i "error" "$ai_log" | tail -n 20 echo &#39;```&#39; echo "### 性能统计" echo "#### 响应时间分布" echo &#39;```&#39; grep "response_time" "$ai_log" | \ awk &#39;{sum+=$NF; count++} END {print "平均响应时间:", sum/count, "ms"}&#39; echo &#39;```&#39; echo "#### 内存使用统计" echo &#39;```&#39; grep "memory_usage" "$ai_log" | tail -n 10 echo &#39;```&#39; } > "$report_file" fi } # 生成安全报告 generate_security_report() { log "生成安全报告..." local report_file="$REPORT_DIR/security_report_$(date +%Y%m%d).md" { echo "# 安全分析报告" echo "## 生成时间: $(date &#39;+%Y-%m-%d %H:%M:%S&#39;)" echo echo "## 安全事件统计" echo "### SSH 暴力破解尝试" echo &#39;```&#39; grep "Failed password" /var/log/auth.log | \ awk &#39;{print $11,$13}&#39; | sort | uniq -c | sort -nr | head -n 10 echo &#39;```&#39; echo "### 可疑 IP 访问" echo &#39;```&#39; grep -i "suspicious\|attack\|hack" /var/log/nginx/access.log | \ awk &#39;{print $1}&#39; | sort | uniq -c | sort -nr echo &#39;```&#39; echo "### 文件权限变更" echo &#39;```&#39; find /etc -mtime -1 -type f -ls echo &#39;```&#39; } > "$report_file" } # 清理旧报告 cleanup_old_reports() { log "清理旧报告..." find "$REPORT_DIR" -type f -name "*.md" -mtime +$RETENTION_DAYS -delete } # 生成摘要报告 generate_summary() { log "生成摘要报告..." local summary_file="$REPORT_DIR/summary_$(date +%Y%m%d).md" { echo "# 日志分析摘要报告" echo "## 生成时间: $(date &#39;+%Y-%m-%d %H:%M:%S&#39;)" echo echo "## 关键指标" # 错误统计 local error_count=$(grep -i "error" /var/log/syslog | wc -l) local nginx_error_count=$(grep -i "error" /var/log/nginx/error.log | wc -l) echo "- 系统错误数: $error_count" echo "- Nginx 错误数: $nginx_error_count" # 安全事件 local ssh_fails=$(grep "Failed password" /var/log/auth.log | wc -l) echo "- SSH 失败尝试: $ssh_fails" # 告警判断 if [ $error_count -gt $ALERT_THRESHOLD ]; then ~/send_notification.sh "警告: 系统错误数超过阈值" "high" fi } > "$summary_file" } # 主函数 main() { log "开始日志分析..." # 执行分析 analyze_system_logs analyze_nginx_logs analyze_ai_logs generate_security_report generate_summary # 清理旧报告 cleanup_old_reports log "日志分析完成" } # 执行分析 main 三十五、系统优化工具 1. 系统优化脚本 # 创建系统优化脚本 nano ~/system_optimize.sh #!/bin/bash # ~/system_optimize.sh # 配置 LOG_FILE="/var/log/optimize.log" NGINX_CONF="/etc/nginx/nginx.conf" SYSCTL_CONF="/etc/sysctl.d/99-custom.conf" JOURNAL_CONF="/etc/systemd/journald.conf" # 日志函数 log() { echo "[$(date &#39;+%Y-%m-%d %H:%M:%S&#39;)] $1" | tee -a "$LOG_FILE" } # 优化系统参数 optimize_system() { log "优化系统参数..." # 备份原始配置 cp "$SYSCTL_CONF" "${SYSCTL_CONF}.backup" # 配置系统参数 cat > "$SYSCTL_CONF" << EOF # 网络优化 net.core.somaxconn = 2048 net.core.netdev_max_backlog = 4096 net.ipv4.tcp_max_syn_backlog = 4096 net.ipv4.tcp_fin_timeout = 30 net.ipv4.tcp_keepalive_time = 1200 net.ipv4.tcp_max_tw_buckets = 5000 net.ipv4.tcp_fastopen = 3 net.ipv4.tcp_rmem = 4096 87380 16777216 net.ipv4.tcp_wmem = 4096 65536 16777216 # 文件系统优化 fs.file-max = 100000 fs.inotify.max_user_watches = 524288 # 内存优化 vm.swappiness = 10 vm.dirty_ratio = 60 vm.dirty_background_ratio = 2 EOF # 应用系统参数 sysctl -p "$SYSCTL_CONF" } # 优化 Nginx 配置 optimize_nginx() { log "优化 Nginx 配置..." # 备份原始配置 cp "$NGINX_CONF" "${NGINX_CONF}.backup" # 配置 Nginx cat > "$NGINX_CONF" << EOF user www-data; worker_processes auto; worker_rlimit_nofile 100000; events { worker_connections 2048; multi_accept on; use epoll; } http { # 基础设置 sendfile on; tcp_nopush on; tcp_nodelay on; keepalive_timeout 65; types_hash_max_size 2048; server_tokens off; # MIME 类型 include /etc/nginx/mime.types; default_type application/octet-stream; # 日志格式 log_format main &#39;\$remote_addr - \$remote_user [\$time_local] "\$request" &#39; &#39;\$status \$body_bytes_sent "\$http_referer" &#39; &#39;"\$http_user_agent" "\$http_x_forwarded_for"&#39;; # 缓冲区设置 client_body_buffer_size 128k; client_max_body_size 10m; client_header_buffer_size 1k; large_client_header_buffers 4 4k; # Gzip 压缩 gzip on; gzip_vary on; gzip_proxied any; gzip_comp_level 6; gzip_types text/plain text/css application/json application/javascript text/xml application/xml application/xml+rss text/javascript; # SSL 优化 ssl_protocols TLSv1.2 TLSv1.3; ssl_prefer_server_ciphers on; ssl_session_cache shared:SSL:10m; ssl_session_timeout 10m; # 包含其他配置 include /etc/nginx/conf.d/*.conf; include /etc/nginx/sites-enabled/*; } EOF # 测试配置 nginx -t && systemctl restart nginx } # 优化系统服务 optimize_services() { log "优化系统服务..." # 禁用不必要的服务 local unnecessary_services=( "bluetooth" "cups" "avahi-daemon" ) for service in "${unnecessary_services[@]}"; do if systemctl is-active --quiet "$service"; then systemctl stop "$service" systemctl disable "$service" log "已禁用服务: $service" fi done # 优化日志服务 cat > "$JOURNAL_CONF" << EOF [Journal] SystemMaxUse=100M SystemMaxFileSize=10M RuntimeMaxUse=50M RuntimeMaxFileSize=5M EOF # 重启日志服务 systemctl restart systemd-journald } # 优化文件系统 optimize_filesystem() { log "优化文件系统..." # 清理临时文件 find /tmp -type f -atime +10 -delete find /var/tmp -type f -atime +10 -delete # 清理日志 find /var/log -type f -name "*.gz" -delete find /var/log -type f -name "*.old" -delete # 优化日志轮转 cat > /etc/logrotate.d/custom << EOF /var/log/custom/*.log { daily rotate 7 compress delaycompress missingok notifempty create 640 root adm } EOF } # 优化内存使用 optimize_memory() { log "优化内存使用..." # 清理缓存 sync; echo 3 > /proc/sys/vm/drop_caches # 配置 swap 使用 if [ -f /swapfile ]; then swapoff /swapfile dd if=/dev/zero of=/swapfile bs=1M count=2048 chmod 600 /swapfile mkswap /swapfile swapon /swapfile fi } # 验证优化 verify_optimization() { log "验证系统优化..." local status=0 # 检查系统负载 local load=$(uptime | awk -F&#39;load average:&#39; &#39;{print $2}&#39; | cut -d, -f1) if [ $(echo "$load > 2" | bc -l) -eq 1 ]; then log "警告: 系统负载较高 ($load)" status=1 fi # 检查内存使用 local mem_usage=$(free | grep Mem | awk &#39;{print $3/$2 * 100.0}&#39;) if [ $(echo "$mem_usage > 90" | bc -l) -eq 1 ]; then log "警告: 内存使用率过高 ($mem_usage%)" status=1 fi # 检查服务状态 if ! systemctl is-active --quiet nginx; then log "错误: Nginx 服务未正常运行" status=1 fi return $status } # 主函数 main() { log "开始系统优化..." optimize_system optimize_nginx optimize_services optimize_filesystem optimize_memory if verify_optimization; then log "系统优化成功完成" ~/send_notification.sh "系统优化已完成" "normal" else log "系统优化完成，但存在警告" ~/send_notification.sh "系统优化完成，但需要检查" "high" fi } # 执行优化 main 三十六、部署后检查清单 1. 部署检查脚本 # 创建部署检查脚本 nano ~/deployment_checklist.sh #!/bin/bash # ~/deployment_checklist.sh # 配置 LOG_FILE="/var/log/deployment_check.log" REPORT_FILE="/home/zhaoxiongzhou/deployment_report.md" CHECK_INTERVAL=300 # 检查间隔（秒） # 日志函数 log() { echo "[$(date &#39;+%Y-%m-%d %H:%M:%S&#39;)] $1" | tee -a "$LOG_FILE" } # 检查系统基础配置 check_system_basics() { log "检查系统基础配置..." local status=0 { echo "## 系统基础检查" echo "### 系统信息" echo "- 主机名: $(hostname)" echo "- 系统版本: $(cat /etc/os-release | grep PRETTY_NAME)" echo "- 内核版本: $(uname -r)" echo "- 运行时间: $(uptime -p)" echo echo "### 资源使用" echo "- CPU 使用率: $(top -bn1 | grep "Cpu(s)" | awk &#39;{print $2}&#39;)%" echo "- 内存使用率: $(free | grep Mem | awk &#39;{print $3/$2 * 100.0}&#39;)%" echo "- 磁盘使用率: $(df -h / | awk &#39;NR==2 {print $5}&#39;)" echo } > "$REPORT_FILE" return $status } # 检查网络配置 check_network() { log "检查网络配置..." local status=0 { echo "### 网络配置" echo "#### IP 配置" echo &#39;```&#39; ip addr show echo &#39;```&#39; echo "#### 路由表" echo &#39;```&#39; ip route echo &#39;```&#39; echo "#### 开放端口" echo &#39;```&#39; netstat -tuln echo &#39;```&#39; echo "#### DNS 配置" echo &#39;```&#39; cat /etc/resolv.conf echo &#39;```&#39; } >> "$REPORT_FILE" return $status } # 检查服务配置 check_services() { log "检查服务配置..." local status=0 { echo "### 服务状态" echo "#### Nginx 配置" echo &#39;```&#39; nginx -T echo &#39;```&#39; echo "#### 服务运行状态" echo &#39;```&#39; systemctl status nginx systemctl status mysql ps aux | grep llama-server echo &#39;```&#39; echo "#### 服务日志检查" echo &#39;```&#39; tail -n 20 /var/log/nginx/error.log echo &#39;```&#39; } >> "$REPORT_FILE" return $status } # 检查安全配置 check_security() { log "检查安全配置..." local status=0 { echo "### 安全检查" echo "#### 防火墙规则" echo &#39;```&#39; sudo iptables -L echo &#39;```&#39; echo "#### SSH 配置" echo &#39;```&#39; grep -v &#39;^#&#39; /etc/ssh/sshd_config echo &#39;```&#39; echo "#### 用户权限" echo &#39;```&#39; ls -la /home/zhaoxiongzhou/ ls -la /var/www/ echo &#39;```&#39; echo "#### SSL 证书" echo &#39;```&#39; openssl x509 -in /etc/nginx/ssl/server.crt -text -noout echo &#39;```&#39; } >> "$REPORT_FILE" return $status } # 检查备份配置 check_backups() { log "检查备份配置..." local status=0 { echo "### 备份检查" echo "#### 备份配置" echo &#39;```&#39; ls -lh /mnt/backup_drive/system_backups/ echo &#39;```&#39; echo "#### 最近备份状态" echo &#39;```&#39; tail -n 20 /var/log/backup.log echo &#39;```&#39; } >> "$REPORT_FILE" return $status } # 检查监控配置 check_monitoring() { log "检查监控配置..." local status=0 { echo "### 监控检查" echo "#### 监控脚本状态" echo &#39;```&#39; ps aux | grep monitor echo &#39;```&#39; echo "#### 告警配置" echo &#39;```&#39; cat ~/send_notification.sh echo &#39;```&#39; } >> "$REPORT_FILE" return $status } # 生成总结报告 generate_summary() { log "生成总结报告..." { echo "## 部署检查总结" echo "### 检查时间: $(date &#39;+%Y-%m-%d %H:%M:%S&#39;)" echo echo "### 主要发现" echo "1. 系统状态: $([ $system_status -eq 0 ] && echo &#39;正常 ✅&#39; || echo &#39;异常 ❌&#39;)" echo "2. 网络配置: $([ $network_status -eq 0 ] && echo &#39;正常 ✅&#39; || echo &#39;异常 ❌&#39;)" echo "3. 服务状态: $([ $services_status -eq 0 ] && echo &#39;正常 ✅&#39; || echo &#39;异常 ❌&#39;)" echo "4. 安全配置: $([ $security_status -eq 0 ] && echo &#39;正常 ✅&#39; || echo &#39;异常 ❌&#39;)" echo "5. 备份状态: $([ $backup_status -eq 0 ] && echo &#39;正常 ✅&#39; || echo &#39;异常 ❌&#39;)" echo "6. 监控状态: $([ $monitoring_status -eq 0 ] && echo &#39;正常 ✅&#39; || echo &#39;异常 ❌&#39;)" echo echo "### 建议操作" [ $system_status -ne 0 ] && echo "- 检查系统资源使用情况" [ $network_status -ne 0 ] && echo "- 验证网络配置" [ $services_status -ne 0 ] && echo "- 检查服务运行状态" [ $security_status -ne 0 ] && echo "- 审查安全配置" [ $backup_status -ne 0 ] && echo "- 确认备份是否正常" [ $monitoring_status -ne 0 ] && echo "- 检查监控系统" } >> "$REPORT_FILE" } # 主函数 main() { log "开始部署后检查..." # 执行检查 check_system_basics system_status=$? check_network network_status=$? check_services services_status=$? check_security security_status=$? check_backups backup_status=$? check_monitoring monitoring_status=$? # 生成总结 generate_summary # 发送通知 if [ $system_status -eq 0 ] && [ $network_status -eq 0 ] && \ [ $services_status -eq 0 ] && [ $security_status -eq 0 ] && \ [ $backup_status -eq 0 ] && [ $monitoring_status -eq 0 ]; then ~/send_notification.sh "部署检查完成：所有项目正常" "normal" else ~/send_notification.sh "部署检查完成：存在需要关注的项目" "high" fi log "部署检查完成，报告已生成: $REPORT_FILE" } # 执行检查 main 《树莓派服务部署与维护完整指南》总共包含了 36 个部分，涵盖了从系统部署到维护的各个方面。每个脚本都经过精心设计，可以独立运行，也可以互相配合使用。'><meta property="og:locale" content="zh"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2024-12-03T18:00:00+08:00"><meta property="article:modified_time" content="2024-12-03T18:00:00+08:00"><meta property="article:tag" content="RaspberryPi"><meta property="article:tag" content="Hugo"><meta property="article:tag" content="教程"><meta name=twitter:card content="summary"><meta name=twitter:title content="树莓派服务部署与维护完整指南"><meta name=twitter:description content='树莓派服务部署与维护完整指南 一、系统概况 1. 硬件资源 处理器: ARM64 架构 总内存: 3.7GB 可用内存: ~2.5GB Swap: 512MB 网络: wlan0 (IP: 10.40.110.47) 2. 服务概览 AI 智能助手 端口: 8080 基于: llama.cpp 模型: Phi-3-mini-4k-instruct-q4.gguf 资源占用: CPU: ~300% (多核) 内存: ~3GB Swap: 511Mi 个人博客 端口: 80 框架: Hugo v0.139.3-extended 主题: Ananke Web服务器: Nginx 资源占用: 轻量级 3. 服务访问 AI 助手: http://10.40.110.47:8080 博客开发: http://10.40.110.47:1313 博客正式: http://10.40.110.47 二、AI 智能助手部署 1. 环境准备 # 更新系统 sudo apt update sudo apt upgrade -y # 安装依赖 sudo apt install build-essential git cmake 2. 编译安装 # 克隆仓库 git clone https://github.com/ggerganov/llama.cpp.git cd llama.cpp # 编译 make clean LLAMA_METAL=1 make -j4 3. 模型配置 # 创建模型目录 mkdir models cd models # 下载模型文件 wget [模型下载地址]/Phi-3-mini-4k-instruct-q4.gguf # 验证模型文件 sha256sum Phi-3-mini-4k-instruct-q4.gguf 4. 服务配置 # 创建启动脚本 nano ~/projects/llama.cpp/start-llama.sh #!/bin/bash cd ~/projects/llama.cpp nohup ./llama-server \ -m models/Phi-3-mini-4k-instruct-q4.gguf \ --host 0.0.0.0 \ --port 8080 \ --ctx-size 2048 \ --threads 2 \ --batch-size 256 \ > llama.log 2>&amp;1 & # 设置执行权限 chmod +x start-llama.sh # 启动服务 ./start-llama.sh # 验证服务状态 ps aux | grep llama-server netstat -tuln | grep 8080 三、个人博客部署 1. Hugo 安装 # 下载 Hugo Extended 版本 wget https://github.com/gohugoio/hugo/releases/download/v0.139.3/hugo_extended_0.139.3_linux-arm64.deb # 安装 sudo dpkg -i hugo_extended_0.139.3_linux-arm64.deb # 验证安装 hugo version 2. 博客初始化 # 创建站点 cd ~ hugo new site myblog cd myblog # 初始化 Git git init # 添加主题 git submodule add https://github.com/theNewDynamic/gohugo-theme-ananke.git themes/ananke 3. 博客配置 # 编辑配置文件 nano config.toml baseURL = "http://10.40.110.47/" languageCode = "zh-cn" title = "My Blog" theme = "ananke" [params] author = "Your Name" description = "Welcome to my blog" dateFormat = "2006-01-02" background_color_class = "bg-black" recent_posts_number = 3 mainSections = ["posts"] featured_image = false [menu] [[menu.main]] identifier = "posts" name = "文章" url = "/posts/" weight = 1 [[menu.main]] identifier = "about" name = "关于" url = "/about/" weight = 2 4. Nginx 配置 # 安装 Nginx sudo apt install nginx # 创建配置文件 sudo nano /etc/nginx/sites-available/myblog server { listen 80; server_name 10.40.110.47; root /home/zhaoxiongzhou/myblog/public; index index.html; location / { try_files $uri $uri/ =404; } access_log /var/log/nginx/myblog_access.log; error_log /var/log/nginx/myblog_error.log; } # 启用配置 sudo ln -s /etc/nginx/sites-available/myblog /etc/nginx/sites-enabled/ sudo rm /etc/nginx/sites-enabled/default # 测试配置 sudo nginx -t # 重启 Nginx sudo systemctl restart nginx 四、权限与自动化配置 1. 权限设置 # 设置目录权限 sudo chmod 755 /home/zhaoxiongzhou sudo chmod -R 755 /home/zhaoxiongzhou/myblog # 设置文件所有权 sudo chown -R www-data:www-data /home/zhaoxiongzhou/myblog/public # 验证权限 ls -la ~/myblog/public ls -la /home/zhaoxiongzhou 2. 自动部署脚本 # 创建博客部署脚本 nano ~/deploy-blog.sh #!/bin/bash cd ~/myblog hugo sudo chown -R www-data:www-data public/ sudo systemctl restart nginx # 设置执行权限 chmod +x ~/deploy-blog.sh 3. 备份脚本 # 创建备份脚本 nano ~/backup-blog.sh #!/bin/bash BACKUP_DIR="/home/zhaoxiongzhou/backups" DATE=$(date +%Y%m%d) # 创建备份目录 mkdir -p $BACKUP_DIR # 备份博客内容 tar -czf $BACKUP_DIR/blog_$DATE.tar.gz ~/myblog/content # 备份配置文件 cp ~/myblog/config.toml $BACKUP_DIR/config_$DATE.toml # 删除30天前的备份 find $BACKUP_DIR -name "*.tar.gz" -mtime +30 -delete # 设置执行权限 chmod +x ~/backup-blog.sh # 配置定时任务 crontab -e # 添加定时任务（每周日凌晨2点执行备份） 0 2 * * 0 /home/zhaoxiongzhou/backup-blog.sh 五、系统维护与监控 1. 资源监控命令 # 系统资源监控 htop top free -h vmstat 1 # 磁盘使用监控 df -h du -sh /* du -sh ~/myblog du -sh ~/projects/llama.cpp # 温度监控 vcgencmd measure_temp 2. 性能优化 # 清理系统缓存 sudo sync; echo 3 | sudo tee /proc/sys/vm/drop_caches # 调整 Swap 设置 cat /proc/sys/vm/swappiness sudo sysctl vm.swappiness=60 # CPU 频率调整 sudo nano /boot/config.txt # CPU 配置参数 arm_freq=1800 over_voltage=6 temp_limit=75 3. 系统维护 # 系统更新 sudo apt update sudo apt upgrade -y sudo apt autoremove sudo apt clean # 日志清理 sudo find /var/log -type f -name "*.log" -mtime +30 -delete sudo find /var/log -type f -name "*.gz" -delete # 服务状态检查 systemctl status nginx ps aux | grep llama-server 六、安全配置 1. 防火墙设置 # 安装 UFW sudo apt install ufw # 配置基本规则 sudo ufw default deny incoming sudo ufw default allow outgoing sudo ufw allow 22 sudo ufw allow 80 sudo ufw allow 8080 # 启用防火墙 sudo ufw enable # 检查状态 sudo ufw status 2. Nginx 访问控制 # 安装认证工具 sudo apt install apache2-utils # 创建用户密码 sudo htpasswd -c /etc/nginx/.htpasswd username # 修改 Nginx 配置 sudo nano /etc/nginx/sites-available/myblog server { listen 80; server_name 10.40.110.47; root /home/zhaoxiongzhou/myblog/public; index index.html; # 添加基本认证 location / { auth_basic "Restricted Access"; auth_basic_user_file /etc/nginx/.htpasswd; try_files $uri $uri/ =404; } # 日志配置 access_log /var/log/nginx/myblog_access.log; error_log /var/log/nginx/myblog_error.log; } 3. 日志监控 # 安装日志监控工具 sudo apt install logwatch # 配置日志监控 sudo nano /etc/logwatch/conf/logwatch.conf # 配置每日日志检查 Output = mail Format = html MailTo = your-email@domain.com Detail = High 七、故障排除指南 内存相关问题 # 检查内存状态 free -h ps aux --sort=-%mem | head # 如果内存不足，调整服务参数 nano ~/projects/llama.cpp/start-llama.sh # 降低资源使用的参数示例 --ctx-size 1024 \ --batch-size 128 \ --threads 1 服务无响应 # 检查进程 ps aux | grep llama-server # 检查端口 netstat -tuln | grep 8080 # 重启服务 pkill llama-server ./start-llama.sh # 检查日志 tail -f ~/projects/llama.cpp/llama.log 2. 博客服务故障排除 Nginx 问题 # 检查配置语法 sudo nginx -t # 检查日志 sudo tail -f /var/log/nginx/error.log sudo tail -f /var/log/nginx/myblog_error.log # 检查服务状态 sudo systemctl status nginx # 重启服务 sudo systemctl restart nginx Hugo 生成问题 # 清理缓存 rm -rf ~/myblog/public rm -rf ~/myblog/resources # 更新主题 git submodule update --init --recursive # 重新生成（详细模式） hugo --verbose 八、系统级故障排除 1. 磁盘问题 # 检查磁盘使用情况 df -h du -sh /* # 查找大文件 sudo find / -type f -size +100M # 清理空间 sudo apt clean sudo apt autoremove sudo journalctl --vacuum-time=7d 2. 网络问题 # 网络状态检查 ip addr show ping -c 4 8.8.8.8 netstat -tuln # DNS 检查 cat /etc/resolv.conf nslookup google.com # 重启网络服务 sudo systemctl restart networking sudo systemctl restart wpa_supplicant 3. 性能问题 # CPU 温度监控 vcgencmd measure_temp watch -n 1 vcgencmd measure_temp # CPU 频率检查 vcgencmd measure_clock arm cat /sys/devices/system/cpu/cpu0/cpufreq/scaling_cur_freq # 系统负载检查 uptime cat /proc/loadavg 九、维护最佳实践 1. 日常维护清单 检查系统日志 监控资源使用 验证服务状态 检查备份状态 更新系统安全补丁 2. 周期性维护任务 清理旧日志和临时文件 验证备份完整性 检查系统更新 检查服务性能 更新文档和配置说明 3. 应急预案 保存所有配置文件的备份 记录所有服务的配置步骤 维护问题解决方案文档 建立服务恢复流程 保持重要数据的多份备份 十、性能优化建议 1. 系统级优化 # 1. 调整 SWAP 设置 sudo nano /etc/sysctl.conf # 添加或修改以下参数 vm.swappiness=60 vm.vfs_cache_pressure=50 vm.dirty_background_ratio=5 vm.dirty_ratio=10 # 2. 优化文件系统 # 检查并优化文件系统 sudo tune2fs -o journal_data_writeback /dev/mmcblk0p2 # 3. 调整 CPU 性能 sudo nano /boot/config.txt # 添加以下配置 arm_freq=1800 over_voltage=6 gpu_freq=500 dtparam=audio=on 2. 服务优化 AI 服务优化 # 调整服务参数 nano ~/projects/llama.cpp/start-llama.sh # 优化参数示例 --ctx-size 2048 \ --threads 2 \ --batch-size 256 \ --keep-context \ --mlock \ --numa Nginx 优化 sudo nano /etc/nginx/nginx.conf worker_processes auto; worker_rlimit_nofile 65535; events { worker_connections 1024; multi_accept on; use epoll; } http { sendfile on; tcp_nopush on; tcp_nodelay on; keepalive_timeout 65; types_hash_max_size 2048; server_tokens off; # 缓存设置 open_file_cache max=1000 inactive=20s; open_file_cache_valid 30s; open_file_cache_min_uses 2; open_file_cache_errors on; } 十一、监控与报警系统 1. 系统监控配置 # 安装监控工具 sudo apt install prometheus node-exporter grafana # 配置 Prometheus sudo nano /etc/prometheus/prometheus.yml global: scrape_interval: 15s scrape_configs: - job_name: &#39;node&#39; static_configs: - targets: [&#39;localhost:9100&#39;] - job_name: &#39;nginx&#39; static_configs: - targets: [&#39;localhost:9113&#39;] 2. 自动报警脚本 # 创建监控脚本 nano ~/monitor.sh #!/bin/bash # 定义阈值 MAX_CPU_USAGE=90 MAX_MEM_USAGE=90 MAX_DISK_USAGE=90 MAX_TEMP=75 # 获取系统数据 CPU_USAGE=$(top -bn1 | grep "Cpu(s)" | awk &#39;{print $2}&#39; | cut -d. -f1) MEM_USAGE=$(free | grep Mem | awk &#39;{print $3/$2 * 100.0}&#39;) DISK_USAGE=$(df -h / | awk &#39;NR==2 {print $5}&#39; | cut -d% -f1) TEMP=$(vcgencmd measure_temp | cut -d= -f2 | cut -d. -f1) # 检查服务状态 check_services() { services=("nginx" "llama-server") for service in "${services[@]}"; do if ! pgrep -x "$service" > /dev/null; then echo "警告: $service 服务未运行!" # 可以添加重启服务的命令 fi done } # 发送警告 send_alert() { message="$1" # 这里可以添加发送邮件或其他通知的命令 echo "$message" >> /var/log/system_alerts.log } # 检查各项指标 if [ "$CPU_USAGE" -gt "$MAX_CPU_USAGE" ]; then send_alert "CPU 使用率过高: $CPU_USAGE%" fi if [ "${MEM_USAGE%.*}" -gt "$MAX_MEM_USAGE" ]; then send_alert "内存使用率过高: $MEM_USAGE%" fi if [ "$DISK_USAGE" -gt "$MAX_DISK_USAGE" ]; then send_alert "磁盘使用率过高: $DISK_USAGE%" fi if [ "$TEMP" -gt "$MAX_TEMP" ]; then send_alert "系统温度过高: $TEMP°C" fi # 检查服务状态 check_services # 设置执行权限 chmod +x ~/monitor.sh # 添加到 crontab crontab -e # 每5分钟执行一次监控 */5 * * * * /home/zhaoxiongzhou/monitor.sh 十二、数据备份与恢复 1. 完整备份方案 # 创建完整备份脚本 nano ~/full-backup.sh #!/bin/bash BACKUP_ROOT="/home/zhaoxiongzhou/backups" DATE=$(date +%Y%m%d_%H%M%S) BACKUP_DIR="$BACKUP_ROOT/$DATE" # 创建备份目录 mkdir -p "$BACKUP_DIR" # 备份博客内容 echo "备份博客内容..." tar -czf "$BACKUP_DIR/blog_content.tar.gz" ~/myblog/content tar -czf "$BACKUP_DIR/blog_config.tar.gz" ~/myblog/config.toml # 备份 AI 模型和配置 echo "备份 AI 服务..." tar -czf "$BACKUP_DIR/llama_models.tar.gz" ~/projects/llama.cpp/models tar -czf "$BACKUP_DIR/llama_config.tar.gz" ~/projects/llama.cpp/start-llama.sh # 备份 Nginx 配置 echo "备份 Nginx 配置..." sudo tar -czf "$BACKUP_DIR/nginx_config.tar.gz" /etc/nginx/sites-available/myblog # 备份系统配置 echo "备份系统配置..." sudo tar -czf "$BACKUP_DIR/system_config.tar.gz" /boot/config.txt /etc/fstab # 创建备份清单 echo "创建备份清单..." find "$BACKUP_DIR" -type f -exec sha256sum {} \; > "$BACKUP_DIR/checksum.txt" # 清理旧备份（保留最近7份） cd "$BACKUP_ROOT" ls -t | tail -n +8 | xargs -r rm -r echo "备份完成: $BACKUP_DIR" 2. 数据恢复流程 # 创建恢复脚本 nano ~/restore.sh #!/bin/bash if [ -z "$1" ]; then echo "使用方法: $0 <备份目录>" exit 1 fi BACKUP_DIR="$1" # 验证备份完整性 echo "验证备份完整性..." cd "$BACKUP_DIR" sha256sum -c checksum.txt || { echo "备份验证失败！" exit 1 } # 恢复博客内容 echo "恢复博客内容..." tar -xzf "$BACKUP_DIR/blog_content.tar.gz" -C ~/myblog/ tar -xzf "$BACKUP_DIR/blog_config.tar.gz" -C ~/myblog/ # 恢复 AI 服务 echo "恢复 AI 服务..." tar -xzf "$BACKUP_DIR/llama_models.tar.gz" -C ~/projects/llama.cpp/ tar -xzf "$BACKUP_DIR/llama_config.tar.gz" -C ~/projects/llama.cpp/ # 恢复 Nginx 配置 echo "恢复 Nginx 配置..." sudo tar -xzf "$BACKUP_DIR/nginx_config.tar.gz" -C /etc/nginx/sites-available/ # 恢复系统配置 echo "恢复系统配置..." sudo tar -xzf "$BACKUP_DIR/system_config.tar.gz" -C / # 重启服务 echo "重启服务..." sudo systemctl restart nginx pkill llama-server ~/projects/llama.cpp/start-llama.sh echo "恢复完成" 十三、服务升级指南 1. Hugo 博客升级 # 1. 备份当前版本 cd ~ tar -czf hugo_backup_$(date +%Y%m%d).tar.gz myblog/ # 2. 检查当前版本 hugo version # 3. 下载新版本 wget https://github.com/gohugoio/hugo/releases/download/v[新版本]/hugo_extended_[新版本]_linux-arm64.deb # 4. 安装新版本 sudo dpkg -i hugo_extended_[新版本]_linux-arm64.deb # 5. 更新主题 cd ~/myblog git submodule update --remote themes/ananke # 6. 测试生成 hugo --verbose # 7. 部署更新 ./deploy-blog.sh 2. AI 服务升级 # 1. 备份当前版本 cd ~/projects tar -czf llama_backup_$(date +%Y%m%d).tar.gz llama.cpp/ # 2. 更新源码 cd llama.cpp git pull origin master # 3. 重新编译 make clean LLAMA_METAL=1 make -j4 # 4. 测试新版本 ./llama-server -h # 5. 更新启动脚本 nano start-llama.sh 3. 系统升级 # 1. 更新软件包列表 sudo apt update # 2. 升级所有包 sudo apt upgrade -y # 3. 升级系统 sudo apt dist-upgrade -y # 4. 清理旧包 sudo apt autoremove -y sudo apt clean # 5. 检查启动项 sudo systemctl list-unit-files --state=enabled # 6. 更新树莓派固件 sudo rpi-update # 7. 检查系统状态 sudo systemctl --failed sudo journalctl -p 3 -xb 十四、安全加固指南 1. 系统安全配置 # 1. SSH 安全配置 sudo nano /etc/ssh/sshd_config # SSH 配置建议 Port 22222 # 修改默认端口 PermitRootLogin no # 禁止 root 登录 PasswordAuthentication no # 禁用密码认证 PubkeyAuthentication yes # 启用密钥认证 AllowUsers zhaoxiongzhou # 限制允许的用户 # 2. 设置防火墙规则 sudo apt install ufw fail2ban # 配置 UFW sudo ufw default deny incoming sudo ufw default allow outgoing sudo ufw allow 22222/tcp # SSH sudo ufw allow 80/tcp # HTTP sudo ufw allow 8080/tcp # AI 服务 sudo ufw enable # 配置 fail2ban sudo nano /etc/fail2ban/jail.local [sshd] enabled = true port = 22222 filter = sshd logpath = /var/log/auth.log maxretry = 3 bantime = 3600 2. 服务安全配置 Nginx 安全设置 # 1. 创建 SSL 证书 sudo openssl req -x509 -nodes -days 365 -newkey rsa:2048 \ -keyout /etc/nginx/ssl/nginx.key \ -out /etc/nginx/ssl/nginx.crt # 2. 配置 HTTPS sudo nano /etc/nginx/sites-available/myblog server { listen 443 ssl; server_name 10.40.110.47; ssl_certificate /etc/nginx/ssl/nginx.crt; ssl_certificate_key /etc/nginx/ssl/nginx.key; # SSL 配置 ssl_protocols TLSv1.2 TLSv1.3; ssl_prefer_server_ciphers on; ssl_ciphers ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256; # 安全头部 add_header X-Frame-Options "SAMEORIGIN"; add_header X-XSS-Protection "1; mode=block"; add_header X-Content-Type-Options "nosniff"; add_header Strict-Transport-Security "max-age=31536000"; # 其他配置... } 十五、性能监控与分析 1. 监控脚本配置 # 创建综合监控脚本 nano ~/system_monitor.sh #!/bin/bash LOG_FILE="/var/log/system_monitor.log" ALERT_FILE="/var/log/system_alerts.log" # 记录时间戳 timestamp() { date "+%Y-%m-%d %H:%M:%S" } # 系统资源监控 monitor_resources() { echo "=== 系统资源监控 $(timestamp) ===" >> "$LOG_FILE" # CPU 使用率 CPU_USAGE=$(top -bn1 | grep "Cpu(s)" | awk &#39;{print $2}&#39;) echo "CPU 使用率: $CPU_USAGE%" >> "$LOG_FILE" # 内存使用 free -h | grep "Mem:" >> "$LOG_FILE" # 磁盘使用 df -h / >> "$LOG_FILE" # 系统负载 uptime >> "$LOG_FILE" # CPU 温度 vcgencmd measure_temp >> "$LOG_FILE" } # 服务状态监控 monitor_services() { echo "=== 服务状态监控 $(timestamp) ===" >> "$LOG_FILE" # Nginx 状态 if systemctl is-active nginx >/dev/null 2>&amp;1; then echo "Nginx: 运行中" >> "$LOG_FILE" else echo "警告: Nginx 未运行!" >> "$ALERT_FILE" fi # AI 服务状态 if pgrep -f llama-server >/dev/null; then echo "AI 服务: 运行中" >> "$LOG_FILE" else echo "警告: AI 服务未运行!" >> "$ALERT_FILE" fi } # 网络监控 monitor_network() { echo "=== 网络监控 $(timestamp) ===" >> "$LOG_FILE" # 网络连接数 netstat -an | grep ESTABLISHED | wc -l >> "$LOG_FILE" # 网络流量 ifconfig wlan0 | grep bytes >> "$LOG_FILE" } # 主函数 main() { monitor_resources monitor_services monitor_network # 检查是否需要发送警告 if [ -s "$ALERT_FILE" ]; then # 可以添加发送警告的命令（如邮件通知） cat "$ALERT_FILE" fi } # 执行监控 main 2. 性能分析工具 # 安装性能分析工具 sudo apt install sysstat iotop htop # 创建性能数据收集脚本 nano ~/collect_performance.sh 十六、性能数据收集与分析 1. 性能数据收集脚本 #!/bin/bash # ~/collect_performance.sh PERF_DIR="/home/zhaoxiongzhou/performance_data" DATE=$(date +%Y%m%d_%H%M%S) # 创建数据目录 mkdir -p "$PERF_DIR/$DATE" # CPU 性能数据 mpstat 1 60 > "$PERF_DIR/$DATE/cpu_stats.log" & # 内存使用数据 vmstat 1 60 > "$PERF_DIR/$DATE/memory_stats.log" & # IO 性能数据 iostat -x 1 60 > "$PERF_DIR/$DATE/io_stats.log" & # 网络性能数据 sar -n DEV 1 60 > "$PERF_DIR/$DATE/network_stats.log" & # 进程性能数据 ps aux --sort=-%cpu | head -n 20 > "$PERF_DIR/$DATE/top_processes.log" # 系统负载数据 uptime > "$PERF_DIR/$DATE/load_average.log" # 等待所有后台进程完成 wait # 压缩数据 tar -czf "$PERF_DIR/performance_${DATE}.tar.gz" "$PERF_DIR/$DATE" rm -rf "$PERF_DIR/$DATE" 2. 性能数据分析脚本 # 创建分析脚本 nano ~/analyze_performance.sh #!/bin/bash # ~/analyze_performance.sh PERF_DIR="/home/zhaoxiongzhou/performance_data" REPORT_DIR="/home/zhaoxiongzhou/performance_reports" DATE=$(date +%Y%m%d) mkdir -p "$REPORT_DIR" generate_report() { local REPORT_FILE="$REPORT_DIR/report_${DATE}.txt" echo "性能分析报告 - $(date)" > "$REPORT_FILE" echo "===================" >> "$REPORT_FILE" # CPU 使用分析 echo -e "\nCPU 使用情况:" >> "$REPORT_FILE" awk &#39;/all/ {total += $3; count++} END {print "平均CPU使用率: " total/count "%"}&#39; \ "$PERF_DIR/latest/cpu_stats.log" >> "$REPORT_FILE" # 内存使用分析 echo -e "\n内存使用情况:" >> "$REPORT_FILE" free -h | grep "Mem:" >> "$REPORT_FILE" # IO 性能分析 echo -e "\nIO 性能:" >> "$REPORT_FILE" tail -n 10 "$PERF_DIR/latest/io_stats.log" >> "$REPORT_FILE" # 网络性能分析 echo -e "\n网络性能:" >> "$REPORT_FILE" tail -n 10 "$PERF_DIR/latest/network_stats.log" >> "$REPORT_FILE" # 进程分析 echo -e "\n资源占用最高的进程:" >> "$REPORT_FILE" head -n 5 "$PERF_DIR/latest/top_processes.log" >> "$REPORT_FILE" echo -e "\n分析完成。报告保存在: $REPORT_FILE" } # 生成报告 generate_report 十七、自动化运维脚本 1. 服务健康检查与自动恢复 # 创建服务监控脚本 nano ~/service_health_check.sh #!/bin/bash # ~/service_health_check.sh LOG_FILE="/var/log/service_health.log" ALERT_SCRIPT="/home/zhaoxiongzhou/send_alert.sh" log_message() { echo "[$(date &#39;+%Y-%m-%d %H:%M:%S&#39;)] $1" >> "$LOG_FILE" } check_and_restart_service() { local service_name="$1" local process_pattern="$2" if ! pgrep -f "$process_pattern" > /dev/null; then log_message "警告: $service_name 服务未运行，尝试重启" case "$service_name" in "nginx") sudo systemctl restart nginx ;; "llama-server") cd ~/projects/llama.cpp ./start-llama.sh ;; esac # 等待服务启动 sleep 10 # 验证服务是否成功重启 if pgrep -f "$process_pattern" > /dev/null; then log_message "$service_name 服务已成功重启" "$ALERT_SCRIPT" "$service_name 服务已自动重启" else log_message "错误: $service_name 服务重启失败" "$ALERT_SCRIPT" "警告: $service_name 服务重启失败，需要手动干预" fi else log_message "$service_name 服务运行正常" fi } # 检查各个服务 check_and_restart_service "nginx" "nginx" check_and_restart_service "llama-server" "llama-server" # 清理旧日志 find "$LOG_FILE" -mtime +30 -delete 2. 自动备份与清理 # 创建自动维护脚本 nano ~/auto_maintenance.sh #!/bin/bash # ~/auto_maintenance.sh BACKUP_DIR="/home/zhaoxiongzhou/backups" LOG_DIR="/var/log" DATE=$(date +%Y%m%d) # 创建备份 create_backups() { # 博客备份 tar -czf "$BACKUP_DIR/blog_$DATE.tar.gz" ~/myblog/content # AI 服务配置备份 tar -czf "$BACKUP_DIR/llama_config_$DATE.tar.gz" ~/projects/llama.cpp/start-llama.sh # Nginx 配置备份 sudo tar -czf "$BACKUP_DIR/nginx_config_$DATE.tar.gz" /etc/nginx/sites-available/ } # 清理旧文件 cleanup_old_files() { # 删除30天前的备份 find "$BACKUP_DIR" -name "*.tar.gz" -mtime +30 -delete # 清理日志 sudo find "$LOG_DIR" -name "*.log" -mtime +30 -delete sudo find "$LOG_DIR" -name "*.gz" -mtime +30 -delete # 清理系统临时文件 sudo rm -rf /tmp/* sudo rm -rf /var/tmp/* } # 主函数 main() { create_backups cleanup_old_files # 压缩日志 sudo logrotate -f /etc/logrotate.conf # 清理包缓存 sudo apt clean sudo apt autoremove -y } # 执行维护任务 main 十八、日志管理系统 1. 集中式日志配置 # 创建日志管理脚本 nano ~/log_management.sh #!/bin/bash # ~/log_management.sh LOG_BASE="/var/log/services" ARCHIVE_DIR="/home/zhaoxiongzhou/log_archives" DATE=$(date +%Y%m%d) # 创建日志目录 mkdir -p "$LOG_BASE"/{nginx,ai_service,system} mkdir -p "$ARCHIVE_DIR" # 配置日志轮转 sudo tee /etc/logrotate.d/custom_services << EOF $LOG_BASE/nginx/*.log { daily missingok rotate 14 compress delaycompress notifempty create 0640 www-data adm sharedscripts postrotate [ -f /var/run/nginx.pid ] && kill -USR1 \$(cat /var/run/nginx.pid) endscript } $LOG_BASE/ai_service/*.log { daily missingok rotate 14 compress delaycompress notifempty create 0640 zhaoxiongzhou adm } $LOG_BASE/system/*.log { daily missingok rotate 30 compress delaycompress notifempty create 0640 root adm } EOF # 日志分析函数 analyze_logs() { local log_file="$1" local output_file="$2" echo "=== 日志分析报告 $(date) ===" > "$output_file" # 错误统计 echo -e "\n错误统计:" >> "$output_file" grep -i "error" "$log_file" | sort | uniq -c | sort -nr >> "$output_file" # 警告统计 echo -e "\n警告统计:" >> "$output_file" grep -i "warning" "$log_file" | sort | uniq -c | sort -nr >> "$output_file" # 访问统计（针对 Nginx 访问日志） if [[ "$log_file" == *"nginx/access"* ]]; then echo -e "\n访问量统计:" >> "$output_file" awk &#39;{print $1}&#39; "$log_file" | sort | uniq -c | sort -nr | head -n 10 >> "$output_file" fi } # 日志归档函数 archive_logs() { local source_dir="$1" local archive_name="logs_${DATE}.tar.gz" find "$source_dir" -name "*.log.*" -mtime +14 -exec tar -czf "$ARCHIVE_DIR/$archive_name" {} + find "$source_dir" -name "*.log.*" -mtime +14 -delete } 2. 日志监控告警 # 创建日志监控脚本 nano ~/log_monitor.sh #!/bin/bash # ~/log_monitor.sh ALERT_THRESHOLD=10 # 错误阈值 ALERT_SCRIPT="/home/zhaoxiongzhou/send_alert.sh" # 监控特定关键词 monitor_keywords() { local log_file="$1" local keywords=("error" "critical" "failed" "timeout" "exception") for keyword in "${keywords[@]}"; do count=$(grep -i "$keyword" "$log_file" | wc -l) if [ "$count" -gt "$ALERT_THRESHOLD" ]; then "$ALERT_SCRIPT" "警告: $log_file 中发现大量 $keyword ($count 次)" fi done } # 监控日志大小 check_log_size() { local log_file="$1" local max_size=$((100 * 1024 * 1024)) # 100MB size=$(stat -f%z "$log_file") if [ "$size" -gt "$max_size" ]; then "$ALERT_SCRIPT" "警告: $log_file 大小超过 100MB" fi } # 主监控循环 main() { while true; do for log_file in "$LOG_BASE"/**/*.log; do monitor_keywords "$log_file" check_log_size "$log_file" done sleep 300 # 每5分钟检查一次 done } main & 十九、系统优化与调优 1. 系统参数优化 # 创建系统优化脚本 nano ~/system_optimize.sh #!/bin/bash # ~/system_optimize.sh # 系统参数优化 optimize_sysctl() { sudo tee /etc/sysctl.d/99-custom.conf << EOF # 内存管理优化 vm.swappiness = 60 vm.vfs_cache_pressure = 50 vm.dirty_background_ratio = 5 vm.dirty_ratio = 10 # 网络优化 net.core.somaxconn = 1024 net.core.netdev_max_backlog = 5000 net.ipv4.tcp_max_syn_backlog = 2048 net.ipv4.tcp_fin_timeout = 20 net.ipv4.tcp_keepalive_time = 1200 net.ipv4.tcp_keepalive_intvl = 15 net.ipv4.tcp_keepalive_probes = 5 # 文件系统优化 fs.file-max = 65535 fs.inotify.max_user_watches = 524288 EOF # 应用新的系统参数 sudo sysctl -p /etc/sysctl.d/99-custom.conf } # CPU 频率优化 optimize_cpu() { sudo tee /boot/config.txt << EOF # CPU 设置 arm_freq=1800 over_voltage=6 gpu_freq=500 # 温度控制 temp_limit=75 EOF } # 服务优化 optimize_services() { # 禁用不必要的服务 UNNECESSARY_SERVICES=( "bluetooth" "cups" "avahi-daemon" ) for service in "${UNNECESSARY_SERVICES[@]}"; do if systemctl is-enabled "$service" &>/dev/null; then sudo systemctl disable "$service" sudo systemctl stop "$service" fi done } # 内存优化 optimize_memory() { # 调整 ZRAM sudo tee /etc/default/zramswap << EOF ALGO=lz4 PERCENT=50 EOF # 重启 ZRAM 服务 sudo systemctl restart zramswap } 2. 服务优化配置 # Nginx 优化配置 sudo nano /etc/nginx/nginx.conf user www-data; worker_processes auto; worker_rlimit_nofile 65535; events { worker_connections 1024; multi_accept on; use epoll; } http { # 基础设置 sendfile on; tcp_nopush on; tcp_nodelay on; keepalive_timeout 65; types_hash_max_size 2048; server_tokens off; # MIME 类型 include /etc/nginx/mime.types; default_type application/octet-stream; # 日志格式 log_format main &#39;$remote_addr - $remote_user [$time_local] "$request" &#39; &#39;$status $body_bytes_sent "$http_referer" &#39; &#39;"$http_user_agent" "$http_x_forwarded_for"&#39;; # 缓冲区设置 client_body_buffer_size 10K; client_header_buffer_size 1k; client_max_body_size 8m; large_client_header_buffers 2 1k; # 超时设置 client_body_timeout 12; client_header_timeout 12; send_timeout 10; # 缓存设置 open_file_cache max=1000 inactive=20s; open_file_cache_valid 30s; open_file_cache_min_uses 2; open_file_cache_errors on; # Gzip 压缩 gzip on; gzip_vary on; gzip_proxied any; gzip_comp_level 6; gzip_types text/plain text/css text/xml application/json application/javascript application/xml+rss application/atom+xml image/svg+xml; } 二十、服务监控面板配置 1. Grafana 监控系统配置 # 安装 Grafana sudo apt-get install -y apt-transport-https sudo apt-get install -y software-properties-common wget wget -q -O - https://packages.grafana.com/gpg.key | sudo apt-key add - echo "deb https://packages.grafana.com/oss/deb stable main" | sudo tee -a /etc/apt/sources.list.d/grafana.list sudo apt-get update sudo apt-get install -y grafana # 配置 Grafana sudo nano /etc/grafana/grafana.ini [server] http_addr = 0.0.0.0 http_port = 3000 [security] admin_user = admin admin_password = your_secure_password [auth.anonymous] enabled = false [paths] data = /var/lib/grafana logs = /var/log/grafana plugins = /var/lib/grafana/plugins [dashboards] versions_to_keep = 20 2. Prometheus 配置 # 安装 Prometheus sudo apt-get install -y prometheus # 配置 Prometheus sudo nano /etc/prometheus/prometheus.yml global: scrape_interval: 15s evaluation_interval: 15s scrape_configs: - job_name: &#39;node&#39; static_configs: - targets: [&#39;localhost:9100&#39;] - job_name: &#39;nginx&#39; static_configs: - targets: [&#39;localhost:9113&#39;] - job_name: &#39;system&#39; static_configs: - targets: [&#39;localhost:9090&#39;] - job_name: &#39;process&#39; static_configs: - targets: [&#39;localhost:9256&#39;] 3. Node Exporter 配置 # 安装 Node Exporter sudo apt-get install -y prometheus-node-exporter # 创建自定义指标收集脚本 nano ~/custom_metrics.sh #!/bin/bash # ~/custom_metrics.sh # 创建指标文件 METRICS_FILE="/var/lib/node_exporter/custom_metrics.prom" while true; do # CPU 温度 CPU_TEMP=$(vcgencmd measure_temp | sed &#39;s/temp=//&#39; | sed &#39;s/&#39;"&#39;"&#39;C//&#39;) echo "raspberry_pi_cpu_temperature $CPU_TEMP" > "$METRICS_FILE" # AI 服务状态 if pgrep -f llama-server > /dev/null; then echo "ai_service_status 1" >> "$METRICS_FILE" else echo "ai_service_status 0" >> "$METRICS_FILE" fi # 博客服务状态 if systemctl is-active nginx > /dev/null; then echo "blog_service_status 1" >> "$METRICS_FILE" else echo "blog_service_status 0" >> "$METRICS_FILE" fi # 内存使用 FREE_MEM=$(free | grep Mem | awk &#39;{print $4}&#39;) echo "system_free_memory_bytes $FREE_MEM" >> "$METRICS_FILE" sleep 15 done 二十一、自动化部署与更新 1. 自动部署配置脚本 # 创建自动部署脚本 nano ~/auto_deploy.sh #!/bin/bash # ~/auto_deploy.sh # 配置 BLOG_DIR="/home/zhaoxiongzhou/myblog" LLAMA_DIR="/home/zhaoxiongzhou/projects/llama.cpp" BACKUP_DIR="/home/zhaoxiongzhou/backups" LOG_FILE="/var/log/auto_deploy.log" # 日志函数 log() { echo "[$(date &#39;+%Y-%m-%d %H:%M:%S&#39;)] $1" >> "$LOG_FILE" } # 备份当前版本 backup_current() { log "开始备份当前版本" # 博客备份 tar -czf "$BACKUP_DIR/blog_$(date +%Y%m%d_%H%M%S).tar.gz" "$BLOG_DIR" # AI 服务备份 tar -czf "$BACKUP_DIR/llama_$(date +%Y%m%d_%H%M%S).tar.gz" "$LLAMA_DIR" log "备份完成" } # 更新博客 update_blog() { log "开始更新博客" cd "$BLOG_DIR" || exit 1 # 拉取最新代码 if git pull origin master; then # 更新主题 git submodule update --remote themes/ananke # 构建站点 hugo --minify # 更新权限 sudo chown -R www-data:www-data public/ # 重启 Nginx sudo systemctl restart nginx log "博客更新成功" else log "错误: 博客更新失败" return 1 fi } # 更新 AI 服务 update_ai_service() { log "开始更新 AI 服务" cd "$LLAMA_DIR" || exit 1 # 停止当前服务 pkill llama-server # 拉取最新代码 if git pull origin master; then # 重新编译 make clean if LLAMA_METAL=1 make -j4; then # 启动服务 ./start-llama.sh # 验证服务 sleep 5 if pgrep -f llama-server > /dev/null; then log "AI 服务更新成功" else log "错误: AI 服务启动失败" return 1 fi else log "错误: AI 服务编译失败" return 1 fi else log "错误: AI 服务代码更新失败" return 1 fi } # 主函数 main() { log "开始自动部署流程" # 创建备份 backup_current # 更新服务 if update_blog && update_ai_service; then log "部署完成" return 0 else log "部署失败" return 1 fi } # 执行部署 main 2. 自动更新检查脚本 # 创建更新检查脚本 nano ~/check_updates.sh 二十一、自动更新检查与通知系统 1. 更新检查脚本 #!/bin/bash # ~/check_updates.sh # 配置 NOTIFY_SCRIPT="/home/zhaoxiongzhou/send_notification.sh" LOG_FILE="/var/log/update_check.log" GITHUB_API="https://api.github.com" LLAMA_REPO="ggerganov/llama.cpp" HUGO_REPO="gohugoio/hugo" # 日志函数 log() { echo "[$(date &#39;+%Y-%m-%d %H:%M:%S&#39;)] $1" | tee -a "$LOG_FILE" } # 检查 GitHub 仓库更新 check_github_updates() { local repo="$1" local current_version="$2" # 获取最新版本 latest_version=$(curl -s "$GITHUB_API/repos/$repo/releases/latest" | grep -Po &#39;"tag_name": "\K.*?(?=")&#39;) if [ "$latest_version" != "$current_version" ]; then log "发现新版本: $repo ($current_version -> $latest_version)" return 0 else log "当前版本已是最新: $repo ($current_version)" return 1 fi } # 检查系统更新 check_system_updates() { sudo apt update > /dev/null 2>&amp;1 updates=$(sudo apt list --upgradable 2>/dev/null | grep -c "upgradable") if [ "$updates" -gt 0 ]; then log "发现 $updates 个系统更新" return 0 else log "系统已是最新" return 1 fi } # 检查服务状态 check_services() { local services=("nginx" "llama-server") local status=0 for service in "${services[@]}"; do if [ "$service" = "nginx" ]; then if ! systemctl is-active --quiet nginx; then log "警告: Nginx 服务未运行" status=1 fi elif [ "$service" = "llama-server" ]; then if ! pgrep -f llama-server > /dev/null; then log "警告: AI 服务未运行" status=1 fi fi done return $status } # 发送通知 send_notification() { local message="$1" local priority="$2" if [ -x "$NOTIFY_SCRIPT" ]; then "$NOTIFY_SCRIPT" "$message" "$priority" else log "通知脚本不存在或不可执行" fi } # 主函数 main() { log "开始检查更新" # 获取当前版本 current_llama_version=$(cd ~/projects/llama.cpp && git describe --tags) current_hugo_version=$(hugo version | grep -Po "v\d+\.\d+\.\d+") # 检查更新 updates_found=0 if check_github_updates "$LLAMA_REPO" "$current_llama_version"; then send_notification "llama.cpp 有新版本可用" "normal" updates_found=1 fi if check_github_updates "$HUGO_REPO" "$current_hugo_version"; then send_notification "Hugo 有新版本可用" "normal" updates_found=1 fi if check_system_updates; then send_notification "系统有更新可用" "normal" updates_found=1 fi if ! check_services; then send_notification "服务状态异常，请检查" "high" fi if [ "$updates_found" -eq 0 ]; then log "所有组件均为最新版本" fi } # 执行检查 main 二十二、通知系统配置 1. 通知发送脚本 # 创建通知发送脚本 nano ~/send_notification.sh #!/bin/bash # ~/send_notification.sh # 配置 TELEGRAM_BOT_TOKEN="your_bot_token" TELEGRAM_CHAT_ID="your_chat_id" EMAIL_ADDRESS="your_email@domain.com" DISCORD_WEBHOOK_URL="your_discord_webhook_url" # 日志配置 LOG_FILE="/var/log/notifications.log" # 日志函数 log() { echo "[$(date &#39;+%Y-%m-%d %H:%M:%S&#39;)] $1" >> "$LOG_FILE" } # Telegram 通知 send_telegram() { local message="$1" local priority="$2" # 根据优先级添加表情符号 case "$priority" in "high") message="🚨 紧急: $message" ;; "normal") message="ℹ️ 通知: $message" ;; "low") message="📝 信息: $message" ;; esac # 发送消息 curl -s -X POST \ "https://api.telegram.org/bot$TELEGRAM_BOT_TOKEN/sendMessage" \ -d "chat_id=$TELEGRAM_CHAT_ID" \ -d "text=$message" \ -d "parse_mode=HTML" log "Telegram 通知已发送: $message" } # 邮件通知 send_email() { local message="$1" local priority="$2" local subject case "$priority" in "high") subject="[紧急] 树莓派服务警告" ;; "normal") subject="[通知] 树莓派服务更新" ;; "low") subject="[信息] 树莓派服务状态" ;; esac echo "$message" | mail -s "$subject" "$EMAIL_ADDRESS" log "邮件通知已发送: $subject - $message" } # Discord 通知 send_discord() { local message="$1" local priority="$2" local color case "$priority" in "high") color="16711680" # 红色 ;; "normal") color="65280" # 绿色 ;; "low") color="255" # 蓝色 ;; esac curl -H "Content-Type: application/json" \ -X POST \ -d "{\"embeds\": [{\"description\": \"$message\", \"color\": $color}]}" \ "$DISCORD_WEBHOOK_URL" log "Discord 通知已发送: $message" } # 主函数 main() { local message="$1" local priority="${2:-normal}" # 默认优先级为 normal # 检查必要参数 if [ -z "$message" ]; then log "错误: 消息内容不能为空" return 1 fi # 添加系统信息 local hostname=$(hostname) local timestamp=$(date &#39;+%Y-%m-%d %H:%M:%S&#39;) message="[$hostname] [$timestamp] $message" # 发送所有通知 send_telegram "$message" "$priority" send_email "$message" "$priority" send_discord "$message" "$priority" log "所有通知渠道处理完成" } # 执行通知发送 main "$@" 二十三、定时任务配置 1. Crontab 配置 # 编辑 crontab crontab -e # 系统维护任务 # 每天凌晨 2 点执行系统更新检查 0 2 * * * ~/check_updates.sh > /dev/null 2>&amp;1 # 每 6 小时执行一次服务健康检查 0 */6 * * * ~/service_health_check.sh > /dev/null 2>&amp;1 # 每周日凌晨 3 点执行系统优化 0 3 * * 0 ~/system_optimize.sh > /dev/null 2>&amp;1 # 每天凌晨 4 点执行日志管理 0 4 * * * ~/log_management.sh > /dev/null 2>&amp;1 # 每小时执行性能数据收集 0 * * * * ~/collect_performance.sh > /dev/null 2>&amp;1 # 每 5 分钟检查一次关键服务状态 */5 * * * * ~/monitor.sh > /dev/null 2>&amp;1 # 每天晚上 11 点执行备份 0 23 * * * ~/auto_backup.sh > /dev/null 2>&amp;1 # 每月 1 号执行完整系统检查 0 1 1 * * ~/full_system_check.sh > /dev/null 2>&amp;1 2. 完整系统检查脚本 # 创建完整系统检查脚本 nano ~/full_system_check.sh #!/bin/bash # ~/full_system_check.sh LOG_FILE="/var/log/system_check.log" REPORT_FILE="/home/zhaoxiongzhou/reports/monthly_report_$(date +%Y%m).txt" # 确保目录存在 mkdir -p "$(dirname "$REPORT_FILE")" # 日志函数 log() { echo "[$(date &#39;+%Y-%m-%d %H:%M:%S&#39;)] $1" | tee -a "$LOG_FILE" "$REPORT_FILE" } # 系统信息检查 check_system_info() { log "=== 系统信息 ===" log "系统版本: $(cat /etc/os-release | grep PRETTY_NAME)" log "内核版本: $(uname -r)" log "运行时间: $(uptime -p)" log "最后启动: $(who -b | awk &#39;{print $3,$4}&#39;)" } # 资源使用检查 check_resources() { log "=== 资源使用情况 ===" log "CPU 使用率: $(top -bn1 | grep "Cpu(s)" | awk &#39;{print $2}&#39;)%" log "内存使用情况:" free -h | tee -a "$REPORT_FILE" log "磁盘使用情况:" df -h | tee -a "$REPORT_FILE" } # 服务状态检查 check_services() { log "=== 服务状态 ===" # 检查 Nginx if systemctl is-active --quiet nginx; then log "Nginx: 运行正常" else log "Nginx: 未运行" fi # 检查 AI 服务 if pgrep -f llama-server > /dev/null; then log "AI 服务: 运行正常" else log "AI 服务: 未运行" fi } # 安全检查 check_security() { log "=== 安全检查 ===" # 检查失败的登录尝试 log "失败的登录尝试:" grep "Failed password" /var/log/auth.log | tail -n 5 | tee -a "$REPORT_FILE" # 检查开放的端口 log "开放的端口:" netstat -tuln | grep LISTEN | tee -a "$REPORT_FILE" } # 性能分析 analyze_performance() { log "=== 性能分析 ===" # 分析 CPU 使用情况 log "CPU 密集进程:" ps aux --sort=-%cpu | head -n 5 | tee -a "$REPORT_FILE" # 分析内存使用情况 log "内存密集进程:" ps aux --sort=-%mem | head -n 5 | tee -a "$REPORT_FILE" } # 主函数 main() { log "开始月度系统检查 - $(date)" check_system_info check_resources check_services check_security analyze_performance log "系统检查完成" # 发送报告 if [ -f "$REPORT_FILE" ]; then ~/send_notification.sh "月度系统检查报告已生成" "normal" fi } # 执行检查 main 二十四、灾难恢复计划 1. 系统恢复脚本 # 创建系统恢复脚本 nano ~/disaster_recovery.sh #!/bin/bash # ~/disaster_recovery.sh # 配置 BACKUP_DIR="/home/zhaoxiongzhou/backups" RECOVERY_LOG="/var/log/recovery.log" SERVICES=("nginx" "llama-server") # 日志函数 log() { echo "[$(date &#39;+%Y-%m-%d %H:%M:%S&#39;)] $1" | tee -a "$RECOVERY_LOG" } # 验证备份 verify_backup() { local backup_file="$1" if [ ! -f "$backup_file" ]; then log "错误: 备份文件不存在 - $backup_file" return 1 fi # 检查文件完整性 if ! tar -tzf "$backup_file" >/dev/null 2>&amp;1; then log "错误: 备份文件损坏 - $backup_file" return 1 fi return 0 } # 停止服务 stop_services() { log "停止所有服务..." for service in "${SERVICES[@]}"; do if [ "$service" = "nginx" ]; then sudo systemctl stop nginx else pkill "$service" fi done # 等待服务完全停止 sleep 5 } # 恢复博客服务 restore_blog() { local backup_file="$BACKUP_DIR/blog_latest.tar.gz" if verify_backup "$backup_file"; then log "开始恢复博客服务..." # 清理当前目录 rm -rf ~/myblog/* # 解压备份 tar -xzf "$backup_file" -C ~/myblog/ # 重建站点 cd ~/myblog hugo --minify # 恢复权限 sudo chown -R www-data:www-data public/ log "博客服务恢复完成" else log "博客服务恢复失败" return 1 fi } # 恢复 AI 服务 restore_ai_service() { local backup_file="$BACKUP_DIR/llama_latest.tar.gz" if verify_backup "$backup_file"; then log "开始恢复 AI 服务..." # 清理当前目录 rm -rf ~/projects/llama.cpp/* # 解压备份 tar -xzf "$backup_file" -C ~/projects/llama.cpp/ # 重新编译 cd ~/projects/llama.cpp make clean LLAMA_METAL=1 make -j4 log "AI 服务恢复完成" else log "AI 服务恢复失败" return 1 fi } # 恢复系统配置 restore_system_config() { local backup_file="$BACKUP_DIR/system_config_latest.tar.gz" if verify_backup "$backup_file"; then log "开始恢复系统配置..." # 解压系统配置 sudo tar -xzf "$backup_file" -C / # 重新加载系统配置 sudo sysctl --system log "系统配置恢复完成" else log "系统配置恢复失败" return 1 fi } # 启动服务 start_services() { log "启动所有服务..." # 启动 Nginx sudo systemctl start nginx # 启动 AI 服务 ~/projects/llama.cpp/start-llama.sh # 验证服务状态 sleep 10 verify_services } # 验证服务 verify_services() { local status=0 log "验证服务状态..." # 检查 Nginx if ! systemctl is-active --quiet nginx; then log "警告: Nginx 服务未正常运行" status=1 fi # 检查 AI 服务 if ! pgrep -f llama-server > /dev/null; then log "警告: AI 服务未正常运行" status=1 fi return $status } # 主函数 main() { log "开始系统恢复流程..." # 停止服务 stop_services # 执行恢复 if restore_system_config && restore_blog && restore_ai_service; then # 启动服务 start_services if verify_services; then log "系统恢复成功完成" ~/send_notification.sh "系统恢复成功完成" "normal" return 0 else log "系统恢复完成，但部分服务可能未正常运行" ~/send_notification.sh "系统恢复完成，但需要手动检查服务状态" "high" return 1 fi else log "系统恢复失败" ~/send_notification.sh "系统恢复失败，需要手动干预" "high" return 1 fi } # 执行恢复 main 二十五、文档管理系统 1. 文档生成脚本 # 创建文档生成脚本 nano ~/generate_docs.sh #!/bin/bash # ~/generate_docs.sh # 配置 DOCS_DIR="/home/zhaoxiongzhou/documentation" SCRIPTS_DIR="/home/zhaoxiongzhou" CONFIG_DIR="/etc" LOG_FILE="/var/log/documentation.log" # 确保目录存在 mkdir -p "$DOCS_DIR"/{scripts,configs,logs,maintenance} # 日志函数 log() { echo "[$(date &#39;+%Y-%m-%d %H:%M:%S&#39;)] $1" | tee -a "$LOG_FILE" } # 生成脚本文档 generate_script_docs() { log "生成脚本文档..." for script in "$SCRIPTS_DIR"/*.sh; do if [ -f "$script" ]; then script_name=$(basename "$script") output_file="$DOCS_DIR/scripts/${script_name%.sh}.md" { echo "# $script_name" echo "## 路径: $script" echo "## 最后修改: $(date -r "$script" &#39;+%Y-%m-%d %H:%M:%S&#39;)" echo "## 权限: $(stat -c &#39;%a&#39; "$script")" echo "## 所有者: $(stat -c &#39;%U:%G&#39; "$script")" echo echo "## 功能描述" grep -A 5 "^#.*功能:" "$script" 2>/dev/null || echo "未提供功能描述" echo echo "## 脚本内容" echo &#39;```bash&#39; cat "$script" echo &#39;```&#39; echo echo "## 依赖项" grep "^[^#]*apt.*install" "$script" 2>/dev/null || echo "未找到明确的依赖项" echo echo "## 定时任务" crontab -l 2>/dev/null | grep "$script_name" || echo "未配置定时任务" } > "$output_file" fi done } # 生成配置文档 generate_config_docs() { log "生成配置文档..." # Nginx 配置 { echo "# Nginx 配置文档" echo "## 主配置文件" echo &#39;```nginx&#39; cat /etc/nginx/nginx.conf echo &#39;```&#39; echo "## 站点配置" echo &#39;```nginx&#39; cat /etc/nginx/sites-available/myblog echo &#39;```&#39; } > "$DOCS_DIR/configs/nginx_config.md" # 系统配置 { echo "# 系统配置文档" echo "## Sysctl 配置" echo &#39;```bash&#39; cat /etc/sysctl.d/99-custom.conf echo &#39;```&#39; echo "## 树莓派配置" echo &#39;```bash&#39; cat /boot/config.txt echo &#39;```&#39; } > "$DOCS_DIR/configs/system_config.md" } # 生成维护文档 generate_maintenance_docs() { log "生成维护文档..." { echo "# 系统维护文档" echo "## 定时任务" echo &#39;```bash&#39; crontab -l echo &#39;```&#39; echo "## 服务状态" echo &#39;```bash&#39; systemctl status nginx ps aux | grep llama-server echo &#39;```&#39; echo "## 资源使用" echo &#39;```bash&#39; df -h free -h top -bn1 echo &#39;```&#39; echo "## 最近日志" echo &#39;```bash&#39; tail -n 50 /var/log/syslog echo &#39;```&#39; } > "$DOCS_DIR/maintenance/system_status.md" } # 生成索引 generate_index() { log "生成文档索引..." { echo "# 系统文档索引" echo "## 生成时间: $(date &#39;+%Y-%m-%d %H:%M:%S&#39;)" echo echo "## 脚本文档" for doc in "$DOCS_DIR/scripts"/*.md; do echo "- [$(basename "${doc%.md}")](scripts/$(basename "$doc"))" done echo echo "## 配置文档" for doc in "$DOCS_DIR/configs"/*.md; do echo "- [$(basename "${doc%.md}")](configs/$(basename "$doc"))" done echo echo "## 维护文档" for doc in "$DOCS_DIR/maintenance"/*.md; do echo "- [$(basename "${doc%.md}")](maintenance/$(basename "$doc"))" done } > "$DOCS_DIR/index.md" } # 主函数 main() { log "开始生成文档..." generate_script_docs generate_config_docs generate_maintenance_docs generate_index log "文档生成完成: $DOCS_DIR" } # 执行文档生成 main 二十六、性能测试与基准测试 1. 性能测试脚本 # 创建性能测试脚本 nano ~/benchmark.sh #!/bin/bash # ~/benchmark.sh # 配置 RESULTS_DIR="/home/zhaoxiongzhou/benchmark_results" LOG_FILE="/var/log/benchmark.log" DURATION=300 # 测试持续时间（秒） CONCURRENT_USERS=10 # 并发用户数 # 确保目录存在 mkdir -p "$RESULTS_DIR" # 日志函数 log() { echo "[$(date &#39;+%Y-%m-%d %H:%M:%S&#39;)] $1" | tee -a "$LOG_FILE" } # CPU 性能测试 benchmark_cpu() { log "开始 CPU 性能测试..." # 使用 sysbench 进行 CPU 测试 sysbench cpu --cpu-max-prime=20000 --threads=4 run > "$RESULTS_DIR/cpu_benchmark.txt" # 记录 CPU 温度 for i in $(seq 1 10); do vcgencmd measure_temp >> "$RESULTS_DIR/cpu_temp.txt" sleep 1 done } # 内存性能测试 benchmark_memory() { log "开始内存性能测试..." # 使用 sysbench 进行内存测试 sysbench memory --memory-block-size=1K --memory-total-size=10G run > "$RESULTS_DIR/memory_benchmark.txt" } # 磁盘性能测试 benchmark_disk() { log "开始磁盘性能测试..." # 使用 dd 测试写入速度 dd if=/dev/zero of=/tmp/test_file bs=1M count=1000 conv=fdatasync 2>> "$RESULTS_DIR/disk_write_benchmark.txt" # 使用 dd 测试读取速度 dd if=/tmp/test_file of=/dev/null bs=1M count=1000 2>> "$RESULTS_DIR/disk_read_benchmark.txt" # 清理测试文件 rm /tmp/test_file } # 网络性能测试 benchmark_network() { log "开始网络性能测试..." # 使用 iperf3 测试网络性能 iperf3 -c iperf.he.net -t 30 > "$RESULTS_DIR/network_benchmark.txt" } # Web 服务性能测试 benchmark_web() { log "开始 Web 服务性能测试..." # 使用 ab 测试 Web 服务 ab -n 1000 -c "$CONCURRENT_USERS" http://localhost/ > "$RESULTS_DIR/web_benchmark.txt" } # AI 服务性能测试 benchmark_ai() { log "开始 AI 服务性能测试..." # 创建测试请求 cat > /tmp/test_prompt.txt << EOF Hello, how are you? EOF # 使用 curl 测试 AI 服务响应时间 for i in $(seq 1 10); do time curl -X POST \ -H "Content-Type: application/json" \ -d @/tmp/test_prompt.txt \ http://localhost:8080/completion >> "$RESULTS_DIR/ai_benchmark.txt" 2>&amp;1 echo -e "\n---\n" >> "$RESULTS_DIR/ai_benchmark.txt" sleep 2 done } # 生成报告 generate_report() { log "生成性能测试报告..." local report_file="$RESULTS_DIR/benchmark_report_$(date +%Y%m%d_%H%M%S).md" { echo "# 性能测试报告" echo "## 测试时间: $(date &#39;+%Y-%m-%d %H:%M:%S&#39;)" echo echo "## 系统信息" echo &#39;```&#39; uname -a echo &#39;```&#39; echo echo "## CPU 性能" echo &#39;```&#39; cat "$RESULTS_DIR/cpu_benchmark.txt" echo &#39;```&#39; echo echo "## 内存性能" echo &#39;```&#39; cat "$RESULTS_DIR/memory_benchmark.txt" echo &#39;```&#39; echo echo "## 磁盘性能" echo &#39;```&#39; cat "$RESULTS_DIR/disk_write_benchmark.txt" cat "$RESULTS_DIR/disk_read_benchmark.txt" echo &#39;```&#39; echo echo "## 网络性能" echo &#39;```&#39; cat "$RESULTS_DIR/network_benchmark.txt" echo &#39;```&#39; echo echo "## Web 服务性能" echo &#39;```&#39; cat "$RESULTS_DIR/web_benchmark.txt" echo &#39;```&#39; echo echo "## AI 服务性能" echo &#39;```&#39; cat "$RESULTS_DIR/ai_benchmark.txt" echo &#39;```&#39; } > "$report_file" log "性能测试报告已生成: $report_file" } # 主函数 main() { log "开始性能测试..." # 安装必要的工具 sudo apt install -y sysbench apache2-utils iperf3 # 执行各项测试 benchmark_cpu benchmark_memory benchmark_disk benchmark_network benchmark_web benchmark_ai # 生成报告 generate_report log "性能测试完成" } # 执行测试 main 二十七、安全审计系统 1. 安全审计脚本 # 创建安全审计脚本 nano ~/security_audit.sh #!/bin/bash # ~/security_audit.sh # 配置 AUDIT_DIR="/home/zhaoxiongzhou/security_audits" REPORT_FILE="$AUDIT_DIR/security_report_$(date +%Y%m%d_%H%M%S).md" LOG_FILE="/var/log/security_audit.log" # 确保目录存在 mkdir -p "$AUDIT_DIR" # 日志函数 log() { echo "[$(date &#39;+%Y-%m-%d %H:%M:%S&#39;)] $1" | tee -a "$LOG_FILE" } # 检查系统用户 audit_users() { log "检查系统用户..." { echo "## 系统用户审计" echo "### 特权用户" echo &#39;```&#39; awk -F: &#39;$3 == 0 {print $1}&#39; /etc/passwd echo &#39;```&#39; echo "### 最近的用户活动" echo &#39;```&#39; last | head -n 10 echo &#39;```&#39; echo "### 失败的登录尝试" echo &#39;```&#39; grep "Failed password" /var/log/auth.log | tail -n 10 echo &#39;```&#39; } >> "$REPORT_FILE" } # 检查网络安全 audit_network() { log "检查网络安全..." { echo "## 网络安全审计" echo "### 开放端口" echo &#39;```&#39; netstat -tuln echo &#39;```&#39; echo "### 活动连接" echo &#39;```&#39; netstat -nat | grep ESTABLISHED echo &#39;```&#39; echo "### 防火墙规则" echo &#39;```&#39; sudo iptables -L -n echo &#39;```&#39; } >> "$REPORT_FILE" } # 检查文件权限 audit_permissions() { log "检查文件权限..." { echo "## 文件权限审计" echo "### SUID 文件" echo &#39;```&#39; sudo find / -type f -perm -4000 2>/dev/null echo &#39;```&#39; echo "### 世界可写文件" echo &#39;```&#39; sudo find / -type f -perm -2 ! -path "/proc/*" ! -path "/sys/*" 2>/dev/null echo &#39;```&#39; echo "### 敏感目录权限" echo &#39;```&#39; ls -la /etc/nginx/ ls -la ~/projects/llama.cpp/ ls -la ~/myblog/ echo &#39;```&#39; } >> "$REPORT_FILE" } # 检查服务配置 audit_services() { log "检查服务配置..." { echo "## 服务配置审计" echo "### Nginx 配置检查" echo &#39;```&#39; sudo nginx -t 2>&amp;1 echo &#39;```&#39; echo "### SSL 配置" echo &#39;```&#39; openssl s_client -connect localhost:443 -servername localhost </dev/null 2>/dev/null | openssl x509 -text echo &#39;```&#39; echo "### 服务状态" echo &#39;```&#39; systemctl list-units --type=service --state=active echo &#39;```&#39; } >> "$REPORT_FILE" } # 检查系统更新 audit_updates() { log "检查系统更新..." { echo "## 系统更新审计" echo "### 可用更新" echo &#39;```&#39; apt list --upgradable 2>/dev/null echo &#39;```&#39; echo "### 已安装包" echo &#39;```&#39; dpkg -l | grep "^ii" | wc -l echo &#39;```&#39; } >> "$REPORT_FILE" } # 检查日志异常 audit_logs() { log "检查日志异常..." { echo "## 日志审计" echo "### 系统错误" echo &#39;```&#39; sudo journalctl -p 3 -xb --no-pager | tail -n 20 echo &#39;```&#39; echo "### 异常访问" echo &#39;```&#39; grep -i "error\|failed\|warning" /var/log/nginx/error.log | tail -n 20 echo &#39;```&#39; } >> "$REPORT_FILE" } # 生成安全建议 generate_recommendations() { log "生成安全建议..." { echo "## 安全建议" echo "### 高优先级" # 检查并生成建议 if grep -q "Failed password" /var/log/auth.log; then echo "- 建议：启用 fail2ban 加强 SSH 防护" fi if [ $(find / -type f -perm -2 2>/dev/null | wc -l) -gt 0 ]; then echo "- 建议：检查并修复世界可写文件权限" fi echo "### 中优先级" # 添加其他建议 echo "- 定期更新系统包" echo "- 检查并更新 SSL 证书" echo "- 定期审查用户权限" } >> "$REPORT_FILE" } # 主函数 main() { log "开始安全审计..." # 创建报告头部 { echo "# 安全审计报告" echo "## 生成时间: $(date &#39;+%Y-%m-%d %H:%M:%S&#39;)" echo "## 系统信息" echo &#39;```&#39; uname -a echo &#39;```&#39; echo } > "$REPORT_FILE" # 执行各项审计 audit_users audit_network audit_permissions audit_services audit_updates audit_logs generate_recommendations log "安全审计完成，报告已生成: $REPORT_FILE" # 发送通知 ~/send_notification.sh "安全审计报告已生成" "normal" } # 执行审计 main 二十八、资源限制与控制 1. 资源限制配置脚本 # 创建资源限制配置脚本 nano ~/resource_control.sh #!/bin/bash # ~/resource_control.sh # 配置 LOG_FILE="/var/log/resource_control.log" LIMITS_CONF="/etc/security/limits.conf" SYSTEMD_DIR="/etc/systemd/system" # 日志函数 log() { echo "[$(date &#39;+%Y-%m-%d %H:%M:%S&#39;)] $1" | tee -a "$LOG_FILE" } # 配置系统资源限制 configure_system_limits() { log "配置系统资源限制..." # 备份原始配置 sudo cp "$LIMITS_CONF" "${LIMITS_CONF}.backup" # 添加资源限制配置 sudo tee -a "$LIMITS_CONF" << EOF # 用户资源限制 zhaoxiongzhou soft nofile 65535 zhaoxiongzhou hard nofile 65535 zhaoxiongzhou soft nproc 2048 zhaoxiongzhou hard nproc 4096 # 系统服务资源限制 www-data soft nofile 65535 www-data hard nofile 65535 www-data soft nproc 1024 www-data hard nproc 2048 EOF } # 配置 AI 服务资源限制 configure_ai_service() { log "配置 AI 服务资源限制..." # 创建 systemd 服务文件 sudo tee "$SYSTEMD_DIR/llama-server.service" << EOF [Unit] Description=Llama AI Server After=network.target [Service] User=zhaoxiongzhou Group=zhaoxiongzhou WorkingDirectory=/home/zhaoxiongzhou/projects/llama.cpp ExecStart=/home/zhaoxiongzhou/projects/llama.cpp/start-llama.sh # 资源限制 CPUQuota=80% MemoryLimit=2G TasksMax=128 LimitNOFILE=65535 # 重启策略 Restart=always RestartSec=10 [Install] WantedBy=multi-user.target EOF # 重新加载 systemd 配置 sudo systemctl daemon-reload } # 配置 Nginx 资源限制 configure_nginx() { log "配置 Nginx 资源限制..." # 修改 Nginx 配置 sudo tee "/etc/nginx/conf.d/resource_limits.conf" << EOF # 工作进程限制 worker_processes auto; worker_rlimit_nofile 65535; # 连接限制 events { worker_connections 1024; multi_accept on; } # 客户端限制 http { # 请求限制 limit_req_zone \$binary_remote_addr zone=one:10m rate=10r/s; # 连接限制 limit_conn_zone \$binary_remote_addr zone=addr:10m; server { # 应用限制 location / { limit_req zone=one burst=5; limit_conn addr 10; } } } EOF } # 配置系统资源监控 configure_monitoring() { log "配置资源监控..." # 创建监控脚本 cat > ~/monitor_resources.sh << EOF #!/bin/bash while true; do # CPU 使用率 CPU_USAGE=\$(top -bn1 | grep "Cpu(s)" | awk &#39;{print \$2}&#39;) # 内存使用率 MEM_USAGE=\$(free | grep Mem | awk &#39;{print \$3/\$2 * 100.0}&#39;) # 进程数 PROCESS_COUNT=\$(ps aux | wc -l) # 检查限制 if (( \$(echo "\$CPU_USAGE > 80" | bc -l) )); then ~/send_notification.sh "警告: CPU 使用率过高 (\${CPU_USAGE}%)" "high" fi if (( \$(echo "\$MEM_USAGE > 90" | bc -l) )); then ~/send_notification.sh "警告: 内存使用率过高 (\${MEM_USAGE}%)" "high" fi if [ "\$PROCESS_COUNT" -gt 200 ]; then ~/send_notification.sh "警告: 进程数过多 (\$PROCESS_COUNT)" "high" fi sleep 60 done EOF chmod +x ~/monitor_resources.sh } # 应用配置 apply_configurations() { log "应用资源限制配置..." # 重启服务 sudo systemctl restart nginx sudo systemctl restart llama-server # 启动监控 ~/monitor_resources.sh & # 验证配置 log "验证配置..." sudo nginx -t sudo systemctl status llama-server ulimit -a } # 主函数 main() { log "开始配置资源限制..." configure_system_limits configure_ai_service configure_nginx configure_monitoring apply_configurations log "资源限制配置完成" } # 执行配置 main 二十九、自动化测试系统 1. 集成测试脚本 # 创建集成测试脚本 nano ~/integration_test.sh #!/bin/bash # ~/integration_test.sh # 配置 TEST_DIR="/home/zhaoxiongzhou/tests" REPORT_DIR="/home/zhaoxiongzhou/test_reports" LOG_FILE="/var/log/integration_test.log" # 确保目录存在 mkdir -p "$TEST_DIR" "$REPORT_DIR" # 日志函数 log() { echo "[$(date &#39;+%Y-%m-%d %H:%M:%S&#39;)] $1" | tee -a "$LOG_FILE" } # 测试 Web 服务 test_web_service() { log "测试 Web 服务..." local result=0 # 测试首页访问 if curl -s -o /dev/null -w "%{http_code}" http://localhost/ | grep -q "200"; then log "首页访问测试通过" else log "错误: 首页访问测试失败" result=1 fi # 测试静态资源 if curl -s -o /dev/null -w "%{http_code}" http://localhost/css/main.css | grep -q "200"; then log "静态资源测试通过" else log "错误: 静态资源测试失败" result=1 fi # 测试 404 页面 if curl -s -o /dev/null -w "%{http_code}" http://localhost/nonexistent | grep -q "404"; then log "404 页面测试通过" else log "错误: 404 页面测试失败" result=1 fi return $result } # 测试 AI 服务 test_ai_service() { log "测试 AI 服务..." local result=0 # 测试服务可用性 if curl -s -o /dev/null -w "%{http_code}" http://localhost:8080/health | grep -q "200"; then log "AI 服务健康检查通过" else log "错误: AI 服务健康检查失败" result=1 fi # 测试模型响应 local response=$(curl -s -X POST \ -H "Content-Type: application/json" \ -d &#39;{"prompt": "Hello", "max_tokens": 10}&#39; \ http://localhost:8080/completion) if echo "$response" | grep -q "text"; then log "AI 服务响应测试通过" else log "错误: AI 服务响应测试失败" result=1 fi return $result } # 测试系统服务 test_system_services() { log "测试系统服务..." local result=0 # 测试 Nginx 状态 if systemctl is-active --quiet nginx; then log "Nginx 服务测试通过" else log "错误: Nginx 服务测试失败" result=1 fi # 测试系统资源 local cpu_usage=$(top -bn1 | grep "Cpu(s)" | awk &#39;{print $2}&#39;) local mem_usage=$(free | grep Mem | awk &#39;{print $3/$2 * 100.0}&#39;) if [ $(echo "$cpu_usage < 90" | bc -l) -eq 1 ]; then log "CPU 使用率正常" else log "警告: CPU 使用率过高" result=1 fi if [ $(echo "$mem_usage < 90" | bc -l) -eq 1 ]; then log "内存使用率正常" else log "警告: 内存使用率过高" result=1 fi return $result } # 生成测试报告 generate_report() { local web_result=$1 local ai_result=$2 local system_result=$3 local report_file="$REPORT_DIR/test_report_$(date +%Y%m%d_%H%M%S).md" { echo "# 集成测试报告" echo "## 测试时间: $(date &#39;+%Y-%m-%d %H:%M:%S&#39;)" echo echo "## 测试结果摘要" echo "- Web 服务: $([ $web_result -eq 0 ] && echo &#39;通过 ✅&#39; || echo &#39;失败 ❌&#39;)" echo "- AI 服务: $([ $ai_result -eq 0 ] && echo &#39;通过 ✅&#39; || echo &#39;失败 ❌&#39;)" echo "- 系统服务: $([ $system_result -eq 0 ] && echo &#39;通过 ✅&#39; || echo &#39;失败 ❌&#39;)" echo echo "## 详细日志" echo &#39;```&#39; tail -n 50 "$LOG_FILE" echo &#39;```&#39; } > "$report_file" log "测试报告已生成: $report_file" } # 主函数 main() { log "开始集成测试..." local web_result=0 local ai_result=0 local system_result=0 # 执行测试 test_web_service web_result=$? test_ai_service ai_result=$? test_system_services system_result=$? # 生成报告 generate_report $web_result $ai_result $system_result # 发送通知 if [ $web_result -eq 0 ] && [ $ai_result -eq 0 ] && [ $system_result -eq 0 ]; then ~/send_notification.sh "集成测试全部通过" "normal" else ~/send_notification.sh "集成测试存在失败项，请查看报告" "high" fi # 返回总体结果 return $(( web_result + ai_result + system_result )) } # 执行测试 main 三十、系统状态仪表板 1. 状态监控页面生成脚本 # 创建状态页面生成脚本 nano ~/generate_dashboard.sh #!/bin/bash # ~/generate_dashboard.sh # 配置 DASHBOARD_DIR="/var/www/html/dashboard" REFRESH_INTERVAL=60 # 页面刷新间隔（秒） LOG_FILE="/var/log/dashboard.log" # 确保目录存在 sudo mkdir -p "$DASHBOARD_DIR" # 日志函数 log() { echo "[$(date &#39;+%Y-%m-%d %H:%M:%S&#39;)] $1" | tee -a "$LOG_FILE" } # 收集系统状态数据 collect_system_data() { # CPU 信息 CPU_USAGE=$(top -bn1 | grep "Cpu(s)" | awk &#39;{print $2}&#39;) CPU_TEMP=$(vcgencmd measure_temp | sed &#39;s/temp=//&#39; | sed &#39;s/&#39;"&#39;"&#39;C//&#39;) # 内存信息 MEM_TOTAL=$(free -m | awk &#39;/Mem:/ {print $2}&#39;) MEM_USED=$(free -m | awk &#39;/Mem:/ {print $3}&#39;) MEM_USAGE=$(awk "BEGIN {printf \"%.2f\", $MEM_USED/$MEM_TOTAL*100}") # 磁盘信息 DISK_USAGE=$(df -h / | awk &#39;NR==2 {print $5}&#39; | sed &#39;s/%//&#39;) # 系统负载 LOAD_AVG=$(uptime | awk -F&#39;load average:&#39; &#39;{print $2}&#39; | xargs) # 运行时间 UPTIME=$(uptime -p) } # 收集服务状态 collect_service_data() { # Nginx 状态 if systemctl is-active --quiet nginx; then NGINX_STATUS="运行中 ✅" else NGINX_STATUS="已停止 ❌" fi # AI 服务状态 if pgrep -f llama-server > /dev/null; then AI_STATUS="运行中 ✅" else AI_STATUS="已停止 ❌" fi # 获取最近的日志 RECENT_LOGS=$(tail -n 10 /var/log/syslog | sed &#39;s/</\&amp;lt;/g&#39; | sed &#39;s/>/\&amp;gt;/g&#39;) } # 生成状态页面 generate_dashboard() { local timestamp=$(date &#39;+%Y-%m-%d %H:%M:%S&#39;) cat > "$DASHBOARD_DIR/index.html" << EOF <!DOCTYPE html> <html lang="zh"> <head> <meta charset="UTF-8"> <meta name="viewport" content="width=device-width, initial-scale=1.0"> <title>系统状态仪表板</title> <meta http-equiv="refresh" content="$REFRESH_INTERVAL"> <style> body { font-family: Arial, sans-serif; margin: 20px; background-color: #f5f5f5; } .container { max-width: 1200px; margin: 0 auto; } .card { background: white; border-radius: 8px; padding: 20px; margin-bottom: 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); } .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; } .metric { text-align: center; padding: 15px; border-radius: 4px; background: #f8f9fa; } .metric h3 { margin: 0; color: #666; } .metric .value { font-size: 24px; font-weight: bold; margin: 10px 0; } .status { display: flex; justify-content: space-between; align-items: center; padding: 10px; border-bottom: 1px solid #eee; } .logs { background: #2b2b2b; color: #fff; padding: 15px; border-radius: 4px; font-family: monospace; white-space: pre-wrap; } </style> </head> <body> <div class="container"> <h1>系统状态仪表板</h1> <p>最后更新: $timestamp</p> <div class="card"> <h2>系统资源</h2> <div class="grid"> <div class="metric"> <h3>CPU 使用率</h3> <div class="value">$CPU_USAGE%</div> </div> <div class="metric"> <h3>CPU 温度</h3> <div class="value">$CPU_TEMP</div> </div> <div class="metric"> <h3>内存使用率</h3> <div class="value">$MEM_USAGE%</div> </div> <div class="metric"> <h3>磁盘使用率</h3> <div class="value">$DISK_USAGE%</div> </div> </div> </div> <div class="card"> <h2>系统信息</h2> <div class="status"> <span>系统负载:</span> <span>$LOAD_AVG</span> </div> <div class="status"> <span>运行时间:</span> <span>$UPTIME</span> </div> </div> <div class="card"> <h2>服务状态</h2> <div class="status"> <span>Nginx 服务:</span> <span>$NGINX_STATUS</span> </div> <div class="status"> <span>AI 服务:</span> <span>$AI_STATUS</span> </div> </div> <div class="card"> <h2>最近日志</h2> <div class="logs">$RECENT_LOGS</div> </div> </div> </body> </html> EOF # 设置权限 sudo chown www-data:www-data "$DASHBOARD_DIR/index.html" } # 主函数 main() { log "开始生成状态仪表板..." # 收集数据 collect_system_data collect_service_data # 生成页面 generate_dashboard log "状态仪表板已更新" } # 执行生成 main 三十一、系统备份与恢复完整方案 1. 完整备份脚本 # 创建完整备份脚本 nano ~/full_backup.sh #!/bin/bash # ~/full_backup.sh # 配置 BACKUP_ROOT="/mnt/backup_drive" BACKUP_DIR="$BACKUP_ROOT/system_backups" EXCLUDE_FILE="/home/zhaoxiongzhou/backup_exclude.txt" LOG_FILE="/var/log/backup.log" RETENTION_DAYS=30 COMPRESSION_LEVEL=6 # 确保备份目录存在 mkdir -p "$BACKUP_DIR" # 日志函数 log() { echo "[$(date &#39;+%Y-%m-%d %H:%M:%S&#39;)] $1" | tee -a "$LOG_FILE" } # 检查备份环境 check_environment() { log "检查备份环境..." # 检查备份目标目录 if ! mountpoint -q "$BACKUP_ROOT"; then log "错误: 备份驱动器未挂载" return 1 fi # 检查可用空间 local available_space=$(df -BG "$BACKUP_ROOT" | awk &#39;NR==2 {print $4}&#39; | sed &#39;s/G//&#39;) if [ "$available_space" -lt 10 ]; then log "错误: 备份空间不足（小于 10GB）" return 1 fi # 创建排除文件 cat > "$EXCLUDE_FILE" << EOF /proc/* /sys/* /tmp/* /run/* /mnt/* /media/* /lost+found /var/cache/* /var/tmp/* /var/log/* /home/*/Downloads/* /home/*/.cache/* EOF return 0 } # 停止服务 stop_services() { log "停止服务..." # 停止 Nginx sudo systemctl stop nginx # 停止 AI 服务 pkill llama-server # 等待服务完全停止 sleep 5 } # 启动服务 start_services() { log "启动服务..." # 启动 Nginx sudo systemctl start nginx # 启动 AI 服务 ~/projects/llama.cpp/start-llama.sh # 验证服务状态 sleep 10 if ! systemctl is-active --quiet nginx; then log "警告: Nginx 服务未能正常启动" fi if ! pgrep -f llama-server > /dev/null; then log "警告: AI 服务未能正常启动" fi } # 创建完整备份 create_full_backup() { local backup_date=$(date +%Y%m%d_%H%M%S) local backup_file="$BACKUP_DIR/full_backup_${backup_date}.tar.gz" local manifest_file="$BACKUP_DIR/backup_manifest_${backup_date}.txt" log "开始创建完整备份..." # 创建文件清单 log "生成文件清单..." find / -xdev -type f ! -path "$(cat $EXCLUDE_FILE | tr &#39;\n&#39; &#39;|&#39;)" > "$manifest_file" # 创建备份 log "创建系统备份..." sudo tar -czf "$backup_file" \ --exclude-from="$EXCLUDE_FILE" \ --one-file-system \ --preserve-permissions \ --numeric-owner \ --checkpoint=1000 \ --checkpoint-action=dot \ -C / . # 验证备份 if ! tar -tzf "$backup_file" >/dev/null 2>&amp;1; then log "错误: 备份文件验证失败" return 1 fi # 计算校验和 log "计算校验和..." sha256sum "$backup_file" > "${backup_file}.sha256" # 创建备份信息文件 cat > "${backup_file}.info" << EOF 备份时间: $(date) 系统版本: $(cat /etc/os-release | grep PRETTY_NAME) 内核版本: $(uname -r) 备份大小: $(du -h "$backup_file" | cut -f1) 文件数量: $(wc -l < "$manifest_file") 排除规则: $(cat "$EXCLUDE_FILE") EOF return 0 } # 清理旧备份 cleanup_old_backups() { log "清理旧备份..." find "$BACKUP_DIR" -type f -name "full_backup_*" -mtime +$RETENTION_DAYS -delete find "$BACKUP_DIR" -type f -name "backup_manifest_*" -mtime +$RETENTION_DAYS -delete find "$BACKUP_DIR" -type f -name "*.sha256" -mtime +$RETENTION_DAYS -delete find "$BACKUP_DIR" -type f -name "*.info" -mtime +$RETENTION_DAYS -delete } # 主函数 main() { log "开始完整备份流程..." # 检查环境 if ! check_environment; then log "备份环境检查失败，终止备份" ~/send_notification.sh "系统备份失败：环境检查未通过" "high" return 1 fi # 停止服务 stop_services # 创建备份 if create_full_backup; then log "备份创建成功" ~/send_notification.sh "系统完整备份已成功创建" "normal" else log "备份创建失败" ~/send_notification.sh "系统备份失败：备份创建过程出错" "high" fi # 启动服务 start_services # 清理旧备份 cleanup_old_backups log "备份流程完成" } # 执行备份 main 三十二、系统恢复脚本 1. 系统恢复脚本 # 创建系统恢复脚本 nano ~/system_restore.sh #!/bin/bash # ~/system_restore.sh # 配置 BACKUP_ROOT="/mnt/backup_drive" BACKUP_DIR="$BACKUP_ROOT/system_backups" LOG_FILE="/var/log/restore.log" TEMP_DIR="/tmp/restore_temp" # 日志函数 log() { echo "[$(date &#39;+%Y-%m-%d %H:%M:%S&#39;)] $1" | tee -a "$LOG_FILE" } # 验证备份文件 verify_backup() { local backup_file="$1" log "验证备份文件: $backup_file" # 检查文件是否存在 if [ ! -f "$backup_file" ]; then log "错误: 备份文件不存在" return 1 fi # 检查校验和 local checksum_file="${backup_file}.sha256" if [ -f "$checksum_file" ]; then if ! sha256sum -c "$checksum_file"; then log "错误: 备份文件校验和验证失败" return 1 fi else log "警告: 未找到校验和文件" fi # 测试归档完整性 if ! tar -tzf "$backup_file" >/dev/null 2>&amp;1; then log "错误: 备份文件损坏" return 1 fi return 0 } # 准备恢复环境 prepare_environment() { log "准备恢复环境..." # 创建临时目录 mkdir -p "$TEMP_DIR" # 停止所有服务 log "停止服务..." sudo systemctl stop nginx pkill llama-server # 等待服务停止 sleep 5 # 清理目标目录 log "清理目标目录..." read -p "警告: 这将清除系统文件。确定要继续吗？(y/n) " -n 1 -r echo if [[ ! $REPLY =~ ^[Yy]$ ]]; then log "用户取消操作" return 1 fi return 0 } # 执行恢复 perform_restore() { local backup_file="$1" log "开始恢复系统..." # 创建恢复前的快照 log "创建当前系统快照..." local snapshot_date=$(date +%Y%m%d_%H%M%S) local snapshot_file="$BACKUP_DIR/pre_restore_snapshot_${snapshot_date}.tar.gz" sudo tar -czf "$snapshot_file" \ --exclude-from="/home/zhaoxiongzhou/backup_exclude.txt" \ --one-file-system \ -C / . # 解压备份 log "解压备份文件..." sudo tar -xzf "$backup_file" -C / \ --numeric-owner \ --preserve-permissions \ --checkpoint=1000 \ --checkpoint-action=dot # 修复权限 log "修复文件权限..." sudo chown -R www-data:www-data /var/www/ sudo chown -R zhaoxiongzhou:zhaoxiongzhou /home/zhaoxiongzhou/ return 0 } # 恢复服务配置 restore_configurations() { log "恢复服务配置..." # 重新加载系统配置 sudo systemctl daemon-reload sudo sysctl --system # 重新配置网络 sudo systemctl restart networking # 恢复防火墙规则 sudo iptables-restore < /etc/iptables/rules.v4 return 0 } # 验证恢复 verify_restore() { log "验证系统恢复..." local status=0 # 检查关键文件 for file in "/etc/nginx/nginx.conf" "/etc/systemd/system/llama-server.service"; do if [ ! -f "$file" ]; then log "错误: 未找到关键文件 $file" status=1 fi done # 启动服务 sudo systemctl start nginx ~/projects/llama.cpp/start-llama.sh # 验证服务状态 sleep 10 if ! systemctl is-active --quiet nginx; then log "错误: Nginx 服务未能正常启动" status=1 fi if ! pgrep -f llama-server > /dev/null; then log "错误: AI 服务未能正常启动" status=1 fi return $status } # 清理恢复环境 cleanup() { log "清理恢复环境..." # 删除临时文件 rm -rf "$TEMP_DIR" # 清理日志 find /var/log -type f -name "*.gz" -delete return 0 } # 主函数 main() { local backup_file # 列出可用备份 echo "可用的备份文件:" ls -lh "$BACKUP_DIR"/full_backup_*.tar.gz # 选择备份文件 read -p "请输入要恢复的备份文件完整路径: " backup_file # 验证备份 if ! verify_backup "$backup_file"; then log "备份验证失败，终止恢复" return 1 fi # 准备环境 if ! prepare_environment; then log "环境准备失败，终止恢复" return 1 fi # 执行恢复 if perform_restore "$backup_file" && \ restore_configurations && \ verify_restore; then log "系统恢复成功完成" ~/send_notification.sh "系统恢复成功完成" "normal" else log "系统恢复失败" ~/send_notification.sh "系统恢复失败，需要手动检查" "high" fi # 清理环境 cleanup } # 执行恢复 main 三十三、系统迁移工具 1. 系统迁移脚本 # 创建系统迁移脚本 nano ~/system_migration.sh #!/bin/bash # ~/system_migration.sh # 配置 SOURCE_HOST="old-raspberry.local" TARGET_HOST="new-raspberry.local" MIGRATION_DIR="/mnt/migration" LOG_FILE="/var/log/migration.log" SSH_KEY="~/.ssh/migration_key" RSYNC_OPTS="-avz --progress --delete" # 日志函数 log() { echo "[$(date &#39;+%Y-%m-%d %H:%M:%S&#39;)] $1" | tee -a "$LOG_FILE" } # 检查迁移环境 check_migration_env() { log "检查迁移环境..." # 检查 SSH 密钥 if [ ! -f "$SSH_KEY" ]; then log "生成 SSH 密钥..." ssh-keygen -t ed25519 -f "$SSH_KEY" -N "" # 复制密钥到目标主机 ssh-copy-id -i "$SSH_KEY" "zhaoxiongzhou@$TARGET_HOST" fi # 检查必要工具 for tool in rsync ssh scp; do if ! command -v $tool &>/dev/null; then log "错误: 未找到必要工具 $tool" return 1 fi done # 检查目标主机连接 if ! ssh -i "$SSH_KEY" "zhaoxiongzhou@$TARGET_HOST" "echo &#39;Connection test&#39;" &>/dev/null; then log "错误: 无法连接到目标主机" return 1 fi return 0 } # 迁移配置文件 migrate_configs() { log "迁移配置文件..." # 创建配置目录 ssh -i "$SSH_KEY" "zhaoxiongzhou@$TARGET_HOST" "mkdir -p ~/configs_backup" # 迁移 Nginx 配置 rsync $RSYNC_OPTS -e "ssh -i $SSH_KEY" \ /etc/nginx/ \ "zhaoxiongzhou@$TARGET_HOST:~/configs_backup/nginx/" # 迁移系统配置 rsync $RSYNC_OPTS -e "ssh -i $SSH_KEY" \ /etc/sysctl.d/ \ "zhaoxiongzhou@$TARGET_HOST:~/configs_backup/sysctl/" # 迁移服务配置 rsync $RSYNC_OPTS -e "ssh -i $SSH_KEY" \ /etc/systemd/system/ \ "zhaoxiongzhou@$TARGET_HOST:~/configs_backup/systemd/" } # 迁移数据 migrate_data() { log "迁移数据..." # 迁移博客数据 rsync $RSYNC_OPTS -e "ssh -i $SSH_KEY" \ ~/myblog/ \ "zhaoxiongzhou@$TARGET_HOST:~/myblog/" # 迁移 AI 服务数据 rsync $RSYNC_OPTS -e "ssh -i $SSH_KEY" \ ~/projects/llama.cpp/ \ "zhaoxiongzhou@$TARGET_HOST:~/projects/llama.cpp/" # 迁移用户脚本 rsync $RSYNC_OPTS -e "ssh -i $SSH_KEY" \ ~/*.sh \ "zhaoxiongzhou@$TARGET_HOST:~/" } # 迁移数据库 migrate_database() { log "迁移数据库..." # 导出数据库 local dump_file="/tmp/database_dump.sql" if [ -f "/var/lib/mysql" ]; then mysqldump --all-databases > "$dump_file" # 传输到目标主机 scp -i "$SSH_KEY" "$dump_file" "zhaoxiongzhou@$TARGET_HOST:/tmp/" # 在目标主机导入数据库 ssh -i "$SSH_KEY" "zhaoxiongzhou@$TARGET_HOST" \ "mysql < /tmp/database_dump.sql" fi } # 配置目标系统 configure_target() { log "配置目标系统..." ssh -i "$SSH_KEY" "zhaoxiongzhou@$TARGET_HOST" "bash -s" << &#39;EOF&#39; # 安装必要软件 sudo apt update sudo apt install -y nginx mysql-server python3 pip # 恢复配置 sudo cp -r ~/configs_backup/nginx/* /etc/nginx/ sudo cp -r ~/configs_backup/sysctl/* /etc/sysctl.d/ sudo cp -r ~/configs_backup/systemd/* /etc/systemd/system/ # 设置权限 sudo chown -R www-data:www-data /var/www/ sudo chmod +x ~/*.sh # 重启服务 sudo systemctl daemon-reload sudo systemctl restart nginx EOF } # 验证迁移 verify_migration() { log "验证迁移..." local status=0 # 检查服务状态 ssh -i "$SSH_KEY" "zhaoxiongzhou@$TARGET_HOST" "bash -s" << &#39;EOF&#39; # 检查 Nginx if ! systemctl is-active --quiet nginx; then echo "错误: Nginx 服务未运行" exit 1 fi # 检查文件 for dir in "~/myblog" "~/projects/llama.cpp"; do if [ ! -d "$dir" ]; then echo "错误: 目录 $dir 不存在" exit 1 fi done # 检查配置 if ! nginx -t &>/dev/null; then echo "错误: Nginx 配置无效" exit 1 fi EOF status=$? return $status } # 主函数 main() { log "开始系统迁移..." # 检查环境 if ! check_migration_env; then log "迁移环境检查失败" return 1 fi # 执行迁移 migrate_configs migrate_data migrate_database configure_target # 验证迁移 if verify_migration; then log "系统迁移成功完成" ~/send_notification.sh "系统迁移成功完成" "normal" else log "系统迁移失败" ~/send_notification.sh "系统迁移失败，需要手动检查" "high" fi } # 执行迁移 main 三十四、日志分析工具 1. 日志分析脚本 # 创建日志分析脚本 nano ~/log_analyzer.sh #!/bin/bash # ~/log_analyzer.sh # 配置 LOG_DIRS=( "/var/log" "/var/log/nginx" "/home/zhaoxiongzhou/logs" ) REPORT_DIR="/home/zhaoxiongzhou/log_reports" LOG_FILE="/var/log/analyzer.log" ALERT_THRESHOLD=100 # 错误日志阈值 RETENTION_DAYS=30 # 报告保留天数 # 确保目录存在 mkdir -p "$REPORT_DIR" # 日志函数 log() { echo "[$(date &#39;+%Y-%m-%d %H:%M:%S&#39;)] $1" | tee -a "$LOG_FILE" } # 分析系统日志 analyze_system_logs() { log "分析系统日志..." local report_file="$REPORT_DIR/system_log_report_$(date +%Y%m%d).md" { echo "# 系统日志分析报告" echo "## 生成时间: $(date &#39;+%Y-%m-%d %H:%M:%S&#39;)" echo echo "## 系统错误统计" echo "### 严重错误" echo &#39;```&#39; grep -i "error\|critical\|emergency" /var/log/syslog | \ tail -n 50 | sort | uniq -c | sort -nr echo &#39;```&#39; echo "### 认证失败" echo &#39;```&#39; grep "Failed password" /var/log/auth.log | \ awk &#39;{print $1,$2,$3,$11}&#39; | sort | uniq -c | sort -nr | head -n 10 echo &#39;```&#39; echo "### 系统重启记录" echo &#39;```&#39; last reboot | head -n 5 echo &#39;```&#39; } > "$report_file" } # 分析 Nginx 访问日志 analyze_nginx_logs() { log "分析 Nginx 访问日志..." local report_file="$REPORT_DIR/nginx_log_report_$(date +%Y%m%d).md" { echo "# Nginx 访问日志分析报告" echo "## 生成时间: $(date &#39;+%Y-%m-%d %H:%M:%S&#39;)" echo echo "## 访问统计" echo "### 请求量最大的 IP" echo &#39;```&#39; awk &#39;{print $1}&#39; /var/log/nginx/access.log | sort | uniq -c | sort -nr | head -n 10 echo &#39;```&#39; echo "### 访问量最大的页面" echo &#39;```&#39; awk &#39;{print $7}&#39; /var/log/nginx/access.log | sort | uniq -c | sort -nr | head -n 10 echo &#39;```&#39; echo "### HTTP 状态码统计" echo &#39;```&#39; awk &#39;{print $9}&#39; /var/log/nginx/access.log | sort | uniq -c | sort -nr echo &#39;```&#39; echo "### 每小时请求量统计" echo &#39;```&#39; awk &#39;{print $4}&#39; /var/log/nginx/access.log | cut -c 14-15 | sort | uniq -c | \ awk &#39;{printf("%s:00 - %s 请求\n", $2, $1)}&#39; echo &#39;```&#39; } > "$report_file" } # 分析 AI 服务日志 analyze_ai_logs() { log "分析 AI 服务日志..." local report_file="$REPORT_DIR/ai_log_report_$(date +%Y%m%d).md" local ai_log="/home/zhaoxiongzhou/logs/llama.log" if [ -f "$ai_log" ]; then { echo "# AI 服务日志分析报告" echo "## 生成时间: $(date &#39;+%Y-%m-%d %H:%M:%S&#39;)" echo echo "## 服务统计" echo "### 错误统计" echo &#39;```&#39; grep -i "error" "$ai_log" | tail -n 20 echo &#39;```&#39; echo "### 性能统计" echo "#### 响应时间分布" echo &#39;```&#39; grep "response_time" "$ai_log" | \ awk &#39;{sum+=$NF; count++} END {print "平均响应时间:", sum/count, "ms"}&#39; echo &#39;```&#39; echo "#### 内存使用统计" echo &#39;```&#39; grep "memory_usage" "$ai_log" | tail -n 10 echo &#39;```&#39; } > "$report_file" fi } # 生成安全报告 generate_security_report() { log "生成安全报告..." local report_file="$REPORT_DIR/security_report_$(date +%Y%m%d).md" { echo "# 安全分析报告" echo "## 生成时间: $(date &#39;+%Y-%m-%d %H:%M:%S&#39;)" echo echo "## 安全事件统计" echo "### SSH 暴力破解尝试" echo &#39;```&#39; grep "Failed password" /var/log/auth.log | \ awk &#39;{print $11,$13}&#39; | sort | uniq -c | sort -nr | head -n 10 echo &#39;```&#39; echo "### 可疑 IP 访问" echo &#39;```&#39; grep -i "suspicious\|attack\|hack" /var/log/nginx/access.log | \ awk &#39;{print $1}&#39; | sort | uniq -c | sort -nr echo &#39;```&#39; echo "### 文件权限变更" echo &#39;```&#39; find /etc -mtime -1 -type f -ls echo &#39;```&#39; } > "$report_file" } # 清理旧报告 cleanup_old_reports() { log "清理旧报告..." find "$REPORT_DIR" -type f -name "*.md" -mtime +$RETENTION_DAYS -delete } # 生成摘要报告 generate_summary() { log "生成摘要报告..." local summary_file="$REPORT_DIR/summary_$(date +%Y%m%d).md" { echo "# 日志分析摘要报告" echo "## 生成时间: $(date &#39;+%Y-%m-%d %H:%M:%S&#39;)" echo echo "## 关键指标" # 错误统计 local error_count=$(grep -i "error" /var/log/syslog | wc -l) local nginx_error_count=$(grep -i "error" /var/log/nginx/error.log | wc -l) echo "- 系统错误数: $error_count" echo "- Nginx 错误数: $nginx_error_count" # 安全事件 local ssh_fails=$(grep "Failed password" /var/log/auth.log | wc -l) echo "- SSH 失败尝试: $ssh_fails" # 告警判断 if [ $error_count -gt $ALERT_THRESHOLD ]; then ~/send_notification.sh "警告: 系统错误数超过阈值" "high" fi } > "$summary_file" } # 主函数 main() { log "开始日志分析..." # 执行分析 analyze_system_logs analyze_nginx_logs analyze_ai_logs generate_security_report generate_summary # 清理旧报告 cleanup_old_reports log "日志分析完成" } # 执行分析 main 三十五、系统优化工具 1. 系统优化脚本 # 创建系统优化脚本 nano ~/system_optimize.sh #!/bin/bash # ~/system_optimize.sh # 配置 LOG_FILE="/var/log/optimize.log" NGINX_CONF="/etc/nginx/nginx.conf" SYSCTL_CONF="/etc/sysctl.d/99-custom.conf" JOURNAL_CONF="/etc/systemd/journald.conf" # 日志函数 log() { echo "[$(date &#39;+%Y-%m-%d %H:%M:%S&#39;)] $1" | tee -a "$LOG_FILE" } # 优化系统参数 optimize_system() { log "优化系统参数..." # 备份原始配置 cp "$SYSCTL_CONF" "${SYSCTL_CONF}.backup" # 配置系统参数 cat > "$SYSCTL_CONF" << EOF # 网络优化 net.core.somaxconn = 2048 net.core.netdev_max_backlog = 4096 net.ipv4.tcp_max_syn_backlog = 4096 net.ipv4.tcp_fin_timeout = 30 net.ipv4.tcp_keepalive_time = 1200 net.ipv4.tcp_max_tw_buckets = 5000 net.ipv4.tcp_fastopen = 3 net.ipv4.tcp_rmem = 4096 87380 16777216 net.ipv4.tcp_wmem = 4096 65536 16777216 # 文件系统优化 fs.file-max = 100000 fs.inotify.max_user_watches = 524288 # 内存优化 vm.swappiness = 10 vm.dirty_ratio = 60 vm.dirty_background_ratio = 2 EOF # 应用系统参数 sysctl -p "$SYSCTL_CONF" } # 优化 Nginx 配置 optimize_nginx() { log "优化 Nginx 配置..." # 备份原始配置 cp "$NGINX_CONF" "${NGINX_CONF}.backup" # 配置 Nginx cat > "$NGINX_CONF" << EOF user www-data; worker_processes auto; worker_rlimit_nofile 100000; events { worker_connections 2048; multi_accept on; use epoll; } http { # 基础设置 sendfile on; tcp_nopush on; tcp_nodelay on; keepalive_timeout 65; types_hash_max_size 2048; server_tokens off; # MIME 类型 include /etc/nginx/mime.types; default_type application/octet-stream; # 日志格式 log_format main &#39;\$remote_addr - \$remote_user [\$time_local] "\$request" &#39; &#39;\$status \$body_bytes_sent "\$http_referer" &#39; &#39;"\$http_user_agent" "\$http_x_forwarded_for"&#39;; # 缓冲区设置 client_body_buffer_size 128k; client_max_body_size 10m; client_header_buffer_size 1k; large_client_header_buffers 4 4k; # Gzip 压缩 gzip on; gzip_vary on; gzip_proxied any; gzip_comp_level 6; gzip_types text/plain text/css application/json application/javascript text/xml application/xml application/xml+rss text/javascript; # SSL 优化 ssl_protocols TLSv1.2 TLSv1.3; ssl_prefer_server_ciphers on; ssl_session_cache shared:SSL:10m; ssl_session_timeout 10m; # 包含其他配置 include /etc/nginx/conf.d/*.conf; include /etc/nginx/sites-enabled/*; } EOF # 测试配置 nginx -t && systemctl restart nginx } # 优化系统服务 optimize_services() { log "优化系统服务..." # 禁用不必要的服务 local unnecessary_services=( "bluetooth" "cups" "avahi-daemon" ) for service in "${unnecessary_services[@]}"; do if systemctl is-active --quiet "$service"; then systemctl stop "$service" systemctl disable "$service" log "已禁用服务: $service" fi done # 优化日志服务 cat > "$JOURNAL_CONF" << EOF [Journal] SystemMaxUse=100M SystemMaxFileSize=10M RuntimeMaxUse=50M RuntimeMaxFileSize=5M EOF # 重启日志服务 systemctl restart systemd-journald } # 优化文件系统 optimize_filesystem() { log "优化文件系统..." # 清理临时文件 find /tmp -type f -atime +10 -delete find /var/tmp -type f -atime +10 -delete # 清理日志 find /var/log -type f -name "*.gz" -delete find /var/log -type f -name "*.old" -delete # 优化日志轮转 cat > /etc/logrotate.d/custom << EOF /var/log/custom/*.log { daily rotate 7 compress delaycompress missingok notifempty create 640 root adm } EOF } # 优化内存使用 optimize_memory() { log "优化内存使用..." # 清理缓存 sync; echo 3 > /proc/sys/vm/drop_caches # 配置 swap 使用 if [ -f /swapfile ]; then swapoff /swapfile dd if=/dev/zero of=/swapfile bs=1M count=2048 chmod 600 /swapfile mkswap /swapfile swapon /swapfile fi } # 验证优化 verify_optimization() { log "验证系统优化..." local status=0 # 检查系统负载 local load=$(uptime | awk -F&#39;load average:&#39; &#39;{print $2}&#39; | cut -d, -f1) if [ $(echo "$load > 2" | bc -l) -eq 1 ]; then log "警告: 系统负载较高 ($load)" status=1 fi # 检查内存使用 local mem_usage=$(free | grep Mem | awk &#39;{print $3/$2 * 100.0}&#39;) if [ $(echo "$mem_usage > 90" | bc -l) -eq 1 ]; then log "警告: 内存使用率过高 ($mem_usage%)" status=1 fi # 检查服务状态 if ! systemctl is-active --quiet nginx; then log "错误: Nginx 服务未正常运行" status=1 fi return $status } # 主函数 main() { log "开始系统优化..." optimize_system optimize_nginx optimize_services optimize_filesystem optimize_memory if verify_optimization; then log "系统优化成功完成" ~/send_notification.sh "系统优化已完成" "normal" else log "系统优化完成，但存在警告" ~/send_notification.sh "系统优化完成，但需要检查" "high" fi } # 执行优化 main 三十六、部署后检查清单 1. 部署检查脚本 # 创建部署检查脚本 nano ~/deployment_checklist.sh #!/bin/bash # ~/deployment_checklist.sh # 配置 LOG_FILE="/var/log/deployment_check.log" REPORT_FILE="/home/zhaoxiongzhou/deployment_report.md" CHECK_INTERVAL=300 # 检查间隔（秒） # 日志函数 log() { echo "[$(date &#39;+%Y-%m-%d %H:%M:%S&#39;)] $1" | tee -a "$LOG_FILE" } # 检查系统基础配置 check_system_basics() { log "检查系统基础配置..." local status=0 { echo "## 系统基础检查" echo "### 系统信息" echo "- 主机名: $(hostname)" echo "- 系统版本: $(cat /etc/os-release | grep PRETTY_NAME)" echo "- 内核版本: $(uname -r)" echo "- 运行时间: $(uptime -p)" echo echo "### 资源使用" echo "- CPU 使用率: $(top -bn1 | grep "Cpu(s)" | awk &#39;{print $2}&#39;)%" echo "- 内存使用率: $(free | grep Mem | awk &#39;{print $3/$2 * 100.0}&#39;)%" echo "- 磁盘使用率: $(df -h / | awk &#39;NR==2 {print $5}&#39;)" echo } > "$REPORT_FILE" return $status } # 检查网络配置 check_network() { log "检查网络配置..." local status=0 { echo "### 网络配置" echo "#### IP 配置" echo &#39;```&#39; ip addr show echo &#39;```&#39; echo "#### 路由表" echo &#39;```&#39; ip route echo &#39;```&#39; echo "#### 开放端口" echo &#39;```&#39; netstat -tuln echo &#39;```&#39; echo "#### DNS 配置" echo &#39;```&#39; cat /etc/resolv.conf echo &#39;```&#39; } >> "$REPORT_FILE" return $status } # 检查服务配置 check_services() { log "检查服务配置..." local status=0 { echo "### 服务状态" echo "#### Nginx 配置" echo &#39;```&#39; nginx -T echo &#39;```&#39; echo "#### 服务运行状态" echo &#39;```&#39; systemctl status nginx systemctl status mysql ps aux | grep llama-server echo &#39;```&#39; echo "#### 服务日志检查" echo &#39;```&#39; tail -n 20 /var/log/nginx/error.log echo &#39;```&#39; } >> "$REPORT_FILE" return $status } # 检查安全配置 check_security() { log "检查安全配置..." local status=0 { echo "### 安全检查" echo "#### 防火墙规则" echo &#39;```&#39; sudo iptables -L echo &#39;```&#39; echo "#### SSH 配置" echo &#39;```&#39; grep -v &#39;^#&#39; /etc/ssh/sshd_config echo &#39;```&#39; echo "#### 用户权限" echo &#39;```&#39; ls -la /home/zhaoxiongzhou/ ls -la /var/www/ echo &#39;```&#39; echo "#### SSL 证书" echo &#39;```&#39; openssl x509 -in /etc/nginx/ssl/server.crt -text -noout echo &#39;```&#39; } >> "$REPORT_FILE" return $status } # 检查备份配置 check_backups() { log "检查备份配置..." local status=0 { echo "### 备份检查" echo "#### 备份配置" echo &#39;```&#39; ls -lh /mnt/backup_drive/system_backups/ echo &#39;```&#39; echo "#### 最近备份状态" echo &#39;```&#39; tail -n 20 /var/log/backup.log echo &#39;```&#39; } >> "$REPORT_FILE" return $status } # 检查监控配置 check_monitoring() { log "检查监控配置..." local status=0 { echo "### 监控检查" echo "#### 监控脚本状态" echo &#39;```&#39; ps aux | grep monitor echo &#39;```&#39; echo "#### 告警配置" echo &#39;```&#39; cat ~/send_notification.sh echo &#39;```&#39; } >> "$REPORT_FILE" return $status } # 生成总结报告 generate_summary() { log "生成总结报告..." { echo "## 部署检查总结" echo "### 检查时间: $(date &#39;+%Y-%m-%d %H:%M:%S&#39;)" echo echo "### 主要发现" echo "1. 系统状态: $([ $system_status -eq 0 ] && echo &#39;正常 ✅&#39; || echo &#39;异常 ❌&#39;)" echo "2. 网络配置: $([ $network_status -eq 0 ] && echo &#39;正常 ✅&#39; || echo &#39;异常 ❌&#39;)" echo "3. 服务状态: $([ $services_status -eq 0 ] && echo &#39;正常 ✅&#39; || echo &#39;异常 ❌&#39;)" echo "4. 安全配置: $([ $security_status -eq 0 ] && echo &#39;正常 ✅&#39; || echo &#39;异常 ❌&#39;)" echo "5. 备份状态: $([ $backup_status -eq 0 ] && echo &#39;正常 ✅&#39; || echo &#39;异常 ❌&#39;)" echo "6. 监控状态: $([ $monitoring_status -eq 0 ] && echo &#39;正常 ✅&#39; || echo &#39;异常 ❌&#39;)" echo echo "### 建议操作" [ $system_status -ne 0 ] && echo "- 检查系统资源使用情况" [ $network_status -ne 0 ] && echo "- 验证网络配置" [ $services_status -ne 0 ] && echo "- 检查服务运行状态" [ $security_status -ne 0 ] && echo "- 审查安全配置" [ $backup_status -ne 0 ] && echo "- 确认备份是否正常" [ $monitoring_status -ne 0 ] && echo "- 检查监控系统" } >> "$REPORT_FILE" } # 主函数 main() { log "开始部署后检查..." # 执行检查 check_system_basics system_status=$? check_network network_status=$? check_services services_status=$? check_security security_status=$? check_backups backup_status=$? check_monitoring monitoring_status=$? # 生成总结 generate_summary # 发送通知 if [ $system_status -eq 0 ] && [ $network_status -eq 0 ] && \ [ $services_status -eq 0 ] && [ $security_status -eq 0 ] && \ [ $backup_status -eq 0 ] && [ $monitoring_status -eq 0 ]; then ~/send_notification.sh "部署检查完成：所有项目正常" "normal" else ~/send_notification.sh "部署检查完成：存在需要关注的项目" "high" fi log "部署检查完成，报告已生成: $REPORT_FILE" } # 执行检查 main 《树莓派服务部署与维护完整指南》总共包含了 36 个部分，涵盖了从系统部署到维护的各个方面。每个脚本都经过精心设计，可以独立运行，也可以互相配合使用。'><link rel=stylesheet href=/css/output.min.css><style>pre{padding:1em;overflow:auto}</style><link rel=stylesheet href=/css/custom.css><script defer src=https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js></script></head><body x-data="{
    flip: false,
  }"><div id=dream-global-bg></div><nav class="mt-4 lg:mt-8 py-4"><div class="container flex justify-between px-4"><section class="flex items-center gap-4"><div class="avatar cursor-pointer hover:online" @click="flip = !flip" title=翻转一下！><div class="h-10 rounded-full"><img src=/me/avatar.jpg alt></div></div></section><div class="dropdown dropdown-end sm:hidden"><div tabindex=0 role=button class="btn btn-ghost btn-square" aria-label="Select an option"><ion-icon name=menu class=text-2xl></ion-icon></div><ul tabindex=0 class="dropdown-content menu w-36 bg-base-100 rounded-box z-[1] shadow-md"><li><div role=link tabindex=0 class="inline-flex items-center p-2 cursor-pointer" @click="flip = !flip" title=关于><ion-icon name=information-circle></ion-icon>关于</div></li><li><a class="inline-flex items-center p-2 cursor-pointer" href=/posts title=归档><ion-icon name=archive></ion-icon>归档</a></li><li><a class="inline-flex items-center p-2 cursor-pointer" href=/categories title=所有分类><ion-icon name=grid></ion-icon>所有分类</a></li><li><a class="inline-flex items-center p-2 cursor-pointer" href=/tags title=所有标签><ion-icon name=pricetags></ion-icon>所有标签</a></li></ul></div><section class="hidden sm:flex sm:items-center sm:gap-2 md:gap-4"><div role=link tabindex=0 class="text-sm font-semibold cursor-pointer hover:underline" @click="flip = !flip" title=关于>关于</div><a class="group inline-flex items-center p-2 rounded-full cursor-pointer hover:bg-primary" href=/posts title=归档><ion-icon class=group-hover:text-primary-content name=archive></ion-icon></a><a class="group inline-flex items-center p-2 rounded-full cursor-pointer hover:bg-primary" href=/categories title=所有分类><ion-icon class=group-hover:text-primary-content name=grid></ion-icon></a><a class="group inline-flex items-center p-2 rounded-full cursor-pointer hover:bg-primary" href=/tags title=所有标签><ion-icon class=group-hover:text-primary-content name=pricetags></ion-icon></a></section></div></nav><div class=flip-container :class="{ 'flip-it': flip }"><div class=flipper><div class=front><div class=container><div class="mt-4 px-4"><div><article class="mx-auto prose prose-quoteless dark:prose-invert" id=dream-single-post-main itemscope itemtype=http://schema.org/Article><meta itemprop=name content="树莓派服务部署与维护完整指南"><meta itemprop=description content='树莓派服务部署与维护完整指南 一、系统概况 1. 硬件资源 处理器: ARM64 架构 总内存: 3.7GB 可用内存: ~2.5GB Swap: 512MB 网络: wlan0 (IP: 10.40.110.47) 2. 服务概览 AI 智能助手 端口: 8080 基于: llama.cpp 模型: Phi-3-mini-4k-instruct-q4.gguf 资源占用: CPU: ~300% (多核) 内存: ~3GB Swap: 511Mi 个人博客 端口: 80 框架: Hugo v0.139.3-extended 主题: Ananke Web服务器: Nginx 资源占用: 轻量级 3. 服务访问 AI 助手: http://10.40.110.47:8080 博客开发: http://10.40.110.47:1313 博客正式: http://10.40.110.47 二、AI 智能助手部署 1. 环境准备 # 更新系统 sudo apt update sudo apt upgrade -y # 安装依赖 sudo apt install build-essential git cmake 2. 编译安装 # 克隆仓库 git clone https://github.com/ggerganov/llama.cpp.git cd llama.cpp # 编译 make clean LLAMA_METAL=1 make -j4 3. 模型配置 # 创建模型目录 mkdir models cd models # 下载模型文件 wget [模型下载地址]/Phi-3-mini-4k-instruct-q4.gguf # 验证模型文件 sha256sum Phi-3-mini-4k-instruct-q4.gguf 4. 服务配置 # 创建启动脚本 nano ~/projects/llama.cpp/start-llama.sh #!/bin/bash cd ~/projects/llama.cpp nohup ./llama-server \ -m models/Phi-3-mini-4k-instruct-q4.gguf \ --host 0.0.0.0 \ --port 8080 \ --ctx-size 2048 \ --threads 2 \ --batch-size 256 \ > llama.log 2>&amp;1 & # 设置执行权限 chmod +x start-llama.sh # 启动服务 ./start-llama.sh # 验证服务状态 ps aux | grep llama-server netstat -tuln | grep 8080 三、个人博客部署 1. Hugo 安装 # 下载 Hugo Extended 版本 wget https://github.com/gohugoio/hugo/releases/download/v0.139.3/hugo_extended_0.139.3_linux-arm64.deb # 安装 sudo dpkg -i hugo_extended_0.139.3_linux-arm64.deb # 验证安装 hugo version 2. 博客初始化 # 创建站点 cd ~ hugo new site myblog cd myblog # 初始化 Git git init # 添加主题 git submodule add https://github.com/theNewDynamic/gohugo-theme-ananke.git themes/ananke 3. 博客配置 # 编辑配置文件 nano config.toml baseURL = "http://10.40.110.47/" languageCode = "zh-cn" title = "My Blog" theme = "ananke" [params] author = "Your Name" description = "Welcome to my blog" dateFormat = "2006-01-02" background_color_class = "bg-black" recent_posts_number = 3 mainSections = ["posts"] featured_image = false [menu] [[menu.main]] identifier = "posts" name = "文章" url = "/posts/" weight = 1 [[menu.main]] identifier = "about" name = "关于" url = "/about/" weight = 2 4. Nginx 配置 # 安装 Nginx sudo apt install nginx # 创建配置文件 sudo nano /etc/nginx/sites-available/myblog server { listen 80; server_name 10.40.110.47; root /home/zhaoxiongzhou/myblog/public; index index.html; location / { try_files $uri $uri/ =404; } access_log /var/log/nginx/myblog_access.log; error_log /var/log/nginx/myblog_error.log; } # 启用配置 sudo ln -s /etc/nginx/sites-available/myblog /etc/nginx/sites-enabled/ sudo rm /etc/nginx/sites-enabled/default # 测试配置 sudo nginx -t # 重启 Nginx sudo systemctl restart nginx 四、权限与自动化配置 1. 权限设置 # 设置目录权限 sudo chmod 755 /home/zhaoxiongzhou sudo chmod -R 755 /home/zhaoxiongzhou/myblog # 设置文件所有权 sudo chown -R www-data:www-data /home/zhaoxiongzhou/myblog/public # 验证权限 ls -la ~/myblog/public ls -la /home/zhaoxiongzhou 2. 自动部署脚本 # 创建博客部署脚本 nano ~/deploy-blog.sh #!/bin/bash cd ~/myblog hugo sudo chown -R www-data:www-data public/ sudo systemctl restart nginx # 设置执行权限 chmod +x ~/deploy-blog.sh 3. 备份脚本 # 创建备份脚本 nano ~/backup-blog.sh #!/bin/bash BACKUP_DIR="/home/zhaoxiongzhou/backups" DATE=$(date +%Y%m%d) # 创建备份目录 mkdir -p $BACKUP_DIR # 备份博客内容 tar -czf $BACKUP_DIR/blog_$DATE.tar.gz ~/myblog/content # 备份配置文件 cp ~/myblog/config.toml $BACKUP_DIR/config_$DATE.toml # 删除30天前的备份 find $BACKUP_DIR -name "*.tar.gz" -mtime +30 -delete # 设置执行权限 chmod +x ~/backup-blog.sh # 配置定时任务 crontab -e # 添加定时任务（每周日凌晨2点执行备份） 0 2 * * 0 /home/zhaoxiongzhou/backup-blog.sh 五、系统维护与监控 1. 资源监控命令 # 系统资源监控 htop top free -h vmstat 1 # 磁盘使用监控 df -h du -sh /* du -sh ~/myblog du -sh ~/projects/llama.cpp # 温度监控 vcgencmd measure_temp 2. 性能优化 # 清理系统缓存 sudo sync; echo 3 | sudo tee /proc/sys/vm/drop_caches # 调整 Swap 设置 cat /proc/sys/vm/swappiness sudo sysctl vm.swappiness=60 # CPU 频率调整 sudo nano /boot/config.txt # CPU 配置参数 arm_freq=1800 over_voltage=6 temp_limit=75 3. 系统维护 # 系统更新 sudo apt update sudo apt upgrade -y sudo apt autoremove sudo apt clean # 日志清理 sudo find /var/log -type f -name "*.log" -mtime +30 -delete sudo find /var/log -type f -name "*.gz" -delete # 服务状态检查 systemctl status nginx ps aux | grep llama-server 六、安全配置 1. 防火墙设置 # 安装 UFW sudo apt install ufw # 配置基本规则 sudo ufw default deny incoming sudo ufw default allow outgoing sudo ufw allow 22 sudo ufw allow 80 sudo ufw allow 8080 # 启用防火墙 sudo ufw enable # 检查状态 sudo ufw status 2. Nginx 访问控制 # 安装认证工具 sudo apt install apache2-utils # 创建用户密码 sudo htpasswd -c /etc/nginx/.htpasswd username # 修改 Nginx 配置 sudo nano /etc/nginx/sites-available/myblog server { listen 80; server_name 10.40.110.47; root /home/zhaoxiongzhou/myblog/public; index index.html; # 添加基本认证 location / { auth_basic "Restricted Access"; auth_basic_user_file /etc/nginx/.htpasswd; try_files $uri $uri/ =404; } # 日志配置 access_log /var/log/nginx/myblog_access.log; error_log /var/log/nginx/myblog_error.log; } 3. 日志监控 # 安装日志监控工具 sudo apt install logwatch # 配置日志监控 sudo nano /etc/logwatch/conf/logwatch.conf # 配置每日日志检查 Output = mail Format = html MailTo = your-email@domain.com Detail = High 七、故障排除指南 内存相关问题 # 检查内存状态 free -h ps aux --sort=-%mem | head # 如果内存不足，调整服务参数 nano ~/projects/llama.cpp/start-llama.sh # 降低资源使用的参数示例 --ctx-size 1024 \ --batch-size 128 \ --threads 1 服务无响应 # 检查进程 ps aux | grep llama-server # 检查端口 netstat -tuln | grep 8080 # 重启服务 pkill llama-server ./start-llama.sh # 检查日志 tail -f ~/projects/llama.cpp/llama.log 2. 博客服务故障排除 Nginx 问题 # 检查配置语法 sudo nginx -t # 检查日志 sudo tail -f /var/log/nginx/error.log sudo tail -f /var/log/nginx/myblog_error.log # 检查服务状态 sudo systemctl status nginx # 重启服务 sudo systemctl restart nginx Hugo 生成问题 # 清理缓存 rm -rf ~/myblog/public rm -rf ~/myblog/resources # 更新主题 git submodule update --init --recursive # 重新生成（详细模式） hugo --verbose 八、系统级故障排除 1. 磁盘问题 # 检查磁盘使用情况 df -h du -sh /* # 查找大文件 sudo find / -type f -size +100M # 清理空间 sudo apt clean sudo apt autoremove sudo journalctl --vacuum-time=7d 2. 网络问题 # 网络状态检查 ip addr show ping -c 4 8.8.8.8 netstat -tuln # DNS 检查 cat /etc/resolv.conf nslookup google.com # 重启网络服务 sudo systemctl restart networking sudo systemctl restart wpa_supplicant 3. 性能问题 # CPU 温度监控 vcgencmd measure_temp watch -n 1 vcgencmd measure_temp # CPU 频率检查 vcgencmd measure_clock arm cat /sys/devices/system/cpu/cpu0/cpufreq/scaling_cur_freq # 系统负载检查 uptime cat /proc/loadavg 九、维护最佳实践 1. 日常维护清单 检查系统日志 监控资源使用 验证服务状态 检查备份状态 更新系统安全补丁 2. 周期性维护任务 清理旧日志和临时文件 验证备份完整性 检查系统更新 检查服务性能 更新文档和配置说明 3. 应急预案 保存所有配置文件的备份 记录所有服务的配置步骤 维护问题解决方案文档 建立服务恢复流程 保持重要数据的多份备份 十、性能优化建议 1. 系统级优化 # 1. 调整 SWAP 设置 sudo nano /etc/sysctl.conf # 添加或修改以下参数 vm.swappiness=60 vm.vfs_cache_pressure=50 vm.dirty_background_ratio=5 vm.dirty_ratio=10 # 2. 优化文件系统 # 检查并优化文件系统 sudo tune2fs -o journal_data_writeback /dev/mmcblk0p2 # 3. 调整 CPU 性能 sudo nano /boot/config.txt # 添加以下配置 arm_freq=1800 over_voltage=6 gpu_freq=500 dtparam=audio=on 2. 服务优化 AI 服务优化 # 调整服务参数 nano ~/projects/llama.cpp/start-llama.sh # 优化参数示例 --ctx-size 2048 \ --threads 2 \ --batch-size 256 \ --keep-context \ --mlock \ --numa Nginx 优化 sudo nano /etc/nginx/nginx.conf worker_processes auto; worker_rlimit_nofile 65535; events { worker_connections 1024; multi_accept on; use epoll; } http { sendfile on; tcp_nopush on; tcp_nodelay on; keepalive_timeout 65; types_hash_max_size 2048; server_tokens off; # 缓存设置 open_file_cache max=1000 inactive=20s; open_file_cache_valid 30s; open_file_cache_min_uses 2; open_file_cache_errors on; } 十一、监控与报警系统 1. 系统监控配置 # 安装监控工具 sudo apt install prometheus node-exporter grafana # 配置 Prometheus sudo nano /etc/prometheus/prometheus.yml global: scrape_interval: 15s scrape_configs: - job_name: &#39;node&#39; static_configs: - targets: [&#39;localhost:9100&#39;] - job_name: &#39;nginx&#39; static_configs: - targets: [&#39;localhost:9113&#39;] 2. 自动报警脚本 # 创建监控脚本 nano ~/monitor.sh #!/bin/bash # 定义阈值 MAX_CPU_USAGE=90 MAX_MEM_USAGE=90 MAX_DISK_USAGE=90 MAX_TEMP=75 # 获取系统数据 CPU_USAGE=$(top -bn1 | grep "Cpu(s)" | awk &#39;{print $2}&#39; | cut -d. -f1) MEM_USAGE=$(free | grep Mem | awk &#39;{print $3/$2 * 100.0}&#39;) DISK_USAGE=$(df -h / | awk &#39;NR==2 {print $5}&#39; | cut -d% -f1) TEMP=$(vcgencmd measure_temp | cut -d= -f2 | cut -d. -f1) # 检查服务状态 check_services() { services=("nginx" "llama-server") for service in "${services[@]}"; do if ! pgrep -x "$service" > /dev/null; then echo "警告: $service 服务未运行!" # 可以添加重启服务的命令 fi done } # 发送警告 send_alert() { message="$1" # 这里可以添加发送邮件或其他通知的命令 echo "$message" >> /var/log/system_alerts.log } # 检查各项指标 if [ "$CPU_USAGE" -gt "$MAX_CPU_USAGE" ]; then send_alert "CPU 使用率过高: $CPU_USAGE%" fi if [ "${MEM_USAGE%.*}" -gt "$MAX_MEM_USAGE" ]; then send_alert "内存使用率过高: $MEM_USAGE%" fi if [ "$DISK_USAGE" -gt "$MAX_DISK_USAGE" ]; then send_alert "磁盘使用率过高: $DISK_USAGE%" fi if [ "$TEMP" -gt "$MAX_TEMP" ]; then send_alert "系统温度过高: $TEMP°C" fi # 检查服务状态 check_services # 设置执行权限 chmod +x ~/monitor.sh # 添加到 crontab crontab -e # 每5分钟执行一次监控 */5 * * * * /home/zhaoxiongzhou/monitor.sh 十二、数据备份与恢复 1. 完整备份方案 # 创建完整备份脚本 nano ~/full-backup.sh #!/bin/bash BACKUP_ROOT="/home/zhaoxiongzhou/backups" DATE=$(date +%Y%m%d_%H%M%S) BACKUP_DIR="$BACKUP_ROOT/$DATE" # 创建备份目录 mkdir -p "$BACKUP_DIR" # 备份博客内容 echo "备份博客内容..." tar -czf "$BACKUP_DIR/blog_content.tar.gz" ~/myblog/content tar -czf "$BACKUP_DIR/blog_config.tar.gz" ~/myblog/config.toml # 备份 AI 模型和配置 echo "备份 AI 服务..." tar -czf "$BACKUP_DIR/llama_models.tar.gz" ~/projects/llama.cpp/models tar -czf "$BACKUP_DIR/llama_config.tar.gz" ~/projects/llama.cpp/start-llama.sh # 备份 Nginx 配置 echo "备份 Nginx 配置..." sudo tar -czf "$BACKUP_DIR/nginx_config.tar.gz" /etc/nginx/sites-available/myblog # 备份系统配置 echo "备份系统配置..." sudo tar -czf "$BACKUP_DIR/system_config.tar.gz" /boot/config.txt /etc/fstab # 创建备份清单 echo "创建备份清单..." find "$BACKUP_DIR" -type f -exec sha256sum {} \; > "$BACKUP_DIR/checksum.txt" # 清理旧备份（保留最近7份） cd "$BACKUP_ROOT" ls -t | tail -n +8 | xargs -r rm -r echo "备份完成: $BACKUP_DIR" 2. 数据恢复流程 # 创建恢复脚本 nano ~/restore.sh #!/bin/bash if [ -z "$1" ]; then echo "使用方法: $0 <备份目录>" exit 1 fi BACKUP_DIR="$1" # 验证备份完整性 echo "验证备份完整性..." cd "$BACKUP_DIR" sha256sum -c checksum.txt || { echo "备份验证失败！" exit 1 } # 恢复博客内容 echo "恢复博客内容..." tar -xzf "$BACKUP_DIR/blog_content.tar.gz" -C ~/myblog/ tar -xzf "$BACKUP_DIR/blog_config.tar.gz" -C ~/myblog/ # 恢复 AI 服务 echo "恢复 AI 服务..." tar -xzf "$BACKUP_DIR/llama_models.tar.gz" -C ~/projects/llama.cpp/ tar -xzf "$BACKUP_DIR/llama_config.tar.gz" -C ~/projects/llama.cpp/ # 恢复 Nginx 配置 echo "恢复 Nginx 配置..." sudo tar -xzf "$BACKUP_DIR/nginx_config.tar.gz" -C /etc/nginx/sites-available/ # 恢复系统配置 echo "恢复系统配置..." sudo tar -xzf "$BACKUP_DIR/system_config.tar.gz" -C / # 重启服务 echo "重启服务..." sudo systemctl restart nginx pkill llama-server ~/projects/llama.cpp/start-llama.sh echo "恢复完成" 十三、服务升级指南 1. Hugo 博客升级 # 1. 备份当前版本 cd ~ tar -czf hugo_backup_$(date +%Y%m%d).tar.gz myblog/ # 2. 检查当前版本 hugo version # 3. 下载新版本 wget https://github.com/gohugoio/hugo/releases/download/v[新版本]/hugo_extended_[新版本]_linux-arm64.deb # 4. 安装新版本 sudo dpkg -i hugo_extended_[新版本]_linux-arm64.deb # 5. 更新主题 cd ~/myblog git submodule update --remote themes/ananke # 6. 测试生成 hugo --verbose # 7. 部署更新 ./deploy-blog.sh 2. AI 服务升级 # 1. 备份当前版本 cd ~/projects tar -czf llama_backup_$(date +%Y%m%d).tar.gz llama.cpp/ # 2. 更新源码 cd llama.cpp git pull origin master # 3. 重新编译 make clean LLAMA_METAL=1 make -j4 # 4. 测试新版本 ./llama-server -h # 5. 更新启动脚本 nano start-llama.sh 3. 系统升级 # 1. 更新软件包列表 sudo apt update # 2. 升级所有包 sudo apt upgrade -y # 3. 升级系统 sudo apt dist-upgrade -y # 4. 清理旧包 sudo apt autoremove -y sudo apt clean # 5. 检查启动项 sudo systemctl list-unit-files --state=enabled # 6. 更新树莓派固件 sudo rpi-update # 7. 检查系统状态 sudo systemctl --failed sudo journalctl -p 3 -xb 十四、安全加固指南 1. 系统安全配置 # 1. SSH 安全配置 sudo nano /etc/ssh/sshd_config # SSH 配置建议 Port 22222 # 修改默认端口 PermitRootLogin no # 禁止 root 登录 PasswordAuthentication no # 禁用密码认证 PubkeyAuthentication yes # 启用密钥认证 AllowUsers zhaoxiongzhou # 限制允许的用户 # 2. 设置防火墙规则 sudo apt install ufw fail2ban # 配置 UFW sudo ufw default deny incoming sudo ufw default allow outgoing sudo ufw allow 22222/tcp # SSH sudo ufw allow 80/tcp # HTTP sudo ufw allow 8080/tcp # AI 服务 sudo ufw enable # 配置 fail2ban sudo nano /etc/fail2ban/jail.local [sshd] enabled = true port = 22222 filter = sshd logpath = /var/log/auth.log maxretry = 3 bantime = 3600 2. 服务安全配置 Nginx 安全设置 # 1. 创建 SSL 证书 sudo openssl req -x509 -nodes -days 365 -newkey rsa:2048 \ -keyout /etc/nginx/ssl/nginx.key \ -out /etc/nginx/ssl/nginx.crt # 2. 配置 HTTPS sudo nano /etc/nginx/sites-available/myblog server { listen 443 ssl; server_name 10.40.110.47; ssl_certificate /etc/nginx/ssl/nginx.crt; ssl_certificate_key /etc/nginx/ssl/nginx.key; # SSL 配置 ssl_protocols TLSv1.2 TLSv1.3; ssl_prefer_server_ciphers on; ssl_ciphers ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256; # 安全头部 add_header X-Frame-Options "SAMEORIGIN"; add_header X-XSS-Protection "1; mode=block"; add_header X-Content-Type-Options "nosniff"; add_header Strict-Transport-Security "max-age=31536000"; # 其他配置... } 十五、性能监控与分析 1. 监控脚本配置 # 创建综合监控脚本 nano ~/system_monitor.sh #!/bin/bash LOG_FILE="/var/log/system_monitor.log" ALERT_FILE="/var/log/system_alerts.log" # 记录时间戳 timestamp() { date "+%Y-%m-%d %H:%M:%S" } # 系统资源监控 monitor_resources() { echo "=== 系统资源监控 $(timestamp) ===" >> "$LOG_FILE" # CPU 使用率 CPU_USAGE=$(top -bn1 | grep "Cpu(s)" | awk &#39;{print $2}&#39;) echo "CPU 使用率: $CPU_USAGE%" >> "$LOG_FILE" # 内存使用 free -h | grep "Mem:" >> "$LOG_FILE" # 磁盘使用 df -h / >> "$LOG_FILE" # 系统负载 uptime >> "$LOG_FILE" # CPU 温度 vcgencmd measure_temp >> "$LOG_FILE" } # 服务状态监控 monitor_services() { echo "=== 服务状态监控 $(timestamp) ===" >> "$LOG_FILE" # Nginx 状态 if systemctl is-active nginx >/dev/null 2>&amp;1; then echo "Nginx: 运行中" >> "$LOG_FILE" else echo "警告: Nginx 未运行!" >> "$ALERT_FILE" fi # AI 服务状态 if pgrep -f llama-server >/dev/null; then echo "AI 服务: 运行中" >> "$LOG_FILE" else echo "警告: AI 服务未运行!" >> "$ALERT_FILE" fi } # 网络监控 monitor_network() { echo "=== 网络监控 $(timestamp) ===" >> "$LOG_FILE" # 网络连接数 netstat -an | grep ESTABLISHED | wc -l >> "$LOG_FILE" # 网络流量 ifconfig wlan0 | grep bytes >> "$LOG_FILE" } # 主函数 main() { monitor_resources monitor_services monitor_network # 检查是否需要发送警告 if [ -s "$ALERT_FILE" ]; then # 可以添加发送警告的命令（如邮件通知） cat "$ALERT_FILE" fi } # 执行监控 main 2. 性能分析工具 # 安装性能分析工具 sudo apt install sysstat iotop htop # 创建性能数据收集脚本 nano ~/collect_performance.sh 十六、性能数据收集与分析 1. 性能数据收集脚本 #!/bin/bash # ~/collect_performance.sh PERF_DIR="/home/zhaoxiongzhou/performance_data" DATE=$(date +%Y%m%d_%H%M%S) # 创建数据目录 mkdir -p "$PERF_DIR/$DATE" # CPU 性能数据 mpstat 1 60 > "$PERF_DIR/$DATE/cpu_stats.log" & # 内存使用数据 vmstat 1 60 > "$PERF_DIR/$DATE/memory_stats.log" & # IO 性能数据 iostat -x 1 60 > "$PERF_DIR/$DATE/io_stats.log" & # 网络性能数据 sar -n DEV 1 60 > "$PERF_DIR/$DATE/network_stats.log" & # 进程性能数据 ps aux --sort=-%cpu | head -n 20 > "$PERF_DIR/$DATE/top_processes.log" # 系统负载数据 uptime > "$PERF_DIR/$DATE/load_average.log" # 等待所有后台进程完成 wait # 压缩数据 tar -czf "$PERF_DIR/performance_${DATE}.tar.gz" "$PERF_DIR/$DATE" rm -rf "$PERF_DIR/$DATE" 2. 性能数据分析脚本 # 创建分析脚本 nano ~/analyze_performance.sh #!/bin/bash # ~/analyze_performance.sh PERF_DIR="/home/zhaoxiongzhou/performance_data" REPORT_DIR="/home/zhaoxiongzhou/performance_reports" DATE=$(date +%Y%m%d) mkdir -p "$REPORT_DIR" generate_report() { local REPORT_FILE="$REPORT_DIR/report_${DATE}.txt" echo "性能分析报告 - $(date)" > "$REPORT_FILE" echo "===================" >> "$REPORT_FILE" # CPU 使用分析 echo -e "\nCPU 使用情况:" >> "$REPORT_FILE" awk &#39;/all/ {total += $3; count++} END {print "平均CPU使用率: " total/count "%"}&#39; \ "$PERF_DIR/latest/cpu_stats.log" >> "$REPORT_FILE" # 内存使用分析 echo -e "\n内存使用情况:" >> "$REPORT_FILE" free -h | grep "Mem:" >> "$REPORT_FILE" # IO 性能分析 echo -e "\nIO 性能:" >> "$REPORT_FILE" tail -n 10 "$PERF_DIR/latest/io_stats.log" >> "$REPORT_FILE" # 网络性能分析 echo -e "\n网络性能:" >> "$REPORT_FILE" tail -n 10 "$PERF_DIR/latest/network_stats.log" >> "$REPORT_FILE" # 进程分析 echo -e "\n资源占用最高的进程:" >> "$REPORT_FILE" head -n 5 "$PERF_DIR/latest/top_processes.log" >> "$REPORT_FILE" echo -e "\n分析完成。报告保存在: $REPORT_FILE" } # 生成报告 generate_report 十七、自动化运维脚本 1. 服务健康检查与自动恢复 # 创建服务监控脚本 nano ~/service_health_check.sh #!/bin/bash # ~/service_health_check.sh LOG_FILE="/var/log/service_health.log" ALERT_SCRIPT="/home/zhaoxiongzhou/send_alert.sh" log_message() { echo "[$(date &#39;+%Y-%m-%d %H:%M:%S&#39;)] $1" >> "$LOG_FILE" } check_and_restart_service() { local service_name="$1" local process_pattern="$2" if ! pgrep -f "$process_pattern" > /dev/null; then log_message "警告: $service_name 服务未运行，尝试重启" case "$service_name" in "nginx") sudo systemctl restart nginx ;; "llama-server") cd ~/projects/llama.cpp ./start-llama.sh ;; esac # 等待服务启动 sleep 10 # 验证服务是否成功重启 if pgrep -f "$process_pattern" > /dev/null; then log_message "$service_name 服务已成功重启" "$ALERT_SCRIPT" "$service_name 服务已自动重启" else log_message "错误: $service_name 服务重启失败" "$ALERT_SCRIPT" "警告: $service_name 服务重启失败，需要手动干预" fi else log_message "$service_name 服务运行正常" fi } # 检查各个服务 check_and_restart_service "nginx" "nginx" check_and_restart_service "llama-server" "llama-server" # 清理旧日志 find "$LOG_FILE" -mtime +30 -delete 2. 自动备份与清理 # 创建自动维护脚本 nano ~/auto_maintenance.sh #!/bin/bash # ~/auto_maintenance.sh BACKUP_DIR="/home/zhaoxiongzhou/backups" LOG_DIR="/var/log" DATE=$(date +%Y%m%d) # 创建备份 create_backups() { # 博客备份 tar -czf "$BACKUP_DIR/blog_$DATE.tar.gz" ~/myblog/content # AI 服务配置备份 tar -czf "$BACKUP_DIR/llama_config_$DATE.tar.gz" ~/projects/llama.cpp/start-llama.sh # Nginx 配置备份 sudo tar -czf "$BACKUP_DIR/nginx_config_$DATE.tar.gz" /etc/nginx/sites-available/ } # 清理旧文件 cleanup_old_files() { # 删除30天前的备份 find "$BACKUP_DIR" -name "*.tar.gz" -mtime +30 -delete # 清理日志 sudo find "$LOG_DIR" -name "*.log" -mtime +30 -delete sudo find "$LOG_DIR" -name "*.gz" -mtime +30 -delete # 清理系统临时文件 sudo rm -rf /tmp/* sudo rm -rf /var/tmp/* } # 主函数 main() { create_backups cleanup_old_files # 压缩日志 sudo logrotate -f /etc/logrotate.conf # 清理包缓存 sudo apt clean sudo apt autoremove -y } # 执行维护任务 main 十八、日志管理系统 1. 集中式日志配置 # 创建日志管理脚本 nano ~/log_management.sh #!/bin/bash # ~/log_management.sh LOG_BASE="/var/log/services" ARCHIVE_DIR="/home/zhaoxiongzhou/log_archives" DATE=$(date +%Y%m%d) # 创建日志目录 mkdir -p "$LOG_BASE"/{nginx,ai_service,system} mkdir -p "$ARCHIVE_DIR" # 配置日志轮转 sudo tee /etc/logrotate.d/custom_services << EOF $LOG_BASE/nginx/*.log { daily missingok rotate 14 compress delaycompress notifempty create 0640 www-data adm sharedscripts postrotate [ -f /var/run/nginx.pid ] && kill -USR1 \$(cat /var/run/nginx.pid) endscript } $LOG_BASE/ai_service/*.log { daily missingok rotate 14 compress delaycompress notifempty create 0640 zhaoxiongzhou adm } $LOG_BASE/system/*.log { daily missingok rotate 30 compress delaycompress notifempty create 0640 root adm } EOF # 日志分析函数 analyze_logs() { local log_file="$1" local output_file="$2" echo "=== 日志分析报告 $(date) ===" > "$output_file" # 错误统计 echo -e "\n错误统计:" >> "$output_file" grep -i "error" "$log_file" | sort | uniq -c | sort -nr >> "$output_file" # 警告统计 echo -e "\n警告统计:" >> "$output_file" grep -i "warning" "$log_file" | sort | uniq -c | sort -nr >> "$output_file" # 访问统计（针对 Nginx 访问日志） if [[ "$log_file" == *"nginx/access"* ]]; then echo -e "\n访问量统计:" >> "$output_file" awk &#39;{print $1}&#39; "$log_file" | sort | uniq -c | sort -nr | head -n 10 >> "$output_file" fi } # 日志归档函数 archive_logs() { local source_dir="$1" local archive_name="logs_${DATE}.tar.gz" find "$source_dir" -name "*.log.*" -mtime +14 -exec tar -czf "$ARCHIVE_DIR/$archive_name" {} + find "$source_dir" -name "*.log.*" -mtime +14 -delete } 2. 日志监控告警 # 创建日志监控脚本 nano ~/log_monitor.sh #!/bin/bash # ~/log_monitor.sh ALERT_THRESHOLD=10 # 错误阈值 ALERT_SCRIPT="/home/zhaoxiongzhou/send_alert.sh" # 监控特定关键词 monitor_keywords() { local log_file="$1" local keywords=("error" "critical" "failed" "timeout" "exception") for keyword in "${keywords[@]}"; do count=$(grep -i "$keyword" "$log_file" | wc -l) if [ "$count" -gt "$ALERT_THRESHOLD" ]; then "$ALERT_SCRIPT" "警告: $log_file 中发现大量 $keyword ($count 次)" fi done } # 监控日志大小 check_log_size() { local log_file="$1" local max_size=$((100 * 1024 * 1024)) # 100MB size=$(stat -f%z "$log_file") if [ "$size" -gt "$max_size" ]; then "$ALERT_SCRIPT" "警告: $log_file 大小超过 100MB" fi } # 主监控循环 main() { while true; do for log_file in "$LOG_BASE"/**/*.log; do monitor_keywords "$log_file" check_log_size "$log_file" done sleep 300 # 每5分钟检查一次 done } main & 十九、系统优化与调优 1. 系统参数优化 # 创建系统优化脚本 nano ~/system_optimize.sh #!/bin/bash # ~/system_optimize.sh # 系统参数优化 optimize_sysctl() { sudo tee /etc/sysctl.d/99-custom.conf << EOF # 内存管理优化 vm.swappiness = 60 vm.vfs_cache_pressure = 50 vm.dirty_background_ratio = 5 vm.dirty_ratio = 10 # 网络优化 net.core.somaxconn = 1024 net.core.netdev_max_backlog = 5000 net.ipv4.tcp_max_syn_backlog = 2048 net.ipv4.tcp_fin_timeout = 20 net.ipv4.tcp_keepalive_time = 1200 net.ipv4.tcp_keepalive_intvl = 15 net.ipv4.tcp_keepalive_probes = 5 # 文件系统优化 fs.file-max = 65535 fs.inotify.max_user_watches = 524288 EOF # 应用新的系统参数 sudo sysctl -p /etc/sysctl.d/99-custom.conf } # CPU 频率优化 optimize_cpu() { sudo tee /boot/config.txt << EOF # CPU 设置 arm_freq=1800 over_voltage=6 gpu_freq=500 # 温度控制 temp_limit=75 EOF } # 服务优化 optimize_services() { # 禁用不必要的服务 UNNECESSARY_SERVICES=( "bluetooth" "cups" "avahi-daemon" ) for service in "${UNNECESSARY_SERVICES[@]}"; do if systemctl is-enabled "$service" &>/dev/null; then sudo systemctl disable "$service" sudo systemctl stop "$service" fi done } # 内存优化 optimize_memory() { # 调整 ZRAM sudo tee /etc/default/zramswap << EOF ALGO=lz4 PERCENT=50 EOF # 重启 ZRAM 服务 sudo systemctl restart zramswap } 2. 服务优化配置 # Nginx 优化配置 sudo nano /etc/nginx/nginx.conf user www-data; worker_processes auto; worker_rlimit_nofile 65535; events { worker_connections 1024; multi_accept on; use epoll; } http { # 基础设置 sendfile on; tcp_nopush on; tcp_nodelay on; keepalive_timeout 65; types_hash_max_size 2048; server_tokens off; # MIME 类型 include /etc/nginx/mime.types; default_type application/octet-stream; # 日志格式 log_format main &#39;$remote_addr - $remote_user [$time_local] "$request" &#39; &#39;$status $body_bytes_sent "$http_referer" &#39; &#39;"$http_user_agent" "$http_x_forwarded_for"&#39;; # 缓冲区设置 client_body_buffer_size 10K; client_header_buffer_size 1k; client_max_body_size 8m; large_client_header_buffers 2 1k; # 超时设置 client_body_timeout 12; client_header_timeout 12; send_timeout 10; # 缓存设置 open_file_cache max=1000 inactive=20s; open_file_cache_valid 30s; open_file_cache_min_uses 2; open_file_cache_errors on; # Gzip 压缩 gzip on; gzip_vary on; gzip_proxied any; gzip_comp_level 6; gzip_types text/plain text/css text/xml application/json application/javascript application/xml+rss application/atom+xml image/svg+xml; } 二十、服务监控面板配置 1. Grafana 监控系统配置 # 安装 Grafana sudo apt-get install -y apt-transport-https sudo apt-get install -y software-properties-common wget wget -q -O - https://packages.grafana.com/gpg.key | sudo apt-key add - echo "deb https://packages.grafana.com/oss/deb stable main" | sudo tee -a /etc/apt/sources.list.d/grafana.list sudo apt-get update sudo apt-get install -y grafana # 配置 Grafana sudo nano /etc/grafana/grafana.ini [server] http_addr = 0.0.0.0 http_port = 3000 [security] admin_user = admin admin_password = your_secure_password [auth.anonymous] enabled = false [paths] data = /var/lib/grafana logs = /var/log/grafana plugins = /var/lib/grafana/plugins [dashboards] versions_to_keep = 20 2. Prometheus 配置 # 安装 Prometheus sudo apt-get install -y prometheus # 配置 Prometheus sudo nano /etc/prometheus/prometheus.yml global: scrape_interval: 15s evaluation_interval: 15s scrape_configs: - job_name: &#39;node&#39; static_configs: - targets: [&#39;localhost:9100&#39;] - job_name: &#39;nginx&#39; static_configs: - targets: [&#39;localhost:9113&#39;] - job_name: &#39;system&#39; static_configs: - targets: [&#39;localhost:9090&#39;] - job_name: &#39;process&#39; static_configs: - targets: [&#39;localhost:9256&#39;] 3. Node Exporter 配置 # 安装 Node Exporter sudo apt-get install -y prometheus-node-exporter # 创建自定义指标收集脚本 nano ~/custom_metrics.sh #!/bin/bash # ~/custom_metrics.sh # 创建指标文件 METRICS_FILE="/var/lib/node_exporter/custom_metrics.prom" while true; do # CPU 温度 CPU_TEMP=$(vcgencmd measure_temp | sed &#39;s/temp=//&#39; | sed &#39;s/&#39;"&#39;"&#39;C//&#39;) echo "raspberry_pi_cpu_temperature $CPU_TEMP" > "$METRICS_FILE" # AI 服务状态 if pgrep -f llama-server > /dev/null; then echo "ai_service_status 1" >> "$METRICS_FILE" else echo "ai_service_status 0" >> "$METRICS_FILE" fi # 博客服务状态 if systemctl is-active nginx > /dev/null; then echo "blog_service_status 1" >> "$METRICS_FILE" else echo "blog_service_status 0" >> "$METRICS_FILE" fi # 内存使用 FREE_MEM=$(free | grep Mem | awk &#39;{print $4}&#39;) echo "system_free_memory_bytes $FREE_MEM" >> "$METRICS_FILE" sleep 15 done 二十一、自动化部署与更新 1. 自动部署配置脚本 # 创建自动部署脚本 nano ~/auto_deploy.sh #!/bin/bash # ~/auto_deploy.sh # 配置 BLOG_DIR="/home/zhaoxiongzhou/myblog" LLAMA_DIR="/home/zhaoxiongzhou/projects/llama.cpp" BACKUP_DIR="/home/zhaoxiongzhou/backups" LOG_FILE="/var/log/auto_deploy.log" # 日志函数 log() { echo "[$(date &#39;+%Y-%m-%d %H:%M:%S&#39;)] $1" >> "$LOG_FILE" } # 备份当前版本 backup_current() { log "开始备份当前版本" # 博客备份 tar -czf "$BACKUP_DIR/blog_$(date +%Y%m%d_%H%M%S).tar.gz" "$BLOG_DIR" # AI 服务备份 tar -czf "$BACKUP_DIR/llama_$(date +%Y%m%d_%H%M%S).tar.gz" "$LLAMA_DIR" log "备份完成" } # 更新博客 update_blog() { log "开始更新博客" cd "$BLOG_DIR" || exit 1 # 拉取最新代码 if git pull origin master; then # 更新主题 git submodule update --remote themes/ananke # 构建站点 hugo --minify # 更新权限 sudo chown -R www-data:www-data public/ # 重启 Nginx sudo systemctl restart nginx log "博客更新成功" else log "错误: 博客更新失败" return 1 fi } # 更新 AI 服务 update_ai_service() { log "开始更新 AI 服务" cd "$LLAMA_DIR" || exit 1 # 停止当前服务 pkill llama-server # 拉取最新代码 if git pull origin master; then # 重新编译 make clean if LLAMA_METAL=1 make -j4; then # 启动服务 ./start-llama.sh # 验证服务 sleep 5 if pgrep -f llama-server > /dev/null; then log "AI 服务更新成功" else log "错误: AI 服务启动失败" return 1 fi else log "错误: AI 服务编译失败" return 1 fi else log "错误: AI 服务代码更新失败" return 1 fi } # 主函数 main() { log "开始自动部署流程" # 创建备份 backup_current # 更新服务 if update_blog && update_ai_service; then log "部署完成" return 0 else log "部署失败" return 1 fi } # 执行部署 main 2. 自动更新检查脚本 # 创建更新检查脚本 nano ~/check_updates.sh 二十一、自动更新检查与通知系统 1. 更新检查脚本 #!/bin/bash # ~/check_updates.sh # 配置 NOTIFY_SCRIPT="/home/zhaoxiongzhou/send_notification.sh" LOG_FILE="/var/log/update_check.log" GITHUB_API="https://api.github.com" LLAMA_REPO="ggerganov/llama.cpp" HUGO_REPO="gohugoio/hugo" # 日志函数 log() { echo "[$(date &#39;+%Y-%m-%d %H:%M:%S&#39;)] $1" | tee -a "$LOG_FILE" } # 检查 GitHub 仓库更新 check_github_updates() { local repo="$1" local current_version="$2" # 获取最新版本 latest_version=$(curl -s "$GITHUB_API/repos/$repo/releases/latest" | grep -Po &#39;"tag_name": "\K.*?(?=")&#39;) if [ "$latest_version" != "$current_version" ]; then log "发现新版本: $repo ($current_version -> $latest_version)" return 0 else log "当前版本已是最新: $repo ($current_version)" return 1 fi } # 检查系统更新 check_system_updates() { sudo apt update > /dev/null 2>&amp;1 updates=$(sudo apt list --upgradable 2>/dev/null | grep -c "upgradable") if [ "$updates" -gt 0 ]; then log "发现 $updates 个系统更新" return 0 else log "系统已是最新" return 1 fi } # 检查服务状态 check_services() { local services=("nginx" "llama-server") local status=0 for service in "${services[@]}"; do if [ "$service" = "nginx" ]; then if ! systemctl is-active --quiet nginx; then log "警告: Nginx 服务未运行" status=1 fi elif [ "$service" = "llama-server" ]; then if ! pgrep -f llama-server > /dev/null; then log "警告: AI 服务未运行" status=1 fi fi done return $status } # 发送通知 send_notification() { local message="$1" local priority="$2" if [ -x "$NOTIFY_SCRIPT" ]; then "$NOTIFY_SCRIPT" "$message" "$priority" else log "通知脚本不存在或不可执行" fi } # 主函数 main() { log "开始检查更新" # 获取当前版本 current_llama_version=$(cd ~/projects/llama.cpp && git describe --tags) current_hugo_version=$(hugo version | grep -Po "v\d+\.\d+\.\d+") # 检查更新 updates_found=0 if check_github_updates "$LLAMA_REPO" "$current_llama_version"; then send_notification "llama.cpp 有新版本可用" "normal" updates_found=1 fi if check_github_updates "$HUGO_REPO" "$current_hugo_version"; then send_notification "Hugo 有新版本可用" "normal" updates_found=1 fi if check_system_updates; then send_notification "系统有更新可用" "normal" updates_found=1 fi if ! check_services; then send_notification "服务状态异常，请检查" "high" fi if [ "$updates_found" -eq 0 ]; then log "所有组件均为最新版本" fi } # 执行检查 main 二十二、通知系统配置 1. 通知发送脚本 # 创建通知发送脚本 nano ~/send_notification.sh #!/bin/bash # ~/send_notification.sh # 配置 TELEGRAM_BOT_TOKEN="your_bot_token" TELEGRAM_CHAT_ID="your_chat_id" EMAIL_ADDRESS="your_email@domain.com" DISCORD_WEBHOOK_URL="your_discord_webhook_url" # 日志配置 LOG_FILE="/var/log/notifications.log" # 日志函数 log() { echo "[$(date &#39;+%Y-%m-%d %H:%M:%S&#39;)] $1" >> "$LOG_FILE" } # Telegram 通知 send_telegram() { local message="$1" local priority="$2" # 根据优先级添加表情符号 case "$priority" in "high") message="🚨 紧急: $message" ;; "normal") message="ℹ️ 通知: $message" ;; "low") message="📝 信息: $message" ;; esac # 发送消息 curl -s -X POST \ "https://api.telegram.org/bot$TELEGRAM_BOT_TOKEN/sendMessage" \ -d "chat_id=$TELEGRAM_CHAT_ID" \ -d "text=$message" \ -d "parse_mode=HTML" log "Telegram 通知已发送: $message" } # 邮件通知 send_email() { local message="$1" local priority="$2" local subject case "$priority" in "high") subject="[紧急] 树莓派服务警告" ;; "normal") subject="[通知] 树莓派服务更新" ;; "low") subject="[信息] 树莓派服务状态" ;; esac echo "$message" | mail -s "$subject" "$EMAIL_ADDRESS" log "邮件通知已发送: $subject - $message" } # Discord 通知 send_discord() { local message="$1" local priority="$2" local color case "$priority" in "high") color="16711680" # 红色 ;; "normal") color="65280" # 绿色 ;; "low") color="255" # 蓝色 ;; esac curl -H "Content-Type: application/json" \ -X POST \ -d "{\"embeds\": [{\"description\": \"$message\", \"color\": $color}]}" \ "$DISCORD_WEBHOOK_URL" log "Discord 通知已发送: $message" } # 主函数 main() { local message="$1" local priority="${2:-normal}" # 默认优先级为 normal # 检查必要参数 if [ -z "$message" ]; then log "错误: 消息内容不能为空" return 1 fi # 添加系统信息 local hostname=$(hostname) local timestamp=$(date &#39;+%Y-%m-%d %H:%M:%S&#39;) message="[$hostname] [$timestamp] $message" # 发送所有通知 send_telegram "$message" "$priority" send_email "$message" "$priority" send_discord "$message" "$priority" log "所有通知渠道处理完成" } # 执行通知发送 main "$@" 二十三、定时任务配置 1. Crontab 配置 # 编辑 crontab crontab -e # 系统维护任务 # 每天凌晨 2 点执行系统更新检查 0 2 * * * ~/check_updates.sh > /dev/null 2>&amp;1 # 每 6 小时执行一次服务健康检查 0 */6 * * * ~/service_health_check.sh > /dev/null 2>&amp;1 # 每周日凌晨 3 点执行系统优化 0 3 * * 0 ~/system_optimize.sh > /dev/null 2>&amp;1 # 每天凌晨 4 点执行日志管理 0 4 * * * ~/log_management.sh > /dev/null 2>&amp;1 # 每小时执行性能数据收集 0 * * * * ~/collect_performance.sh > /dev/null 2>&amp;1 # 每 5 分钟检查一次关键服务状态 */5 * * * * ~/monitor.sh > /dev/null 2>&amp;1 # 每天晚上 11 点执行备份 0 23 * * * ~/auto_backup.sh > /dev/null 2>&amp;1 # 每月 1 号执行完整系统检查 0 1 1 * * ~/full_system_check.sh > /dev/null 2>&amp;1 2. 完整系统检查脚本 # 创建完整系统检查脚本 nano ~/full_system_check.sh #!/bin/bash # ~/full_system_check.sh LOG_FILE="/var/log/system_check.log" REPORT_FILE="/home/zhaoxiongzhou/reports/monthly_report_$(date +%Y%m).txt" # 确保目录存在 mkdir -p "$(dirname "$REPORT_FILE")" # 日志函数 log() { echo "[$(date &#39;+%Y-%m-%d %H:%M:%S&#39;)] $1" | tee -a "$LOG_FILE" "$REPORT_FILE" } # 系统信息检查 check_system_info() { log "=== 系统信息 ===" log "系统版本: $(cat /etc/os-release | grep PRETTY_NAME)" log "内核版本: $(uname -r)" log "运行时间: $(uptime -p)" log "最后启动: $(who -b | awk &#39;{print $3,$4}&#39;)" } # 资源使用检查 check_resources() { log "=== 资源使用情况 ===" log "CPU 使用率: $(top -bn1 | grep "Cpu(s)" | awk &#39;{print $2}&#39;)%" log "内存使用情况:" free -h | tee -a "$REPORT_FILE" log "磁盘使用情况:" df -h | tee -a "$REPORT_FILE" } # 服务状态检查 check_services() { log "=== 服务状态 ===" # 检查 Nginx if systemctl is-active --quiet nginx; then log "Nginx: 运行正常" else log "Nginx: 未运行" fi # 检查 AI 服务 if pgrep -f llama-server > /dev/null; then log "AI 服务: 运行正常" else log "AI 服务: 未运行" fi } # 安全检查 check_security() { log "=== 安全检查 ===" # 检查失败的登录尝试 log "失败的登录尝试:" grep "Failed password" /var/log/auth.log | tail -n 5 | tee -a "$REPORT_FILE" # 检查开放的端口 log "开放的端口:" netstat -tuln | grep LISTEN | tee -a "$REPORT_FILE" } # 性能分析 analyze_performance() { log "=== 性能分析 ===" # 分析 CPU 使用情况 log "CPU 密集进程:" ps aux --sort=-%cpu | head -n 5 | tee -a "$REPORT_FILE" # 分析内存使用情况 log "内存密集进程:" ps aux --sort=-%mem | head -n 5 | tee -a "$REPORT_FILE" } # 主函数 main() { log "开始月度系统检查 - $(date)" check_system_info check_resources check_services check_security analyze_performance log "系统检查完成" # 发送报告 if [ -f "$REPORT_FILE" ]; then ~/send_notification.sh "月度系统检查报告已生成" "normal" fi } # 执行检查 main 二十四、灾难恢复计划 1. 系统恢复脚本 # 创建系统恢复脚本 nano ~/disaster_recovery.sh #!/bin/bash # ~/disaster_recovery.sh # 配置 BACKUP_DIR="/home/zhaoxiongzhou/backups" RECOVERY_LOG="/var/log/recovery.log" SERVICES=("nginx" "llama-server") # 日志函数 log() { echo "[$(date &#39;+%Y-%m-%d %H:%M:%S&#39;)] $1" | tee -a "$RECOVERY_LOG" } # 验证备份 verify_backup() { local backup_file="$1" if [ ! -f "$backup_file" ]; then log "错误: 备份文件不存在 - $backup_file" return 1 fi # 检查文件完整性 if ! tar -tzf "$backup_file" >/dev/null 2>&amp;1; then log "错误: 备份文件损坏 - $backup_file" return 1 fi return 0 } # 停止服务 stop_services() { log "停止所有服务..." for service in "${SERVICES[@]}"; do if [ "$service" = "nginx" ]; then sudo systemctl stop nginx else pkill "$service" fi done # 等待服务完全停止 sleep 5 } # 恢复博客服务 restore_blog() { local backup_file="$BACKUP_DIR/blog_latest.tar.gz" if verify_backup "$backup_file"; then log "开始恢复博客服务..." # 清理当前目录 rm -rf ~/myblog/* # 解压备份 tar -xzf "$backup_file" -C ~/myblog/ # 重建站点 cd ~/myblog hugo --minify # 恢复权限 sudo chown -R www-data:www-data public/ log "博客服务恢复完成" else log "博客服务恢复失败" return 1 fi } # 恢复 AI 服务 restore_ai_service() { local backup_file="$BACKUP_DIR/llama_latest.tar.gz" if verify_backup "$backup_file"; then log "开始恢复 AI 服务..." # 清理当前目录 rm -rf ~/projects/llama.cpp/* # 解压备份 tar -xzf "$backup_file" -C ~/projects/llama.cpp/ # 重新编译 cd ~/projects/llama.cpp make clean LLAMA_METAL=1 make -j4 log "AI 服务恢复完成" else log "AI 服务恢复失败" return 1 fi } # 恢复系统配置 restore_system_config() { local backup_file="$BACKUP_DIR/system_config_latest.tar.gz" if verify_backup "$backup_file"; then log "开始恢复系统配置..." # 解压系统配置 sudo tar -xzf "$backup_file" -C / # 重新加载系统配置 sudo sysctl --system log "系统配置恢复完成" else log "系统配置恢复失败" return 1 fi } # 启动服务 start_services() { log "启动所有服务..." # 启动 Nginx sudo systemctl start nginx # 启动 AI 服务 ~/projects/llama.cpp/start-llama.sh # 验证服务状态 sleep 10 verify_services } # 验证服务 verify_services() { local status=0 log "验证服务状态..." # 检查 Nginx if ! systemctl is-active --quiet nginx; then log "警告: Nginx 服务未正常运行" status=1 fi # 检查 AI 服务 if ! pgrep -f llama-server > /dev/null; then log "警告: AI 服务未正常运行" status=1 fi return $status } # 主函数 main() { log "开始系统恢复流程..." # 停止服务 stop_services # 执行恢复 if restore_system_config && restore_blog && restore_ai_service; then # 启动服务 start_services if verify_services; then log "系统恢复成功完成" ~/send_notification.sh "系统恢复成功完成" "normal" return 0 else log "系统恢复完成，但部分服务可能未正常运行" ~/send_notification.sh "系统恢复完成，但需要手动检查服务状态" "high" return 1 fi else log "系统恢复失败" ~/send_notification.sh "系统恢复失败，需要手动干预" "high" return 1 fi } # 执行恢复 main 二十五、文档管理系统 1. 文档生成脚本 # 创建文档生成脚本 nano ~/generate_docs.sh #!/bin/bash # ~/generate_docs.sh # 配置 DOCS_DIR="/home/zhaoxiongzhou/documentation" SCRIPTS_DIR="/home/zhaoxiongzhou" CONFIG_DIR="/etc" LOG_FILE="/var/log/documentation.log" # 确保目录存在 mkdir -p "$DOCS_DIR"/{scripts,configs,logs,maintenance} # 日志函数 log() { echo "[$(date &#39;+%Y-%m-%d %H:%M:%S&#39;)] $1" | tee -a "$LOG_FILE" } # 生成脚本文档 generate_script_docs() { log "生成脚本文档..." for script in "$SCRIPTS_DIR"/*.sh; do if [ -f "$script" ]; then script_name=$(basename "$script") output_file="$DOCS_DIR/scripts/${script_name%.sh}.md" { echo "# $script_name" echo "## 路径: $script" echo "## 最后修改: $(date -r "$script" &#39;+%Y-%m-%d %H:%M:%S&#39;)" echo "## 权限: $(stat -c &#39;%a&#39; "$script")" echo "## 所有者: $(stat -c &#39;%U:%G&#39; "$script")" echo echo "## 功能描述" grep -A 5 "^#.*功能:" "$script" 2>/dev/null || echo "未提供功能描述" echo echo "## 脚本内容" echo &#39;```bash&#39; cat "$script" echo &#39;```&#39; echo echo "## 依赖项" grep "^[^#]*apt.*install" "$script" 2>/dev/null || echo "未找到明确的依赖项" echo echo "## 定时任务" crontab -l 2>/dev/null | grep "$script_name" || echo "未配置定时任务" } > "$output_file" fi done } # 生成配置文档 generate_config_docs() { log "生成配置文档..." # Nginx 配置 { echo "# Nginx 配置文档" echo "## 主配置文件" echo &#39;```nginx&#39; cat /etc/nginx/nginx.conf echo &#39;```&#39; echo "## 站点配置" echo &#39;```nginx&#39; cat /etc/nginx/sites-available/myblog echo &#39;```&#39; } > "$DOCS_DIR/configs/nginx_config.md" # 系统配置 { echo "# 系统配置文档" echo "## Sysctl 配置" echo &#39;```bash&#39; cat /etc/sysctl.d/99-custom.conf echo &#39;```&#39; echo "## 树莓派配置" echo &#39;```bash&#39; cat /boot/config.txt echo &#39;```&#39; } > "$DOCS_DIR/configs/system_config.md" } # 生成维护文档 generate_maintenance_docs() { log "生成维护文档..." { echo "# 系统维护文档" echo "## 定时任务" echo &#39;```bash&#39; crontab -l echo &#39;```&#39; echo "## 服务状态" echo &#39;```bash&#39; systemctl status nginx ps aux | grep llama-server echo &#39;```&#39; echo "## 资源使用" echo &#39;```bash&#39; df -h free -h top -bn1 echo &#39;```&#39; echo "## 最近日志" echo &#39;```bash&#39; tail -n 50 /var/log/syslog echo &#39;```&#39; } > "$DOCS_DIR/maintenance/system_status.md" } # 生成索引 generate_index() { log "生成文档索引..." { echo "# 系统文档索引" echo "## 生成时间: $(date &#39;+%Y-%m-%d %H:%M:%S&#39;)" echo echo "## 脚本文档" for doc in "$DOCS_DIR/scripts"/*.md; do echo "- [$(basename "${doc%.md}")](scripts/$(basename "$doc"))" done echo echo "## 配置文档" for doc in "$DOCS_DIR/configs"/*.md; do echo "- [$(basename "${doc%.md}")](configs/$(basename "$doc"))" done echo echo "## 维护文档" for doc in "$DOCS_DIR/maintenance"/*.md; do echo "- [$(basename "${doc%.md}")](maintenance/$(basename "$doc"))" done } > "$DOCS_DIR/index.md" } # 主函数 main() { log "开始生成文档..." generate_script_docs generate_config_docs generate_maintenance_docs generate_index log "文档生成完成: $DOCS_DIR" } # 执行文档生成 main 二十六、性能测试与基准测试 1. 性能测试脚本 # 创建性能测试脚本 nano ~/benchmark.sh #!/bin/bash # ~/benchmark.sh # 配置 RESULTS_DIR="/home/zhaoxiongzhou/benchmark_results" LOG_FILE="/var/log/benchmark.log" DURATION=300 # 测试持续时间（秒） CONCURRENT_USERS=10 # 并发用户数 # 确保目录存在 mkdir -p "$RESULTS_DIR" # 日志函数 log() { echo "[$(date &#39;+%Y-%m-%d %H:%M:%S&#39;)] $1" | tee -a "$LOG_FILE" } # CPU 性能测试 benchmark_cpu() { log "开始 CPU 性能测试..." # 使用 sysbench 进行 CPU 测试 sysbench cpu --cpu-max-prime=20000 --threads=4 run > "$RESULTS_DIR/cpu_benchmark.txt" # 记录 CPU 温度 for i in $(seq 1 10); do vcgencmd measure_temp >> "$RESULTS_DIR/cpu_temp.txt" sleep 1 done } # 内存性能测试 benchmark_memory() { log "开始内存性能测试..." # 使用 sysbench 进行内存测试 sysbench memory --memory-block-size=1K --memory-total-size=10G run > "$RESULTS_DIR/memory_benchmark.txt" } # 磁盘性能测试 benchmark_disk() { log "开始磁盘性能测试..." # 使用 dd 测试写入速度 dd if=/dev/zero of=/tmp/test_file bs=1M count=1000 conv=fdatasync 2>> "$RESULTS_DIR/disk_write_benchmark.txt" # 使用 dd 测试读取速度 dd if=/tmp/test_file of=/dev/null bs=1M count=1000 2>> "$RESULTS_DIR/disk_read_benchmark.txt" # 清理测试文件 rm /tmp/test_file } # 网络性能测试 benchmark_network() { log "开始网络性能测试..." # 使用 iperf3 测试网络性能 iperf3 -c iperf.he.net -t 30 > "$RESULTS_DIR/network_benchmark.txt" } # Web 服务性能测试 benchmark_web() { log "开始 Web 服务性能测试..." # 使用 ab 测试 Web 服务 ab -n 1000 -c "$CONCURRENT_USERS" http://localhost/ > "$RESULTS_DIR/web_benchmark.txt" } # AI 服务性能测试 benchmark_ai() { log "开始 AI 服务性能测试..." # 创建测试请求 cat > /tmp/test_prompt.txt << EOF Hello, how are you? EOF # 使用 curl 测试 AI 服务响应时间 for i in $(seq 1 10); do time curl -X POST \ -H "Content-Type: application/json" \ -d @/tmp/test_prompt.txt \ http://localhost:8080/completion >> "$RESULTS_DIR/ai_benchmark.txt" 2>&amp;1 echo -e "\n---\n" >> "$RESULTS_DIR/ai_benchmark.txt" sleep 2 done } # 生成报告 generate_report() { log "生成性能测试报告..." local report_file="$RESULTS_DIR/benchmark_report_$(date +%Y%m%d_%H%M%S).md" { echo "# 性能测试报告" echo "## 测试时间: $(date &#39;+%Y-%m-%d %H:%M:%S&#39;)" echo echo "## 系统信息" echo &#39;```&#39; uname -a echo &#39;```&#39; echo echo "## CPU 性能" echo &#39;```&#39; cat "$RESULTS_DIR/cpu_benchmark.txt" echo &#39;```&#39; echo echo "## 内存性能" echo &#39;```&#39; cat "$RESULTS_DIR/memory_benchmark.txt" echo &#39;```&#39; echo echo "## 磁盘性能" echo &#39;```&#39; cat "$RESULTS_DIR/disk_write_benchmark.txt" cat "$RESULTS_DIR/disk_read_benchmark.txt" echo &#39;```&#39; echo echo "## 网络性能" echo &#39;```&#39; cat "$RESULTS_DIR/network_benchmark.txt" echo &#39;```&#39; echo echo "## Web 服务性能" echo &#39;```&#39; cat "$RESULTS_DIR/web_benchmark.txt" echo &#39;```&#39; echo echo "## AI 服务性能" echo &#39;```&#39; cat "$RESULTS_DIR/ai_benchmark.txt" echo &#39;```&#39; } > "$report_file" log "性能测试报告已生成: $report_file" } # 主函数 main() { log "开始性能测试..." # 安装必要的工具 sudo apt install -y sysbench apache2-utils iperf3 # 执行各项测试 benchmark_cpu benchmark_memory benchmark_disk benchmark_network benchmark_web benchmark_ai # 生成报告 generate_report log "性能测试完成" } # 执行测试 main 二十七、安全审计系统 1. 安全审计脚本 # 创建安全审计脚本 nano ~/security_audit.sh #!/bin/bash # ~/security_audit.sh # 配置 AUDIT_DIR="/home/zhaoxiongzhou/security_audits" REPORT_FILE="$AUDIT_DIR/security_report_$(date +%Y%m%d_%H%M%S).md" LOG_FILE="/var/log/security_audit.log" # 确保目录存在 mkdir -p "$AUDIT_DIR" # 日志函数 log() { echo "[$(date &#39;+%Y-%m-%d %H:%M:%S&#39;)] $1" | tee -a "$LOG_FILE" } # 检查系统用户 audit_users() { log "检查系统用户..." { echo "## 系统用户审计" echo "### 特权用户" echo &#39;```&#39; awk -F: &#39;$3 == 0 {print $1}&#39; /etc/passwd echo &#39;```&#39; echo "### 最近的用户活动" echo &#39;```&#39; last | head -n 10 echo &#39;```&#39; echo "### 失败的登录尝试" echo &#39;```&#39; grep "Failed password" /var/log/auth.log | tail -n 10 echo &#39;```&#39; } >> "$REPORT_FILE" } # 检查网络安全 audit_network() { log "检查网络安全..." { echo "## 网络安全审计" echo "### 开放端口" echo &#39;```&#39; netstat -tuln echo &#39;```&#39; echo "### 活动连接" echo &#39;```&#39; netstat -nat | grep ESTABLISHED echo &#39;```&#39; echo "### 防火墙规则" echo &#39;```&#39; sudo iptables -L -n echo &#39;```&#39; } >> "$REPORT_FILE" } # 检查文件权限 audit_permissions() { log "检查文件权限..." { echo "## 文件权限审计" echo "### SUID 文件" echo &#39;```&#39; sudo find / -type f -perm -4000 2>/dev/null echo &#39;```&#39; echo "### 世界可写文件" echo &#39;```&#39; sudo find / -type f -perm -2 ! -path "/proc/*" ! -path "/sys/*" 2>/dev/null echo &#39;```&#39; echo "### 敏感目录权限" echo &#39;```&#39; ls -la /etc/nginx/ ls -la ~/projects/llama.cpp/ ls -la ~/myblog/ echo &#39;```&#39; } >> "$REPORT_FILE" } # 检查服务配置 audit_services() { log "检查服务配置..." { echo "## 服务配置审计" echo "### Nginx 配置检查" echo &#39;```&#39; sudo nginx -t 2>&amp;1 echo &#39;```&#39; echo "### SSL 配置" echo &#39;```&#39; openssl s_client -connect localhost:443 -servername localhost </dev/null 2>/dev/null | openssl x509 -text echo &#39;```&#39; echo "### 服务状态" echo &#39;```&#39; systemctl list-units --type=service --state=active echo &#39;```&#39; } >> "$REPORT_FILE" } # 检查系统更新 audit_updates() { log "检查系统更新..." { echo "## 系统更新审计" echo "### 可用更新" echo &#39;```&#39; apt list --upgradable 2>/dev/null echo &#39;```&#39; echo "### 已安装包" echo &#39;```&#39; dpkg -l | grep "^ii" | wc -l echo &#39;```&#39; } >> "$REPORT_FILE" } # 检查日志异常 audit_logs() { log "检查日志异常..." { echo "## 日志审计" echo "### 系统错误" echo &#39;```&#39; sudo journalctl -p 3 -xb --no-pager | tail -n 20 echo &#39;```&#39; echo "### 异常访问" echo &#39;```&#39; grep -i "error\|failed\|warning" /var/log/nginx/error.log | tail -n 20 echo &#39;```&#39; } >> "$REPORT_FILE" } # 生成安全建议 generate_recommendations() { log "生成安全建议..." { echo "## 安全建议" echo "### 高优先级" # 检查并生成建议 if grep -q "Failed password" /var/log/auth.log; then echo "- 建议：启用 fail2ban 加强 SSH 防护" fi if [ $(find / -type f -perm -2 2>/dev/null | wc -l) -gt 0 ]; then echo "- 建议：检查并修复世界可写文件权限" fi echo "### 中优先级" # 添加其他建议 echo "- 定期更新系统包" echo "- 检查并更新 SSL 证书" echo "- 定期审查用户权限" } >> "$REPORT_FILE" } # 主函数 main() { log "开始安全审计..." # 创建报告头部 { echo "# 安全审计报告" echo "## 生成时间: $(date &#39;+%Y-%m-%d %H:%M:%S&#39;)" echo "## 系统信息" echo &#39;```&#39; uname -a echo &#39;```&#39; echo } > "$REPORT_FILE" # 执行各项审计 audit_users audit_network audit_permissions audit_services audit_updates audit_logs generate_recommendations log "安全审计完成，报告已生成: $REPORT_FILE" # 发送通知 ~/send_notification.sh "安全审计报告已生成" "normal" } # 执行审计 main 二十八、资源限制与控制 1. 资源限制配置脚本 # 创建资源限制配置脚本 nano ~/resource_control.sh #!/bin/bash # ~/resource_control.sh # 配置 LOG_FILE="/var/log/resource_control.log" LIMITS_CONF="/etc/security/limits.conf" SYSTEMD_DIR="/etc/systemd/system" # 日志函数 log() { echo "[$(date &#39;+%Y-%m-%d %H:%M:%S&#39;)] $1" | tee -a "$LOG_FILE" } # 配置系统资源限制 configure_system_limits() { log "配置系统资源限制..." # 备份原始配置 sudo cp "$LIMITS_CONF" "${LIMITS_CONF}.backup" # 添加资源限制配置 sudo tee -a "$LIMITS_CONF" << EOF # 用户资源限制 zhaoxiongzhou soft nofile 65535 zhaoxiongzhou hard nofile 65535 zhaoxiongzhou soft nproc 2048 zhaoxiongzhou hard nproc 4096 # 系统服务资源限制 www-data soft nofile 65535 www-data hard nofile 65535 www-data soft nproc 1024 www-data hard nproc 2048 EOF } # 配置 AI 服务资源限制 configure_ai_service() { log "配置 AI 服务资源限制..." # 创建 systemd 服务文件 sudo tee "$SYSTEMD_DIR/llama-server.service" << EOF [Unit] Description=Llama AI Server After=network.target [Service] User=zhaoxiongzhou Group=zhaoxiongzhou WorkingDirectory=/home/zhaoxiongzhou/projects/llama.cpp ExecStart=/home/zhaoxiongzhou/projects/llama.cpp/start-llama.sh # 资源限制 CPUQuota=80% MemoryLimit=2G TasksMax=128 LimitNOFILE=65535 # 重启策略 Restart=always RestartSec=10 [Install] WantedBy=multi-user.target EOF # 重新加载 systemd 配置 sudo systemctl daemon-reload } # 配置 Nginx 资源限制 configure_nginx() { log "配置 Nginx 资源限制..." # 修改 Nginx 配置 sudo tee "/etc/nginx/conf.d/resource_limits.conf" << EOF # 工作进程限制 worker_processes auto; worker_rlimit_nofile 65535; # 连接限制 events { worker_connections 1024; multi_accept on; } # 客户端限制 http { # 请求限制 limit_req_zone \$binary_remote_addr zone=one:10m rate=10r/s; # 连接限制 limit_conn_zone \$binary_remote_addr zone=addr:10m; server { # 应用限制 location / { limit_req zone=one burst=5; limit_conn addr 10; } } } EOF } # 配置系统资源监控 configure_monitoring() { log "配置资源监控..." # 创建监控脚本 cat > ~/monitor_resources.sh << EOF #!/bin/bash while true; do # CPU 使用率 CPU_USAGE=\$(top -bn1 | grep "Cpu(s)" | awk &#39;{print \$2}&#39;) # 内存使用率 MEM_USAGE=\$(free | grep Mem | awk &#39;{print \$3/\$2 * 100.0}&#39;) # 进程数 PROCESS_COUNT=\$(ps aux | wc -l) # 检查限制 if (( \$(echo "\$CPU_USAGE > 80" | bc -l) )); then ~/send_notification.sh "警告: CPU 使用率过高 (\${CPU_USAGE}%)" "high" fi if (( \$(echo "\$MEM_USAGE > 90" | bc -l) )); then ~/send_notification.sh "警告: 内存使用率过高 (\${MEM_USAGE}%)" "high" fi if [ "\$PROCESS_COUNT" -gt 200 ]; then ~/send_notification.sh "警告: 进程数过多 (\$PROCESS_COUNT)" "high" fi sleep 60 done EOF chmod +x ~/monitor_resources.sh } # 应用配置 apply_configurations() { log "应用资源限制配置..." # 重启服务 sudo systemctl restart nginx sudo systemctl restart llama-server # 启动监控 ~/monitor_resources.sh & # 验证配置 log "验证配置..." sudo nginx -t sudo systemctl status llama-server ulimit -a } # 主函数 main() { log "开始配置资源限制..." configure_system_limits configure_ai_service configure_nginx configure_monitoring apply_configurations log "资源限制配置完成" } # 执行配置 main 二十九、自动化测试系统 1. 集成测试脚本 # 创建集成测试脚本 nano ~/integration_test.sh #!/bin/bash # ~/integration_test.sh # 配置 TEST_DIR="/home/zhaoxiongzhou/tests" REPORT_DIR="/home/zhaoxiongzhou/test_reports" LOG_FILE="/var/log/integration_test.log" # 确保目录存在 mkdir -p "$TEST_DIR" "$REPORT_DIR" # 日志函数 log() { echo "[$(date &#39;+%Y-%m-%d %H:%M:%S&#39;)] $1" | tee -a "$LOG_FILE" } # 测试 Web 服务 test_web_service() { log "测试 Web 服务..." local result=0 # 测试首页访问 if curl -s -o /dev/null -w "%{http_code}" http://localhost/ | grep -q "200"; then log "首页访问测试通过" else log "错误: 首页访问测试失败" result=1 fi # 测试静态资源 if curl -s -o /dev/null -w "%{http_code}" http://localhost/css/main.css | grep -q "200"; then log "静态资源测试通过" else log "错误: 静态资源测试失败" result=1 fi # 测试 404 页面 if curl -s -o /dev/null -w "%{http_code}" http://localhost/nonexistent | grep -q "404"; then log "404 页面测试通过" else log "错误: 404 页面测试失败" result=1 fi return $result } # 测试 AI 服务 test_ai_service() { log "测试 AI 服务..." local result=0 # 测试服务可用性 if curl -s -o /dev/null -w "%{http_code}" http://localhost:8080/health | grep -q "200"; then log "AI 服务健康检查通过" else log "错误: AI 服务健康检查失败" result=1 fi # 测试模型响应 local response=$(curl -s -X POST \ -H "Content-Type: application/json" \ -d &#39;{"prompt": "Hello", "max_tokens": 10}&#39; \ http://localhost:8080/completion) if echo "$response" | grep -q "text"; then log "AI 服务响应测试通过" else log "错误: AI 服务响应测试失败" result=1 fi return $result } # 测试系统服务 test_system_services() { log "测试系统服务..." local result=0 # 测试 Nginx 状态 if systemctl is-active --quiet nginx; then log "Nginx 服务测试通过" else log "错误: Nginx 服务测试失败" result=1 fi # 测试系统资源 local cpu_usage=$(top -bn1 | grep "Cpu(s)" | awk &#39;{print $2}&#39;) local mem_usage=$(free | grep Mem | awk &#39;{print $3/$2 * 100.0}&#39;) if [ $(echo "$cpu_usage < 90" | bc -l) -eq 1 ]; then log "CPU 使用率正常" else log "警告: CPU 使用率过高" result=1 fi if [ $(echo "$mem_usage < 90" | bc -l) -eq 1 ]; then log "内存使用率正常" else log "警告: 内存使用率过高" result=1 fi return $result } # 生成测试报告 generate_report() { local web_result=$1 local ai_result=$2 local system_result=$3 local report_file="$REPORT_DIR/test_report_$(date +%Y%m%d_%H%M%S).md" { echo "# 集成测试报告" echo "## 测试时间: $(date &#39;+%Y-%m-%d %H:%M:%S&#39;)" echo echo "## 测试结果摘要" echo "- Web 服务: $([ $web_result -eq 0 ] && echo &#39;通过 ✅&#39; || echo &#39;失败 ❌&#39;)" echo "- AI 服务: $([ $ai_result -eq 0 ] && echo &#39;通过 ✅&#39; || echo &#39;失败 ❌&#39;)" echo "- 系统服务: $([ $system_result -eq 0 ] && echo &#39;通过 ✅&#39; || echo &#39;失败 ❌&#39;)" echo echo "## 详细日志" echo &#39;```&#39; tail -n 50 "$LOG_FILE" echo &#39;```&#39; } > "$report_file" log "测试报告已生成: $report_file" } # 主函数 main() { log "开始集成测试..." local web_result=0 local ai_result=0 local system_result=0 # 执行测试 test_web_service web_result=$? test_ai_service ai_result=$? test_system_services system_result=$? # 生成报告 generate_report $web_result $ai_result $system_result # 发送通知 if [ $web_result -eq 0 ] && [ $ai_result -eq 0 ] && [ $system_result -eq 0 ]; then ~/send_notification.sh "集成测试全部通过" "normal" else ~/send_notification.sh "集成测试存在失败项，请查看报告" "high" fi # 返回总体结果 return $(( web_result + ai_result + system_result )) } # 执行测试 main 三十、系统状态仪表板 1. 状态监控页面生成脚本 # 创建状态页面生成脚本 nano ~/generate_dashboard.sh #!/bin/bash # ~/generate_dashboard.sh # 配置 DASHBOARD_DIR="/var/www/html/dashboard" REFRESH_INTERVAL=60 # 页面刷新间隔（秒） LOG_FILE="/var/log/dashboard.log" # 确保目录存在 sudo mkdir -p "$DASHBOARD_DIR" # 日志函数 log() { echo "[$(date &#39;+%Y-%m-%d %H:%M:%S&#39;)] $1" | tee -a "$LOG_FILE" } # 收集系统状态数据 collect_system_data() { # CPU 信息 CPU_USAGE=$(top -bn1 | grep "Cpu(s)" | awk &#39;{print $2}&#39;) CPU_TEMP=$(vcgencmd measure_temp | sed &#39;s/temp=//&#39; | sed &#39;s/&#39;"&#39;"&#39;C//&#39;) # 内存信息 MEM_TOTAL=$(free -m | awk &#39;/Mem:/ {print $2}&#39;) MEM_USED=$(free -m | awk &#39;/Mem:/ {print $3}&#39;) MEM_USAGE=$(awk "BEGIN {printf \"%.2f\", $MEM_USED/$MEM_TOTAL*100}") # 磁盘信息 DISK_USAGE=$(df -h / | awk &#39;NR==2 {print $5}&#39; | sed &#39;s/%//&#39;) # 系统负载 LOAD_AVG=$(uptime | awk -F&#39;load average:&#39; &#39;{print $2}&#39; | xargs) # 运行时间 UPTIME=$(uptime -p) } # 收集服务状态 collect_service_data() { # Nginx 状态 if systemctl is-active --quiet nginx; then NGINX_STATUS="运行中 ✅" else NGINX_STATUS="已停止 ❌" fi # AI 服务状态 if pgrep -f llama-server > /dev/null; then AI_STATUS="运行中 ✅" else AI_STATUS="已停止 ❌" fi # 获取最近的日志 RECENT_LOGS=$(tail -n 10 /var/log/syslog | sed &#39;s/</\&amp;lt;/g&#39; | sed &#39;s/>/\&amp;gt;/g&#39;) } # 生成状态页面 generate_dashboard() { local timestamp=$(date &#39;+%Y-%m-%d %H:%M:%S&#39;) cat > "$DASHBOARD_DIR/index.html" << EOF <!DOCTYPE html> <html lang="zh"> <head> <meta charset="UTF-8"> <meta name="viewport" content="width=device-width, initial-scale=1.0"> <title>系统状态仪表板</title> <meta http-equiv="refresh" content="$REFRESH_INTERVAL"> <style> body { font-family: Arial, sans-serif; margin: 20px; background-color: #f5f5f5; } .container { max-width: 1200px; margin: 0 auto; } .card { background: white; border-radius: 8px; padding: 20px; margin-bottom: 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); } .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; } .metric { text-align: center; padding: 15px; border-radius: 4px; background: #f8f9fa; } .metric h3 { margin: 0; color: #666; } .metric .value { font-size: 24px; font-weight: bold; margin: 10px 0; } .status { display: flex; justify-content: space-between; align-items: center; padding: 10px; border-bottom: 1px solid #eee; } .logs { background: #2b2b2b; color: #fff; padding: 15px; border-radius: 4px; font-family: monospace; white-space: pre-wrap; } </style> </head> <body> <div class="container"> <h1>系统状态仪表板</h1> <p>最后更新: $timestamp</p> <div class="card"> <h2>系统资源</h2> <div class="grid"> <div class="metric"> <h3>CPU 使用率</h3> <div class="value">$CPU_USAGE%</div> </div> <div class="metric"> <h3>CPU 温度</h3> <div class="value">$CPU_TEMP</div> </div> <div class="metric"> <h3>内存使用率</h3> <div class="value">$MEM_USAGE%</div> </div> <div class="metric"> <h3>磁盘使用率</h3> <div class="value">$DISK_USAGE%</div> </div> </div> </div> <div class="card"> <h2>系统信息</h2> <div class="status"> <span>系统负载:</span> <span>$LOAD_AVG</span> </div> <div class="status"> <span>运行时间:</span> <span>$UPTIME</span> </div> </div> <div class="card"> <h2>服务状态</h2> <div class="status"> <span>Nginx 服务:</span> <span>$NGINX_STATUS</span> </div> <div class="status"> <span>AI 服务:</span> <span>$AI_STATUS</span> </div> </div> <div class="card"> <h2>最近日志</h2> <div class="logs">$RECENT_LOGS</div> </div> </div> </body> </html> EOF # 设置权限 sudo chown www-data:www-data "$DASHBOARD_DIR/index.html" } # 主函数 main() { log "开始生成状态仪表板..." # 收集数据 collect_system_data collect_service_data # 生成页面 generate_dashboard log "状态仪表板已更新" } # 执行生成 main 三十一、系统备份与恢复完整方案 1. 完整备份脚本 # 创建完整备份脚本 nano ~/full_backup.sh #!/bin/bash # ~/full_backup.sh # 配置 BACKUP_ROOT="/mnt/backup_drive" BACKUP_DIR="$BACKUP_ROOT/system_backups" EXCLUDE_FILE="/home/zhaoxiongzhou/backup_exclude.txt" LOG_FILE="/var/log/backup.log" RETENTION_DAYS=30 COMPRESSION_LEVEL=6 # 确保备份目录存在 mkdir -p "$BACKUP_DIR" # 日志函数 log() { echo "[$(date &#39;+%Y-%m-%d %H:%M:%S&#39;)] $1" | tee -a "$LOG_FILE" } # 检查备份环境 check_environment() { log "检查备份环境..." # 检查备份目标目录 if ! mountpoint -q "$BACKUP_ROOT"; then log "错误: 备份驱动器未挂载" return 1 fi # 检查可用空间 local available_space=$(df -BG "$BACKUP_ROOT" | awk &#39;NR==2 {print $4}&#39; | sed &#39;s/G//&#39;) if [ "$available_space" -lt 10 ]; then log "错误: 备份空间不足（小于 10GB）" return 1 fi # 创建排除文件 cat > "$EXCLUDE_FILE" << EOF /proc/* /sys/* /tmp/* /run/* /mnt/* /media/* /lost+found /var/cache/* /var/tmp/* /var/log/* /home/*/Downloads/* /home/*/.cache/* EOF return 0 } # 停止服务 stop_services() { log "停止服务..." # 停止 Nginx sudo systemctl stop nginx # 停止 AI 服务 pkill llama-server # 等待服务完全停止 sleep 5 } # 启动服务 start_services() { log "启动服务..." # 启动 Nginx sudo systemctl start nginx # 启动 AI 服务 ~/projects/llama.cpp/start-llama.sh # 验证服务状态 sleep 10 if ! systemctl is-active --quiet nginx; then log "警告: Nginx 服务未能正常启动" fi if ! pgrep -f llama-server > /dev/null; then log "警告: AI 服务未能正常启动" fi } # 创建完整备份 create_full_backup() { local backup_date=$(date +%Y%m%d_%H%M%S) local backup_file="$BACKUP_DIR/full_backup_${backup_date}.tar.gz" local manifest_file="$BACKUP_DIR/backup_manifest_${backup_date}.txt" log "开始创建完整备份..." # 创建文件清单 log "生成文件清单..." find / -xdev -type f ! -path "$(cat $EXCLUDE_FILE | tr &#39;\n&#39; &#39;|&#39;)" > "$manifest_file" # 创建备份 log "创建系统备份..." sudo tar -czf "$backup_file" \ --exclude-from="$EXCLUDE_FILE" \ --one-file-system \ --preserve-permissions \ --numeric-owner \ --checkpoint=1000 \ --checkpoint-action=dot \ -C / . # 验证备份 if ! tar -tzf "$backup_file" >/dev/null 2>&amp;1; then log "错误: 备份文件验证失败" return 1 fi # 计算校验和 log "计算校验和..." sha256sum "$backup_file" > "${backup_file}.sha256" # 创建备份信息文件 cat > "${backup_file}.info" << EOF 备份时间: $(date) 系统版本: $(cat /etc/os-release | grep PRETTY_NAME) 内核版本: $(uname -r) 备份大小: $(du -h "$backup_file" | cut -f1) 文件数量: $(wc -l < "$manifest_file") 排除规则: $(cat "$EXCLUDE_FILE") EOF return 0 } # 清理旧备份 cleanup_old_backups() { log "清理旧备份..." find "$BACKUP_DIR" -type f -name "full_backup_*" -mtime +$RETENTION_DAYS -delete find "$BACKUP_DIR" -type f -name "backup_manifest_*" -mtime +$RETENTION_DAYS -delete find "$BACKUP_DIR" -type f -name "*.sha256" -mtime +$RETENTION_DAYS -delete find "$BACKUP_DIR" -type f -name "*.info" -mtime +$RETENTION_DAYS -delete } # 主函数 main() { log "开始完整备份流程..." # 检查环境 if ! check_environment; then log "备份环境检查失败，终止备份" ~/send_notification.sh "系统备份失败：环境检查未通过" "high" return 1 fi # 停止服务 stop_services # 创建备份 if create_full_backup; then log "备份创建成功" ~/send_notification.sh "系统完整备份已成功创建" "normal" else log "备份创建失败" ~/send_notification.sh "系统备份失败：备份创建过程出错" "high" fi # 启动服务 start_services # 清理旧备份 cleanup_old_backups log "备份流程完成" } # 执行备份 main 三十二、系统恢复脚本 1. 系统恢复脚本 # 创建系统恢复脚本 nano ~/system_restore.sh #!/bin/bash # ~/system_restore.sh # 配置 BACKUP_ROOT="/mnt/backup_drive" BACKUP_DIR="$BACKUP_ROOT/system_backups" LOG_FILE="/var/log/restore.log" TEMP_DIR="/tmp/restore_temp" # 日志函数 log() { echo "[$(date &#39;+%Y-%m-%d %H:%M:%S&#39;)] $1" | tee -a "$LOG_FILE" } # 验证备份文件 verify_backup() { local backup_file="$1" log "验证备份文件: $backup_file" # 检查文件是否存在 if [ ! -f "$backup_file" ]; then log "错误: 备份文件不存在" return 1 fi # 检查校验和 local checksum_file="${backup_file}.sha256" if [ -f "$checksum_file" ]; then if ! sha256sum -c "$checksum_file"; then log "错误: 备份文件校验和验证失败" return 1 fi else log "警告: 未找到校验和文件" fi # 测试归档完整性 if ! tar -tzf "$backup_file" >/dev/null 2>&amp;1; then log "错误: 备份文件损坏" return 1 fi return 0 } # 准备恢复环境 prepare_environment() { log "准备恢复环境..." # 创建临时目录 mkdir -p "$TEMP_DIR" # 停止所有服务 log "停止服务..." sudo systemctl stop nginx pkill llama-server # 等待服务停止 sleep 5 # 清理目标目录 log "清理目标目录..." read -p "警告: 这将清除系统文件。确定要继续吗？(y/n) " -n 1 -r echo if [[ ! $REPLY =~ ^[Yy]$ ]]; then log "用户取消操作" return 1 fi return 0 } # 执行恢复 perform_restore() { local backup_file="$1" log "开始恢复系统..." # 创建恢复前的快照 log "创建当前系统快照..." local snapshot_date=$(date +%Y%m%d_%H%M%S) local snapshot_file="$BACKUP_DIR/pre_restore_snapshot_${snapshot_date}.tar.gz" sudo tar -czf "$snapshot_file" \ --exclude-from="/home/zhaoxiongzhou/backup_exclude.txt" \ --one-file-system \ -C / . # 解压备份 log "解压备份文件..." sudo tar -xzf "$backup_file" -C / \ --numeric-owner \ --preserve-permissions \ --checkpoint=1000 \ --checkpoint-action=dot # 修复权限 log "修复文件权限..." sudo chown -R www-data:www-data /var/www/ sudo chown -R zhaoxiongzhou:zhaoxiongzhou /home/zhaoxiongzhou/ return 0 } # 恢复服务配置 restore_configurations() { log "恢复服务配置..." # 重新加载系统配置 sudo systemctl daemon-reload sudo sysctl --system # 重新配置网络 sudo systemctl restart networking # 恢复防火墙规则 sudo iptables-restore < /etc/iptables/rules.v4 return 0 } # 验证恢复 verify_restore() { log "验证系统恢复..." local status=0 # 检查关键文件 for file in "/etc/nginx/nginx.conf" "/etc/systemd/system/llama-server.service"; do if [ ! -f "$file" ]; then log "错误: 未找到关键文件 $file" status=1 fi done # 启动服务 sudo systemctl start nginx ~/projects/llama.cpp/start-llama.sh # 验证服务状态 sleep 10 if ! systemctl is-active --quiet nginx; then log "错误: Nginx 服务未能正常启动" status=1 fi if ! pgrep -f llama-server > /dev/null; then log "错误: AI 服务未能正常启动" status=1 fi return $status } # 清理恢复环境 cleanup() { log "清理恢复环境..." # 删除临时文件 rm -rf "$TEMP_DIR" # 清理日志 find /var/log -type f -name "*.gz" -delete return 0 } # 主函数 main() { local backup_file # 列出可用备份 echo "可用的备份文件:" ls -lh "$BACKUP_DIR"/full_backup_*.tar.gz # 选择备份文件 read -p "请输入要恢复的备份文件完整路径: " backup_file # 验证备份 if ! verify_backup "$backup_file"; then log "备份验证失败，终止恢复" return 1 fi # 准备环境 if ! prepare_environment; then log "环境准备失败，终止恢复" return 1 fi # 执行恢复 if perform_restore "$backup_file" && \ restore_configurations && \ verify_restore; then log "系统恢复成功完成" ~/send_notification.sh "系统恢复成功完成" "normal" else log "系统恢复失败" ~/send_notification.sh "系统恢复失败，需要手动检查" "high" fi # 清理环境 cleanup } # 执行恢复 main 三十三、系统迁移工具 1. 系统迁移脚本 # 创建系统迁移脚本 nano ~/system_migration.sh #!/bin/bash # ~/system_migration.sh # 配置 SOURCE_HOST="old-raspberry.local" TARGET_HOST="new-raspberry.local" MIGRATION_DIR="/mnt/migration" LOG_FILE="/var/log/migration.log" SSH_KEY="~/.ssh/migration_key" RSYNC_OPTS="-avz --progress --delete" # 日志函数 log() { echo "[$(date &#39;+%Y-%m-%d %H:%M:%S&#39;)] $1" | tee -a "$LOG_FILE" } # 检查迁移环境 check_migration_env() { log "检查迁移环境..." # 检查 SSH 密钥 if [ ! -f "$SSH_KEY" ]; then log "生成 SSH 密钥..." ssh-keygen -t ed25519 -f "$SSH_KEY" -N "" # 复制密钥到目标主机 ssh-copy-id -i "$SSH_KEY" "zhaoxiongzhou@$TARGET_HOST" fi # 检查必要工具 for tool in rsync ssh scp; do if ! command -v $tool &>/dev/null; then log "错误: 未找到必要工具 $tool" return 1 fi done # 检查目标主机连接 if ! ssh -i "$SSH_KEY" "zhaoxiongzhou@$TARGET_HOST" "echo &#39;Connection test&#39;" &>/dev/null; then log "错误: 无法连接到目标主机" return 1 fi return 0 } # 迁移配置文件 migrate_configs() { log "迁移配置文件..." # 创建配置目录 ssh -i "$SSH_KEY" "zhaoxiongzhou@$TARGET_HOST" "mkdir -p ~/configs_backup" # 迁移 Nginx 配置 rsync $RSYNC_OPTS -e "ssh -i $SSH_KEY" \ /etc/nginx/ \ "zhaoxiongzhou@$TARGET_HOST:~/configs_backup/nginx/" # 迁移系统配置 rsync $RSYNC_OPTS -e "ssh -i $SSH_KEY" \ /etc/sysctl.d/ \ "zhaoxiongzhou@$TARGET_HOST:~/configs_backup/sysctl/" # 迁移服务配置 rsync $RSYNC_OPTS -e "ssh -i $SSH_KEY" \ /etc/systemd/system/ \ "zhaoxiongzhou@$TARGET_HOST:~/configs_backup/systemd/" } # 迁移数据 migrate_data() { log "迁移数据..." # 迁移博客数据 rsync $RSYNC_OPTS -e "ssh -i $SSH_KEY" \ ~/myblog/ \ "zhaoxiongzhou@$TARGET_HOST:~/myblog/" # 迁移 AI 服务数据 rsync $RSYNC_OPTS -e "ssh -i $SSH_KEY" \ ~/projects/llama.cpp/ \ "zhaoxiongzhou@$TARGET_HOST:~/projects/llama.cpp/" # 迁移用户脚本 rsync $RSYNC_OPTS -e "ssh -i $SSH_KEY" \ ~/*.sh \ "zhaoxiongzhou@$TARGET_HOST:~/" } # 迁移数据库 migrate_database() { log "迁移数据库..." # 导出数据库 local dump_file="/tmp/database_dump.sql" if [ -f "/var/lib/mysql" ]; then mysqldump --all-databases > "$dump_file" # 传输到目标主机 scp -i "$SSH_KEY" "$dump_file" "zhaoxiongzhou@$TARGET_HOST:/tmp/" # 在目标主机导入数据库 ssh -i "$SSH_KEY" "zhaoxiongzhou@$TARGET_HOST" \ "mysql < /tmp/database_dump.sql" fi } # 配置目标系统 configure_target() { log "配置目标系统..." ssh -i "$SSH_KEY" "zhaoxiongzhou@$TARGET_HOST" "bash -s" << &#39;EOF&#39; # 安装必要软件 sudo apt update sudo apt install -y nginx mysql-server python3 pip # 恢复配置 sudo cp -r ~/configs_backup/nginx/* /etc/nginx/ sudo cp -r ~/configs_backup/sysctl/* /etc/sysctl.d/ sudo cp -r ~/configs_backup/systemd/* /etc/systemd/system/ # 设置权限 sudo chown -R www-data:www-data /var/www/ sudo chmod +x ~/*.sh # 重启服务 sudo systemctl daemon-reload sudo systemctl restart nginx EOF } # 验证迁移 verify_migration() { log "验证迁移..." local status=0 # 检查服务状态 ssh -i "$SSH_KEY" "zhaoxiongzhou@$TARGET_HOST" "bash -s" << &#39;EOF&#39; # 检查 Nginx if ! systemctl is-active --quiet nginx; then echo "错误: Nginx 服务未运行" exit 1 fi # 检查文件 for dir in "~/myblog" "~/projects/llama.cpp"; do if [ ! -d "$dir" ]; then echo "错误: 目录 $dir 不存在" exit 1 fi done # 检查配置 if ! nginx -t &>/dev/null; then echo "错误: Nginx 配置无效" exit 1 fi EOF status=$? return $status } # 主函数 main() { log "开始系统迁移..." # 检查环境 if ! check_migration_env; then log "迁移环境检查失败" return 1 fi # 执行迁移 migrate_configs migrate_data migrate_database configure_target # 验证迁移 if verify_migration; then log "系统迁移成功完成" ~/send_notification.sh "系统迁移成功完成" "normal" else log "系统迁移失败" ~/send_notification.sh "系统迁移失败，需要手动检查" "high" fi } # 执行迁移 main 三十四、日志分析工具 1. 日志分析脚本 # 创建日志分析脚本 nano ~/log_analyzer.sh #!/bin/bash # ~/log_analyzer.sh # 配置 LOG_DIRS=( "/var/log" "/var/log/nginx" "/home/zhaoxiongzhou/logs" ) REPORT_DIR="/home/zhaoxiongzhou/log_reports" LOG_FILE="/var/log/analyzer.log" ALERT_THRESHOLD=100 # 错误日志阈值 RETENTION_DAYS=30 # 报告保留天数 # 确保目录存在 mkdir -p "$REPORT_DIR" # 日志函数 log() { echo "[$(date &#39;+%Y-%m-%d %H:%M:%S&#39;)] $1" | tee -a "$LOG_FILE" } # 分析系统日志 analyze_system_logs() { log "分析系统日志..." local report_file="$REPORT_DIR/system_log_report_$(date +%Y%m%d).md" { echo "# 系统日志分析报告" echo "## 生成时间: $(date &#39;+%Y-%m-%d %H:%M:%S&#39;)" echo echo "## 系统错误统计" echo "### 严重错误" echo &#39;```&#39; grep -i "error\|critical\|emergency" /var/log/syslog | \ tail -n 50 | sort | uniq -c | sort -nr echo &#39;```&#39; echo "### 认证失败" echo &#39;```&#39; grep "Failed password" /var/log/auth.log | \ awk &#39;{print $1,$2,$3,$11}&#39; | sort | uniq -c | sort -nr | head -n 10 echo &#39;```&#39; echo "### 系统重启记录" echo &#39;```&#39; last reboot | head -n 5 echo &#39;```&#39; } > "$report_file" } # 分析 Nginx 访问日志 analyze_nginx_logs() { log "分析 Nginx 访问日志..." local report_file="$REPORT_DIR/nginx_log_report_$(date +%Y%m%d).md" { echo "# Nginx 访问日志分析报告" echo "## 生成时间: $(date &#39;+%Y-%m-%d %H:%M:%S&#39;)" echo echo "## 访问统计" echo "### 请求量最大的 IP" echo &#39;```&#39; awk &#39;{print $1}&#39; /var/log/nginx/access.log | sort | uniq -c | sort -nr | head -n 10 echo &#39;```&#39; echo "### 访问量最大的页面" echo &#39;```&#39; awk &#39;{print $7}&#39; /var/log/nginx/access.log | sort | uniq -c | sort -nr | head -n 10 echo &#39;```&#39; echo "### HTTP 状态码统计" echo &#39;```&#39; awk &#39;{print $9}&#39; /var/log/nginx/access.log | sort | uniq -c | sort -nr echo &#39;```&#39; echo "### 每小时请求量统计" echo &#39;```&#39; awk &#39;{print $4}&#39; /var/log/nginx/access.log | cut -c 14-15 | sort | uniq -c | \ awk &#39;{printf("%s:00 - %s 请求\n", $2, $1)}&#39; echo &#39;```&#39; } > "$report_file" } # 分析 AI 服务日志 analyze_ai_logs() { log "分析 AI 服务日志..." local report_file="$REPORT_DIR/ai_log_report_$(date +%Y%m%d).md" local ai_log="/home/zhaoxiongzhou/logs/llama.log" if [ -f "$ai_log" ]; then { echo "# AI 服务日志分析报告" echo "## 生成时间: $(date &#39;+%Y-%m-%d %H:%M:%S&#39;)" echo echo "## 服务统计" echo "### 错误统计" echo &#39;```&#39; grep -i "error" "$ai_log" | tail -n 20 echo &#39;```&#39; echo "### 性能统计" echo "#### 响应时间分布" echo &#39;```&#39; grep "response_time" "$ai_log" | \ awk &#39;{sum+=$NF; count++} END {print "平均响应时间:", sum/count, "ms"}&#39; echo &#39;```&#39; echo "#### 内存使用统计" echo &#39;```&#39; grep "memory_usage" "$ai_log" | tail -n 10 echo &#39;```&#39; } > "$report_file" fi } # 生成安全报告 generate_security_report() { log "生成安全报告..." local report_file="$REPORT_DIR/security_report_$(date +%Y%m%d).md" { echo "# 安全分析报告" echo "## 生成时间: $(date &#39;+%Y-%m-%d %H:%M:%S&#39;)" echo echo "## 安全事件统计" echo "### SSH 暴力破解尝试" echo &#39;```&#39; grep "Failed password" /var/log/auth.log | \ awk &#39;{print $11,$13}&#39; | sort | uniq -c | sort -nr | head -n 10 echo &#39;```&#39; echo "### 可疑 IP 访问" echo &#39;```&#39; grep -i "suspicious\|attack\|hack" /var/log/nginx/access.log | \ awk &#39;{print $1}&#39; | sort | uniq -c | sort -nr echo &#39;```&#39; echo "### 文件权限变更" echo &#39;```&#39; find /etc -mtime -1 -type f -ls echo &#39;```&#39; } > "$report_file" } # 清理旧报告 cleanup_old_reports() { log "清理旧报告..." find "$REPORT_DIR" -type f -name "*.md" -mtime +$RETENTION_DAYS -delete } # 生成摘要报告 generate_summary() { log "生成摘要报告..." local summary_file="$REPORT_DIR/summary_$(date +%Y%m%d).md" { echo "# 日志分析摘要报告" echo "## 生成时间: $(date &#39;+%Y-%m-%d %H:%M:%S&#39;)" echo echo "## 关键指标" # 错误统计 local error_count=$(grep -i "error" /var/log/syslog | wc -l) local nginx_error_count=$(grep -i "error" /var/log/nginx/error.log | wc -l) echo "- 系统错误数: $error_count" echo "- Nginx 错误数: $nginx_error_count" # 安全事件 local ssh_fails=$(grep "Failed password" /var/log/auth.log | wc -l) echo "- SSH 失败尝试: $ssh_fails" # 告警判断 if [ $error_count -gt $ALERT_THRESHOLD ]; then ~/send_notification.sh "警告: 系统错误数超过阈值" "high" fi } > "$summary_file" } # 主函数 main() { log "开始日志分析..." # 执行分析 analyze_system_logs analyze_nginx_logs analyze_ai_logs generate_security_report generate_summary # 清理旧报告 cleanup_old_reports log "日志分析完成" } # 执行分析 main 三十五、系统优化工具 1. 系统优化脚本 # 创建系统优化脚本 nano ~/system_optimize.sh #!/bin/bash # ~/system_optimize.sh # 配置 LOG_FILE="/var/log/optimize.log" NGINX_CONF="/etc/nginx/nginx.conf" SYSCTL_CONF="/etc/sysctl.d/99-custom.conf" JOURNAL_CONF="/etc/systemd/journald.conf" # 日志函数 log() { echo "[$(date &#39;+%Y-%m-%d %H:%M:%S&#39;)] $1" | tee -a "$LOG_FILE" } # 优化系统参数 optimize_system() { log "优化系统参数..." # 备份原始配置 cp "$SYSCTL_CONF" "${SYSCTL_CONF}.backup" # 配置系统参数 cat > "$SYSCTL_CONF" << EOF # 网络优化 net.core.somaxconn = 2048 net.core.netdev_max_backlog = 4096 net.ipv4.tcp_max_syn_backlog = 4096 net.ipv4.tcp_fin_timeout = 30 net.ipv4.tcp_keepalive_time = 1200 net.ipv4.tcp_max_tw_buckets = 5000 net.ipv4.tcp_fastopen = 3 net.ipv4.tcp_rmem = 4096 87380 16777216 net.ipv4.tcp_wmem = 4096 65536 16777216 # 文件系统优化 fs.file-max = 100000 fs.inotify.max_user_watches = 524288 # 内存优化 vm.swappiness = 10 vm.dirty_ratio = 60 vm.dirty_background_ratio = 2 EOF # 应用系统参数 sysctl -p "$SYSCTL_CONF" } # 优化 Nginx 配置 optimize_nginx() { log "优化 Nginx 配置..." # 备份原始配置 cp "$NGINX_CONF" "${NGINX_CONF}.backup" # 配置 Nginx cat > "$NGINX_CONF" << EOF user www-data; worker_processes auto; worker_rlimit_nofile 100000; events { worker_connections 2048; multi_accept on; use epoll; } http { # 基础设置 sendfile on; tcp_nopush on; tcp_nodelay on; keepalive_timeout 65; types_hash_max_size 2048; server_tokens off; # MIME 类型 include /etc/nginx/mime.types; default_type application/octet-stream; # 日志格式 log_format main &#39;\$remote_addr - \$remote_user [\$time_local] "\$request" &#39; &#39;\$status \$body_bytes_sent "\$http_referer" &#39; &#39;"\$http_user_agent" "\$http_x_forwarded_for"&#39;; # 缓冲区设置 client_body_buffer_size 128k; client_max_body_size 10m; client_header_buffer_size 1k; large_client_header_buffers 4 4k; # Gzip 压缩 gzip on; gzip_vary on; gzip_proxied any; gzip_comp_level 6; gzip_types text/plain text/css application/json application/javascript text/xml application/xml application/xml+rss text/javascript; # SSL 优化 ssl_protocols TLSv1.2 TLSv1.3; ssl_prefer_server_ciphers on; ssl_session_cache shared:SSL:10m; ssl_session_timeout 10m; # 包含其他配置 include /etc/nginx/conf.d/*.conf; include /etc/nginx/sites-enabled/*; } EOF # 测试配置 nginx -t && systemctl restart nginx } # 优化系统服务 optimize_services() { log "优化系统服务..." # 禁用不必要的服务 local unnecessary_services=( "bluetooth" "cups" "avahi-daemon" ) for service in "${unnecessary_services[@]}"; do if systemctl is-active --quiet "$service"; then systemctl stop "$service" systemctl disable "$service" log "已禁用服务: $service" fi done # 优化日志服务 cat > "$JOURNAL_CONF" << EOF [Journal] SystemMaxUse=100M SystemMaxFileSize=10M RuntimeMaxUse=50M RuntimeMaxFileSize=5M EOF # 重启日志服务 systemctl restart systemd-journald } # 优化文件系统 optimize_filesystem() { log "优化文件系统..." # 清理临时文件 find /tmp -type f -atime +10 -delete find /var/tmp -type f -atime +10 -delete # 清理日志 find /var/log -type f -name "*.gz" -delete find /var/log -type f -name "*.old" -delete # 优化日志轮转 cat > /etc/logrotate.d/custom << EOF /var/log/custom/*.log { daily rotate 7 compress delaycompress missingok notifempty create 640 root adm } EOF } # 优化内存使用 optimize_memory() { log "优化内存使用..." # 清理缓存 sync; echo 3 > /proc/sys/vm/drop_caches # 配置 swap 使用 if [ -f /swapfile ]; then swapoff /swapfile dd if=/dev/zero of=/swapfile bs=1M count=2048 chmod 600 /swapfile mkswap /swapfile swapon /swapfile fi } # 验证优化 verify_optimization() { log "验证系统优化..." local status=0 # 检查系统负载 local load=$(uptime | awk -F&#39;load average:&#39; &#39;{print $2}&#39; | cut -d, -f1) if [ $(echo "$load > 2" | bc -l) -eq 1 ]; then log "警告: 系统负载较高 ($load)" status=1 fi # 检查内存使用 local mem_usage=$(free | grep Mem | awk &#39;{print $3/$2 * 100.0}&#39;) if [ $(echo "$mem_usage > 90" | bc -l) -eq 1 ]; then log "警告: 内存使用率过高 ($mem_usage%)" status=1 fi # 检查服务状态 if ! systemctl is-active --quiet nginx; then log "错误: Nginx 服务未正常运行" status=1 fi return $status } # 主函数 main() { log "开始系统优化..." optimize_system optimize_nginx optimize_services optimize_filesystem optimize_memory if verify_optimization; then log "系统优化成功完成" ~/send_notification.sh "系统优化已完成" "normal" else log "系统优化完成，但存在警告" ~/send_notification.sh "系统优化完成，但需要检查" "high" fi } # 执行优化 main 三十六、部署后检查清单 1. 部署检查脚本 # 创建部署检查脚本 nano ~/deployment_checklist.sh #!/bin/bash # ~/deployment_checklist.sh # 配置 LOG_FILE="/var/log/deployment_check.log" REPORT_FILE="/home/zhaoxiongzhou/deployment_report.md" CHECK_INTERVAL=300 # 检查间隔（秒） # 日志函数 log() { echo "[$(date &#39;+%Y-%m-%d %H:%M:%S&#39;)] $1" | tee -a "$LOG_FILE" } # 检查系统基础配置 check_system_basics() { log "检查系统基础配置..." local status=0 { echo "## 系统基础检查" echo "### 系统信息" echo "- 主机名: $(hostname)" echo "- 系统版本: $(cat /etc/os-release | grep PRETTY_NAME)" echo "- 内核版本: $(uname -r)" echo "- 运行时间: $(uptime -p)" echo echo "### 资源使用" echo "- CPU 使用率: $(top -bn1 | grep "Cpu(s)" | awk &#39;{print $2}&#39;)%" echo "- 内存使用率: $(free | grep Mem | awk &#39;{print $3/$2 * 100.0}&#39;)%" echo "- 磁盘使用率: $(df -h / | awk &#39;NR==2 {print $5}&#39;)" echo } > "$REPORT_FILE" return $status } # 检查网络配置 check_network() { log "检查网络配置..." local status=0 { echo "### 网络配置" echo "#### IP 配置" echo &#39;```&#39; ip addr show echo &#39;```&#39; echo "#### 路由表" echo &#39;```&#39; ip route echo &#39;```&#39; echo "#### 开放端口" echo &#39;```&#39; netstat -tuln echo &#39;```&#39; echo "#### DNS 配置" echo &#39;```&#39; cat /etc/resolv.conf echo &#39;```&#39; } >> "$REPORT_FILE" return $status } # 检查服务配置 check_services() { log "检查服务配置..." local status=0 { echo "### 服务状态" echo "#### Nginx 配置" echo &#39;```&#39; nginx -T echo &#39;```&#39; echo "#### 服务运行状态" echo &#39;```&#39; systemctl status nginx systemctl status mysql ps aux | grep llama-server echo &#39;```&#39; echo "#### 服务日志检查" echo &#39;```&#39; tail -n 20 /var/log/nginx/error.log echo &#39;```&#39; } >> "$REPORT_FILE" return $status } # 检查安全配置 check_security() { log "检查安全配置..." local status=0 { echo "### 安全检查" echo "#### 防火墙规则" echo &#39;```&#39; sudo iptables -L echo &#39;```&#39; echo "#### SSH 配置" echo &#39;```&#39; grep -v &#39;^#&#39; /etc/ssh/sshd_config echo &#39;```&#39; echo "#### 用户权限" echo &#39;```&#39; ls -la /home/zhaoxiongzhou/ ls -la /var/www/ echo &#39;```&#39; echo "#### SSL 证书" echo &#39;```&#39; openssl x509 -in /etc/nginx/ssl/server.crt -text -noout echo &#39;```&#39; } >> "$REPORT_FILE" return $status } # 检查备份配置 check_backups() { log "检查备份配置..." local status=0 { echo "### 备份检查" echo "#### 备份配置" echo &#39;```&#39; ls -lh /mnt/backup_drive/system_backups/ echo &#39;```&#39; echo "#### 最近备份状态" echo &#39;```&#39; tail -n 20 /var/log/backup.log echo &#39;```&#39; } >> "$REPORT_FILE" return $status } # 检查监控配置 check_monitoring() { log "检查监控配置..." local status=0 { echo "### 监控检查" echo "#### 监控脚本状态" echo &#39;```&#39; ps aux | grep monitor echo &#39;```&#39; echo "#### 告警配置" echo &#39;```&#39; cat ~/send_notification.sh echo &#39;```&#39; } >> "$REPORT_FILE" return $status } # 生成总结报告 generate_summary() { log "生成总结报告..." { echo "## 部署检查总结" echo "### 检查时间: $(date &#39;+%Y-%m-%d %H:%M:%S&#39;)" echo echo "### 主要发现" echo "1. 系统状态: $([ $system_status -eq 0 ] && echo &#39;正常 ✅&#39; || echo &#39;异常 ❌&#39;)" echo "2. 网络配置: $([ $network_status -eq 0 ] && echo &#39;正常 ✅&#39; || echo &#39;异常 ❌&#39;)" echo "3. 服务状态: $([ $services_status -eq 0 ] && echo &#39;正常 ✅&#39; || echo &#39;异常 ❌&#39;)" echo "4. 安全配置: $([ $security_status -eq 0 ] && echo &#39;正常 ✅&#39; || echo &#39;异常 ❌&#39;)" echo "5. 备份状态: $([ $backup_status -eq 0 ] && echo &#39;正常 ✅&#39; || echo &#39;异常 ❌&#39;)" echo "6. 监控状态: $([ $monitoring_status -eq 0 ] && echo &#39;正常 ✅&#39; || echo &#39;异常 ❌&#39;)" echo echo "### 建议操作" [ $system_status -ne 0 ] && echo "- 检查系统资源使用情况" [ $network_status -ne 0 ] && echo "- 验证网络配置" [ $services_status -ne 0 ] && echo "- 检查服务运行状态" [ $security_status -ne 0 ] && echo "- 审查安全配置" [ $backup_status -ne 0 ] && echo "- 确认备份是否正常" [ $monitoring_status -ne 0 ] && echo "- 检查监控系统" } >> "$REPORT_FILE" } # 主函数 main() { log "开始部署后检查..." # 执行检查 check_system_basics system_status=$? check_network network_status=$? check_services services_status=$? check_security security_status=$? check_backups backup_status=$? check_monitoring monitoring_status=$? # 生成总结 generate_summary # 发送通知 if [ $system_status -eq 0 ] && [ $network_status -eq 0 ] && \ [ $services_status -eq 0 ] && [ $security_status -eq 0 ] && \ [ $backup_status -eq 0 ] && [ $monitoring_status -eq 0 ]; then ~/send_notification.sh "部署检查完成：所有项目正常" "normal" else ~/send_notification.sh "部署检查完成：存在需要关注的项目" "high" fi log "部署检查完成，报告已生成: $REPORT_FILE" } # 执行检查 main 《树莓派服务部署与维护完整指南》总共包含了 36 个部分，涵盖了从系统部署到维护的各个方面。每个脚本都经过精心设计，可以独立运行，也可以互相配合使用。'><meta itemprop=datePublished content="2024-12-03T18:00:00+08:00"><meta itemprop=dateModified content="2024-12-03T18:00:00+08:00"><meta itemprop=wordCount content="9977"><meta itemprop=keywords content="RaspberryPi,Hugo,教程"><header><h1 itemprop=headline>树莓派服务部署与维护完整指南</h1><p class=text-sm>星期二, 12月 3, 2024
| <span>47分钟阅读</span>
| <span>更新于
星期二, 12月 3, 2024</span></p><div class="flex justify-between"><div class="flex items-center"><span>@</span>
<span itemprop=author itemscope itemtype=https://schema.org/Person><span itemprop=name>赵雄州</span></span></div><div class="flex items-center gap-2"><a class="group inline-flex items-center p-2 rounded-full cursor-pointer hover:bg-primary" href="https://x.com/intent/post?text=%e6%a0%91%e8%8e%93%e6%b4%be%e6%9c%8d%e5%8a%a1%e9%83%a8%e7%bd%b2%e4%b8%8e%e7%bb%b4%e6%8a%a4%e5%ae%8c%e6%95%b4%e6%8c%87%e5%8d%97&amp;url=http://10.10.164.61/posts/guide/%E6%A0%91%E8%8E%93%E6%B4%BE%E6%9C%8D%E5%8A%A1%E9%83%A8%E7%BD%B2%E4%B8%8E%E7%BB%B4%E6%8A%A4%E5%AE%8C%E6%95%B4%E6%8C%87%E5%8D%97/" target=_blank rel="noopener noreferrer" title="Share on X"><ion-icon class=group-hover:text-primary-content name=logo-x></ion-icon></a><a class="group inline-flex items-center p-2 rounded-full cursor-pointer hover:bg-primary" href="https://facebook.com/sharer/sharer.php?u=http://10.10.164.61/posts/guide/%E6%A0%91%E8%8E%93%E6%B4%BE%E6%9C%8D%E5%8A%A1%E9%83%A8%E7%BD%B2%E4%B8%8E%E7%BB%B4%E6%8A%A4%E5%AE%8C%E6%95%B4%E6%8C%87%E5%8D%97/" target=_blank rel="noopener noreferrer" title="Share on Facebook"><ion-icon class=group-hover:text-primary-content name=logo-facebook></ion-icon></a><a class="group inline-flex items-center p-2 rounded-full cursor-pointer hover:bg-primary" href="https://wa.me/?text=%e6%a0%91%e8%8e%93%e6%b4%be%e6%9c%8d%e5%8a%a1%e9%83%a8%e7%bd%b2%e4%b8%8e%e7%bb%b4%e6%8a%a4%e5%ae%8c%e6%95%b4%e6%8c%87%e5%8d%97%20http://10.10.164.61/posts/guide/%E6%A0%91%E8%8E%93%E6%B4%BE%E6%9C%8D%E5%8A%A1%E9%83%A8%E7%BD%B2%E4%B8%8E%E7%BB%B4%E6%8A%A4%E5%AE%8C%E6%95%B4%E6%8C%87%E5%8D%97/" target=_blank rel="noopener noreferrer" title="Share on WhatsApp"><ion-icon class=group-hover:text-primary-content name=logo-whatsapp></ion-icon></a></div></div></header><img src=/images/default3.jpg alt=树莓派服务部署与维护完整指南><h1 id=树莓派服务部署与维护完整指南>树莓派服务部署与维护完整指南</h1><h2 id=一系统概况>一、系统概况</h2><h3 id=1-硬件资源>1. 硬件资源</h3><ul><li><strong>处理器</strong>: ARM64 架构</li><li><strong>总内存</strong>: 3.7GB</li><li><strong>可用内存</strong>: ~2.5GB</li><li><strong>Swap</strong>: 512MB</li><li><strong>网络</strong>: wlan0 (IP: 10.40.110.47)</li></ul><h3 id=2-服务概览>2. 服务概览</h3><ol><li><strong>AI 智能助手</strong><ul><li>端口: 8080</li><li>基于: llama.cpp</li><li>模型: Phi-3-mini-4k-instruct-q4.gguf</li><li>资源占用:<ul><li>CPU: ~300% (多核)</li><li>内存: ~3GB</li><li>Swap: 511Mi</li></ul></li></ul></li><li><strong>个人博客</strong><ul><li>端口: 80</li><li>框架: Hugo v0.139.3-extended</li><li>主题: Ananke</li><li>Web服务器: Nginx</li><li>资源占用: 轻量级</li></ul></li></ol><h3 id=3-服务访问>3. 服务访问</h3><ul><li>AI 助手: <code>http://10.40.110.47:8080</code></li><li>博客开发: <code>http://10.40.110.47:1313</code></li><li>博客正式: <code>http://10.40.110.47</code></li></ul><h2 id=二ai-智能助手部署>二、AI 智能助手部署</h2><h3 id=1-环境准备>1. 环境准备</h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># 更新系统</span>
</span></span><span style=display:flex><span>sudo apt update
</span></span><span style=display:flex><span>sudo apt upgrade -y
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 安装依赖</span>
</span></span><span style=display:flex><span>sudo apt install build-essential git cmake
</span></span></code></pre></div><h3 id=2-编译安装>2. 编译安装</h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># 克隆仓库</span>
</span></span><span style=display:flex><span>git clone https://github.com/ggerganov/llama.cpp.git
</span></span><span style=display:flex><span>cd llama.cpp
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 编译</span>
</span></span><span style=display:flex><span>make clean
</span></span><span style=display:flex><span>LLAMA_METAL<span style=color:#f92672>=</span><span style=color:#ae81ff>1</span> make -j4
</span></span></code></pre></div><h3 id=3-模型配置>3. 模型配置</h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># 创建模型目录</span>
</span></span><span style=display:flex><span>mkdir models
</span></span><span style=display:flex><span>cd models
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 下载模型文件</span>
</span></span><span style=display:flex><span>wget <span style=color:#f92672>[</span>模型下载地址<span style=color:#f92672>]</span>/Phi-3-mini-4k-instruct-q4.gguf
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 验证模型文件</span>
</span></span><span style=display:flex><span>sha256sum Phi-3-mini-4k-instruct-q4.gguf
</span></span></code></pre></div><h3 id=4-服务配置>4. 服务配置</h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># 创建启动脚本</span>
</span></span><span style=display:flex><span>nano ~/projects/llama.cpp/start-llama.sh
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e>#!/bin/bash
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>cd ~/projects/llama.cpp
</span></span><span style=display:flex><span>nohup ./llama-server <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  -m models/Phi-3-mini-4k-instruct-q4.gguf <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  --host 0.0.0.0 <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  --port <span style=color:#ae81ff>8080</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  --ctx-size <span style=color:#ae81ff>2048</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  --threads <span style=color:#ae81ff>2</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  --batch-size <span style=color:#ae81ff>256</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  &gt; llama.log 2&gt;&amp;<span style=color:#ae81ff>1</span> &amp;
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># 设置执行权限</span>
</span></span><span style=display:flex><span>chmod +x start-llama.sh
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 启动服务</span>
</span></span><span style=display:flex><span>./start-llama.sh
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 验证服务状态</span>
</span></span><span style=display:flex><span>ps aux | grep llama-server
</span></span><span style=display:flex><span>netstat -tuln | grep <span style=color:#ae81ff>8080</span>
</span></span></code></pre></div><h2 id=三个人博客部署>三、个人博客部署</h2><h3 id=1-hugo-安装>1. Hugo 安装</h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># 下载 Hugo Extended 版本</span>
</span></span><span style=display:flex><span>wget https://github.com/gohugoio/hugo/releases/download/v0.139.3/hugo_extended_0.139.3_linux-arm64.deb
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 安装</span>
</span></span><span style=display:flex><span>sudo dpkg -i hugo_extended_0.139.3_linux-arm64.deb
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 验证安装</span>
</span></span><span style=display:flex><span>hugo version
</span></span></code></pre></div><h3 id=2-博客初始化>2. 博客初始化</h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># 创建站点</span>
</span></span><span style=display:flex><span>cd ~
</span></span><span style=display:flex><span>hugo new site myblog
</span></span><span style=display:flex><span>cd myblog
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 初始化 Git</span>
</span></span><span style=display:flex><span>git init
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 添加主题</span>
</span></span><span style=display:flex><span>git submodule add https://github.com/theNewDynamic/gohugo-theme-ananke.git themes/ananke
</span></span></code></pre></div><h3 id=3-博客配置>3. 博客配置</h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># 编辑配置文件</span>
</span></span><span style=display:flex><span>nano config.toml
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-toml data-lang=toml><span style=display:flex><span><span style=color:#a6e22e>baseURL</span> = <span style=color:#e6db74>&#34;http://10.40.110.47/&#34;</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>languageCode</span> = <span style=color:#e6db74>&#34;zh-cn&#34;</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>title</span> = <span style=color:#e6db74>&#34;My Blog&#34;</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>theme</span> = <span style=color:#e6db74>&#34;ananke&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>[<span style=color:#a6e22e>params</span>]
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>author</span> = <span style=color:#e6db74>&#34;Your Name&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>description</span> = <span style=color:#e6db74>&#34;Welcome to my blog&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>dateFormat</span> = <span style=color:#e6db74>&#34;2006-01-02&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>background_color_class</span> = <span style=color:#e6db74>&#34;bg-black&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>recent_posts_number</span> = <span style=color:#ae81ff>3</span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>mainSections</span> = [<span style=color:#e6db74>&#34;posts&#34;</span>]
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>featured_image</span> = <span style=color:#66d9ef>false</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>[<span style=color:#a6e22e>menu</span>]
</span></span><span style=display:flex><span>  [[<span style=color:#a6e22e>menu</span>.<span style=color:#a6e22e>main</span>]]
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>identifier</span> = <span style=color:#e6db74>&#34;posts&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>name</span> = <span style=color:#e6db74>&#34;文章&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>url</span> = <span style=color:#e6db74>&#34;/posts/&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>weight</span> = <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>  [[<span style=color:#a6e22e>menu</span>.<span style=color:#a6e22e>main</span>]]
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>identifier</span> = <span style=color:#e6db74>&#34;about&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>name</span> = <span style=color:#e6db74>&#34;关于&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>url</span> = <span style=color:#e6db74>&#34;/about/&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>weight</span> = <span style=color:#ae81ff>2</span>
</span></span></code></pre></div><h3 id=4-nginx-配置>4. Nginx 配置</h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># 安装 Nginx</span>
</span></span><span style=display:flex><span>sudo apt install nginx
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 创建配置文件</span>
</span></span><span style=display:flex><span>sudo nano /etc/nginx/sites-available/myblog
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-nginx data-lang=nginx><span style=display:flex><span><span style=color:#66d9ef>server</span> {
</span></span><span style=display:flex><span>    <span style=color:#f92672>listen</span> <span style=color:#ae81ff>80</span>;
</span></span><span style=display:flex><span>    <span style=color:#f92672>server_name</span> <span style=color:#ae81ff>10</span><span style=color:#e6db74>.40.110.47</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>root</span> <span style=color:#e6db74>/home/zhaoxiongzhou/myblog/public</span>;
</span></span><span style=display:flex><span>    <span style=color:#f92672>index</span> <span style=color:#e6db74>index.html</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>location</span> <span style=color:#e6db74>/</span> {
</span></span><span style=display:flex><span>        <span style=color:#f92672>try_files</span> $uri $uri/ =<span style=color:#ae81ff>404</span>;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>access_log</span> <span style=color:#e6db74>/var/log/nginx/myblog_access.log</span>;
</span></span><span style=display:flex><span>    <span style=color:#f92672>error_log</span> <span style=color:#e6db74>/var/log/nginx/myblog_error.log</span>;
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># 启用配置</span>
</span></span><span style=display:flex><span>sudo ln -s /etc/nginx/sites-available/myblog /etc/nginx/sites-enabled/
</span></span><span style=display:flex><span>sudo rm /etc/nginx/sites-enabled/default
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 测试配置</span>
</span></span><span style=display:flex><span>sudo nginx -t
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 重启 Nginx</span>
</span></span><span style=display:flex><span>sudo systemctl restart nginx
</span></span></code></pre></div><h2 id=四权限与自动化配置>四、权限与自动化配置</h2><h3 id=1-权限设置>1. 权限设置</h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># 设置目录权限</span>
</span></span><span style=display:flex><span>sudo chmod <span style=color:#ae81ff>755</span> /home/zhaoxiongzhou
</span></span><span style=display:flex><span>sudo chmod -R <span style=color:#ae81ff>755</span> /home/zhaoxiongzhou/myblog
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 设置文件所有权</span>
</span></span><span style=display:flex><span>sudo chown -R www-data:www-data /home/zhaoxiongzhou/myblog/public
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 验证权限</span>
</span></span><span style=display:flex><span>ls -la ~/myblog/public
</span></span><span style=display:flex><span>ls -la /home/zhaoxiongzhou
</span></span></code></pre></div><h3 id=2-自动部署脚本>2. 自动部署脚本</h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># 创建博客部署脚本</span>
</span></span><span style=display:flex><span>nano ~/deploy-blog.sh
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e>#!/bin/bash
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>cd ~/myblog
</span></span><span style=display:flex><span>hugo
</span></span><span style=display:flex><span>sudo chown -R www-data:www-data public/
</span></span><span style=display:flex><span>sudo systemctl restart nginx
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># 设置执行权限</span>
</span></span><span style=display:flex><span>chmod +x ~/deploy-blog.sh
</span></span></code></pre></div><h3 id=3-备份脚本>3. 备份脚本</h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># 创建备份脚本</span>
</span></span><span style=display:flex><span>nano ~/backup-blog.sh
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e>#!/bin/bash
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>BACKUP_DIR<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;/home/zhaoxiongzhou/backups&#34;</span>
</span></span><span style=display:flex><span>DATE<span style=color:#f92672>=</span><span style=color:#66d9ef>$(</span>date +%Y%m%d<span style=color:#66d9ef>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 创建备份目录</span>
</span></span><span style=display:flex><span>mkdir -p $BACKUP_DIR
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 备份博客内容</span>
</span></span><span style=display:flex><span>tar -czf $BACKUP_DIR/blog_$DATE.tar.gz ~/myblog/content
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 备份配置文件</span>
</span></span><span style=display:flex><span>cp ~/myblog/config.toml $BACKUP_DIR/config_$DATE.toml
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 删除30天前的备份</span>
</span></span><span style=display:flex><span>find $BACKUP_DIR -name <span style=color:#e6db74>&#34;*.tar.gz&#34;</span> -mtime +30 -delete
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># 设置执行权限</span>
</span></span><span style=display:flex><span>chmod +x ~/backup-blog.sh
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 配置定时任务</span>
</span></span><span style=display:flex><span>crontab -e
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># 添加定时任务（每周日凌晨2点执行备份）</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>0</span> <span style=color:#ae81ff>2</span> * * <span style=color:#ae81ff>0</span> /home/zhaoxiongzhou/backup-blog.sh
</span></span></code></pre></div><h2 id=五系统维护与监控>五、系统维护与监控</h2><h3 id=1-资源监控命令>1. 资源监控命令</h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># 系统资源监控</span>
</span></span><span style=display:flex><span>htop
</span></span><span style=display:flex><span>top
</span></span><span style=display:flex><span>free -h
</span></span><span style=display:flex><span>vmstat <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 磁盘使用监控</span>
</span></span><span style=display:flex><span>df -h
</span></span><span style=display:flex><span>du -sh /*
</span></span><span style=display:flex><span>du -sh ~/myblog
</span></span><span style=display:flex><span>du -sh ~/projects/llama.cpp
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 温度监控</span>
</span></span><span style=display:flex><span>vcgencmd measure_temp
</span></span></code></pre></div><h3 id=2-性能优化>2. 性能优化</h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># 清理系统缓存</span>
</span></span><span style=display:flex><span>sudo sync; echo <span style=color:#ae81ff>3</span> | sudo tee /proc/sys/vm/drop_caches
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 调整 Swap 设置</span>
</span></span><span style=display:flex><span>cat /proc/sys/vm/swappiness
</span></span><span style=display:flex><span>sudo sysctl vm.swappiness<span style=color:#f92672>=</span><span style=color:#ae81ff>60</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># CPU 频率调整</span>
</span></span><span style=display:flex><span>sudo nano /boot/config.txt
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-toml data-lang=toml><span style=display:flex><span><span style=color:#75715e># CPU 配置参数</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>arm_freq</span>=<span style=color:#ae81ff>1800</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>over_voltage</span>=<span style=color:#ae81ff>6</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>temp_limit</span>=<span style=color:#ae81ff>75</span>
</span></span></code></pre></div><h3 id=3-系统维护>3. 系统维护</h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># 系统更新</span>
</span></span><span style=display:flex><span>sudo apt update
</span></span><span style=display:flex><span>sudo apt upgrade -y
</span></span><span style=display:flex><span>sudo apt autoremove
</span></span><span style=display:flex><span>sudo apt clean
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 日志清理</span>
</span></span><span style=display:flex><span>sudo find /var/log -type f -name <span style=color:#e6db74>&#34;*.log&#34;</span> -mtime +30 -delete
</span></span><span style=display:flex><span>sudo find /var/log -type f -name <span style=color:#e6db74>&#34;*.gz&#34;</span> -delete
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 服务状态检查</span>
</span></span><span style=display:flex><span>systemctl status nginx
</span></span><span style=display:flex><span>ps aux | grep llama-server
</span></span></code></pre></div><h2 id=六安全配置>六、安全配置</h2><h3 id=1-防火墙设置>1. 防火墙设置</h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># 安装 UFW</span>
</span></span><span style=display:flex><span>sudo apt install ufw
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 配置基本规则</span>
</span></span><span style=display:flex><span>sudo ufw default deny incoming
</span></span><span style=display:flex><span>sudo ufw default allow outgoing
</span></span><span style=display:flex><span>sudo ufw allow <span style=color:#ae81ff>22</span>
</span></span><span style=display:flex><span>sudo ufw allow <span style=color:#ae81ff>80</span>
</span></span><span style=display:flex><span>sudo ufw allow <span style=color:#ae81ff>8080</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 启用防火墙</span>
</span></span><span style=display:flex><span>sudo ufw enable
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 检查状态</span>
</span></span><span style=display:flex><span>sudo ufw status
</span></span></code></pre></div><h3 id=2-nginx-访问控制>2. Nginx 访问控制</h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># 安装认证工具</span>
</span></span><span style=display:flex><span>sudo apt install apache2-utils
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 创建用户密码</span>
</span></span><span style=display:flex><span>sudo htpasswd -c /etc/nginx/.htpasswd username
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 修改 Nginx 配置</span>
</span></span><span style=display:flex><span>sudo nano /etc/nginx/sites-available/myblog
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-nginx data-lang=nginx><span style=display:flex><span><span style=color:#66d9ef>server</span> {
</span></span><span style=display:flex><span>    <span style=color:#f92672>listen</span> <span style=color:#ae81ff>80</span>;
</span></span><span style=display:flex><span>    <span style=color:#f92672>server_name</span> <span style=color:#ae81ff>10</span><span style=color:#e6db74>.40.110.47</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>root</span> <span style=color:#e6db74>/home/zhaoxiongzhou/myblog/public</span>;
</span></span><span style=display:flex><span>    <span style=color:#f92672>index</span> <span style=color:#e6db74>index.html</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># 添加基本认证
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#f92672>location</span> <span style=color:#e6db74>/</span> {
</span></span><span style=display:flex><span>        <span style=color:#f92672>auth_basic</span> <span style=color:#e6db74>&#34;Restricted</span> <span style=color:#e6db74>Access&#34;</span>;
</span></span><span style=display:flex><span>        <span style=color:#f92672>auth_basic_user_file</span> <span style=color:#e6db74>/etc/nginx/.htpasswd</span>;
</span></span><span style=display:flex><span>        <span style=color:#f92672>try_files</span> $uri $uri/ =<span style=color:#ae81ff>404</span>;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># 日志配置
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#f92672>access_log</span> <span style=color:#e6db74>/var/log/nginx/myblog_access.log</span>;
</span></span><span style=display:flex><span>    <span style=color:#f92672>error_log</span> <span style=color:#e6db74>/var/log/nginx/myblog_error.log</span>;
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h3 id=3-日志监控>3. 日志监控</h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># 安装日志监控工具</span>
</span></span><span style=display:flex><span>sudo apt install logwatch
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 配置日志监控</span>
</span></span><span style=display:flex><span>sudo nano /etc/logwatch/conf/logwatch.conf
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-toml data-lang=toml><span style=display:flex><span><span style=color:#75715e># 配置每日日志检查</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>Output</span> = <span style=color:#a6e22e>mail</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>Format</span> = <span style=color:#a6e22e>html</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>MailTo</span> = <span style=color:#a6e22e>your-email</span><span style=color:#960050;background-color:#1e0010>@</span><span style=color:#a6e22e>domain</span>.<span style=color:#a6e22e>com</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>Detail</span> = <span style=color:#a6e22e>High</span>
</span></span></code></pre></div><h2 id=七故障排除指南>七、故障排除指南</h2><h4 id=内存相关问题>内存相关问题</h4><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># 检查内存状态</span>
</span></span><span style=display:flex><span>free -h
</span></span><span style=display:flex><span>ps aux --sort<span style=color:#f92672>=</span>-%mem | head
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 如果内存不足，调整服务参数</span>
</span></span><span style=display:flex><span>nano ~/projects/llama.cpp/start-llama.sh
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># 降低资源使用的参数示例</span>
</span></span><span style=display:flex><span>--ctx-size <span style=color:#ae81ff>1024</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>--batch-size <span style=color:#ae81ff>128</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>--threads <span style=color:#ae81ff>1</span>
</span></span></code></pre></div><h4 id=服务无响应>服务无响应</h4><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># 检查进程</span>
</span></span><span style=display:flex><span>ps aux | grep llama-server
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 检查端口</span>
</span></span><span style=display:flex><span>netstat -tuln | grep <span style=color:#ae81ff>8080</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 重启服务</span>
</span></span><span style=display:flex><span>pkill llama-server
</span></span><span style=display:flex><span>./start-llama.sh
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 检查日志</span>
</span></span><span style=display:flex><span>tail -f ~/projects/llama.cpp/llama.log
</span></span></code></pre></div><h3 id=2-博客服务故障排除>2. 博客服务故障排除</h3><h4 id=nginx-问题>Nginx 问题</h4><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># 检查配置语法</span>
</span></span><span style=display:flex><span>sudo nginx -t
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 检查日志</span>
</span></span><span style=display:flex><span>sudo tail -f /var/log/nginx/error.log
</span></span><span style=display:flex><span>sudo tail -f /var/log/nginx/myblog_error.log
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 检查服务状态</span>
</span></span><span style=display:flex><span>sudo systemctl status nginx
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 重启服务</span>
</span></span><span style=display:flex><span>sudo systemctl restart nginx
</span></span></code></pre></div><h4 id=hugo-生成问题>Hugo 生成问题</h4><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># 清理缓存</span>
</span></span><span style=display:flex><span>rm -rf ~/myblog/public
</span></span><span style=display:flex><span>rm -rf ~/myblog/resources
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 更新主题</span>
</span></span><span style=display:flex><span>git submodule update --init --recursive
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 重新生成（详细模式）</span>
</span></span><span style=display:flex><span>hugo --verbose
</span></span></code></pre></div><h2 id=八系统级故障排除>八、系统级故障排除</h2><h3 id=1-磁盘问题>1. 磁盘问题</h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># 检查磁盘使用情况</span>
</span></span><span style=display:flex><span>df -h
</span></span><span style=display:flex><span>du -sh /*
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 查找大文件</span>
</span></span><span style=display:flex><span>sudo find / -type f -size +100M
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 清理空间</span>
</span></span><span style=display:flex><span>sudo apt clean
</span></span><span style=display:flex><span>sudo apt autoremove
</span></span><span style=display:flex><span>sudo journalctl --vacuum-time<span style=color:#f92672>=</span>7d
</span></span></code></pre></div><h3 id=2-网络问题>2. 网络问题</h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># 网络状态检查</span>
</span></span><span style=display:flex><span>ip addr show
</span></span><span style=display:flex><span>ping -c <span style=color:#ae81ff>4</span> 8.8.8.8
</span></span><span style=display:flex><span>netstat -tuln
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># DNS 检查</span>
</span></span><span style=display:flex><span>cat /etc/resolv.conf
</span></span><span style=display:flex><span>nslookup google.com
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 重启网络服务</span>
</span></span><span style=display:flex><span>sudo systemctl restart networking
</span></span><span style=display:flex><span>sudo systemctl restart wpa_supplicant
</span></span></code></pre></div><h3 id=3-性能问题>3. 性能问题</h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># CPU 温度监控</span>
</span></span><span style=display:flex><span>vcgencmd measure_temp
</span></span><span style=display:flex><span>watch -n <span style=color:#ae81ff>1</span> vcgencmd measure_temp
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># CPU 频率检查</span>
</span></span><span style=display:flex><span>vcgencmd measure_clock arm
</span></span><span style=display:flex><span>cat /sys/devices/system/cpu/cpu0/cpufreq/scaling_cur_freq
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 系统负载检查</span>
</span></span><span style=display:flex><span>uptime
</span></span><span style=display:flex><span>cat /proc/loadavg
</span></span></code></pre></div><h2 id=九维护最佳实践>九、维护最佳实践</h2><h3 id=1-日常维护清单>1. 日常维护清单</h3><ul><li>检查系统日志</li><li>监控资源使用</li><li>验证服务状态</li><li>检查备份状态</li><li>更新系统安全补丁</li></ul><h3 id=2-周期性维护任务>2. 周期性维护任务</h3><ul><li>清理旧日志和临时文件</li><li>验证备份完整性</li><li>检查系统更新</li><li>检查服务性能</li><li>更新文档和配置说明</li></ul><h3 id=3-应急预案>3. 应急预案</h3><ul><li>保存所有配置文件的备份</li><li>记录所有服务的配置步骤</li><li>维护问题解决方案文档</li><li>建立服务恢复流程</li><li>保持重要数据的多份备份</li></ul><h2 id=十性能优化建议>十、性能优化建议</h2><h3 id=1-系统级优化>1. 系统级优化</h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># 1. 调整 SWAP 设置</span>
</span></span><span style=display:flex><span>sudo nano /etc/sysctl.conf
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-toml data-lang=toml><span style=display:flex><span><span style=color:#75715e># 添加或修改以下参数</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>vm</span>.<span style=color:#a6e22e>swappiness</span>=<span style=color:#ae81ff>60</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>vm</span>.<span style=color:#a6e22e>vfs_cache_pressure</span>=<span style=color:#ae81ff>50</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>vm</span>.<span style=color:#a6e22e>dirty_background_ratio</span>=<span style=color:#ae81ff>5</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>vm</span>.<span style=color:#a6e22e>dirty_ratio</span>=<span style=color:#ae81ff>10</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># 2. 优化文件系统</span>
</span></span><span style=display:flex><span><span style=color:#75715e># 检查并优化文件系统</span>
</span></span><span style=display:flex><span>sudo tune2fs -o journal_data_writeback /dev/mmcblk0p2
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 3. 调整 CPU 性能</span>
</span></span><span style=display:flex><span>sudo nano /boot/config.txt
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-toml data-lang=toml><span style=display:flex><span><span style=color:#75715e># 添加以下配置</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>arm_freq</span>=<span style=color:#ae81ff>1800</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>over_voltage</span>=<span style=color:#ae81ff>6</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>gpu_freq</span>=<span style=color:#ae81ff>500</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>dtparam</span>=<span style=color:#a6e22e>audio</span>=<span style=color:#a6e22e>on</span>
</span></span></code></pre></div><h3 id=2-服务优化>2. 服务优化</h3><h4 id=ai-服务优化>AI 服务优化</h4><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># 调整服务参数</span>
</span></span><span style=display:flex><span>nano ~/projects/llama.cpp/start-llama.sh
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-toml data-lang=toml><span style=display:flex><span><span style=color:#75715e># 优化参数示例</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>--ctx-size</span> <span style=color:#ae81ff>2048</span> <span style=color:#960050;background-color:#1e0010>\</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>--threads</span> <span style=color:#ae81ff>2</span> <span style=color:#960050;background-color:#1e0010>\</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>--batch-size</span> <span style=color:#ae81ff>256</span> <span style=color:#960050;background-color:#1e0010>\</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>--keep-context</span> <span style=color:#960050;background-color:#1e0010>\</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>--mlock</span> <span style=color:#960050;background-color:#1e0010>\</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>--numa</span>
</span></span></code></pre></div><h4 id=nginx-优化>Nginx 优化</h4><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>sudo nano /etc/nginx/nginx.conf
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-toml data-lang=toml><span style=display:flex><span><span style=color:#a6e22e>worker_processes</span> <span style=color:#a6e22e>auto</span><span style=color:#960050;background-color:#1e0010>;</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>worker_rlimit_nofile</span> <span style=color:#ae81ff>65535</span><span style=color:#960050;background-color:#1e0010>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>events</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>worker_connections</span> <span style=color:#ae81ff>1024</span><span style=color:#960050;background-color:#1e0010>;</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>multi_accept</span> <span style=color:#a6e22e>on</span><span style=color:#960050;background-color:#1e0010>;</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>use</span> <span style=color:#a6e22e>epoll</span><span style=color:#960050;background-color:#1e0010>;</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>http</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>sendfile</span> <span style=color:#a6e22e>on</span><span style=color:#960050;background-color:#1e0010>;</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>tcp_nopush</span> <span style=color:#a6e22e>on</span><span style=color:#960050;background-color:#1e0010>;</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>tcp_nodelay</span> <span style=color:#a6e22e>on</span><span style=color:#960050;background-color:#1e0010>;</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>keepalive_timeout</span> <span style=color:#ae81ff>65</span><span style=color:#960050;background-color:#1e0010>;</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>types_hash_max_size</span> <span style=color:#ae81ff>2048</span><span style=color:#960050;background-color:#1e0010>;</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>server_tokens</span> <span style=color:#a6e22e>off</span><span style=color:#960050;background-color:#1e0010>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># 缓存设置</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>open_file_cache</span> <span style=color:#a6e22e>max</span>=<span style=color:#ae81ff>1000</span> <span style=color:#a6e22e>inactive</span>=<span style=color:#ae81ff>20</span><span style=color:#a6e22e>s</span><span style=color:#960050;background-color:#1e0010>;</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>open_file_cache_valid</span> <span style=color:#ae81ff>30</span><span style=color:#a6e22e>s</span><span style=color:#960050;background-color:#1e0010>;</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>open_file_cache_min_uses</span> <span style=color:#ae81ff>2</span><span style=color:#960050;background-color:#1e0010>;</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>open_file_cache_errors</span> <span style=color:#a6e22e>on</span><span style=color:#960050;background-color:#1e0010>;</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h2 id=十一监控与报警系统>十一、监控与报警系统</h2><h3 id=1-系统监控配置>1. 系统监控配置</h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># 安装监控工具</span>
</span></span><span style=display:flex><span>sudo apt install prometheus node-exporter grafana
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 配置 Prometheus</span>
</span></span><span style=display:flex><span>sudo nano /etc/prometheus/prometheus.yml
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-toml data-lang=toml><span style=display:flex><span><span style=color:#a6e22e>global</span><span style=color:#960050;background-color:#1e0010>:</span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>scrape_interval</span><span style=color:#960050;background-color:#1e0010>:</span> <span style=color:#ae81ff>15</span><span style=color:#a6e22e>s</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>scrape_configs</span><span style=color:#960050;background-color:#1e0010>:</span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>-</span> <span style=color:#a6e22e>job_name</span><span style=color:#960050;background-color:#1e0010>:</span> <span style=color:#e6db74>&#39;node&#39;</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>static_configs</span><span style=color:#960050;background-color:#1e0010>:</span>
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>-</span> <span style=color:#a6e22e>targets</span><span style=color:#960050;background-color:#1e0010>:</span> [<span style=color:#e6db74>&#39;localhost:9100&#39;</span>]
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>-</span> <span style=color:#a6e22e>job_name</span><span style=color:#960050;background-color:#1e0010>:</span> <span style=color:#e6db74>&#39;nginx&#39;</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>static_configs</span><span style=color:#960050;background-color:#1e0010>:</span>
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>-</span> <span style=color:#a6e22e>targets</span><span style=color:#960050;background-color:#1e0010>:</span> [<span style=color:#e6db74>&#39;localhost:9113&#39;</span>]
</span></span></code></pre></div><h3 id=2-自动报警脚本>2. 自动报警脚本</h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># 创建监控脚本</span>
</span></span><span style=display:flex><span>nano ~/monitor.sh
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e>#!/bin/bash
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#75715e># 定义阈值</span>
</span></span><span style=display:flex><span>MAX_CPU_USAGE<span style=color:#f92672>=</span><span style=color:#ae81ff>90</span>
</span></span><span style=display:flex><span>MAX_MEM_USAGE<span style=color:#f92672>=</span><span style=color:#ae81ff>90</span>
</span></span><span style=display:flex><span>MAX_DISK_USAGE<span style=color:#f92672>=</span><span style=color:#ae81ff>90</span>
</span></span><span style=display:flex><span>MAX_TEMP<span style=color:#f92672>=</span><span style=color:#ae81ff>75</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 获取系统数据</span>
</span></span><span style=display:flex><span>CPU_USAGE<span style=color:#f92672>=</span><span style=color:#66d9ef>$(</span>top -bn1 | grep <span style=color:#e6db74>&#34;Cpu(s)&#34;</span> | awk <span style=color:#e6db74>&#39;{print $2}&#39;</span> | cut -d. -f1<span style=color:#66d9ef>)</span>
</span></span><span style=display:flex><span>MEM_USAGE<span style=color:#f92672>=</span><span style=color:#66d9ef>$(</span>free | grep Mem | awk <span style=color:#e6db74>&#39;{print $3/$2 * 100.0}&#39;</span><span style=color:#66d9ef>)</span>
</span></span><span style=display:flex><span>DISK_USAGE<span style=color:#f92672>=</span><span style=color:#66d9ef>$(</span>df -h / | awk <span style=color:#e6db74>&#39;NR==2 {print $5}&#39;</span> | cut -d% -f1<span style=color:#66d9ef>)</span>
</span></span><span style=display:flex><span>TEMP<span style=color:#f92672>=</span><span style=color:#66d9ef>$(</span>vcgencmd measure_temp | cut -d<span style=color:#f92672>=</span> -f2 | cut -d. -f1<span style=color:#66d9ef>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 检查服务状态</span>
</span></span><span style=display:flex><span>check_services<span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    services<span style=color:#f92672>=(</span><span style=color:#e6db74>&#34;nginx&#34;</span> <span style=color:#e6db74>&#34;llama-server&#34;</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>for</span> service in <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>${</span>services[@]<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span>; <span style=color:#66d9ef>do</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> ! pgrep -x <span style=color:#e6db74>&#34;</span>$service<span style=color:#e6db74>&#34;</span> &gt; /dev/null; <span style=color:#66d9ef>then</span>
</span></span><span style=display:flex><span>            echo <span style=color:#e6db74>&#34;警告: </span>$service<span style=color:#e6db74> 服务未运行!&#34;</span>
</span></span><span style=display:flex><span>            <span style=color:#75715e># 可以添加重启服务的命令</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>fi</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>done</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 发送警告</span>
</span></span><span style=display:flex><span>send_alert<span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    message<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;</span>$1<span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># 这里可以添加发送邮件或其他通知的命令</span>
</span></span><span style=display:flex><span>    echo <span style=color:#e6db74>&#34;</span>$message<span style=color:#e6db74>&#34;</span> &gt;&gt; /var/log/system_alerts.log
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 检查各项指标</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>if</span> <span style=color:#f92672>[</span> <span style=color:#e6db74>&#34;</span>$CPU_USAGE<span style=color:#e6db74>&#34;</span> -gt <span style=color:#e6db74>&#34;</span>$MAX_CPU_USAGE<span style=color:#e6db74>&#34;</span> <span style=color:#f92672>]</span>; <span style=color:#66d9ef>then</span>
</span></span><span style=display:flex><span>    send_alert <span style=color:#e6db74>&#34;CPU 使用率过高: </span>$CPU_USAGE<span style=color:#e6db74>%&#34;</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>fi</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>if</span> <span style=color:#f92672>[</span> <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>${</span>MEM_USAGE%.*<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span> -gt <span style=color:#e6db74>&#34;</span>$MAX_MEM_USAGE<span style=color:#e6db74>&#34;</span> <span style=color:#f92672>]</span>; <span style=color:#66d9ef>then</span>
</span></span><span style=display:flex><span>    send_alert <span style=color:#e6db74>&#34;内存使用率过高: </span>$MEM_USAGE<span style=color:#e6db74>%&#34;</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>fi</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>if</span> <span style=color:#f92672>[</span> <span style=color:#e6db74>&#34;</span>$DISK_USAGE<span style=color:#e6db74>&#34;</span> -gt <span style=color:#e6db74>&#34;</span>$MAX_DISK_USAGE<span style=color:#e6db74>&#34;</span> <span style=color:#f92672>]</span>; <span style=color:#66d9ef>then</span>
</span></span><span style=display:flex><span>    send_alert <span style=color:#e6db74>&#34;磁盘使用率过高: </span>$DISK_USAGE<span style=color:#e6db74>%&#34;</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>fi</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>if</span> <span style=color:#f92672>[</span> <span style=color:#e6db74>&#34;</span>$TEMP<span style=color:#e6db74>&#34;</span> -gt <span style=color:#e6db74>&#34;</span>$MAX_TEMP<span style=color:#e6db74>&#34;</span> <span style=color:#f92672>]</span>; <span style=color:#66d9ef>then</span>
</span></span><span style=display:flex><span>    send_alert <span style=color:#e6db74>&#34;系统温度过高: </span>$TEMP<span style=color:#e6db74>°C&#34;</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>fi</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 检查服务状态</span>
</span></span><span style=display:flex><span>check_services
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># 设置执行权限</span>
</span></span><span style=display:flex><span>chmod +x ~/monitor.sh
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 添加到 crontab</span>
</span></span><span style=display:flex><span>crontab -e
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># 每5分钟执行一次监控</span>
</span></span><span style=display:flex><span>*/5 * * * * /home/zhaoxiongzhou/monitor.sh
</span></span></code></pre></div><h2 id=十二数据备份与恢复>十二、数据备份与恢复</h2><h3 id=1-完整备份方案>1. 完整备份方案</h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># 创建完整备份脚本</span>
</span></span><span style=display:flex><span>nano ~/full-backup.sh
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e>#!/bin/bash
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>BACKUP_ROOT<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;/home/zhaoxiongzhou/backups&#34;</span>
</span></span><span style=display:flex><span>DATE<span style=color:#f92672>=</span><span style=color:#66d9ef>$(</span>date +%Y%m%d_%H%M%S<span style=color:#66d9ef>)</span>
</span></span><span style=display:flex><span>BACKUP_DIR<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;</span>$BACKUP_ROOT<span style=color:#e6db74>/</span>$DATE<span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 创建备份目录</span>
</span></span><span style=display:flex><span>mkdir -p <span style=color:#e6db74>&#34;</span>$BACKUP_DIR<span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 备份博客内容</span>
</span></span><span style=display:flex><span>echo <span style=color:#e6db74>&#34;备份博客内容...&#34;</span>
</span></span><span style=display:flex><span>tar -czf <span style=color:#e6db74>&#34;</span>$BACKUP_DIR<span style=color:#e6db74>/blog_content.tar.gz&#34;</span> ~/myblog/content
</span></span><span style=display:flex><span>tar -czf <span style=color:#e6db74>&#34;</span>$BACKUP_DIR<span style=color:#e6db74>/blog_config.tar.gz&#34;</span> ~/myblog/config.toml
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 备份 AI 模型和配置</span>
</span></span><span style=display:flex><span>echo <span style=color:#e6db74>&#34;备份 AI 服务...&#34;</span>
</span></span><span style=display:flex><span>tar -czf <span style=color:#e6db74>&#34;</span>$BACKUP_DIR<span style=color:#e6db74>/llama_models.tar.gz&#34;</span> ~/projects/llama.cpp/models
</span></span><span style=display:flex><span>tar -czf <span style=color:#e6db74>&#34;</span>$BACKUP_DIR<span style=color:#e6db74>/llama_config.tar.gz&#34;</span> ~/projects/llama.cpp/start-llama.sh
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 备份 Nginx 配置</span>
</span></span><span style=display:flex><span>echo <span style=color:#e6db74>&#34;备份 Nginx 配置...&#34;</span>
</span></span><span style=display:flex><span>sudo tar -czf <span style=color:#e6db74>&#34;</span>$BACKUP_DIR<span style=color:#e6db74>/nginx_config.tar.gz&#34;</span> /etc/nginx/sites-available/myblog
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 备份系统配置</span>
</span></span><span style=display:flex><span>echo <span style=color:#e6db74>&#34;备份系统配置...&#34;</span>
</span></span><span style=display:flex><span>sudo tar -czf <span style=color:#e6db74>&#34;</span>$BACKUP_DIR<span style=color:#e6db74>/system_config.tar.gz&#34;</span> /boot/config.txt /etc/fstab
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 创建备份清单</span>
</span></span><span style=display:flex><span>echo <span style=color:#e6db74>&#34;创建备份清单...&#34;</span>
</span></span><span style=display:flex><span>find <span style=color:#e6db74>&#34;</span>$BACKUP_DIR<span style=color:#e6db74>&#34;</span> -type f -exec sha256sum <span style=color:#f92672>{}</span> <span style=color:#ae81ff>\;</span> &gt; <span style=color:#e6db74>&#34;</span>$BACKUP_DIR<span style=color:#e6db74>/checksum.txt&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 清理旧备份（保留最近7份）</span>
</span></span><span style=display:flex><span>cd <span style=color:#e6db74>&#34;</span>$BACKUP_ROOT<span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>ls -t | tail -n +8 | xargs -r rm -r
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>echo <span style=color:#e6db74>&#34;备份完成: </span>$BACKUP_DIR<span style=color:#e6db74>&#34;</span>
</span></span></code></pre></div><h3 id=2-数据恢复流程>2. 数据恢复流程</h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># 创建恢复脚本</span>
</span></span><span style=display:flex><span>nano ~/restore.sh
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e>#!/bin/bash
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>if</span> <span style=color:#f92672>[</span> -z <span style=color:#e6db74>&#34;</span>$1<span style=color:#e6db74>&#34;</span> <span style=color:#f92672>]</span>; <span style=color:#66d9ef>then</span>
</span></span><span style=display:flex><span>    echo <span style=color:#e6db74>&#34;使用方法: </span>$0<span style=color:#e6db74> &lt;备份目录&gt;&#34;</span>
</span></span><span style=display:flex><span>    exit <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>fi</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>BACKUP_DIR<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;</span>$1<span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 验证备份完整性</span>
</span></span><span style=display:flex><span>echo <span style=color:#e6db74>&#34;验证备份完整性...&#34;</span>
</span></span><span style=display:flex><span>cd <span style=color:#e6db74>&#34;</span>$BACKUP_DIR<span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>sha256sum -c checksum.txt <span style=color:#f92672>||</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    echo <span style=color:#e6db74>&#34;备份验证失败！&#34;</span>
</span></span><span style=display:flex><span>    exit <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 恢复博客内容</span>
</span></span><span style=display:flex><span>echo <span style=color:#e6db74>&#34;恢复博客内容...&#34;</span>
</span></span><span style=display:flex><span>tar -xzf <span style=color:#e6db74>&#34;</span>$BACKUP_DIR<span style=color:#e6db74>/blog_content.tar.gz&#34;</span> -C ~/myblog/
</span></span><span style=display:flex><span>tar -xzf <span style=color:#e6db74>&#34;</span>$BACKUP_DIR<span style=color:#e6db74>/blog_config.tar.gz&#34;</span> -C ~/myblog/
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 恢复 AI 服务</span>
</span></span><span style=display:flex><span>echo <span style=color:#e6db74>&#34;恢复 AI 服务...&#34;</span>
</span></span><span style=display:flex><span>tar -xzf <span style=color:#e6db74>&#34;</span>$BACKUP_DIR<span style=color:#e6db74>/llama_models.tar.gz&#34;</span> -C ~/projects/llama.cpp/
</span></span><span style=display:flex><span>tar -xzf <span style=color:#e6db74>&#34;</span>$BACKUP_DIR<span style=color:#e6db74>/llama_config.tar.gz&#34;</span> -C ~/projects/llama.cpp/
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 恢复 Nginx 配置</span>
</span></span><span style=display:flex><span>echo <span style=color:#e6db74>&#34;恢复 Nginx 配置...&#34;</span>
</span></span><span style=display:flex><span>sudo tar -xzf <span style=color:#e6db74>&#34;</span>$BACKUP_DIR<span style=color:#e6db74>/nginx_config.tar.gz&#34;</span> -C /etc/nginx/sites-available/
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 恢复系统配置</span>
</span></span><span style=display:flex><span>echo <span style=color:#e6db74>&#34;恢复系统配置...&#34;</span>
</span></span><span style=display:flex><span>sudo tar -xzf <span style=color:#e6db74>&#34;</span>$BACKUP_DIR<span style=color:#e6db74>/system_config.tar.gz&#34;</span> -C /
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 重启服务</span>
</span></span><span style=display:flex><span>echo <span style=color:#e6db74>&#34;重启服务...&#34;</span>
</span></span><span style=display:flex><span>sudo systemctl restart nginx
</span></span><span style=display:flex><span>pkill llama-server
</span></span><span style=display:flex><span>~/projects/llama.cpp/start-llama.sh
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>echo <span style=color:#e6db74>&#34;恢复完成&#34;</span>
</span></span></code></pre></div><h2 id=十三服务升级指南>十三、服务升级指南</h2><h3 id=1-hugo-博客升级>1. Hugo 博客升级</h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># 1. 备份当前版本</span>
</span></span><span style=display:flex><span>cd ~
</span></span><span style=display:flex><span>tar -czf hugo_backup_<span style=color:#66d9ef>$(</span>date +%Y%m%d<span style=color:#66d9ef>)</span>.tar.gz myblog/
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 2. 检查当前版本</span>
</span></span><span style=display:flex><span>hugo version
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 3. 下载新版本</span>
</span></span><span style=display:flex><span>wget https://github.com/gohugoio/hugo/releases/download/v<span style=color:#f92672>[</span>新版本<span style=color:#f92672>]</span>/hugo_extended_<span style=color:#f92672>[</span>新版本<span style=color:#f92672>]</span>_linux-arm64.deb
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 4. 安装新版本</span>
</span></span><span style=display:flex><span>sudo dpkg -i hugo_extended_<span style=color:#f92672>[</span>新版本<span style=color:#f92672>]</span>_linux-arm64.deb
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 5. 更新主题</span>
</span></span><span style=display:flex><span>cd ~/myblog
</span></span><span style=display:flex><span>git submodule update --remote themes/ananke
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 6. 测试生成</span>
</span></span><span style=display:flex><span>hugo --verbose
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 7. 部署更新</span>
</span></span><span style=display:flex><span>./deploy-blog.sh
</span></span></code></pre></div><h3 id=2-ai-服务升级>2. AI 服务升级</h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># 1. 备份当前版本</span>
</span></span><span style=display:flex><span>cd ~/projects
</span></span><span style=display:flex><span>tar -czf llama_backup_<span style=color:#66d9ef>$(</span>date +%Y%m%d<span style=color:#66d9ef>)</span>.tar.gz llama.cpp/
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 2. 更新源码</span>
</span></span><span style=display:flex><span>cd llama.cpp
</span></span><span style=display:flex><span>git pull origin master
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 3. 重新编译</span>
</span></span><span style=display:flex><span>make clean
</span></span><span style=display:flex><span>LLAMA_METAL<span style=color:#f92672>=</span><span style=color:#ae81ff>1</span> make -j4
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 4. 测试新版本</span>
</span></span><span style=display:flex><span>./llama-server -h
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 5. 更新启动脚本</span>
</span></span><span style=display:flex><span>nano start-llama.sh
</span></span></code></pre></div><h3 id=3-系统升级>3. 系统升级</h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># 1. 更新软件包列表</span>
</span></span><span style=display:flex><span>sudo apt update
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 2. 升级所有包</span>
</span></span><span style=display:flex><span>sudo apt upgrade -y
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 3. 升级系统</span>
</span></span><span style=display:flex><span>sudo apt dist-upgrade -y
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 4. 清理旧包</span>
</span></span><span style=display:flex><span>sudo apt autoremove -y
</span></span><span style=display:flex><span>sudo apt clean
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 5. 检查启动项</span>
</span></span><span style=display:flex><span>sudo systemctl list-unit-files --state<span style=color:#f92672>=</span>enabled
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 6. 更新树莓派固件</span>
</span></span><span style=display:flex><span>sudo rpi-update
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 7. 检查系统状态</span>
</span></span><span style=display:flex><span>sudo systemctl --failed
</span></span><span style=display:flex><span>sudo journalctl -p <span style=color:#ae81ff>3</span> -xb
</span></span></code></pre></div><h2 id=十四安全加固指南>十四、安全加固指南</h2><h3 id=1-系统安全配置>1. 系统安全配置</h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># 1. SSH 安全配置</span>
</span></span><span style=display:flex><span>sudo nano /etc/ssh/sshd_config
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-toml data-lang=toml><span style=display:flex><span><span style=color:#75715e># SSH 配置建议</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>Port</span> <span style=color:#ae81ff>22222</span>                    <span style=color:#75715e># 修改默认端口</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>PermitRootLogin</span> <span style=color:#a6e22e>no</span>           <span style=color:#75715e># 禁止 root 登录</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>PasswordAuthentication</span> <span style=color:#a6e22e>no</span>    <span style=color:#75715e># 禁用密码认证</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>PubkeyAuthentication</span> <span style=color:#a6e22e>yes</span>    <span style=color:#75715e># 启用密钥认证</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>AllowUsers</span> <span style=color:#a6e22e>zhaoxiongzhou</span>   <span style=color:#75715e># 限制允许的用户</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># 2. 设置防火墙规则</span>
</span></span><span style=display:flex><span>sudo apt install ufw fail2ban
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 配置 UFW</span>
</span></span><span style=display:flex><span>sudo ufw default deny incoming
</span></span><span style=display:flex><span>sudo ufw default allow outgoing
</span></span><span style=display:flex><span>sudo ufw allow 22222/tcp  <span style=color:#75715e># SSH</span>
</span></span><span style=display:flex><span>sudo ufw allow 80/tcp     <span style=color:#75715e># HTTP</span>
</span></span><span style=display:flex><span>sudo ufw allow 8080/tcp   <span style=color:#75715e># AI 服务</span>
</span></span><span style=display:flex><span>sudo ufw enable
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 配置 fail2ban</span>
</span></span><span style=display:flex><span>sudo nano /etc/fail2ban/jail.local
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#f92672>[</span>sshd<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>enabled <span style=color:#f92672>=</span> true
</span></span><span style=display:flex><span>port <span style=color:#f92672>=</span> <span style=color:#ae81ff>22222</span>
</span></span><span style=display:flex><span>filter <span style=color:#f92672>=</span> sshd
</span></span><span style=display:flex><span>logpath <span style=color:#f92672>=</span> /var/log/auth.log
</span></span><span style=display:flex><span>maxretry <span style=color:#f92672>=</span> <span style=color:#ae81ff>3</span>
</span></span><span style=display:flex><span>bantime <span style=color:#f92672>=</span> <span style=color:#ae81ff>3600</span>
</span></span></code></pre></div><h3 id=2-服务安全配置>2. 服务安全配置</h3><h4 id=nginx-安全设置>Nginx 安全设置</h4><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># 1. 创建 SSL 证书</span>
</span></span><span style=display:flex><span>sudo openssl req -x509 -nodes -days <span style=color:#ae81ff>365</span> -newkey rsa:2048 <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>-keyout /etc/nginx/ssl/nginx.key <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>-out /etc/nginx/ssl/nginx.crt
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 2. 配置 HTTPS</span>
</span></span><span style=display:flex><span>sudo nano /etc/nginx/sites-available/myblog
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-toml data-lang=toml><span style=display:flex><span><span style=color:#a6e22e>server</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>listen</span> <span style=color:#ae81ff>443</span> <span style=color:#a6e22e>ssl</span><span style=color:#960050;background-color:#1e0010>;</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>server_name</span> <span style=color:#ae81ff>10.40</span>.<span style=color:#ae81ff>110.47</span><span style=color:#960050;background-color:#1e0010>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>ssl_certificate</span> <span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>etc</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>nginx</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>ssl</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>nginx</span>.<span style=color:#a6e22e>crt</span><span style=color:#960050;background-color:#1e0010>;</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>ssl_certificate_key</span> <span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>etc</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>nginx</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>ssl</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>nginx</span>.<span style=color:#a6e22e>key</span><span style=color:#960050;background-color:#1e0010>;</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#75715e># SSL 配置</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>ssl_protocols</span> <span style=color:#a6e22e>TLSv1</span>.<span style=color:#ae81ff>2</span> <span style=color:#a6e22e>TLSv1</span>.<span style=color:#ae81ff>3</span><span style=color:#960050;background-color:#1e0010>;</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>ssl_prefer_server_ciphers</span> <span style=color:#a6e22e>on</span><span style=color:#960050;background-color:#1e0010>;</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>ssl_ciphers</span> <span style=color:#a6e22e>ECDHE-ECDSA-AES128-GCM-SHA256</span><span style=color:#960050;background-color:#1e0010>:</span><span style=color:#a6e22e>ECDHE-RSA-AES128-GCM-SHA256</span><span style=color:#960050;background-color:#1e0010>;</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#75715e># 安全头部</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>add_header</span> <span style=color:#a6e22e>X-Frame-Options</span> <span style=color:#e6db74>&#34;SAMEORIGIN&#34;</span><span style=color:#960050;background-color:#1e0010>;</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>add_header</span> <span style=color:#a6e22e>X-XSS-Protection</span> <span style=color:#e6db74>&#34;1; mode=block&#34;</span><span style=color:#960050;background-color:#1e0010>;</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>add_header</span> <span style=color:#a6e22e>X-Content-Type-Options</span> <span style=color:#e6db74>&#34;nosniff&#34;</span><span style=color:#960050;background-color:#1e0010>;</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>add_header</span> <span style=color:#a6e22e>Strict-Transport-Security</span> <span style=color:#e6db74>&#34;max-age=31536000&#34;</span><span style=color:#960050;background-color:#1e0010>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># 其他配置...</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h2 id=十五性能监控与分析>十五、性能监控与分析</h2><h3 id=1-监控脚本配置>1. 监控脚本配置</h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># 创建综合监控脚本</span>
</span></span><span style=display:flex><span>nano ~/system_monitor.sh
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e>#!/bin/bash
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>LOG_FILE<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;/var/log/system_monitor.log&#34;</span>
</span></span><span style=display:flex><span>ALERT_FILE<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;/var/log/system_alerts.log&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 记录时间戳</span>
</span></span><span style=display:flex><span>timestamp<span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    date <span style=color:#e6db74>&#34;+%Y-%m-%d %H:%M:%S&#34;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 系统资源监控</span>
</span></span><span style=display:flex><span>monitor_resources<span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    echo <span style=color:#e6db74>&#34;=== 系统资源监控 </span><span style=color:#66d9ef>$(</span>timestamp<span style=color:#66d9ef>)</span><span style=color:#e6db74> ===&#34;</span> &gt;&gt; <span style=color:#e6db74>&#34;</span>$LOG_FILE<span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#75715e># CPU 使用率</span>
</span></span><span style=display:flex><span>    CPU_USAGE<span style=color:#f92672>=</span><span style=color:#66d9ef>$(</span>top -bn1 | grep <span style=color:#e6db74>&#34;Cpu(s)&#34;</span> | awk <span style=color:#e6db74>&#39;{print $2}&#39;</span><span style=color:#66d9ef>)</span>
</span></span><span style=display:flex><span>    echo <span style=color:#e6db74>&#34;CPU 使用率: </span>$CPU_USAGE<span style=color:#e6db74>%&#34;</span> &gt;&gt; <span style=color:#e6db74>&#34;</span>$LOG_FILE<span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#75715e># 内存使用</span>
</span></span><span style=display:flex><span>    free -h | grep <span style=color:#e6db74>&#34;Mem:&#34;</span> &gt;&gt; <span style=color:#e6db74>&#34;</span>$LOG_FILE<span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#75715e># 磁盘使用</span>
</span></span><span style=display:flex><span>    df -h / &gt;&gt; <span style=color:#e6db74>&#34;</span>$LOG_FILE<span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#75715e># 系统负载</span>
</span></span><span style=display:flex><span>    uptime &gt;&gt; <span style=color:#e6db74>&#34;</span>$LOG_FILE<span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#75715e># CPU 温度</span>
</span></span><span style=display:flex><span>    vcgencmd measure_temp &gt;&gt; <span style=color:#e6db74>&#34;</span>$LOG_FILE<span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 服务状态监控</span>
</span></span><span style=display:flex><span>monitor_services<span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    echo <span style=color:#e6db74>&#34;=== 服务状态监控 </span><span style=color:#66d9ef>$(</span>timestamp<span style=color:#66d9ef>)</span><span style=color:#e6db74> ===&#34;</span> &gt;&gt; <span style=color:#e6db74>&#34;</span>$LOG_FILE<span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#75715e># Nginx 状态</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> systemctl is-active nginx &gt;/dev/null 2&gt;&amp;1; <span style=color:#66d9ef>then</span>
</span></span><span style=display:flex><span>        echo <span style=color:#e6db74>&#34;Nginx: 运行中&#34;</span> &gt;&gt; <span style=color:#e6db74>&#34;</span>$LOG_FILE<span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>else</span>
</span></span><span style=display:flex><span>        echo <span style=color:#e6db74>&#34;警告: Nginx 未运行!&#34;</span> &gt;&gt; <span style=color:#e6db74>&#34;</span>$ALERT_FILE<span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>fi</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#75715e># AI 服务状态</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> pgrep -f llama-server &gt;/dev/null; <span style=color:#66d9ef>then</span>
</span></span><span style=display:flex><span>        echo <span style=color:#e6db74>&#34;AI 服务: 运行中&#34;</span> &gt;&gt; <span style=color:#e6db74>&#34;</span>$LOG_FILE<span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>else</span>
</span></span><span style=display:flex><span>        echo <span style=color:#e6db74>&#34;警告: AI 服务未运行!&#34;</span> &gt;&gt; <span style=color:#e6db74>&#34;</span>$ALERT_FILE<span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>fi</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 网络监控</span>
</span></span><span style=display:flex><span>monitor_network<span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    echo <span style=color:#e6db74>&#34;=== 网络监控 </span><span style=color:#66d9ef>$(</span>timestamp<span style=color:#66d9ef>)</span><span style=color:#e6db74> ===&#34;</span> &gt;&gt; <span style=color:#e6db74>&#34;</span>$LOG_FILE<span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#75715e># 网络连接数</span>
</span></span><span style=display:flex><span>    netstat -an | grep ESTABLISHED | wc -l &gt;&gt; <span style=color:#e6db74>&#34;</span>$LOG_FILE<span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#75715e># 网络流量</span>
</span></span><span style=display:flex><span>    ifconfig wlan0 | grep bytes &gt;&gt; <span style=color:#e6db74>&#34;</span>$LOG_FILE<span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 主函数</span>
</span></span><span style=display:flex><span>main<span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    monitor_resources
</span></span><span style=display:flex><span>    monitor_services
</span></span><span style=display:flex><span>    monitor_network
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#75715e># 检查是否需要发送警告</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>[</span> -s <span style=color:#e6db74>&#34;</span>$ALERT_FILE<span style=color:#e6db74>&#34;</span> <span style=color:#f92672>]</span>; <span style=color:#66d9ef>then</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e># 可以添加发送警告的命令（如邮件通知）</span>
</span></span><span style=display:flex><span>        cat <span style=color:#e6db74>&#34;</span>$ALERT_FILE<span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>fi</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 执行监控</span>
</span></span><span style=display:flex><span>main
</span></span></code></pre></div><h3 id=2-性能分析工具>2. 性能分析工具</h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># 安装性能分析工具</span>
</span></span><span style=display:flex><span>sudo apt install sysstat iotop htop
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 创建性能数据收集脚本</span>
</span></span><span style=display:flex><span>nano ~/collect_performance.sh
</span></span></code></pre></div><h2 id=十六性能数据收集与分析>十六、性能数据收集与分析</h2><h3 id=1-性能数据收集脚本>1. 性能数据收集脚本</h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e>#!/bin/bash
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#75715e># ~/collect_performance.sh</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>PERF_DIR<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;/home/zhaoxiongzhou/performance_data&#34;</span>
</span></span><span style=display:flex><span>DATE<span style=color:#f92672>=</span><span style=color:#66d9ef>$(</span>date +%Y%m%d_%H%M%S<span style=color:#66d9ef>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 创建数据目录</span>
</span></span><span style=display:flex><span>mkdir -p <span style=color:#e6db74>&#34;</span>$PERF_DIR<span style=color:#e6db74>/</span>$DATE<span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># CPU 性能数据</span>
</span></span><span style=display:flex><span>mpstat <span style=color:#ae81ff>1</span> <span style=color:#ae81ff>60</span> &gt; <span style=color:#e6db74>&#34;</span>$PERF_DIR<span style=color:#e6db74>/</span>$DATE<span style=color:#e6db74>/cpu_stats.log&#34;</span> &amp;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 内存使用数据</span>
</span></span><span style=display:flex><span>vmstat <span style=color:#ae81ff>1</span> <span style=color:#ae81ff>60</span> &gt; <span style=color:#e6db74>&#34;</span>$PERF_DIR<span style=color:#e6db74>/</span>$DATE<span style=color:#e6db74>/memory_stats.log&#34;</span> &amp;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># IO 性能数据</span>
</span></span><span style=display:flex><span>iostat -x <span style=color:#ae81ff>1</span> <span style=color:#ae81ff>60</span> &gt; <span style=color:#e6db74>&#34;</span>$PERF_DIR<span style=color:#e6db74>/</span>$DATE<span style=color:#e6db74>/io_stats.log&#34;</span> &amp;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 网络性能数据</span>
</span></span><span style=display:flex><span>sar -n DEV <span style=color:#ae81ff>1</span> <span style=color:#ae81ff>60</span> &gt; <span style=color:#e6db74>&#34;</span>$PERF_DIR<span style=color:#e6db74>/</span>$DATE<span style=color:#e6db74>/network_stats.log&#34;</span> &amp;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 进程性能数据</span>
</span></span><span style=display:flex><span>ps aux --sort<span style=color:#f92672>=</span>-%cpu | head -n <span style=color:#ae81ff>20</span> &gt; <span style=color:#e6db74>&#34;</span>$PERF_DIR<span style=color:#e6db74>/</span>$DATE<span style=color:#e6db74>/top_processes.log&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 系统负载数据</span>
</span></span><span style=display:flex><span>uptime &gt; <span style=color:#e6db74>&#34;</span>$PERF_DIR<span style=color:#e6db74>/</span>$DATE<span style=color:#e6db74>/load_average.log&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 等待所有后台进程完成</span>
</span></span><span style=display:flex><span>wait
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 压缩数据</span>
</span></span><span style=display:flex><span>tar -czf <span style=color:#e6db74>&#34;</span>$PERF_DIR<span style=color:#e6db74>/performance_</span><span style=color:#e6db74>${</span>DATE<span style=color:#e6db74>}</span><span style=color:#e6db74>.tar.gz&#34;</span> <span style=color:#e6db74>&#34;</span>$PERF_DIR<span style=color:#e6db74>/</span>$DATE<span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>rm -rf <span style=color:#e6db74>&#34;</span>$PERF_DIR<span style=color:#e6db74>/</span>$DATE<span style=color:#e6db74>&#34;</span>
</span></span></code></pre></div><h3 id=2-性能数据分析脚本>2. 性能数据分析脚本</h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># 创建分析脚本</span>
</span></span><span style=display:flex><span>nano ~/analyze_performance.sh
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e>#!/bin/bash
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#75715e># ~/analyze_performance.sh</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>PERF_DIR<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;/home/zhaoxiongzhou/performance_data&#34;</span>
</span></span><span style=display:flex><span>REPORT_DIR<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;/home/zhaoxiongzhou/performance_reports&#34;</span>
</span></span><span style=display:flex><span>DATE<span style=color:#f92672>=</span><span style=color:#66d9ef>$(</span>date +%Y%m%d<span style=color:#66d9ef>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>mkdir -p <span style=color:#e6db74>&#34;</span>$REPORT_DIR<span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>generate_report<span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    local REPORT_FILE<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;</span>$REPORT_DIR<span style=color:#e6db74>/report_</span><span style=color:#e6db74>${</span>DATE<span style=color:#e6db74>}</span><span style=color:#e6db74>.txt&#34;</span>
</span></span><span style=display:flex><span>    echo <span style=color:#e6db74>&#34;性能分析报告 - </span><span style=color:#66d9ef>$(</span>date<span style=color:#66d9ef>)</span><span style=color:#e6db74>&#34;</span> &gt; <span style=color:#e6db74>&#34;</span>$REPORT_FILE<span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>    echo <span style=color:#e6db74>&#34;===================&#34;</span> &gt;&gt; <span style=color:#e6db74>&#34;</span>$REPORT_FILE<span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># CPU 使用分析</span>
</span></span><span style=display:flex><span>    echo -e <span style=color:#e6db74>&#34;\nCPU 使用情况:&#34;</span> &gt;&gt; <span style=color:#e6db74>&#34;</span>$REPORT_FILE<span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>    awk <span style=color:#e6db74>&#39;/all/ {total += $3; count++} END {print &#34;平均CPU使用率: &#34; total/count &#34;%&#34;}&#39;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>        <span style=color:#e6db74>&#34;</span>$PERF_DIR<span style=color:#e6db74>/latest/cpu_stats.log&#34;</span> &gt;&gt; <span style=color:#e6db74>&#34;</span>$REPORT_FILE<span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># 内存使用分析</span>
</span></span><span style=display:flex><span>    echo -e <span style=color:#e6db74>&#34;\n内存使用情况:&#34;</span> &gt;&gt; <span style=color:#e6db74>&#34;</span>$REPORT_FILE<span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>    free -h | grep <span style=color:#e6db74>&#34;Mem:&#34;</span> &gt;&gt; <span style=color:#e6db74>&#34;</span>$REPORT_FILE<span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># IO 性能分析</span>
</span></span><span style=display:flex><span>    echo -e <span style=color:#e6db74>&#34;\nIO 性能:&#34;</span> &gt;&gt; <span style=color:#e6db74>&#34;</span>$REPORT_FILE<span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>    tail -n <span style=color:#ae81ff>10</span> <span style=color:#e6db74>&#34;</span>$PERF_DIR<span style=color:#e6db74>/latest/io_stats.log&#34;</span> &gt;&gt; <span style=color:#e6db74>&#34;</span>$REPORT_FILE<span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># 网络性能分析</span>
</span></span><span style=display:flex><span>    echo -e <span style=color:#e6db74>&#34;\n网络性能:&#34;</span> &gt;&gt; <span style=color:#e6db74>&#34;</span>$REPORT_FILE<span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>    tail -n <span style=color:#ae81ff>10</span> <span style=color:#e6db74>&#34;</span>$PERF_DIR<span style=color:#e6db74>/latest/network_stats.log&#34;</span> &gt;&gt; <span style=color:#e6db74>&#34;</span>$REPORT_FILE<span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># 进程分析</span>
</span></span><span style=display:flex><span>    echo -e <span style=color:#e6db74>&#34;\n资源占用最高的进程:&#34;</span> &gt;&gt; <span style=color:#e6db74>&#34;</span>$REPORT_FILE<span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>    head -n <span style=color:#ae81ff>5</span> <span style=color:#e6db74>&#34;</span>$PERF_DIR<span style=color:#e6db74>/latest/top_processes.log&#34;</span> &gt;&gt; <span style=color:#e6db74>&#34;</span>$REPORT_FILE<span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    echo -e <span style=color:#e6db74>&#34;\n分析完成。报告保存在: </span>$REPORT_FILE<span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 生成报告</span>
</span></span><span style=display:flex><span>generate_report
</span></span></code></pre></div><h2 id=十七自动化运维脚本>十七、自动化运维脚本</h2><h3 id=1-服务健康检查与自动恢复>1. 服务健康检查与自动恢复</h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># 创建服务监控脚本</span>
</span></span><span style=display:flex><span>nano ~/service_health_check.sh
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e>#!/bin/bash
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#75715e># ~/service_health_check.sh</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>LOG_FILE<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;/var/log/service_health.log&#34;</span>
</span></span><span style=display:flex><span>ALERT_SCRIPT<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;/home/zhaoxiongzhou/send_alert.sh&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>log_message<span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    echo <span style=color:#e6db74>&#34;[</span><span style=color:#66d9ef>$(</span>date <span style=color:#e6db74>&#39;+%Y-%m-%d %H:%M:%S&#39;</span><span style=color:#66d9ef>)</span><span style=color:#e6db74>] </span>$1<span style=color:#e6db74>&#34;</span> &gt;&gt; <span style=color:#e6db74>&#34;</span>$LOG_FILE<span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>check_and_restart_service<span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    local service_name<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;</span>$1<span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>    local process_pattern<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;</span>$2<span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> ! pgrep -f <span style=color:#e6db74>&#34;</span>$process_pattern<span style=color:#e6db74>&#34;</span> &gt; /dev/null; <span style=color:#66d9ef>then</span>
</span></span><span style=display:flex><span>        log_message <span style=color:#e6db74>&#34;警告: </span>$service_name<span style=color:#e6db74> 服务未运行，尝试重启&#34;</span>
</span></span><span style=display:flex><span>        
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>case</span> <span style=color:#e6db74>&#34;</span>$service_name<span style=color:#e6db74>&#34;</span> in
</span></span><span style=display:flex><span>            <span style=color:#e6db74>&#34;nginx&#34;</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>                sudo systemctl restart nginx
</span></span><span style=display:flex><span>                ;;
</span></span><span style=display:flex><span>            <span style=color:#e6db74>&#34;llama-server&#34;</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>                cd ~/projects/llama.cpp
</span></span><span style=display:flex><span>                ./start-llama.sh
</span></span><span style=display:flex><span>                ;;
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>esac</span>
</span></span><span style=display:flex><span>        
</span></span><span style=display:flex><span>        <span style=color:#75715e># 等待服务启动</span>
</span></span><span style=display:flex><span>        sleep <span style=color:#ae81ff>10</span>
</span></span><span style=display:flex><span>        
</span></span><span style=display:flex><span>        <span style=color:#75715e># 验证服务是否成功重启</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> pgrep -f <span style=color:#e6db74>&#34;</span>$process_pattern<span style=color:#e6db74>&#34;</span> &gt; /dev/null; <span style=color:#66d9ef>then</span>
</span></span><span style=display:flex><span>            log_message <span style=color:#e6db74>&#34;</span>$service_name<span style=color:#e6db74> 服务已成功重启&#34;</span>
</span></span><span style=display:flex><span>            <span style=color:#e6db74>&#34;</span>$ALERT_SCRIPT<span style=color:#e6db74>&#34;</span> <span style=color:#e6db74>&#34;</span>$service_name<span style=color:#e6db74> 服务已自动重启&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>else</span>
</span></span><span style=display:flex><span>            log_message <span style=color:#e6db74>&#34;错误: </span>$service_name<span style=color:#e6db74> 服务重启失败&#34;</span>
</span></span><span style=display:flex><span>            <span style=color:#e6db74>&#34;</span>$ALERT_SCRIPT<span style=color:#e6db74>&#34;</span> <span style=color:#e6db74>&#34;警告: </span>$service_name<span style=color:#e6db74> 服务重启失败，需要手动干预&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>fi</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>else</span>
</span></span><span style=display:flex><span>        log_message <span style=color:#e6db74>&#34;</span>$service_name<span style=color:#e6db74> 服务运行正常&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>fi</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 检查各个服务</span>
</span></span><span style=display:flex><span>check_and_restart_service <span style=color:#e6db74>&#34;nginx&#34;</span> <span style=color:#e6db74>&#34;nginx&#34;</span>
</span></span><span style=display:flex><span>check_and_restart_service <span style=color:#e6db74>&#34;llama-server&#34;</span> <span style=color:#e6db74>&#34;llama-server&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 清理旧日志</span>
</span></span><span style=display:flex><span>find <span style=color:#e6db74>&#34;</span>$LOG_FILE<span style=color:#e6db74>&#34;</span> -mtime +30 -delete
</span></span></code></pre></div><h3 id=2-自动备份与清理>2. 自动备份与清理</h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># 创建自动维护脚本</span>
</span></span><span style=display:flex><span>nano ~/auto_maintenance.sh
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e>#!/bin/bash
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#75715e># ~/auto_maintenance.sh</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>BACKUP_DIR<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;/home/zhaoxiongzhou/backups&#34;</span>
</span></span><span style=display:flex><span>LOG_DIR<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;/var/log&#34;</span>
</span></span><span style=display:flex><span>DATE<span style=color:#f92672>=</span><span style=color:#66d9ef>$(</span>date +%Y%m%d<span style=color:#66d9ef>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 创建备份</span>
</span></span><span style=display:flex><span>create_backups<span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># 博客备份</span>
</span></span><span style=display:flex><span>    tar -czf <span style=color:#e6db74>&#34;</span>$BACKUP_DIR<span style=color:#e6db74>/blog_</span>$DATE<span style=color:#e6db74>.tar.gz&#34;</span> ~/myblog/content
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#75715e># AI 服务配置备份</span>
</span></span><span style=display:flex><span>    tar -czf <span style=color:#e6db74>&#34;</span>$BACKUP_DIR<span style=color:#e6db74>/llama_config_</span>$DATE<span style=color:#e6db74>.tar.gz&#34;</span> ~/projects/llama.cpp/start-llama.sh
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#75715e># Nginx 配置备份</span>
</span></span><span style=display:flex><span>    sudo tar -czf <span style=color:#e6db74>&#34;</span>$BACKUP_DIR<span style=color:#e6db74>/nginx_config_</span>$DATE<span style=color:#e6db74>.tar.gz&#34;</span> /etc/nginx/sites-available/
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 清理旧文件</span>
</span></span><span style=display:flex><span>cleanup_old_files<span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># 删除30天前的备份</span>
</span></span><span style=display:flex><span>    find <span style=color:#e6db74>&#34;</span>$BACKUP_DIR<span style=color:#e6db74>&#34;</span> -name <span style=color:#e6db74>&#34;*.tar.gz&#34;</span> -mtime +30 -delete
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#75715e># 清理日志</span>
</span></span><span style=display:flex><span>    sudo find <span style=color:#e6db74>&#34;</span>$LOG_DIR<span style=color:#e6db74>&#34;</span> -name <span style=color:#e6db74>&#34;*.log&#34;</span> -mtime +30 -delete
</span></span><span style=display:flex><span>    sudo find <span style=color:#e6db74>&#34;</span>$LOG_DIR<span style=color:#e6db74>&#34;</span> -name <span style=color:#e6db74>&#34;*.gz&#34;</span> -mtime +30 -delete
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#75715e># 清理系统临时文件</span>
</span></span><span style=display:flex><span>    sudo rm -rf /tmp/*
</span></span><span style=display:flex><span>    sudo rm -rf /var/tmp/*
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 主函数</span>
</span></span><span style=display:flex><span>main<span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    create_backups
</span></span><span style=display:flex><span>    cleanup_old_files
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#75715e># 压缩日志</span>
</span></span><span style=display:flex><span>    sudo logrotate -f /etc/logrotate.conf
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#75715e># 清理包缓存</span>
</span></span><span style=display:flex><span>    sudo apt clean
</span></span><span style=display:flex><span>    sudo apt autoremove -y
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 执行维护任务</span>
</span></span><span style=display:flex><span>main
</span></span></code></pre></div><h2 id=十八日志管理系统>十八、日志管理系统</h2><h3 id=1-集中式日志配置>1. 集中式日志配置</h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># 创建日志管理脚本</span>
</span></span><span style=display:flex><span>nano ~/log_management.sh
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e>#!/bin/bash
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#75715e># ~/log_management.sh</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>LOG_BASE<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;/var/log/services&#34;</span>
</span></span><span style=display:flex><span>ARCHIVE_DIR<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;/home/zhaoxiongzhou/log_archives&#34;</span>
</span></span><span style=display:flex><span>DATE<span style=color:#f92672>=</span><span style=color:#66d9ef>$(</span>date +%Y%m%d<span style=color:#66d9ef>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 创建日志目录</span>
</span></span><span style=display:flex><span>mkdir -p <span style=color:#e6db74>&#34;</span>$LOG_BASE<span style=color:#e6db74>&#34;</span>/<span style=color:#f92672>{</span>nginx,ai_service,system<span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>mkdir -p <span style=color:#e6db74>&#34;</span>$ARCHIVE_DIR<span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 配置日志轮转</span>
</span></span><span style=display:flex><span>sudo tee /etc/logrotate.d/custom_services <span style=color:#e6db74>&lt;&lt; EOF
</span></span></span><span style=display:flex><span><span style=color:#e6db74>$LOG_BASE/nginx/*.log {
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    daily
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    missingok
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    rotate 14
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    compress
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    delaycompress
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    notifempty
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    create 0640 www-data adm
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    sharedscripts
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    postrotate
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        [ -f /var/run/nginx.pid ] &amp;&amp; kill -USR1 \$(cat /var/run/nginx.pid)
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    endscript
</span></span></span><span style=display:flex><span><span style=color:#e6db74>}
</span></span></span><span style=display:flex><span><span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74>$LOG_BASE/ai_service/*.log {
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    daily
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    missingok
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    rotate 14
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    compress
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    delaycompress
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    notifempty
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    create 0640 zhaoxiongzhou adm
</span></span></span><span style=display:flex><span><span style=color:#e6db74>}
</span></span></span><span style=display:flex><span><span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74>$LOG_BASE/system/*.log {
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    daily
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    missingok
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    rotate 30
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    compress
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    delaycompress
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    notifempty
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    create 0640 root adm
</span></span></span><span style=display:flex><span><span style=color:#e6db74>}
</span></span></span><span style=display:flex><span><span style=color:#e6db74>EOF</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 日志分析函数</span>
</span></span><span style=display:flex><span>analyze_logs<span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    local log_file<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;</span>$1<span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>    local output_file<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;</span>$2<span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    echo <span style=color:#e6db74>&#34;=== 日志分析报告 </span><span style=color:#66d9ef>$(</span>date<span style=color:#66d9ef>)</span><span style=color:#e6db74> ===&#34;</span> &gt; <span style=color:#e6db74>&#34;</span>$output_file<span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#75715e># 错误统计</span>
</span></span><span style=display:flex><span>    echo -e <span style=color:#e6db74>&#34;\n错误统计:&#34;</span> &gt;&gt; <span style=color:#e6db74>&#34;</span>$output_file<span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>    grep -i <span style=color:#e6db74>&#34;error&#34;</span> <span style=color:#e6db74>&#34;</span>$log_file<span style=color:#e6db74>&#34;</span> | sort | uniq -c | sort -nr &gt;&gt; <span style=color:#e6db74>&#34;</span>$output_file<span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#75715e># 警告统计</span>
</span></span><span style=display:flex><span>    echo -e <span style=color:#e6db74>&#34;\n警告统计:&#34;</span> &gt;&gt; <span style=color:#e6db74>&#34;</span>$output_file<span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>    grep -i <span style=color:#e6db74>&#34;warning&#34;</span> <span style=color:#e6db74>&#34;</span>$log_file<span style=color:#e6db74>&#34;</span> | sort | uniq -c | sort -nr &gt;&gt; <span style=color:#e6db74>&#34;</span>$output_file<span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#75715e># 访问统计（针对 Nginx 访问日志）</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>[[</span> <span style=color:#e6db74>&#34;</span>$log_file<span style=color:#e6db74>&#34;</span> <span style=color:#f92672>==</span> *<span style=color:#e6db74>&#34;nginx/access&#34;</span>* <span style=color:#f92672>]]</span>; <span style=color:#66d9ef>then</span>
</span></span><span style=display:flex><span>        echo -e <span style=color:#e6db74>&#34;\n访问量统计:&#34;</span> &gt;&gt; <span style=color:#e6db74>&#34;</span>$output_file<span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>        awk <span style=color:#e6db74>&#39;{print $1}&#39;</span> <span style=color:#e6db74>&#34;</span>$log_file<span style=color:#e6db74>&#34;</span> | sort | uniq -c | sort -nr | head -n <span style=color:#ae81ff>10</span> &gt;&gt; <span style=color:#e6db74>&#34;</span>$output_file<span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>fi</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 日志归档函数</span>
</span></span><span style=display:flex><span>archive_logs<span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    local source_dir<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;</span>$1<span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>    local archive_name<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;logs_</span><span style=color:#e6db74>${</span>DATE<span style=color:#e6db74>}</span><span style=color:#e6db74>.tar.gz&#34;</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    find <span style=color:#e6db74>&#34;</span>$source_dir<span style=color:#e6db74>&#34;</span> -name <span style=color:#e6db74>&#34;*.log.*&#34;</span> -mtime +14 -exec tar -czf <span style=color:#e6db74>&#34;</span>$ARCHIVE_DIR<span style=color:#e6db74>/</span>$archive_name<span style=color:#e6db74>&#34;</span> <span style=color:#f92672>{}</span> +
</span></span><span style=display:flex><span>    find <span style=color:#e6db74>&#34;</span>$source_dir<span style=color:#e6db74>&#34;</span> -name <span style=color:#e6db74>&#34;*.log.*&#34;</span> -mtime +14 -delete
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><h3 id=2-日志监控告警>2. 日志监控告警</h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># 创建日志监控脚本</span>
</span></span><span style=display:flex><span>nano ~/log_monitor.sh
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e>#!/bin/bash
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#75715e># ~/log_monitor.sh</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>ALERT_THRESHOLD<span style=color:#f92672>=</span><span style=color:#ae81ff>10</span>  <span style=color:#75715e># 错误阈值</span>
</span></span><span style=display:flex><span>ALERT_SCRIPT<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;/home/zhaoxiongzhou/send_alert.sh&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 监控特定关键词</span>
</span></span><span style=display:flex><span>monitor_keywords<span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    local log_file<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;</span>$1<span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>    local keywords<span style=color:#f92672>=(</span><span style=color:#e6db74>&#34;error&#34;</span> <span style=color:#e6db74>&#34;critical&#34;</span> <span style=color:#e6db74>&#34;failed&#34;</span> <span style=color:#e6db74>&#34;timeout&#34;</span> <span style=color:#e6db74>&#34;exception&#34;</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>for</span> keyword in <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>${</span>keywords[@]<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span>; <span style=color:#66d9ef>do</span>
</span></span><span style=display:flex><span>        count<span style=color:#f92672>=</span><span style=color:#66d9ef>$(</span>grep -i <span style=color:#e6db74>&#34;</span>$keyword<span style=color:#e6db74>&#34;</span> <span style=color:#e6db74>&#34;</span>$log_file<span style=color:#e6db74>&#34;</span> | wc -l<span style=color:#66d9ef>)</span>
</span></span><span style=display:flex><span>        
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#f92672>[</span> <span style=color:#e6db74>&#34;</span>$count<span style=color:#e6db74>&#34;</span> -gt <span style=color:#e6db74>&#34;</span>$ALERT_THRESHOLD<span style=color:#e6db74>&#34;</span> <span style=color:#f92672>]</span>; <span style=color:#66d9ef>then</span>
</span></span><span style=display:flex><span>            <span style=color:#e6db74>&#34;</span>$ALERT_SCRIPT<span style=color:#e6db74>&#34;</span> <span style=color:#e6db74>&#34;警告: </span>$log_file<span style=color:#e6db74> 中发现大量 </span>$keyword<span style=color:#e6db74> (</span>$count<span style=color:#e6db74> 次)&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>fi</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>done</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 监控日志大小</span>
</span></span><span style=display:flex><span>check_log_size<span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    local log_file<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;</span>$1<span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>    local max_size<span style=color:#f92672>=</span><span style=color:#66d9ef>$((</span><span style=color:#ae81ff>100</span> <span style=color:#f92672>*</span> <span style=color:#ae81ff>1024</span> <span style=color:#f92672>*</span> <span style=color:#ae81ff>1024</span><span style=color:#66d9ef>))</span>  <span style=color:#75715e># 100MB</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    size<span style=color:#f92672>=</span><span style=color:#66d9ef>$(</span>stat -f%z <span style=color:#e6db74>&#34;</span>$log_file<span style=color:#e6db74>&#34;</span><span style=color:#66d9ef>)</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>[</span> <span style=color:#e6db74>&#34;</span>$size<span style=color:#e6db74>&#34;</span> -gt <span style=color:#e6db74>&#34;</span>$max_size<span style=color:#e6db74>&#34;</span> <span style=color:#f92672>]</span>; <span style=color:#66d9ef>then</span>
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;</span>$ALERT_SCRIPT<span style=color:#e6db74>&#34;</span> <span style=color:#e6db74>&#34;警告: </span>$log_file<span style=color:#e6db74> 大小超过 100MB&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>fi</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 主监控循环</span>
</span></span><span style=display:flex><span>main<span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>while</span> true; <span style=color:#66d9ef>do</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>for</span> log_file in <span style=color:#e6db74>&#34;</span>$LOG_BASE<span style=color:#e6db74>&#34;</span>/**/*.log; <span style=color:#66d9ef>do</span>
</span></span><span style=display:flex><span>            monitor_keywords <span style=color:#e6db74>&#34;</span>$log_file<span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>            check_log_size <span style=color:#e6db74>&#34;</span>$log_file<span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>done</span>
</span></span><span style=display:flex><span>        sleep <span style=color:#ae81ff>300</span>  <span style=color:#75715e># 每5分钟检查一次</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>done</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>main &amp;
</span></span></code></pre></div><h2 id=十九系统优化与调优>十九、系统优化与调优</h2><h3 id=1-系统参数优化>1. 系统参数优化</h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># 创建系统优化脚本</span>
</span></span><span style=display:flex><span>nano ~/system_optimize.sh
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e>#!/bin/bash
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#75715e># ~/system_optimize.sh</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 系统参数优化</span>
</span></span><span style=display:flex><span>optimize_sysctl<span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    sudo tee /etc/sysctl.d/99-custom.conf <span style=color:#e6db74>&lt;&lt; EOF
</span></span></span><span style=display:flex><span><span style=color:#e6db74># 内存管理优化
</span></span></span><span style=display:flex><span><span style=color:#e6db74>vm.swappiness = 60
</span></span></span><span style=display:flex><span><span style=color:#e6db74>vm.vfs_cache_pressure = 50
</span></span></span><span style=display:flex><span><span style=color:#e6db74>vm.dirty_background_ratio = 5
</span></span></span><span style=display:flex><span><span style=color:#e6db74>vm.dirty_ratio = 10
</span></span></span><span style=display:flex><span><span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74># 网络优化
</span></span></span><span style=display:flex><span><span style=color:#e6db74>net.core.somaxconn = 1024
</span></span></span><span style=display:flex><span><span style=color:#e6db74>net.core.netdev_max_backlog = 5000
</span></span></span><span style=display:flex><span><span style=color:#e6db74>net.ipv4.tcp_max_syn_backlog = 2048
</span></span></span><span style=display:flex><span><span style=color:#e6db74>net.ipv4.tcp_fin_timeout = 20
</span></span></span><span style=display:flex><span><span style=color:#e6db74>net.ipv4.tcp_keepalive_time = 1200
</span></span></span><span style=display:flex><span><span style=color:#e6db74>net.ipv4.tcp_keepalive_intvl = 15
</span></span></span><span style=display:flex><span><span style=color:#e6db74>net.ipv4.tcp_keepalive_probes = 5
</span></span></span><span style=display:flex><span><span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74># 文件系统优化
</span></span></span><span style=display:flex><span><span style=color:#e6db74>fs.file-max = 65535
</span></span></span><span style=display:flex><span><span style=color:#e6db74>fs.inotify.max_user_watches = 524288
</span></span></span><span style=display:flex><span><span style=color:#e6db74>EOF</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># 应用新的系统参数</span>
</span></span><span style=display:flex><span>    sudo sysctl -p /etc/sysctl.d/99-custom.conf
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># CPU 频率优化</span>
</span></span><span style=display:flex><span>optimize_cpu<span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    sudo tee /boot/config.txt <span style=color:#e6db74>&lt;&lt; EOF
</span></span></span><span style=display:flex><span><span style=color:#e6db74># CPU 设置
</span></span></span><span style=display:flex><span><span style=color:#e6db74>arm_freq=1800
</span></span></span><span style=display:flex><span><span style=color:#e6db74>over_voltage=6
</span></span></span><span style=display:flex><span><span style=color:#e6db74>gpu_freq=500
</span></span></span><span style=display:flex><span><span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74># 温度控制
</span></span></span><span style=display:flex><span><span style=color:#e6db74>temp_limit=75
</span></span></span><span style=display:flex><span><span style=color:#e6db74>EOF</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 服务优化</span>
</span></span><span style=display:flex><span>optimize_services<span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># 禁用不必要的服务</span>
</span></span><span style=display:flex><span>    UNNECESSARY_SERVICES<span style=color:#f92672>=(</span>
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;bluetooth&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;cups&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;avahi-daemon&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>for</span> service in <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>${</span>UNNECESSARY_SERVICES[@]<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span>; <span style=color:#66d9ef>do</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> systemctl is-enabled <span style=color:#e6db74>&#34;</span>$service<span style=color:#e6db74>&#34;</span> &amp;&gt;/dev/null; <span style=color:#66d9ef>then</span>
</span></span><span style=display:flex><span>            sudo systemctl disable <span style=color:#e6db74>&#34;</span>$service<span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>            sudo systemctl stop <span style=color:#e6db74>&#34;</span>$service<span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>fi</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>done</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 内存优化</span>
</span></span><span style=display:flex><span>optimize_memory<span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># 调整 ZRAM</span>
</span></span><span style=display:flex><span>    sudo tee /etc/default/zramswap <span style=color:#e6db74>&lt;&lt; EOF
</span></span></span><span style=display:flex><span><span style=color:#e6db74>ALGO=lz4
</span></span></span><span style=display:flex><span><span style=color:#e6db74>PERCENT=50
</span></span></span><span style=display:flex><span><span style=color:#e6db74>EOF</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># 重启 ZRAM 服务</span>
</span></span><span style=display:flex><span>    sudo systemctl restart zramswap
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><h3 id=2-服务优化配置>2. 服务优化配置</h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># Nginx 优化配置</span>
</span></span><span style=display:flex><span>sudo nano /etc/nginx/nginx.conf
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-toml data-lang=toml><span style=display:flex><span><span style=color:#a6e22e>user</span> <span style=color:#a6e22e>www-data</span><span style=color:#960050;background-color:#1e0010>;</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>worker_processes</span> <span style=color:#a6e22e>auto</span><span style=color:#960050;background-color:#1e0010>;</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>worker_rlimit_nofile</span> <span style=color:#ae81ff>65535</span><span style=color:#960050;background-color:#1e0010>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>events</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>worker_connections</span> <span style=color:#ae81ff>1024</span><span style=color:#960050;background-color:#1e0010>;</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>multi_accept</span> <span style=color:#a6e22e>on</span><span style=color:#960050;background-color:#1e0010>;</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>use</span> <span style=color:#a6e22e>epoll</span><span style=color:#960050;background-color:#1e0010>;</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>http</span> {
</span></span><span style=display:flex><span>    <span style=color:#75715e># 基础设置</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>sendfile</span> <span style=color:#a6e22e>on</span><span style=color:#960050;background-color:#1e0010>;</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>tcp_nopush</span> <span style=color:#a6e22e>on</span><span style=color:#960050;background-color:#1e0010>;</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>tcp_nodelay</span> <span style=color:#a6e22e>on</span><span style=color:#960050;background-color:#1e0010>;</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>keepalive_timeout</span> <span style=color:#ae81ff>65</span><span style=color:#960050;background-color:#1e0010>;</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>types_hash_max_size</span> <span style=color:#ae81ff>2048</span><span style=color:#960050;background-color:#1e0010>;</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>server_tokens</span> <span style=color:#a6e22e>off</span><span style=color:#960050;background-color:#1e0010>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># MIME 类型</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>include</span> <span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>etc</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>nginx</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>mime</span>.<span style=color:#a6e22e>types</span><span style=color:#960050;background-color:#1e0010>;</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>default_type</span> <span style=color:#a6e22e>application</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>octet-stream</span><span style=color:#960050;background-color:#1e0010>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># 日志格式</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>log_format</span> <span style=color:#a6e22e>main</span> <span style=color:#e6db74>&#39;$remote_addr - $remote_user [$time_local] &#34;$request&#34; &#39;</span>
</span></span><span style=display:flex><span>                    <span style=color:#e6db74>&#39;$status $body_bytes_sent &#34;$http_referer&#34; &#39;</span>
</span></span><span style=display:flex><span>                    <span style=color:#e6db74>&#39;&#34;$http_user_agent&#34; &#34;$http_x_forwarded_for&#34;&#39;</span><span style=color:#960050;background-color:#1e0010>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># 缓冲区设置</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>client_body_buffer_size</span> <span style=color:#ae81ff>10</span><span style=color:#a6e22e>K</span><span style=color:#960050;background-color:#1e0010>;</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>client_header_buffer_size</span> <span style=color:#ae81ff>1</span><span style=color:#a6e22e>k</span><span style=color:#960050;background-color:#1e0010>;</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>client_max_body_size</span> <span style=color:#ae81ff>8</span><span style=color:#a6e22e>m</span><span style=color:#960050;background-color:#1e0010>;</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>large_client_header_buffers</span> <span style=color:#ae81ff>2</span> <span style=color:#ae81ff>1</span><span style=color:#a6e22e>k</span><span style=color:#960050;background-color:#1e0010>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># 超时设置</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>client_body_timeout</span> <span style=color:#ae81ff>12</span><span style=color:#960050;background-color:#1e0010>;</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>client_header_timeout</span> <span style=color:#ae81ff>12</span><span style=color:#960050;background-color:#1e0010>;</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>send_timeout</span> <span style=color:#ae81ff>10</span><span style=color:#960050;background-color:#1e0010>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># 缓存设置</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>open_file_cache</span> <span style=color:#a6e22e>max</span>=<span style=color:#ae81ff>1000</span> <span style=color:#a6e22e>inactive</span>=<span style=color:#ae81ff>20</span><span style=color:#a6e22e>s</span><span style=color:#960050;background-color:#1e0010>;</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>open_file_cache_valid</span> <span style=color:#ae81ff>30</span><span style=color:#a6e22e>s</span><span style=color:#960050;background-color:#1e0010>;</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>open_file_cache_min_uses</span> <span style=color:#ae81ff>2</span><span style=color:#960050;background-color:#1e0010>;</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>open_file_cache_errors</span> <span style=color:#a6e22e>on</span><span style=color:#960050;background-color:#1e0010>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># Gzip 压缩</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>gzip</span> <span style=color:#a6e22e>on</span><span style=color:#960050;background-color:#1e0010>;</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>gzip_vary</span> <span style=color:#a6e22e>on</span><span style=color:#960050;background-color:#1e0010>;</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>gzip_proxied</span> <span style=color:#a6e22e>any</span><span style=color:#960050;background-color:#1e0010>;</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>gzip_comp_level</span> <span style=color:#ae81ff>6</span><span style=color:#960050;background-color:#1e0010>;</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>gzip_types</span> <span style=color:#a6e22e>text</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>plain</span> <span style=color:#a6e22e>text</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>css</span> <span style=color:#a6e22e>text</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>xml</span> <span style=color:#a6e22e>application</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>json</span> <span style=color:#a6e22e>application</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>javascript</span> <span style=color:#a6e22e>application</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>xml</span><span style=color:#960050;background-color:#1e0010>+</span><span style=color:#a6e22e>rss</span> <span style=color:#a6e22e>application</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>atom</span><span style=color:#960050;background-color:#1e0010>+</span><span style=color:#a6e22e>xml</span> <span style=color:#a6e22e>image</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>svg</span><span style=color:#960050;background-color:#1e0010>+</span><span style=color:#a6e22e>xml</span><span style=color:#960050;background-color:#1e0010>;</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h2 id=二十服务监控面板配置>二十、服务监控面板配置</h2><h3 id=1-grafana-监控系统配置>1. Grafana 监控系统配置</h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># 安装 Grafana</span>
</span></span><span style=display:flex><span>sudo apt-get install -y apt-transport-https
</span></span><span style=display:flex><span>sudo apt-get install -y software-properties-common wget
</span></span><span style=display:flex><span>wget -q -O - https://packages.grafana.com/gpg.key | sudo apt-key add -
</span></span><span style=display:flex><span>echo <span style=color:#e6db74>&#34;deb https://packages.grafana.com/oss/deb stable main&#34;</span> | sudo tee -a /etc/apt/sources.list.d/grafana.list
</span></span><span style=display:flex><span>sudo apt-get update
</span></span><span style=display:flex><span>sudo apt-get install -y grafana
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># 配置 Grafana</span>
</span></span><span style=display:flex><span>sudo nano /etc/grafana/grafana.ini
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-toml data-lang=toml><span style=display:flex><span>[<span style=color:#a6e22e>server</span>]
</span></span><span style=display:flex><span><span style=color:#a6e22e>http_addr</span> = <span style=color:#ae81ff>0.0</span>.<span style=color:#ae81ff>0.0</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>http_port</span> = <span style=color:#ae81ff>3000</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>[<span style=color:#a6e22e>security</span>]
</span></span><span style=display:flex><span><span style=color:#a6e22e>admin_user</span> = <span style=color:#a6e22e>admin</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>admin_password</span> = <span style=color:#a6e22e>your_secure_password</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>[<span style=color:#a6e22e>auth</span>.<span style=color:#a6e22e>anonymous</span>]
</span></span><span style=display:flex><span><span style=color:#a6e22e>enabled</span> = <span style=color:#66d9ef>false</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>[<span style=color:#a6e22e>paths</span>]
</span></span><span style=display:flex><span><span style=color:#a6e22e>data</span> = <span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>var</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>lib</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>grafana</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>logs</span> = <span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>var</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>log</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>grafana</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>plugins</span> = <span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>var</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>lib</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>grafana</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>plugins</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>[<span style=color:#a6e22e>dashboards</span>]
</span></span><span style=display:flex><span><span style=color:#a6e22e>versions_to_keep</span> = <span style=color:#ae81ff>20</span>
</span></span></code></pre></div><h3 id=2-prometheus-配置>2. Prometheus 配置</h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># 安装 Prometheus</span>
</span></span><span style=display:flex><span>sudo apt-get install -y prometheus
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 配置 Prometheus</span>
</span></span><span style=display:flex><span>sudo nano /etc/prometheus/prometheus.yml
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yml data-lang=yml><span style=display:flex><span><span style=color:#f92672>global</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>scrape_interval</span>: <span style=color:#ae81ff>15s</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>evaluation_interval</span>: <span style=color:#ae81ff>15s</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>scrape_configs</span>:
</span></span><span style=display:flex><span>  - <span style=color:#f92672>job_name</span>: <span style=color:#e6db74>&#39;node&#39;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>static_configs</span>:
</span></span><span style=display:flex><span>      - <span style=color:#f92672>targets</span>: [<span style=color:#e6db74>&#39;localhost:9100&#39;</span>]
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>  - <span style=color:#f92672>job_name</span>: <span style=color:#e6db74>&#39;nginx&#39;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>static_configs</span>:
</span></span><span style=display:flex><span>      - <span style=color:#f92672>targets</span>: [<span style=color:#e6db74>&#39;localhost:9113&#39;</span>]
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>  - <span style=color:#f92672>job_name</span>: <span style=color:#e6db74>&#39;system&#39;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>static_configs</span>:
</span></span><span style=display:flex><span>      - <span style=color:#f92672>targets</span>: [<span style=color:#e6db74>&#39;localhost:9090&#39;</span>]
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  - <span style=color:#f92672>job_name</span>: <span style=color:#e6db74>&#39;process&#39;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>static_configs</span>:
</span></span><span style=display:flex><span>      - <span style=color:#f92672>targets</span>: [<span style=color:#e6db74>&#39;localhost:9256&#39;</span>]
</span></span></code></pre></div><h3 id=3-node-exporter-配置>3. Node Exporter 配置</h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># 安装 Node Exporter</span>
</span></span><span style=display:flex><span>sudo apt-get install -y prometheus-node-exporter
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 创建自定义指标收集脚本</span>
</span></span><span style=display:flex><span>nano ~/custom_metrics.sh
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e>#!/bin/bash
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#75715e># ~/custom_metrics.sh</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 创建指标文件</span>
</span></span><span style=display:flex><span>METRICS_FILE<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;/var/lib/node_exporter/custom_metrics.prom&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>while</span> true; <span style=color:#66d9ef>do</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># CPU 温度</span>
</span></span><span style=display:flex><span>    CPU_TEMP<span style=color:#f92672>=</span><span style=color:#66d9ef>$(</span>vcgencmd measure_temp | sed <span style=color:#e6db74>&#39;s/temp=//&#39;</span> | sed <span style=color:#e6db74>&#39;s/&#39;</span><span style=color:#e6db74>&#34;&#39;&#34;</span><span style=color:#e6db74>&#39;C//&#39;</span><span style=color:#66d9ef>)</span>
</span></span><span style=display:flex><span>    echo <span style=color:#e6db74>&#34;raspberry_pi_cpu_temperature </span>$CPU_TEMP<span style=color:#e6db74>&#34;</span> &gt; <span style=color:#e6db74>&#34;</span>$METRICS_FILE<span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># AI 服务状态</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> pgrep -f llama-server &gt; /dev/null; <span style=color:#66d9ef>then</span>
</span></span><span style=display:flex><span>        echo <span style=color:#e6db74>&#34;ai_service_status 1&#34;</span> &gt;&gt; <span style=color:#e6db74>&#34;</span>$METRICS_FILE<span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>else</span>
</span></span><span style=display:flex><span>        echo <span style=color:#e6db74>&#34;ai_service_status 0&#34;</span> &gt;&gt; <span style=color:#e6db74>&#34;</span>$METRICS_FILE<span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>fi</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># 博客服务状态</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> systemctl is-active nginx &gt; /dev/null; <span style=color:#66d9ef>then</span>
</span></span><span style=display:flex><span>        echo <span style=color:#e6db74>&#34;blog_service_status 1&#34;</span> &gt;&gt; <span style=color:#e6db74>&#34;</span>$METRICS_FILE<span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>else</span>
</span></span><span style=display:flex><span>        echo <span style=color:#e6db74>&#34;blog_service_status 0&#34;</span> &gt;&gt; <span style=color:#e6db74>&#34;</span>$METRICS_FILE<span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>fi</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># 内存使用</span>
</span></span><span style=display:flex><span>    FREE_MEM<span style=color:#f92672>=</span><span style=color:#66d9ef>$(</span>free | grep Mem | awk <span style=color:#e6db74>&#39;{print $4}&#39;</span><span style=color:#66d9ef>)</span>
</span></span><span style=display:flex><span>    echo <span style=color:#e6db74>&#34;system_free_memory_bytes </span>$FREE_MEM<span style=color:#e6db74>&#34;</span> &gt;&gt; <span style=color:#e6db74>&#34;</span>$METRICS_FILE<span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    sleep <span style=color:#ae81ff>15</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>done</span>
</span></span></code></pre></div><h2 id=二十一自动化部署与更新>二十一、自动化部署与更新</h2><h3 id=1-自动部署配置脚本>1. 自动部署配置脚本</h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># 创建自动部署脚本</span>
</span></span><span style=display:flex><span>nano ~/auto_deploy.sh
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e>#!/bin/bash
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#75715e># ~/auto_deploy.sh</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 配置</span>
</span></span><span style=display:flex><span>BLOG_DIR<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;/home/zhaoxiongzhou/myblog&#34;</span>
</span></span><span style=display:flex><span>LLAMA_DIR<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;/home/zhaoxiongzhou/projects/llama.cpp&#34;</span>
</span></span><span style=display:flex><span>BACKUP_DIR<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;/home/zhaoxiongzhou/backups&#34;</span>
</span></span><span style=display:flex><span>LOG_FILE<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;/var/log/auto_deploy.log&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 日志函数</span>
</span></span><span style=display:flex><span>log<span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    echo <span style=color:#e6db74>&#34;[</span><span style=color:#66d9ef>$(</span>date <span style=color:#e6db74>&#39;+%Y-%m-%d %H:%M:%S&#39;</span><span style=color:#66d9ef>)</span><span style=color:#e6db74>] </span>$1<span style=color:#e6db74>&#34;</span> &gt;&gt; <span style=color:#e6db74>&#34;</span>$LOG_FILE<span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 备份当前版本</span>
</span></span><span style=display:flex><span>backup_current<span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    log <span style=color:#e6db74>&#34;开始备份当前版本&#34;</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#75715e># 博客备份</span>
</span></span><span style=display:flex><span>    tar -czf <span style=color:#e6db74>&#34;</span>$BACKUP_DIR<span style=color:#e6db74>/blog_</span><span style=color:#66d9ef>$(</span>date +%Y%m%d_%H%M%S<span style=color:#66d9ef>)</span><span style=color:#e6db74>.tar.gz&#34;</span> <span style=color:#e6db74>&#34;</span>$BLOG_DIR<span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#75715e># AI 服务备份</span>
</span></span><span style=display:flex><span>    tar -czf <span style=color:#e6db74>&#34;</span>$BACKUP_DIR<span style=color:#e6db74>/llama_</span><span style=color:#66d9ef>$(</span>date +%Y%m%d_%H%M%S<span style=color:#66d9ef>)</span><span style=color:#e6db74>.tar.gz&#34;</span> <span style=color:#e6db74>&#34;</span>$LLAMA_DIR<span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    log <span style=color:#e6db74>&#34;备份完成&#34;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 更新博客</span>
</span></span><span style=display:flex><span>update_blog<span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    log <span style=color:#e6db74>&#34;开始更新博客&#34;</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    cd <span style=color:#e6db74>&#34;</span>$BLOG_DIR<span style=color:#e6db74>&#34;</span> <span style=color:#f92672>||</span> exit <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#75715e># 拉取最新代码</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> git pull origin master; <span style=color:#66d9ef>then</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e># 更新主题</span>
</span></span><span style=display:flex><span>        git submodule update --remote themes/ananke
</span></span><span style=display:flex><span>        
</span></span><span style=display:flex><span>        <span style=color:#75715e># 构建站点</span>
</span></span><span style=display:flex><span>        hugo --minify
</span></span><span style=display:flex><span>        
</span></span><span style=display:flex><span>        <span style=color:#75715e># 更新权限</span>
</span></span><span style=display:flex><span>        sudo chown -R www-data:www-data public/
</span></span><span style=display:flex><span>        
</span></span><span style=display:flex><span>        <span style=color:#75715e># 重启 Nginx</span>
</span></span><span style=display:flex><span>        sudo systemctl restart nginx
</span></span><span style=display:flex><span>        
</span></span><span style=display:flex><span>        log <span style=color:#e6db74>&#34;博客更新成功&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>else</span>
</span></span><span style=display:flex><span>        log <span style=color:#e6db74>&#34;错误: 博客更新失败&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>fi</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 更新 AI 服务</span>
</span></span><span style=display:flex><span>update_ai_service<span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    log <span style=color:#e6db74>&#34;开始更新 AI 服务&#34;</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    cd <span style=color:#e6db74>&#34;</span>$LLAMA_DIR<span style=color:#e6db74>&#34;</span> <span style=color:#f92672>||</span> exit <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#75715e># 停止当前服务</span>
</span></span><span style=display:flex><span>    pkill llama-server
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#75715e># 拉取最新代码</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> git pull origin master; <span style=color:#66d9ef>then</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e># 重新编译</span>
</span></span><span style=display:flex><span>        make clean
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> LLAMA_METAL<span style=color:#f92672>=</span><span style=color:#ae81ff>1</span> make -j4; <span style=color:#66d9ef>then</span>
</span></span><span style=display:flex><span>            <span style=color:#75715e># 启动服务</span>
</span></span><span style=display:flex><span>            ./start-llama.sh
</span></span><span style=display:flex><span>            
</span></span><span style=display:flex><span>            <span style=color:#75715e># 验证服务</span>
</span></span><span style=display:flex><span>            sleep <span style=color:#ae81ff>5</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> pgrep -f llama-server &gt; /dev/null; <span style=color:#66d9ef>then</span>
</span></span><span style=display:flex><span>                log <span style=color:#e6db74>&#34;AI 服务更新成功&#34;</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>else</span>
</span></span><span style=display:flex><span>                log <span style=color:#e6db74>&#34;错误: AI 服务启动失败&#34;</span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>return</span> <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>fi</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>else</span>
</span></span><span style=display:flex><span>            log <span style=color:#e6db74>&#34;错误: AI 服务编译失败&#34;</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>fi</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>else</span>
</span></span><span style=display:flex><span>        log <span style=color:#e6db74>&#34;错误: AI 服务代码更新失败&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>fi</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 主函数</span>
</span></span><span style=display:flex><span>main<span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    log <span style=color:#e6db74>&#34;开始自动部署流程&#34;</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#75715e># 创建备份</span>
</span></span><span style=display:flex><span>    backup_current
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#75715e># 更新服务</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> update_blog <span style=color:#f92672>&amp;&amp;</span> update_ai_service; <span style=color:#66d9ef>then</span>
</span></span><span style=display:flex><span>        log <span style=color:#e6db74>&#34;部署完成&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>else</span>
</span></span><span style=display:flex><span>        log <span style=color:#e6db74>&#34;部署失败&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>fi</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 执行部署</span>
</span></span><span style=display:flex><span>main
</span></span></code></pre></div><h3 id=2-自动更新检查脚本>2. 自动更新检查脚本</h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># 创建更新检查脚本</span>
</span></span><span style=display:flex><span>nano ~/check_updates.sh
</span></span></code></pre></div><h2 id=二十一自动更新检查与通知系统>二十一、自动更新检查与通知系统</h2><h3 id=1-更新检查脚本>1. 更新检查脚本</h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e>#!/bin/bash
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#75715e># ~/check_updates.sh</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 配置</span>
</span></span><span style=display:flex><span>NOTIFY_SCRIPT<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;/home/zhaoxiongzhou/send_notification.sh&#34;</span>
</span></span><span style=display:flex><span>LOG_FILE<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;/var/log/update_check.log&#34;</span>
</span></span><span style=display:flex><span>GITHUB_API<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;https://api.github.com&#34;</span>
</span></span><span style=display:flex><span>LLAMA_REPO<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;ggerganov/llama.cpp&#34;</span>
</span></span><span style=display:flex><span>HUGO_REPO<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;gohugoio/hugo&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 日志函数</span>
</span></span><span style=display:flex><span>log<span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    echo <span style=color:#e6db74>&#34;[</span><span style=color:#66d9ef>$(</span>date <span style=color:#e6db74>&#39;+%Y-%m-%d %H:%M:%S&#39;</span><span style=color:#66d9ef>)</span><span style=color:#e6db74>] </span>$1<span style=color:#e6db74>&#34;</span> | tee -a <span style=color:#e6db74>&#34;</span>$LOG_FILE<span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 检查 GitHub 仓库更新</span>
</span></span><span style=display:flex><span>check_github_updates<span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    local repo<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;</span>$1<span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>    local current_version<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;</span>$2<span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#75715e># 获取最新版本</span>
</span></span><span style=display:flex><span>    latest_version<span style=color:#f92672>=</span><span style=color:#66d9ef>$(</span>curl -s <span style=color:#e6db74>&#34;</span>$GITHUB_API<span style=color:#e6db74>/repos/</span>$repo<span style=color:#e6db74>/releases/latest&#34;</span> | grep -Po <span style=color:#e6db74>&#39;&#34;tag_name&#34;: &#34;\K.*?(?=&#34;)&#39;</span><span style=color:#66d9ef>)</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>[</span> <span style=color:#e6db74>&#34;</span>$latest_version<span style=color:#e6db74>&#34;</span> !<span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;</span>$current_version<span style=color:#e6db74>&#34;</span> <span style=color:#f92672>]</span>; <span style=color:#66d9ef>then</span>
</span></span><span style=display:flex><span>        log <span style=color:#e6db74>&#34;发现新版本: </span>$repo<span style=color:#e6db74> (</span>$current_version<span style=color:#e6db74> -&gt; </span>$latest_version<span style=color:#e6db74>)&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>else</span>
</span></span><span style=display:flex><span>        log <span style=color:#e6db74>&#34;当前版本已是最新: </span>$repo<span style=color:#e6db74> (</span>$current_version<span style=color:#e6db74>)&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>fi</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 检查系统更新</span>
</span></span><span style=display:flex><span>check_system_updates<span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    sudo apt update &gt; /dev/null 2&gt;&amp;<span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>    updates<span style=color:#f92672>=</span><span style=color:#66d9ef>$(</span>sudo apt list --upgradable 2&gt;/dev/null | grep -c <span style=color:#e6db74>&#34;upgradable&#34;</span><span style=color:#66d9ef>)</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>[</span> <span style=color:#e6db74>&#34;</span>$updates<span style=color:#e6db74>&#34;</span> -gt <span style=color:#ae81ff>0</span> <span style=color:#f92672>]</span>; <span style=color:#66d9ef>then</span>
</span></span><span style=display:flex><span>        log <span style=color:#e6db74>&#34;发现 </span>$updates<span style=color:#e6db74> 个系统更新&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>else</span>
</span></span><span style=display:flex><span>        log <span style=color:#e6db74>&#34;系统已是最新&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>fi</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 检查服务状态</span>
</span></span><span style=display:flex><span>check_services<span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    local services<span style=color:#f92672>=(</span><span style=color:#e6db74>&#34;nginx&#34;</span> <span style=color:#e6db74>&#34;llama-server&#34;</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>    local status<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>for</span> service in <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>${</span>services[@]<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span>; <span style=color:#66d9ef>do</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#f92672>[</span> <span style=color:#e6db74>&#34;</span>$service<span style=color:#e6db74>&#34;</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;nginx&#34;</span> <span style=color:#f92672>]</span>; <span style=color:#66d9ef>then</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> ! systemctl is-active --quiet nginx; <span style=color:#66d9ef>then</span>
</span></span><span style=display:flex><span>                log <span style=color:#e6db74>&#34;警告: Nginx 服务未运行&#34;</span>
</span></span><span style=display:flex><span>                status<span style=color:#f92672>=</span><span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>fi</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>elif</span> <span style=color:#f92672>[</span> <span style=color:#e6db74>&#34;</span>$service<span style=color:#e6db74>&#34;</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;llama-server&#34;</span> <span style=color:#f92672>]</span>; <span style=color:#66d9ef>then</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> ! pgrep -f llama-server &gt; /dev/null; <span style=color:#66d9ef>then</span>
</span></span><span style=display:flex><span>                log <span style=color:#e6db74>&#34;警告: AI 服务未运行&#34;</span>
</span></span><span style=display:flex><span>                status<span style=color:#f92672>=</span><span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>fi</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>fi</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>done</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> $status
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 发送通知</span>
</span></span><span style=display:flex><span>send_notification<span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    local message<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;</span>$1<span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>    local priority<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;</span>$2<span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>[</span> -x <span style=color:#e6db74>&#34;</span>$NOTIFY_SCRIPT<span style=color:#e6db74>&#34;</span> <span style=color:#f92672>]</span>; <span style=color:#66d9ef>then</span>
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;</span>$NOTIFY_SCRIPT<span style=color:#e6db74>&#34;</span> <span style=color:#e6db74>&#34;</span>$message<span style=color:#e6db74>&#34;</span> <span style=color:#e6db74>&#34;</span>$priority<span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>else</span>
</span></span><span style=display:flex><span>        log <span style=color:#e6db74>&#34;通知脚本不存在或不可执行&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>fi</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 主函数</span>
</span></span><span style=display:flex><span>main<span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    log <span style=color:#e6db74>&#34;开始检查更新&#34;</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#75715e># 获取当前版本</span>
</span></span><span style=display:flex><span>    current_llama_version<span style=color:#f92672>=</span><span style=color:#66d9ef>$(</span>cd ~/projects/llama.cpp <span style=color:#f92672>&amp;&amp;</span> git describe --tags<span style=color:#66d9ef>)</span>
</span></span><span style=display:flex><span>    current_hugo_version<span style=color:#f92672>=</span><span style=color:#66d9ef>$(</span>hugo version | grep -Po <span style=color:#e6db74>&#34;v\d+\.\d+\.\d+&#34;</span><span style=color:#66d9ef>)</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#75715e># 检查更新</span>
</span></span><span style=display:flex><span>    updates_found<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> check_github_updates <span style=color:#e6db74>&#34;</span>$LLAMA_REPO<span style=color:#e6db74>&#34;</span> <span style=color:#e6db74>&#34;</span>$current_llama_version<span style=color:#e6db74>&#34;</span>; <span style=color:#66d9ef>then</span>
</span></span><span style=display:flex><span>        send_notification <span style=color:#e6db74>&#34;llama.cpp 有新版本可用&#34;</span> <span style=color:#e6db74>&#34;normal&#34;</span>
</span></span><span style=display:flex><span>        updates_found<span style=color:#f92672>=</span><span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>fi</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> check_github_updates <span style=color:#e6db74>&#34;</span>$HUGO_REPO<span style=color:#e6db74>&#34;</span> <span style=color:#e6db74>&#34;</span>$current_hugo_version<span style=color:#e6db74>&#34;</span>; <span style=color:#66d9ef>then</span>
</span></span><span style=display:flex><span>        send_notification <span style=color:#e6db74>&#34;Hugo 有新版本可用&#34;</span> <span style=color:#e6db74>&#34;normal&#34;</span>
</span></span><span style=display:flex><span>        updates_found<span style=color:#f92672>=</span><span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>fi</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> check_system_updates; <span style=color:#66d9ef>then</span>
</span></span><span style=display:flex><span>        send_notification <span style=color:#e6db74>&#34;系统有更新可用&#34;</span> <span style=color:#e6db74>&#34;normal&#34;</span>
</span></span><span style=display:flex><span>        updates_found<span style=color:#f92672>=</span><span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>fi</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> ! check_services; <span style=color:#66d9ef>then</span>
</span></span><span style=display:flex><span>        send_notification <span style=color:#e6db74>&#34;服务状态异常，请检查&#34;</span> <span style=color:#e6db74>&#34;high&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>fi</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>[</span> <span style=color:#e6db74>&#34;</span>$updates_found<span style=color:#e6db74>&#34;</span> -eq <span style=color:#ae81ff>0</span> <span style=color:#f92672>]</span>; <span style=color:#66d9ef>then</span>
</span></span><span style=display:flex><span>        log <span style=color:#e6db74>&#34;所有组件均为最新版本&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>fi</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 执行检查</span>
</span></span><span style=display:flex><span>main
</span></span></code></pre></div><h2 id=二十二通知系统配置>二十二、通知系统配置</h2><h3 id=1-通知发送脚本>1. 通知发送脚本</h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># 创建通知发送脚本</span>
</span></span><span style=display:flex><span>nano ~/send_notification.sh
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e>#!/bin/bash
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#75715e># ~/send_notification.sh</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 配置</span>
</span></span><span style=display:flex><span>TELEGRAM_BOT_TOKEN<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;your_bot_token&#34;</span>
</span></span><span style=display:flex><span>TELEGRAM_CHAT_ID<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;your_chat_id&#34;</span>
</span></span><span style=display:flex><span>EMAIL_ADDRESS<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;your_email@domain.com&#34;</span>
</span></span><span style=display:flex><span>DISCORD_WEBHOOK_URL<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;your_discord_webhook_url&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 日志配置</span>
</span></span><span style=display:flex><span>LOG_FILE<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;/var/log/notifications.log&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 日志函数</span>
</span></span><span style=display:flex><span>log<span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    echo <span style=color:#e6db74>&#34;[</span><span style=color:#66d9ef>$(</span>date <span style=color:#e6db74>&#39;+%Y-%m-%d %H:%M:%S&#39;</span><span style=color:#66d9ef>)</span><span style=color:#e6db74>] </span>$1<span style=color:#e6db74>&#34;</span> &gt;&gt; <span style=color:#e6db74>&#34;</span>$LOG_FILE<span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Telegram 通知</span>
</span></span><span style=display:flex><span>send_telegram<span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    local message<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;</span>$1<span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>    local priority<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;</span>$2<span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#75715e># 根据优先级添加表情符号</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>case</span> <span style=color:#e6db74>&#34;</span>$priority<span style=color:#e6db74>&#34;</span> in
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;high&#34;</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>            message<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;🚨 紧急: </span>$message<span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>            ;;
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;normal&#34;</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>            message<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;ℹ️ 通知: </span>$message<span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>            ;;
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;low&#34;</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>            message<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;📝 信息: </span>$message<span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>            ;;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>esac</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#75715e># 发送消息</span>
</span></span><span style=display:flex><span>    curl -s -X POST <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>        <span style=color:#e6db74>&#34;https://api.telegram.org/bot</span>$TELEGRAM_BOT_TOKEN<span style=color:#e6db74>/sendMessage&#34;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>        -d <span style=color:#e6db74>&#34;chat_id=</span>$TELEGRAM_CHAT_ID<span style=color:#e6db74>&#34;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>        -d <span style=color:#e6db74>&#34;text=</span>$message<span style=color:#e6db74>&#34;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>        -d <span style=color:#e6db74>&#34;parse_mode=HTML&#34;</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    log <span style=color:#e6db74>&#34;Telegram 通知已发送: </span>$message<span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 邮件通知</span>
</span></span><span style=display:flex><span>send_email<span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    local message<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;</span>$1<span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>    local priority<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;</span>$2<span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>    local subject
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>case</span> <span style=color:#e6db74>&#34;</span>$priority<span style=color:#e6db74>&#34;</span> in
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;high&#34;</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>            subject<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;[紧急] 树莓派服务警告&#34;</span>
</span></span><span style=display:flex><span>            ;;
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;normal&#34;</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>            subject<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;[通知] 树莓派服务更新&#34;</span>
</span></span><span style=display:flex><span>            ;;
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;low&#34;</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>            subject<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;[信息] 树莓派服务状态&#34;</span>
</span></span><span style=display:flex><span>            ;;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>esac</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    echo <span style=color:#e6db74>&#34;</span>$message<span style=color:#e6db74>&#34;</span> | mail -s <span style=color:#e6db74>&#34;</span>$subject<span style=color:#e6db74>&#34;</span> <span style=color:#e6db74>&#34;</span>$EMAIL_ADDRESS<span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>    log <span style=color:#e6db74>&#34;邮件通知已发送: </span>$subject<span style=color:#e6db74> - </span>$message<span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Discord 通知</span>
</span></span><span style=display:flex><span>send_discord<span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    local message<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;</span>$1<span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>    local priority<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;</span>$2<span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>    local color
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>case</span> <span style=color:#e6db74>&#34;</span>$priority<span style=color:#e6db74>&#34;</span> in
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;high&#34;</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>            color<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;16711680&#34;</span>  <span style=color:#75715e># 红色</span>
</span></span><span style=display:flex><span>            ;;
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;normal&#34;</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>            color<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;65280&#34;</span>     <span style=color:#75715e># 绿色</span>
</span></span><span style=display:flex><span>            ;;
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;low&#34;</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>            color<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;255&#34;</span>       <span style=color:#75715e># 蓝色</span>
</span></span><span style=display:flex><span>            ;;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>esac</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    curl -H <span style=color:#e6db74>&#34;Content-Type: application/json&#34;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>        -X POST <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>        -d <span style=color:#e6db74>&#34;{\&#34;embeds\&#34;: [{\&#34;description\&#34;: \&#34;</span>$message<span style=color:#e6db74>\&#34;, \&#34;color\&#34;: </span>$color<span style=color:#e6db74>}]}&#34;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>        <span style=color:#e6db74>&#34;</span>$DISCORD_WEBHOOK_URL<span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    log <span style=color:#e6db74>&#34;Discord 通知已发送: </span>$message<span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 主函数</span>
</span></span><span style=display:flex><span>main<span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    local message<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;</span>$1<span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>    local priority<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;</span><span style=color:#e6db74>${</span>2<span style=color:#66d9ef>:-</span>normal<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span>  <span style=color:#75715e># 默认优先级为 normal</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#75715e># 检查必要参数</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>[</span> -z <span style=color:#e6db74>&#34;</span>$message<span style=color:#e6db74>&#34;</span> <span style=color:#f92672>]</span>; <span style=color:#66d9ef>then</span>
</span></span><span style=display:flex><span>        log <span style=color:#e6db74>&#34;错误: 消息内容不能为空&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>fi</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#75715e># 添加系统信息</span>
</span></span><span style=display:flex><span>    local hostname<span style=color:#f92672>=</span><span style=color:#66d9ef>$(</span>hostname<span style=color:#66d9ef>)</span>
</span></span><span style=display:flex><span>    local timestamp<span style=color:#f92672>=</span><span style=color:#66d9ef>$(</span>date <span style=color:#e6db74>&#39;+%Y-%m-%d %H:%M:%S&#39;</span><span style=color:#66d9ef>)</span>
</span></span><span style=display:flex><span>    message<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;[</span>$hostname<span style=color:#e6db74>] [</span>$timestamp<span style=color:#e6db74>] </span>$message<span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#75715e># 发送所有通知</span>
</span></span><span style=display:flex><span>    send_telegram <span style=color:#e6db74>&#34;</span>$message<span style=color:#e6db74>&#34;</span> <span style=color:#e6db74>&#34;</span>$priority<span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>    send_email <span style=color:#e6db74>&#34;</span>$message<span style=color:#e6db74>&#34;</span> <span style=color:#e6db74>&#34;</span>$priority<span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>    send_discord <span style=color:#e6db74>&#34;</span>$message<span style=color:#e6db74>&#34;</span> <span style=color:#e6db74>&#34;</span>$priority<span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    log <span style=color:#e6db74>&#34;所有通知渠道处理完成&#34;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 执行通知发送</span>
</span></span><span style=display:flex><span>main <span style=color:#e6db74>&#34;</span>$@<span style=color:#e6db74>&#34;</span>
</span></span></code></pre></div><h2 id=二十三定时任务配置>二十三、定时任务配置</h2><h3 id=1-crontab-配置>1. Crontab 配置</h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># 编辑 crontab</span>
</span></span><span style=display:flex><span>crontab -e
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># 系统维护任务</span>
</span></span><span style=display:flex><span><span style=color:#75715e># 每天凌晨 2 点执行系统更新检查</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>0</span> <span style=color:#ae81ff>2</span> * * * ~/check_updates.sh &gt; /dev/null 2&gt;&amp;<span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 每 6 小时执行一次服务健康检查</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>0</span> */6 * * * ~/service_health_check.sh &gt; /dev/null 2&gt;&amp;<span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 每周日凌晨 3 点执行系统优化</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>0</span> <span style=color:#ae81ff>3</span> * * <span style=color:#ae81ff>0</span> ~/system_optimize.sh &gt; /dev/null 2&gt;&amp;<span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 每天凌晨 4 点执行日志管理</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>0</span> <span style=color:#ae81ff>4</span> * * * ~/log_management.sh &gt; /dev/null 2&gt;&amp;<span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 每小时执行性能数据收集</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>0</span> * * * * ~/collect_performance.sh &gt; /dev/null 2&gt;&amp;<span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 每 5 分钟检查一次关键服务状态</span>
</span></span><span style=display:flex><span>*/5 * * * * ~/monitor.sh &gt; /dev/null 2&gt;&amp;<span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 每天晚上 11 点执行备份</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>0</span> <span style=color:#ae81ff>23</span> * * * ~/auto_backup.sh &gt; /dev/null 2&gt;&amp;<span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 每月 1 号执行完整系统检查</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>0</span> <span style=color:#ae81ff>1</span> <span style=color:#ae81ff>1</span> * * ~/full_system_check.sh &gt; /dev/null 2&gt;&amp;<span style=color:#ae81ff>1</span>
</span></span></code></pre></div><h3 id=2-完整系统检查脚本>2. 完整系统检查脚本</h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># 创建完整系统检查脚本</span>
</span></span><span style=display:flex><span>nano ~/full_system_check.sh
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e>#!/bin/bash
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#75715e># ~/full_system_check.sh</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>LOG_FILE<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;/var/log/system_check.log&#34;</span>
</span></span><span style=display:flex><span>REPORT_FILE<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;/home/zhaoxiongzhou/reports/monthly_report_</span><span style=color:#66d9ef>$(</span>date +%Y%m<span style=color:#66d9ef>)</span><span style=color:#e6db74>.txt&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 确保目录存在</span>
</span></span><span style=display:flex><span>mkdir -p <span style=color:#e6db74>&#34;</span><span style=color:#66d9ef>$(</span>dirname <span style=color:#e6db74>&#34;</span>$REPORT_FILE<span style=color:#e6db74>&#34;</span><span style=color:#66d9ef>)</span><span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 日志函数</span>
</span></span><span style=display:flex><span>log<span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    echo <span style=color:#e6db74>&#34;[</span><span style=color:#66d9ef>$(</span>date <span style=color:#e6db74>&#39;+%Y-%m-%d %H:%M:%S&#39;</span><span style=color:#66d9ef>)</span><span style=color:#e6db74>] </span>$1<span style=color:#e6db74>&#34;</span> | tee -a <span style=color:#e6db74>&#34;</span>$LOG_FILE<span style=color:#e6db74>&#34;</span> <span style=color:#e6db74>&#34;</span>$REPORT_FILE<span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 系统信息检查</span>
</span></span><span style=display:flex><span>check_system_info<span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    log <span style=color:#e6db74>&#34;=== 系统信息 ===&#34;</span>
</span></span><span style=display:flex><span>    log <span style=color:#e6db74>&#34;系统版本: </span><span style=color:#66d9ef>$(</span>cat /etc/os-release | grep PRETTY_NAME<span style=color:#66d9ef>)</span><span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>    log <span style=color:#e6db74>&#34;内核版本: </span><span style=color:#66d9ef>$(</span>uname -r<span style=color:#66d9ef>)</span><span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>    log <span style=color:#e6db74>&#34;运行时间: </span><span style=color:#66d9ef>$(</span>uptime -p<span style=color:#66d9ef>)</span><span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>    log <span style=color:#e6db74>&#34;最后启动: </span><span style=color:#66d9ef>$(</span>who -b | awk <span style=color:#e6db74>&#39;{print $3,$4}&#39;</span><span style=color:#66d9ef>)</span><span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 资源使用检查</span>
</span></span><span style=display:flex><span>check_resources<span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    log <span style=color:#e6db74>&#34;=== 资源使用情况 ===&#34;</span>
</span></span><span style=display:flex><span>    log <span style=color:#e6db74>&#34;CPU 使用率: </span><span style=color:#66d9ef>$(</span>top -bn1 | grep <span style=color:#e6db74>&#34;Cpu(s)&#34;</span> | awk <span style=color:#e6db74>&#39;{print $2}&#39;</span><span style=color:#66d9ef>)</span><span style=color:#e6db74>%&#34;</span>
</span></span><span style=display:flex><span>    log <span style=color:#e6db74>&#34;内存使用情况:&#34;</span>
</span></span><span style=display:flex><span>    free -h | tee -a <span style=color:#e6db74>&#34;</span>$REPORT_FILE<span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>    log <span style=color:#e6db74>&#34;磁盘使用情况:&#34;</span>
</span></span><span style=display:flex><span>    df -h | tee -a <span style=color:#e6db74>&#34;</span>$REPORT_FILE<span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 服务状态检查</span>
</span></span><span style=display:flex><span>check_services<span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    log <span style=color:#e6db74>&#34;=== 服务状态 ===&#34;</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#75715e># 检查 Nginx</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> systemctl is-active --quiet nginx; <span style=color:#66d9ef>then</span>
</span></span><span style=display:flex><span>        log <span style=color:#e6db74>&#34;Nginx: 运行正常&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>else</span>
</span></span><span style=display:flex><span>        log <span style=color:#e6db74>&#34;Nginx: 未运行&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>fi</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#75715e># 检查 AI 服务</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> pgrep -f llama-server &gt; /dev/null; <span style=color:#66d9ef>then</span>
</span></span><span style=display:flex><span>        log <span style=color:#e6db74>&#34;AI 服务: 运行正常&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>else</span>
</span></span><span style=display:flex><span>        log <span style=color:#e6db74>&#34;AI 服务: 未运行&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>fi</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 安全检查</span>
</span></span><span style=display:flex><span>check_security<span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    log <span style=color:#e6db74>&#34;=== 安全检查 ===&#34;</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#75715e># 检查失败的登录尝试</span>
</span></span><span style=display:flex><span>    log <span style=color:#e6db74>&#34;失败的登录尝试:&#34;</span>
</span></span><span style=display:flex><span>    grep <span style=color:#e6db74>&#34;Failed password&#34;</span> /var/log/auth.log | tail -n <span style=color:#ae81ff>5</span> | tee -a <span style=color:#e6db74>&#34;</span>$REPORT_FILE<span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#75715e># 检查开放的端口</span>
</span></span><span style=display:flex><span>    log <span style=color:#e6db74>&#34;开放的端口:&#34;</span>
</span></span><span style=display:flex><span>    netstat -tuln | grep LISTEN | tee -a <span style=color:#e6db74>&#34;</span>$REPORT_FILE<span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 性能分析</span>
</span></span><span style=display:flex><span>analyze_performance<span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    log <span style=color:#e6db74>&#34;=== 性能分析 ===&#34;</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#75715e># 分析 CPU 使用情况</span>
</span></span><span style=display:flex><span>    log <span style=color:#e6db74>&#34;CPU 密集进程:&#34;</span>
</span></span><span style=display:flex><span>    ps aux --sort<span style=color:#f92672>=</span>-%cpu | head -n <span style=color:#ae81ff>5</span> | tee -a <span style=color:#e6db74>&#34;</span>$REPORT_FILE<span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#75715e># 分析内存使用情况</span>
</span></span><span style=display:flex><span>    log <span style=color:#e6db74>&#34;内存密集进程:&#34;</span>
</span></span><span style=display:flex><span>    ps aux --sort<span style=color:#f92672>=</span>-%mem | head -n <span style=color:#ae81ff>5</span> | tee -a <span style=color:#e6db74>&#34;</span>$REPORT_FILE<span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 主函数</span>
</span></span><span style=display:flex><span>main<span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    log <span style=color:#e6db74>&#34;开始月度系统检查 - </span><span style=color:#66d9ef>$(</span>date<span style=color:#66d9ef>)</span><span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    check_system_info
</span></span><span style=display:flex><span>    check_resources
</span></span><span style=display:flex><span>    check_services
</span></span><span style=display:flex><span>    check_security
</span></span><span style=display:flex><span>    analyze_performance
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    log <span style=color:#e6db74>&#34;系统检查完成&#34;</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#75715e># 发送报告</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>[</span> -f <span style=color:#e6db74>&#34;</span>$REPORT_FILE<span style=color:#e6db74>&#34;</span> <span style=color:#f92672>]</span>; <span style=color:#66d9ef>then</span>
</span></span><span style=display:flex><span>        ~/send_notification.sh <span style=color:#e6db74>&#34;月度系统检查报告已生成&#34;</span> <span style=color:#e6db74>&#34;normal&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>fi</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 执行检查</span>
</span></span><span style=display:flex><span>main
</span></span></code></pre></div><h2 id=二十四灾难恢复计划>二十四、灾难恢复计划</h2><h3 id=1-系统恢复脚本>1. 系统恢复脚本</h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># 创建系统恢复脚本</span>
</span></span><span style=display:flex><span>nano ~/disaster_recovery.sh
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e>#!/bin/bash
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#75715e># ~/disaster_recovery.sh</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 配置</span>
</span></span><span style=display:flex><span>BACKUP_DIR<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;/home/zhaoxiongzhou/backups&#34;</span>
</span></span><span style=display:flex><span>RECOVERY_LOG<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;/var/log/recovery.log&#34;</span>
</span></span><span style=display:flex><span>SERVICES<span style=color:#f92672>=(</span><span style=color:#e6db74>&#34;nginx&#34;</span> <span style=color:#e6db74>&#34;llama-server&#34;</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 日志函数</span>
</span></span><span style=display:flex><span>log<span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    echo <span style=color:#e6db74>&#34;[</span><span style=color:#66d9ef>$(</span>date <span style=color:#e6db74>&#39;+%Y-%m-%d %H:%M:%S&#39;</span><span style=color:#66d9ef>)</span><span style=color:#e6db74>] </span>$1<span style=color:#e6db74>&#34;</span> | tee -a <span style=color:#e6db74>&#34;</span>$RECOVERY_LOG<span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 验证备份</span>
</span></span><span style=display:flex><span>verify_backup<span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    local backup_file<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;</span>$1<span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>[</span> ! -f <span style=color:#e6db74>&#34;</span>$backup_file<span style=color:#e6db74>&#34;</span> <span style=color:#f92672>]</span>; <span style=color:#66d9ef>then</span>
</span></span><span style=display:flex><span>        log <span style=color:#e6db74>&#34;错误: 备份文件不存在 - </span>$backup_file<span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>fi</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#75715e># 检查文件完整性</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> ! tar -tzf <span style=color:#e6db74>&#34;</span>$backup_file<span style=color:#e6db74>&#34;</span> &gt;/dev/null 2&gt;&amp;1; <span style=color:#66d9ef>then</span>
</span></span><span style=display:flex><span>        log <span style=color:#e6db74>&#34;错误: 备份文件损坏 - </span>$backup_file<span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>fi</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 停止服务</span>
</span></span><span style=display:flex><span>stop_services<span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    log <span style=color:#e6db74>&#34;停止所有服务...&#34;</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>for</span> service in <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>${</span>SERVICES[@]<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span>; <span style=color:#66d9ef>do</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#f92672>[</span> <span style=color:#e6db74>&#34;</span>$service<span style=color:#e6db74>&#34;</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;nginx&#34;</span> <span style=color:#f92672>]</span>; <span style=color:#66d9ef>then</span>
</span></span><span style=display:flex><span>            sudo systemctl stop nginx
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>else</span>
</span></span><span style=display:flex><span>            pkill <span style=color:#e6db74>&#34;</span>$service<span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>fi</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>done</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#75715e># 等待服务完全停止</span>
</span></span><span style=display:flex><span>    sleep <span style=color:#ae81ff>5</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 恢复博客服务</span>
</span></span><span style=display:flex><span>restore_blog<span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    local backup_file<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;</span>$BACKUP_DIR<span style=color:#e6db74>/blog_latest.tar.gz&#34;</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> verify_backup <span style=color:#e6db74>&#34;</span>$backup_file<span style=color:#e6db74>&#34;</span>; <span style=color:#66d9ef>then</span>
</span></span><span style=display:flex><span>        log <span style=color:#e6db74>&#34;开始恢复博客服务...&#34;</span>
</span></span><span style=display:flex><span>        
</span></span><span style=display:flex><span>        <span style=color:#75715e># 清理当前目录</span>
</span></span><span style=display:flex><span>        rm -rf ~/myblog/*
</span></span><span style=display:flex><span>        
</span></span><span style=display:flex><span>        <span style=color:#75715e># 解压备份</span>
</span></span><span style=display:flex><span>        tar -xzf <span style=color:#e6db74>&#34;</span>$backup_file<span style=color:#e6db74>&#34;</span> -C ~/myblog/
</span></span><span style=display:flex><span>        
</span></span><span style=display:flex><span>        <span style=color:#75715e># 重建站点</span>
</span></span><span style=display:flex><span>        cd ~/myblog
</span></span><span style=display:flex><span>        hugo --minify
</span></span><span style=display:flex><span>        
</span></span><span style=display:flex><span>        <span style=color:#75715e># 恢复权限</span>
</span></span><span style=display:flex><span>        sudo chown -R www-data:www-data public/
</span></span><span style=display:flex><span>        
</span></span><span style=display:flex><span>        log <span style=color:#e6db74>&#34;博客服务恢复完成&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>else</span>
</span></span><span style=display:flex><span>        log <span style=color:#e6db74>&#34;博客服务恢复失败&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>fi</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 恢复 AI 服务</span>
</span></span><span style=display:flex><span>restore_ai_service<span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    local backup_file<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;</span>$BACKUP_DIR<span style=color:#e6db74>/llama_latest.tar.gz&#34;</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> verify_backup <span style=color:#e6db74>&#34;</span>$backup_file<span style=color:#e6db74>&#34;</span>; <span style=color:#66d9ef>then</span>
</span></span><span style=display:flex><span>        log <span style=color:#e6db74>&#34;开始恢复 AI 服务...&#34;</span>
</span></span><span style=display:flex><span>        
</span></span><span style=display:flex><span>        <span style=color:#75715e># 清理当前目录</span>
</span></span><span style=display:flex><span>        rm -rf ~/projects/llama.cpp/*
</span></span><span style=display:flex><span>        
</span></span><span style=display:flex><span>        <span style=color:#75715e># 解压备份</span>
</span></span><span style=display:flex><span>        tar -xzf <span style=color:#e6db74>&#34;</span>$backup_file<span style=color:#e6db74>&#34;</span> -C ~/projects/llama.cpp/
</span></span><span style=display:flex><span>        
</span></span><span style=display:flex><span>        <span style=color:#75715e># 重新编译</span>
</span></span><span style=display:flex><span>        cd ~/projects/llama.cpp
</span></span><span style=display:flex><span>        make clean
</span></span><span style=display:flex><span>        LLAMA_METAL<span style=color:#f92672>=</span><span style=color:#ae81ff>1</span> make -j4
</span></span><span style=display:flex><span>        
</span></span><span style=display:flex><span>        log <span style=color:#e6db74>&#34;AI 服务恢复完成&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>else</span>
</span></span><span style=display:flex><span>        log <span style=color:#e6db74>&#34;AI 服务恢复失败&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>fi</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 恢复系统配置</span>
</span></span><span style=display:flex><span>restore_system_config<span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    local backup_file<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;</span>$BACKUP_DIR<span style=color:#e6db74>/system_config_latest.tar.gz&#34;</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> verify_backup <span style=color:#e6db74>&#34;</span>$backup_file<span style=color:#e6db74>&#34;</span>; <span style=color:#66d9ef>then</span>
</span></span><span style=display:flex><span>        log <span style=color:#e6db74>&#34;开始恢复系统配置...&#34;</span>
</span></span><span style=display:flex><span>        
</span></span><span style=display:flex><span>        <span style=color:#75715e># 解压系统配置</span>
</span></span><span style=display:flex><span>        sudo tar -xzf <span style=color:#e6db74>&#34;</span>$backup_file<span style=color:#e6db74>&#34;</span> -C /
</span></span><span style=display:flex><span>        
</span></span><span style=display:flex><span>        <span style=color:#75715e># 重新加载系统配置</span>
</span></span><span style=display:flex><span>        sudo sysctl --system
</span></span><span style=display:flex><span>        
</span></span><span style=display:flex><span>        log <span style=color:#e6db74>&#34;系统配置恢复完成&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>else</span>
</span></span><span style=display:flex><span>        log <span style=color:#e6db74>&#34;系统配置恢复失败&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>fi</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 启动服务</span>
</span></span><span style=display:flex><span>start_services<span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    log <span style=color:#e6db74>&#34;启动所有服务...&#34;</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#75715e># 启动 Nginx</span>
</span></span><span style=display:flex><span>    sudo systemctl start nginx
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#75715e># 启动 AI 服务</span>
</span></span><span style=display:flex><span>    ~/projects/llama.cpp/start-llama.sh
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#75715e># 验证服务状态</span>
</span></span><span style=display:flex><span>    sleep <span style=color:#ae81ff>10</span>
</span></span><span style=display:flex><span>    verify_services
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 验证服务</span>
</span></span><span style=display:flex><span>verify_services<span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    local status<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    log <span style=color:#e6db74>&#34;验证服务状态...&#34;</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#75715e># 检查 Nginx</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> ! systemctl is-active --quiet nginx; <span style=color:#66d9ef>then</span>
</span></span><span style=display:flex><span>        log <span style=color:#e6db74>&#34;警告: Nginx 服务未正常运行&#34;</span>
</span></span><span style=display:flex><span>        status<span style=color:#f92672>=</span><span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>fi</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#75715e># 检查 AI 服务</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> ! pgrep -f llama-server &gt; /dev/null; <span style=color:#66d9ef>then</span>
</span></span><span style=display:flex><span>        log <span style=color:#e6db74>&#34;警告: AI 服务未正常运行&#34;</span>
</span></span><span style=display:flex><span>        status<span style=color:#f92672>=</span><span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>fi</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> $status
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 主函数</span>
</span></span><span style=display:flex><span>main<span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    log <span style=color:#e6db74>&#34;开始系统恢复流程...&#34;</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#75715e># 停止服务</span>
</span></span><span style=display:flex><span>    stop_services
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#75715e># 执行恢复</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> restore_system_config <span style=color:#f92672>&amp;&amp;</span> restore_blog <span style=color:#f92672>&amp;&amp;</span> restore_ai_service; <span style=color:#66d9ef>then</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e># 启动服务</span>
</span></span><span style=display:flex><span>        start_services
</span></span><span style=display:flex><span>        
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> verify_services; <span style=color:#66d9ef>then</span>
</span></span><span style=display:flex><span>            log <span style=color:#e6db74>&#34;系统恢复成功完成&#34;</span>
</span></span><span style=display:flex><span>            ~/send_notification.sh <span style=color:#e6db74>&#34;系统恢复成功完成&#34;</span> <span style=color:#e6db74>&#34;normal&#34;</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>else</span>
</span></span><span style=display:flex><span>            log <span style=color:#e6db74>&#34;系统恢复完成，但部分服务可能未正常运行&#34;</span>
</span></span><span style=display:flex><span>            ~/send_notification.sh <span style=color:#e6db74>&#34;系统恢复完成，但需要手动检查服务状态&#34;</span> <span style=color:#e6db74>&#34;high&#34;</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>fi</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>else</span>
</span></span><span style=display:flex><span>        log <span style=color:#e6db74>&#34;系统恢复失败&#34;</span>
</span></span><span style=display:flex><span>        ~/send_notification.sh <span style=color:#e6db74>&#34;系统恢复失败，需要手动干预&#34;</span> <span style=color:#e6db74>&#34;high&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>fi</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 执行恢复</span>
</span></span><span style=display:flex><span>main
</span></span></code></pre></div><h2 id=二十五文档管理系统>二十五、文档管理系统</h2><h3 id=1-文档生成脚本>1. 文档生成脚本</h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># 创建文档生成脚本</span>
</span></span><span style=display:flex><span>nano ~/generate_docs.sh
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e>#!/bin/bash
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#75715e># ~/generate_docs.sh</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 配置</span>
</span></span><span style=display:flex><span>DOCS_DIR<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;/home/zhaoxiongzhou/documentation&#34;</span>
</span></span><span style=display:flex><span>SCRIPTS_DIR<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;/home/zhaoxiongzhou&#34;</span>
</span></span><span style=display:flex><span>CONFIG_DIR<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;/etc&#34;</span>
</span></span><span style=display:flex><span>LOG_FILE<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;/var/log/documentation.log&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 确保目录存在</span>
</span></span><span style=display:flex><span>mkdir -p <span style=color:#e6db74>&#34;</span>$DOCS_DIR<span style=color:#e6db74>&#34;</span>/<span style=color:#f92672>{</span>scripts,configs,logs,maintenance<span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 日志函数</span>
</span></span><span style=display:flex><span>log<span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    echo <span style=color:#e6db74>&#34;[</span><span style=color:#66d9ef>$(</span>date <span style=color:#e6db74>&#39;+%Y-%m-%d %H:%M:%S&#39;</span><span style=color:#66d9ef>)</span><span style=color:#e6db74>] </span>$1<span style=color:#e6db74>&#34;</span> | tee -a <span style=color:#e6db74>&#34;</span>$LOG_FILE<span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 生成脚本文档</span>
</span></span><span style=display:flex><span>generate_script_docs<span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    log <span style=color:#e6db74>&#34;生成脚本文档...&#34;</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>for</span> script in <span style=color:#e6db74>&#34;</span>$SCRIPTS_DIR<span style=color:#e6db74>&#34;</span>/*.sh; <span style=color:#66d9ef>do</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#f92672>[</span> -f <span style=color:#e6db74>&#34;</span>$script<span style=color:#e6db74>&#34;</span> <span style=color:#f92672>]</span>; <span style=color:#66d9ef>then</span>
</span></span><span style=display:flex><span>            script_name<span style=color:#f92672>=</span><span style=color:#66d9ef>$(</span>basename <span style=color:#e6db74>&#34;</span>$script<span style=color:#e6db74>&#34;</span><span style=color:#66d9ef>)</span>
</span></span><span style=display:flex><span>            output_file<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;</span>$DOCS_DIR<span style=color:#e6db74>/scripts/</span><span style=color:#e6db74>${</span>script_name%.sh<span style=color:#e6db74>}</span><span style=color:#e6db74>.md&#34;</span>
</span></span><span style=display:flex><span>            
</span></span><span style=display:flex><span>            <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                echo <span style=color:#e6db74>&#34;# </span>$script_name<span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>                echo <span style=color:#e6db74>&#34;## 路径: </span>$script<span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>                echo <span style=color:#e6db74>&#34;## 最后修改: </span><span style=color:#66d9ef>$(</span>date -r <span style=color:#e6db74>&#34;</span>$script<span style=color:#e6db74>&#34;</span> <span style=color:#e6db74>&#39;+%Y-%m-%d %H:%M:%S&#39;</span><span style=color:#66d9ef>)</span><span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>                echo <span style=color:#e6db74>&#34;## 权限: </span><span style=color:#66d9ef>$(</span>stat -c <span style=color:#e6db74>&#39;%a&#39;</span> <span style=color:#e6db74>&#34;</span>$script<span style=color:#e6db74>&#34;</span><span style=color:#66d9ef>)</span><span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>                echo <span style=color:#e6db74>&#34;## 所有者: </span><span style=color:#66d9ef>$(</span>stat -c <span style=color:#e6db74>&#39;%U:%G&#39;</span> <span style=color:#e6db74>&#34;</span>$script<span style=color:#e6db74>&#34;</span><span style=color:#66d9ef>)</span><span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>                echo
</span></span><span style=display:flex><span>                echo <span style=color:#e6db74>&#34;## 功能描述&#34;</span>
</span></span><span style=display:flex><span>                grep -A <span style=color:#ae81ff>5</span> <span style=color:#e6db74>&#34;^#.*功能:&#34;</span> <span style=color:#e6db74>&#34;</span>$script<span style=color:#e6db74>&#34;</span> 2&gt;/dev/null <span style=color:#f92672>||</span> echo <span style=color:#e6db74>&#34;未提供功能描述&#34;</span>
</span></span><span style=display:flex><span>                echo
</span></span><span style=display:flex><span>                echo <span style=color:#e6db74>&#34;## 脚本内容&#34;</span>
</span></span><span style=display:flex><span>                echo <span style=color:#e6db74>&#39;```bash&#39;</span>
</span></span><span style=display:flex><span>                cat <span style=color:#e6db74>&#34;</span>$script<span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>                echo <span style=color:#e6db74>&#39;```&#39;</span>
</span></span><span style=display:flex><span>                echo
</span></span><span style=display:flex><span>                echo <span style=color:#e6db74>&#34;## 依赖项&#34;</span>
</span></span><span style=display:flex><span>                grep <span style=color:#e6db74>&#34;^[^#]*apt.*install&#34;</span> <span style=color:#e6db74>&#34;</span>$script<span style=color:#e6db74>&#34;</span> 2&gt;/dev/null <span style=color:#f92672>||</span> echo <span style=color:#e6db74>&#34;未找到明确的依赖项&#34;</span>
</span></span><span style=display:flex><span>                echo
</span></span><span style=display:flex><span>                echo <span style=color:#e6db74>&#34;## 定时任务&#34;</span>
</span></span><span style=display:flex><span>                crontab -l 2&gt;/dev/null | grep <span style=color:#e6db74>&#34;</span>$script_name<span style=color:#e6db74>&#34;</span> <span style=color:#f92672>||</span> echo <span style=color:#e6db74>&#34;未配置定时任务&#34;</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>}</span> &gt; <span style=color:#e6db74>&#34;</span>$output_file<span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>fi</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>done</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 生成配置文档</span>
</span></span><span style=display:flex><span>generate_config_docs<span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    log <span style=color:#e6db74>&#34;生成配置文档...&#34;</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#75715e># Nginx 配置</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        echo <span style=color:#e6db74>&#34;# Nginx 配置文档&#34;</span>
</span></span><span style=display:flex><span>        echo <span style=color:#e6db74>&#34;## 主配置文件&#34;</span>
</span></span><span style=display:flex><span>        echo <span style=color:#e6db74>&#39;```nginx&#39;</span>
</span></span><span style=display:flex><span>        cat /etc/nginx/nginx.conf
</span></span><span style=display:flex><span>        echo <span style=color:#e6db74>&#39;```&#39;</span>
</span></span><span style=display:flex><span>        
</span></span><span style=display:flex><span>        echo <span style=color:#e6db74>&#34;## 站点配置&#34;</span>
</span></span><span style=display:flex><span>        echo <span style=color:#e6db74>&#39;```nginx&#39;</span>
</span></span><span style=display:flex><span>        cat /etc/nginx/sites-available/myblog
</span></span><span style=display:flex><span>        echo <span style=color:#e6db74>&#39;```&#39;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span> &gt; <span style=color:#e6db74>&#34;</span>$DOCS_DIR<span style=color:#e6db74>/configs/nginx_config.md&#34;</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#75715e># 系统配置</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        echo <span style=color:#e6db74>&#34;# 系统配置文档&#34;</span>
</span></span><span style=display:flex><span>        echo <span style=color:#e6db74>&#34;## Sysctl 配置&#34;</span>
</span></span><span style=display:flex><span>        echo <span style=color:#e6db74>&#39;```bash&#39;</span>
</span></span><span style=display:flex><span>        cat /etc/sysctl.d/99-custom.conf
</span></span><span style=display:flex><span>        echo <span style=color:#e6db74>&#39;```&#39;</span>
</span></span><span style=display:flex><span>        
</span></span><span style=display:flex><span>        echo <span style=color:#e6db74>&#34;## 树莓派配置&#34;</span>
</span></span><span style=display:flex><span>        echo <span style=color:#e6db74>&#39;```bash&#39;</span>
</span></span><span style=display:flex><span>        cat /boot/config.txt
</span></span><span style=display:flex><span>        echo <span style=color:#e6db74>&#39;```&#39;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span> &gt; <span style=color:#e6db74>&#34;</span>$DOCS_DIR<span style=color:#e6db74>/configs/system_config.md&#34;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 生成维护文档</span>
</span></span><span style=display:flex><span>generate_maintenance_docs<span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    log <span style=color:#e6db74>&#34;生成维护文档...&#34;</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        echo <span style=color:#e6db74>&#34;# 系统维护文档&#34;</span>
</span></span><span style=display:flex><span>        echo <span style=color:#e6db74>&#34;## 定时任务&#34;</span>
</span></span><span style=display:flex><span>        echo <span style=color:#e6db74>&#39;```bash&#39;</span>
</span></span><span style=display:flex><span>        crontab -l
</span></span><span style=display:flex><span>        echo <span style=color:#e6db74>&#39;```&#39;</span>
</span></span><span style=display:flex><span>        
</span></span><span style=display:flex><span>        echo <span style=color:#e6db74>&#34;## 服务状态&#34;</span>
</span></span><span style=display:flex><span>        echo <span style=color:#e6db74>&#39;```bash&#39;</span>
</span></span><span style=display:flex><span>        systemctl status nginx
</span></span><span style=display:flex><span>        ps aux | grep llama-server
</span></span><span style=display:flex><span>        echo <span style=color:#e6db74>&#39;```&#39;</span>
</span></span><span style=display:flex><span>        
</span></span><span style=display:flex><span>        echo <span style=color:#e6db74>&#34;## 资源使用&#34;</span>
</span></span><span style=display:flex><span>        echo <span style=color:#e6db74>&#39;```bash&#39;</span>
</span></span><span style=display:flex><span>        df -h
</span></span><span style=display:flex><span>        free -h
</span></span><span style=display:flex><span>        top -bn1
</span></span><span style=display:flex><span>        echo <span style=color:#e6db74>&#39;```&#39;</span>
</span></span><span style=display:flex><span>        
</span></span><span style=display:flex><span>        echo <span style=color:#e6db74>&#34;## 最近日志&#34;</span>
</span></span><span style=display:flex><span>        echo <span style=color:#e6db74>&#39;```bash&#39;</span>
</span></span><span style=display:flex><span>        tail -n <span style=color:#ae81ff>50</span> /var/log/syslog
</span></span><span style=display:flex><span>        echo <span style=color:#e6db74>&#39;```&#39;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span> &gt; <span style=color:#e6db74>&#34;</span>$DOCS_DIR<span style=color:#e6db74>/maintenance/system_status.md&#34;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 生成索引</span>
</span></span><span style=display:flex><span>generate_index<span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    log <span style=color:#e6db74>&#34;生成文档索引...&#34;</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        echo <span style=color:#e6db74>&#34;# 系统文档索引&#34;</span>
</span></span><span style=display:flex><span>        echo <span style=color:#e6db74>&#34;## 生成时间: </span><span style=color:#66d9ef>$(</span>date <span style=color:#e6db74>&#39;+%Y-%m-%d %H:%M:%S&#39;</span><span style=color:#66d9ef>)</span><span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>        echo
</span></span><span style=display:flex><span>        echo <span style=color:#e6db74>&#34;## 脚本文档&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>for</span> doc in <span style=color:#e6db74>&#34;</span>$DOCS_DIR<span style=color:#e6db74>/scripts&#34;</span>/*.md; <span style=color:#66d9ef>do</span>
</span></span><span style=display:flex><span>            echo <span style=color:#e6db74>&#34;- [</span><span style=color:#66d9ef>$(</span>basename <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>${</span>doc%.md<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span><span style=color:#66d9ef>)</span><span style=color:#e6db74>](scripts/</span><span style=color:#66d9ef>$(</span>basename <span style=color:#e6db74>&#34;</span>$doc<span style=color:#e6db74>&#34;</span><span style=color:#66d9ef>)</span><span style=color:#e6db74>)&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>done</span>
</span></span><span style=display:flex><span>        echo
</span></span><span style=display:flex><span>        echo <span style=color:#e6db74>&#34;## 配置文档&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>for</span> doc in <span style=color:#e6db74>&#34;</span>$DOCS_DIR<span style=color:#e6db74>/configs&#34;</span>/*.md; <span style=color:#66d9ef>do</span>
</span></span><span style=display:flex><span>            echo <span style=color:#e6db74>&#34;- [</span><span style=color:#66d9ef>$(</span>basename <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>${</span>doc%.md<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span><span style=color:#66d9ef>)</span><span style=color:#e6db74>](configs/</span><span style=color:#66d9ef>$(</span>basename <span style=color:#e6db74>&#34;</span>$doc<span style=color:#e6db74>&#34;</span><span style=color:#66d9ef>)</span><span style=color:#e6db74>)&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>done</span>
</span></span><span style=display:flex><span>        echo
</span></span><span style=display:flex><span>        echo <span style=color:#e6db74>&#34;## 维护文档&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>for</span> doc in <span style=color:#e6db74>&#34;</span>$DOCS_DIR<span style=color:#e6db74>/maintenance&#34;</span>/*.md; <span style=color:#66d9ef>do</span>
</span></span><span style=display:flex><span>            echo <span style=color:#e6db74>&#34;- [</span><span style=color:#66d9ef>$(</span>basename <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>${</span>doc%.md<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span><span style=color:#66d9ef>)</span><span style=color:#e6db74>](maintenance/</span><span style=color:#66d9ef>$(</span>basename <span style=color:#e6db74>&#34;</span>$doc<span style=color:#e6db74>&#34;</span><span style=color:#66d9ef>)</span><span style=color:#e6db74>)&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>done</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span> &gt; <span style=color:#e6db74>&#34;</span>$DOCS_DIR<span style=color:#e6db74>/index.md&#34;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 主函数</span>
</span></span><span style=display:flex><span>main<span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    log <span style=color:#e6db74>&#34;开始生成文档...&#34;</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    generate_script_docs
</span></span><span style=display:flex><span>    generate_config_docs
</span></span><span style=display:flex><span>    generate_maintenance_docs
</span></span><span style=display:flex><span>    generate_index
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    log <span style=color:#e6db74>&#34;文档生成完成: </span>$DOCS_DIR<span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 执行文档生成</span>
</span></span><span style=display:flex><span>main
</span></span></code></pre></div><h2 id=二十六性能测试与基准测试>二十六、性能测试与基准测试</h2><h3 id=1-性能测试脚本>1. 性能测试脚本</h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># 创建性能测试脚本</span>
</span></span><span style=display:flex><span>nano ~/benchmark.sh
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e>#!/bin/bash
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#75715e># ~/benchmark.sh</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 配置</span>
</span></span><span style=display:flex><span>RESULTS_DIR<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;/home/zhaoxiongzhou/benchmark_results&#34;</span>
</span></span><span style=display:flex><span>LOG_FILE<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;/var/log/benchmark.log&#34;</span>
</span></span><span style=display:flex><span>DURATION<span style=color:#f92672>=</span><span style=color:#ae81ff>300</span>  <span style=color:#75715e># 测试持续时间（秒）</span>
</span></span><span style=display:flex><span>CONCURRENT_USERS<span style=color:#f92672>=</span><span style=color:#ae81ff>10</span>  <span style=color:#75715e># 并发用户数</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 确保目录存在</span>
</span></span><span style=display:flex><span>mkdir -p <span style=color:#e6db74>&#34;</span>$RESULTS_DIR<span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 日志函数</span>
</span></span><span style=display:flex><span>log<span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    echo <span style=color:#e6db74>&#34;[</span><span style=color:#66d9ef>$(</span>date <span style=color:#e6db74>&#39;+%Y-%m-%d %H:%M:%S&#39;</span><span style=color:#66d9ef>)</span><span style=color:#e6db74>] </span>$1<span style=color:#e6db74>&#34;</span> | tee -a <span style=color:#e6db74>&#34;</span>$LOG_FILE<span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># CPU 性能测试</span>
</span></span><span style=display:flex><span>benchmark_cpu<span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    log <span style=color:#e6db74>&#34;开始 CPU 性能测试...&#34;</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#75715e># 使用 sysbench 进行 CPU 测试</span>
</span></span><span style=display:flex><span>    sysbench cpu --cpu-max-prime<span style=color:#f92672>=</span><span style=color:#ae81ff>20000</span> --threads<span style=color:#f92672>=</span><span style=color:#ae81ff>4</span> run &gt; <span style=color:#e6db74>&#34;</span>$RESULTS_DIR<span style=color:#e6db74>/cpu_benchmark.txt&#34;</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#75715e># 记录 CPU 温度</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>for</span> i in <span style=color:#66d9ef>$(</span>seq <span style=color:#ae81ff>1</span> 10<span style=color:#66d9ef>)</span>; <span style=color:#66d9ef>do</span>
</span></span><span style=display:flex><span>        vcgencmd measure_temp &gt;&gt; <span style=color:#e6db74>&#34;</span>$RESULTS_DIR<span style=color:#e6db74>/cpu_temp.txt&#34;</span>
</span></span><span style=display:flex><span>        sleep <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>done</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 内存性能测试</span>
</span></span><span style=display:flex><span>benchmark_memory<span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    log <span style=color:#e6db74>&#34;开始内存性能测试...&#34;</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#75715e># 使用 sysbench 进行内存测试</span>
</span></span><span style=display:flex><span>    sysbench memory --memory-block-size<span style=color:#f92672>=</span>1K --memory-total-size<span style=color:#f92672>=</span>10G run &gt; <span style=color:#e6db74>&#34;</span>$RESULTS_DIR<span style=color:#e6db74>/memory_benchmark.txt&#34;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 磁盘性能测试</span>
</span></span><span style=display:flex><span>benchmark_disk<span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    log <span style=color:#e6db74>&#34;开始磁盘性能测试...&#34;</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#75715e># 使用 dd 测试写入速度</span>
</span></span><span style=display:flex><span>    dd <span style=color:#66d9ef>if</span><span style=color:#f92672>=</span>/dev/zero of<span style=color:#f92672>=</span>/tmp/test_file bs<span style=color:#f92672>=</span>1M count<span style=color:#f92672>=</span><span style=color:#ae81ff>1000</span> conv<span style=color:#f92672>=</span>fdatasync 2&gt;&gt; <span style=color:#e6db74>&#34;</span>$RESULTS_DIR<span style=color:#e6db74>/disk_write_benchmark.txt&#34;</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#75715e># 使用 dd 测试读取速度</span>
</span></span><span style=display:flex><span>    dd <span style=color:#66d9ef>if</span><span style=color:#f92672>=</span>/tmp/test_file of<span style=color:#f92672>=</span>/dev/null bs<span style=color:#f92672>=</span>1M count<span style=color:#f92672>=</span><span style=color:#ae81ff>1000</span> 2&gt;&gt; <span style=color:#e6db74>&#34;</span>$RESULTS_DIR<span style=color:#e6db74>/disk_read_benchmark.txt&#34;</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#75715e># 清理测试文件</span>
</span></span><span style=display:flex><span>    rm /tmp/test_file
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 网络性能测试</span>
</span></span><span style=display:flex><span>benchmark_network<span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    log <span style=color:#e6db74>&#34;开始网络性能测试...&#34;</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#75715e># 使用 iperf3 测试网络性能</span>
</span></span><span style=display:flex><span>    iperf3 -c iperf.he.net -t <span style=color:#ae81ff>30</span> &gt; <span style=color:#e6db74>&#34;</span>$RESULTS_DIR<span style=color:#e6db74>/network_benchmark.txt&#34;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Web 服务性能测试</span>
</span></span><span style=display:flex><span>benchmark_web<span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    log <span style=color:#e6db74>&#34;开始 Web 服务性能测试...&#34;</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#75715e># 使用 ab 测试 Web 服务</span>
</span></span><span style=display:flex><span>    ab -n <span style=color:#ae81ff>1000</span> -c <span style=color:#e6db74>&#34;</span>$CONCURRENT_USERS<span style=color:#e6db74>&#34;</span> http://localhost/ &gt; <span style=color:#e6db74>&#34;</span>$RESULTS_DIR<span style=color:#e6db74>/web_benchmark.txt&#34;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># AI 服务性能测试</span>
</span></span><span style=display:flex><span>benchmark_ai<span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    log <span style=color:#e6db74>&#34;开始 AI 服务性能测试...&#34;</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#75715e># 创建测试请求</span>
</span></span><span style=display:flex><span>    cat &gt; /tmp/test_prompt.txt <span style=color:#e6db74>&lt;&lt; EOF
</span></span></span><span style=display:flex><span><span style=color:#e6db74>Hello, how are you?
</span></span></span><span style=display:flex><span><span style=color:#e6db74>EOF</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#75715e># 使用 curl 测试 AI 服务响应时间</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>for</span> i in <span style=color:#66d9ef>$(</span>seq <span style=color:#ae81ff>1</span> 10<span style=color:#66d9ef>)</span>; <span style=color:#66d9ef>do</span>
</span></span><span style=display:flex><span>        time curl -X POST <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>             -H <span style=color:#e6db74>&#34;Content-Type: application/json&#34;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>             -d @/tmp/test_prompt.txt <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>             http://localhost:8080/completion &gt;&gt; <span style=color:#e6db74>&#34;</span>$RESULTS_DIR<span style=color:#e6db74>/ai_benchmark.txt&#34;</span> 2&gt;&amp;<span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>        echo -e <span style=color:#e6db74>&#34;\n---\n&#34;</span> &gt;&gt; <span style=color:#e6db74>&#34;</span>$RESULTS_DIR<span style=color:#e6db74>/ai_benchmark.txt&#34;</span>
</span></span><span style=display:flex><span>        sleep <span style=color:#ae81ff>2</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>done</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 生成报告</span>
</span></span><span style=display:flex><span>generate_report<span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    log <span style=color:#e6db74>&#34;生成性能测试报告...&#34;</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    local report_file<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;</span>$RESULTS_DIR<span style=color:#e6db74>/benchmark_report_</span><span style=color:#66d9ef>$(</span>date +%Y%m%d_%H%M%S<span style=color:#66d9ef>)</span><span style=color:#e6db74>.md&#34;</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        echo <span style=color:#e6db74>&#34;# 性能测试报告&#34;</span>
</span></span><span style=display:flex><span>        echo <span style=color:#e6db74>&#34;## 测试时间: </span><span style=color:#66d9ef>$(</span>date <span style=color:#e6db74>&#39;+%Y-%m-%d %H:%M:%S&#39;</span><span style=color:#66d9ef>)</span><span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>        echo
</span></span><span style=display:flex><span>        echo <span style=color:#e6db74>&#34;## 系统信息&#34;</span>
</span></span><span style=display:flex><span>        echo <span style=color:#e6db74>&#39;```&#39;</span>
</span></span><span style=display:flex><span>        uname -a
</span></span><span style=display:flex><span>        echo <span style=color:#e6db74>&#39;```&#39;</span>
</span></span><span style=display:flex><span>        echo
</span></span><span style=display:flex><span>        echo <span style=color:#e6db74>&#34;## CPU 性能&#34;</span>
</span></span><span style=display:flex><span>        echo <span style=color:#e6db74>&#39;```&#39;</span>
</span></span><span style=display:flex><span>        cat <span style=color:#e6db74>&#34;</span>$RESULTS_DIR<span style=color:#e6db74>/cpu_benchmark.txt&#34;</span>
</span></span><span style=display:flex><span>        echo <span style=color:#e6db74>&#39;```&#39;</span>
</span></span><span style=display:flex><span>        echo
</span></span><span style=display:flex><span>        echo <span style=color:#e6db74>&#34;## 内存性能&#34;</span>
</span></span><span style=display:flex><span>        echo <span style=color:#e6db74>&#39;```&#39;</span>
</span></span><span style=display:flex><span>        cat <span style=color:#e6db74>&#34;</span>$RESULTS_DIR<span style=color:#e6db74>/memory_benchmark.txt&#34;</span>
</span></span><span style=display:flex><span>        echo <span style=color:#e6db74>&#39;```&#39;</span>
</span></span><span style=display:flex><span>        echo
</span></span><span style=display:flex><span>        echo <span style=color:#e6db74>&#34;## 磁盘性能&#34;</span>
</span></span><span style=display:flex><span>        echo <span style=color:#e6db74>&#39;```&#39;</span>
</span></span><span style=display:flex><span>        cat <span style=color:#e6db74>&#34;</span>$RESULTS_DIR<span style=color:#e6db74>/disk_write_benchmark.txt&#34;</span>
</span></span><span style=display:flex><span>        cat <span style=color:#e6db74>&#34;</span>$RESULTS_DIR<span style=color:#e6db74>/disk_read_benchmark.txt&#34;</span>
</span></span><span style=display:flex><span>        echo <span style=color:#e6db74>&#39;```&#39;</span>
</span></span><span style=display:flex><span>        echo
</span></span><span style=display:flex><span>        echo <span style=color:#e6db74>&#34;## 网络性能&#34;</span>
</span></span><span style=display:flex><span>        echo <span style=color:#e6db74>&#39;```&#39;</span>
</span></span><span style=display:flex><span>        cat <span style=color:#e6db74>&#34;</span>$RESULTS_DIR<span style=color:#e6db74>/network_benchmark.txt&#34;</span>
</span></span><span style=display:flex><span>        echo <span style=color:#e6db74>&#39;```&#39;</span>
</span></span><span style=display:flex><span>        echo
</span></span><span style=display:flex><span>        echo <span style=color:#e6db74>&#34;## Web 服务性能&#34;</span>
</span></span><span style=display:flex><span>        echo <span style=color:#e6db74>&#39;```&#39;</span>
</span></span><span style=display:flex><span>        cat <span style=color:#e6db74>&#34;</span>$RESULTS_DIR<span style=color:#e6db74>/web_benchmark.txt&#34;</span>
</span></span><span style=display:flex><span>        echo <span style=color:#e6db74>&#39;```&#39;</span>
</span></span><span style=display:flex><span>        echo
</span></span><span style=display:flex><span>        echo <span style=color:#e6db74>&#34;## AI 服务性能&#34;</span>
</span></span><span style=display:flex><span>        echo <span style=color:#e6db74>&#39;```&#39;</span>
</span></span><span style=display:flex><span>        cat <span style=color:#e6db74>&#34;</span>$RESULTS_DIR<span style=color:#e6db74>/ai_benchmark.txt&#34;</span>
</span></span><span style=display:flex><span>        echo <span style=color:#e6db74>&#39;```&#39;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span> &gt; <span style=color:#e6db74>&#34;</span>$report_file<span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    log <span style=color:#e6db74>&#34;性能测试报告已生成: </span>$report_file<span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 主函数</span>
</span></span><span style=display:flex><span>main<span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    log <span style=color:#e6db74>&#34;开始性能测试...&#34;</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#75715e># 安装必要的工具</span>
</span></span><span style=display:flex><span>    sudo apt install -y sysbench apache2-utils iperf3
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#75715e># 执行各项测试</span>
</span></span><span style=display:flex><span>    benchmark_cpu
</span></span><span style=display:flex><span>    benchmark_memory
</span></span><span style=display:flex><span>    benchmark_disk
</span></span><span style=display:flex><span>    benchmark_network
</span></span><span style=display:flex><span>    benchmark_web
</span></span><span style=display:flex><span>    benchmark_ai
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#75715e># 生成报告</span>
</span></span><span style=display:flex><span>    generate_report
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    log <span style=color:#e6db74>&#34;性能测试完成&#34;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 执行测试</span>
</span></span><span style=display:flex><span>main
</span></span></code></pre></div><h2 id=二十七安全审计系统>二十七、安全审计系统</h2><h3 id=1-安全审计脚本>1. 安全审计脚本</h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># 创建安全审计脚本</span>
</span></span><span style=display:flex><span>nano ~/security_audit.sh
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e>#!/bin/bash
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#75715e># ~/security_audit.sh</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 配置</span>
</span></span><span style=display:flex><span>AUDIT_DIR<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;/home/zhaoxiongzhou/security_audits&#34;</span>
</span></span><span style=display:flex><span>REPORT_FILE<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;</span>$AUDIT_DIR<span style=color:#e6db74>/security_report_</span><span style=color:#66d9ef>$(</span>date +%Y%m%d_%H%M%S<span style=color:#66d9ef>)</span><span style=color:#e6db74>.md&#34;</span>
</span></span><span style=display:flex><span>LOG_FILE<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;/var/log/security_audit.log&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 确保目录存在</span>
</span></span><span style=display:flex><span>mkdir -p <span style=color:#e6db74>&#34;</span>$AUDIT_DIR<span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 日志函数</span>
</span></span><span style=display:flex><span>log<span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    echo <span style=color:#e6db74>&#34;[</span><span style=color:#66d9ef>$(</span>date <span style=color:#e6db74>&#39;+%Y-%m-%d %H:%M:%S&#39;</span><span style=color:#66d9ef>)</span><span style=color:#e6db74>] </span>$1<span style=color:#e6db74>&#34;</span> | tee -a <span style=color:#e6db74>&#34;</span>$LOG_FILE<span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 检查系统用户</span>
</span></span><span style=display:flex><span>audit_users<span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    log <span style=color:#e6db74>&#34;检查系统用户...&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        echo <span style=color:#e6db74>&#34;## 系统用户审计&#34;</span>
</span></span><span style=display:flex><span>        echo <span style=color:#e6db74>&#34;### 特权用户&#34;</span>
</span></span><span style=display:flex><span>        echo <span style=color:#e6db74>&#39;```&#39;</span>
</span></span><span style=display:flex><span>        awk -F: <span style=color:#e6db74>&#39;$3 == 0 {print $1}&#39;</span> /etc/passwd
</span></span><span style=display:flex><span>        echo <span style=color:#e6db74>&#39;```&#39;</span>
</span></span><span style=display:flex><span>        
</span></span><span style=display:flex><span>        echo <span style=color:#e6db74>&#34;### 最近的用户活动&#34;</span>
</span></span><span style=display:flex><span>        echo <span style=color:#e6db74>&#39;```&#39;</span>
</span></span><span style=display:flex><span>        last | head -n <span style=color:#ae81ff>10</span>
</span></span><span style=display:flex><span>        echo <span style=color:#e6db74>&#39;```&#39;</span>
</span></span><span style=display:flex><span>        
</span></span><span style=display:flex><span>        echo <span style=color:#e6db74>&#34;### 失败的登录尝试&#34;</span>
</span></span><span style=display:flex><span>        echo <span style=color:#e6db74>&#39;```&#39;</span>
</span></span><span style=display:flex><span>        grep <span style=color:#e6db74>&#34;Failed password&#34;</span> /var/log/auth.log | tail -n <span style=color:#ae81ff>10</span>
</span></span><span style=display:flex><span>        echo <span style=color:#e6db74>&#39;```&#39;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span> &gt;&gt; <span style=color:#e6db74>&#34;</span>$REPORT_FILE<span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 检查网络安全</span>
</span></span><span style=display:flex><span>audit_network<span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    log <span style=color:#e6db74>&#34;检查网络安全...&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        echo <span style=color:#e6db74>&#34;## 网络安全审计&#34;</span>
</span></span><span style=display:flex><span>        echo <span style=color:#e6db74>&#34;### 开放端口&#34;</span>
</span></span><span style=display:flex><span>        echo <span style=color:#e6db74>&#39;```&#39;</span>
</span></span><span style=display:flex><span>        netstat -tuln
</span></span><span style=display:flex><span>        echo <span style=color:#e6db74>&#39;```&#39;</span>
</span></span><span style=display:flex><span>        
</span></span><span style=display:flex><span>        echo <span style=color:#e6db74>&#34;### 活动连接&#34;</span>
</span></span><span style=display:flex><span>        echo <span style=color:#e6db74>&#39;```&#39;</span>
</span></span><span style=display:flex><span>        netstat -nat | grep ESTABLISHED
</span></span><span style=display:flex><span>        echo <span style=color:#e6db74>&#39;```&#39;</span>
</span></span><span style=display:flex><span>        
</span></span><span style=display:flex><span>        echo <span style=color:#e6db74>&#34;### 防火墙规则&#34;</span>
</span></span><span style=display:flex><span>        echo <span style=color:#e6db74>&#39;```&#39;</span>
</span></span><span style=display:flex><span>        sudo iptables -L -n
</span></span><span style=display:flex><span>        echo <span style=color:#e6db74>&#39;```&#39;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span> &gt;&gt; <span style=color:#e6db74>&#34;</span>$REPORT_FILE<span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 检查文件权限</span>
</span></span><span style=display:flex><span>audit_permissions<span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    log <span style=color:#e6db74>&#34;检查文件权限...&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        echo <span style=color:#e6db74>&#34;## 文件权限审计&#34;</span>
</span></span><span style=display:flex><span>        echo <span style=color:#e6db74>&#34;### SUID 文件&#34;</span>
</span></span><span style=display:flex><span>        echo <span style=color:#e6db74>&#39;```&#39;</span>
</span></span><span style=display:flex><span>        sudo find / -type f -perm -4000 2&gt;/dev/null
</span></span><span style=display:flex><span>        echo <span style=color:#e6db74>&#39;```&#39;</span>
</span></span><span style=display:flex><span>        
</span></span><span style=display:flex><span>        echo <span style=color:#e6db74>&#34;### 世界可写文件&#34;</span>
</span></span><span style=display:flex><span>        echo <span style=color:#e6db74>&#39;```&#39;</span>
</span></span><span style=display:flex><span>        sudo find / -type f -perm -2 ! -path <span style=color:#e6db74>&#34;/proc/*&#34;</span> ! -path <span style=color:#e6db74>&#34;/sys/*&#34;</span> 2&gt;/dev/null
</span></span><span style=display:flex><span>        echo <span style=color:#e6db74>&#39;```&#39;</span>
</span></span><span style=display:flex><span>        
</span></span><span style=display:flex><span>        echo <span style=color:#e6db74>&#34;### 敏感目录权限&#34;</span>
</span></span><span style=display:flex><span>        echo <span style=color:#e6db74>&#39;```&#39;</span>
</span></span><span style=display:flex><span>        ls -la /etc/nginx/
</span></span><span style=display:flex><span>        ls -la ~/projects/llama.cpp/
</span></span><span style=display:flex><span>        ls -la ~/myblog/
</span></span><span style=display:flex><span>        echo <span style=color:#e6db74>&#39;```&#39;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span> &gt;&gt; <span style=color:#e6db74>&#34;</span>$REPORT_FILE<span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 检查服务配置</span>
</span></span><span style=display:flex><span>audit_services<span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    log <span style=color:#e6db74>&#34;检查服务配置...&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        echo <span style=color:#e6db74>&#34;## 服务配置审计&#34;</span>
</span></span><span style=display:flex><span>        echo <span style=color:#e6db74>&#34;### Nginx 配置检查&#34;</span>
</span></span><span style=display:flex><span>        echo <span style=color:#e6db74>&#39;```&#39;</span>
</span></span><span style=display:flex><span>        sudo nginx -t 2&gt;&amp;<span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>        echo <span style=color:#e6db74>&#39;```&#39;</span>
</span></span><span style=display:flex><span>        
</span></span><span style=display:flex><span>        echo <span style=color:#e6db74>&#34;### SSL 配置&#34;</span>
</span></span><span style=display:flex><span>        echo <span style=color:#e6db74>&#39;```&#39;</span>
</span></span><span style=display:flex><span>        openssl s_client -connect localhost:443 -servername localhost &lt;/dev/null 2&gt;/dev/null | openssl x509 -text
</span></span><span style=display:flex><span>        echo <span style=color:#e6db74>&#39;```&#39;</span>
</span></span><span style=display:flex><span>        
</span></span><span style=display:flex><span>        echo <span style=color:#e6db74>&#34;### 服务状态&#34;</span>
</span></span><span style=display:flex><span>        echo <span style=color:#e6db74>&#39;```&#39;</span>
</span></span><span style=display:flex><span>        systemctl list-units --type<span style=color:#f92672>=</span>service --state<span style=color:#f92672>=</span>active
</span></span><span style=display:flex><span>        echo <span style=color:#e6db74>&#39;```&#39;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span> &gt;&gt; <span style=color:#e6db74>&#34;</span>$REPORT_FILE<span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 检查系统更新</span>
</span></span><span style=display:flex><span>audit_updates<span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    log <span style=color:#e6db74>&#34;检查系统更新...&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        echo <span style=color:#e6db74>&#34;## 系统更新审计&#34;</span>
</span></span><span style=display:flex><span>        echo <span style=color:#e6db74>&#34;### 可用更新&#34;</span>
</span></span><span style=display:flex><span>        echo <span style=color:#e6db74>&#39;```&#39;</span>
</span></span><span style=display:flex><span>        apt list --upgradable 2&gt;/dev/null
</span></span><span style=display:flex><span>        echo <span style=color:#e6db74>&#39;```&#39;</span>
</span></span><span style=display:flex><span>        
</span></span><span style=display:flex><span>        echo <span style=color:#e6db74>&#34;### 已安装包&#34;</span>
</span></span><span style=display:flex><span>        echo <span style=color:#e6db74>&#39;```&#39;</span>
</span></span><span style=display:flex><span>        dpkg -l | grep <span style=color:#e6db74>&#34;^ii&#34;</span> | wc -l
</span></span><span style=display:flex><span>        echo <span style=color:#e6db74>&#39;```&#39;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span> &gt;&gt; <span style=color:#e6db74>&#34;</span>$REPORT_FILE<span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 检查日志异常</span>
</span></span><span style=display:flex><span>audit_logs<span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    log <span style=color:#e6db74>&#34;检查日志异常...&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        echo <span style=color:#e6db74>&#34;## 日志审计&#34;</span>
</span></span><span style=display:flex><span>        echo <span style=color:#e6db74>&#34;### 系统错误&#34;</span>
</span></span><span style=display:flex><span>        echo <span style=color:#e6db74>&#39;```&#39;</span>
</span></span><span style=display:flex><span>        sudo journalctl -p <span style=color:#ae81ff>3</span> -xb --no-pager | tail -n <span style=color:#ae81ff>20</span>
</span></span><span style=display:flex><span>        echo <span style=color:#e6db74>&#39;```&#39;</span>
</span></span><span style=display:flex><span>        
</span></span><span style=display:flex><span>        echo <span style=color:#e6db74>&#34;### 异常访问&#34;</span>
</span></span><span style=display:flex><span>        echo <span style=color:#e6db74>&#39;```&#39;</span>
</span></span><span style=display:flex><span>        grep -i <span style=color:#e6db74>&#34;error\|failed\|warning&#34;</span> /var/log/nginx/error.log | tail -n <span style=color:#ae81ff>20</span>
</span></span><span style=display:flex><span>        echo <span style=color:#e6db74>&#39;```&#39;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span> &gt;&gt; <span style=color:#e6db74>&#34;</span>$REPORT_FILE<span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 生成安全建议</span>
</span></span><span style=display:flex><span>generate_recommendations<span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    log <span style=color:#e6db74>&#34;生成安全建议...&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        echo <span style=color:#e6db74>&#34;## 安全建议&#34;</span>
</span></span><span style=display:flex><span>        echo <span style=color:#e6db74>&#34;### 高优先级&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e># 检查并生成建议</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> grep -q <span style=color:#e6db74>&#34;Failed password&#34;</span> /var/log/auth.log; <span style=color:#66d9ef>then</span>
</span></span><span style=display:flex><span>            echo <span style=color:#e6db74>&#34;- 建议：启用 fail2ban 加强 SSH 防护&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>fi</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#f92672>[</span> <span style=color:#66d9ef>$(</span>find / -type f -perm -2 2&gt;/dev/null | wc -l<span style=color:#66d9ef>)</span> -gt <span style=color:#ae81ff>0</span> <span style=color:#f92672>]</span>; <span style=color:#66d9ef>then</span>
</span></span><span style=display:flex><span>            echo <span style=color:#e6db74>&#34;- 建议：检查并修复世界可写文件权限&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>fi</span>
</span></span><span style=display:flex><span>        
</span></span><span style=display:flex><span>        echo <span style=color:#e6db74>&#34;### 中优先级&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e># 添加其他建议</span>
</span></span><span style=display:flex><span>        echo <span style=color:#e6db74>&#34;- 定期更新系统包&#34;</span>
</span></span><span style=display:flex><span>        echo <span style=color:#e6db74>&#34;- 检查并更新 SSL 证书&#34;</span>
</span></span><span style=display:flex><span>        echo <span style=color:#e6db74>&#34;- 定期审查用户权限&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span> &gt;&gt; <span style=color:#e6db74>&#34;</span>$REPORT_FILE<span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 主函数</span>
</span></span><span style=display:flex><span>main<span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    log <span style=color:#e6db74>&#34;开始安全审计...&#34;</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#75715e># 创建报告头部</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        echo <span style=color:#e6db74>&#34;# 安全审计报告&#34;</span>
</span></span><span style=display:flex><span>        echo <span style=color:#e6db74>&#34;## 生成时间: </span><span style=color:#66d9ef>$(</span>date <span style=color:#e6db74>&#39;+%Y-%m-%d %H:%M:%S&#39;</span><span style=color:#66d9ef>)</span><span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>        echo <span style=color:#e6db74>&#34;## 系统信息&#34;</span>
</span></span><span style=display:flex><span>        echo <span style=color:#e6db74>&#39;```&#39;</span>
</span></span><span style=display:flex><span>        uname -a
</span></span><span style=display:flex><span>        echo <span style=color:#e6db74>&#39;```&#39;</span>
</span></span><span style=display:flex><span>        echo
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span> &gt; <span style=color:#e6db74>&#34;</span>$REPORT_FILE<span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#75715e># 执行各项审计</span>
</span></span><span style=display:flex><span>    audit_users
</span></span><span style=display:flex><span>    audit_network
</span></span><span style=display:flex><span>    audit_permissions
</span></span><span style=display:flex><span>    audit_services
</span></span><span style=display:flex><span>    audit_updates
</span></span><span style=display:flex><span>    audit_logs
</span></span><span style=display:flex><span>    generate_recommendations
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    log <span style=color:#e6db74>&#34;安全审计完成，报告已生成: </span>$REPORT_FILE<span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#75715e># 发送通知</span>
</span></span><span style=display:flex><span>    ~/send_notification.sh <span style=color:#e6db74>&#34;安全审计报告已生成&#34;</span> <span style=color:#e6db74>&#34;normal&#34;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 执行审计</span>
</span></span><span style=display:flex><span>main
</span></span></code></pre></div><h2 id=二十八资源限制与控制>二十八、资源限制与控制</h2><h3 id=1-资源限制配置脚本>1. 资源限制配置脚本</h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># 创建资源限制配置脚本</span>
</span></span><span style=display:flex><span>nano ~/resource_control.sh
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e>#!/bin/bash
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#75715e># ~/resource_control.sh</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 配置</span>
</span></span><span style=display:flex><span>LOG_FILE<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;/var/log/resource_control.log&#34;</span>
</span></span><span style=display:flex><span>LIMITS_CONF<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;/etc/security/limits.conf&#34;</span>
</span></span><span style=display:flex><span>SYSTEMD_DIR<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;/etc/systemd/system&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 日志函数</span>
</span></span><span style=display:flex><span>log<span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    echo <span style=color:#e6db74>&#34;[</span><span style=color:#66d9ef>$(</span>date <span style=color:#e6db74>&#39;+%Y-%m-%d %H:%M:%S&#39;</span><span style=color:#66d9ef>)</span><span style=color:#e6db74>] </span>$1<span style=color:#e6db74>&#34;</span> | tee -a <span style=color:#e6db74>&#34;</span>$LOG_FILE<span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 配置系统资源限制</span>
</span></span><span style=display:flex><span>configure_system_limits<span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    log <span style=color:#e6db74>&#34;配置系统资源限制...&#34;</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#75715e># 备份原始配置</span>
</span></span><span style=display:flex><span>    sudo cp <span style=color:#e6db74>&#34;</span>$LIMITS_CONF<span style=color:#e6db74>&#34;</span> <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>${</span>LIMITS_CONF<span style=color:#e6db74>}</span><span style=color:#e6db74>.backup&#34;</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#75715e># 添加资源限制配置</span>
</span></span><span style=display:flex><span>    sudo tee -a <span style=color:#e6db74>&#34;</span>$LIMITS_CONF<span style=color:#e6db74>&#34;</span> <span style=color:#e6db74>&lt;&lt; EOF
</span></span></span><span style=display:flex><span><span style=color:#e6db74># 用户资源限制
</span></span></span><span style=display:flex><span><span style=color:#e6db74>zhaoxiongzhou soft nofile 65535
</span></span></span><span style=display:flex><span><span style=color:#e6db74>zhaoxiongzhou hard nofile 65535
</span></span></span><span style=display:flex><span><span style=color:#e6db74>zhaoxiongzhou soft nproc 2048
</span></span></span><span style=display:flex><span><span style=color:#e6db74>zhaoxiongzhou hard nproc 4096
</span></span></span><span style=display:flex><span><span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74># 系统服务资源限制
</span></span></span><span style=display:flex><span><span style=color:#e6db74>www-data soft nofile 65535
</span></span></span><span style=display:flex><span><span style=color:#e6db74>www-data hard nofile 65535
</span></span></span><span style=display:flex><span><span style=color:#e6db74>www-data soft nproc 1024
</span></span></span><span style=display:flex><span><span style=color:#e6db74>www-data hard nproc 2048
</span></span></span><span style=display:flex><span><span style=color:#e6db74>EOF</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 配置 AI 服务资源限制</span>
</span></span><span style=display:flex><span>configure_ai_service<span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    log <span style=color:#e6db74>&#34;配置 AI 服务资源限制...&#34;</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#75715e># 创建 systemd 服务文件</span>
</span></span><span style=display:flex><span>    sudo tee <span style=color:#e6db74>&#34;</span>$SYSTEMD_DIR<span style=color:#e6db74>/llama-server.service&#34;</span> <span style=color:#e6db74>&lt;&lt; EOF
</span></span></span><span style=display:flex><span><span style=color:#e6db74>[Unit]
</span></span></span><span style=display:flex><span><span style=color:#e6db74>Description=Llama AI Server
</span></span></span><span style=display:flex><span><span style=color:#e6db74>After=network.target
</span></span></span><span style=display:flex><span><span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74>[Service]
</span></span></span><span style=display:flex><span><span style=color:#e6db74>User=zhaoxiongzhou
</span></span></span><span style=display:flex><span><span style=color:#e6db74>Group=zhaoxiongzhou
</span></span></span><span style=display:flex><span><span style=color:#e6db74>WorkingDirectory=/home/zhaoxiongzhou/projects/llama.cpp
</span></span></span><span style=display:flex><span><span style=color:#e6db74>ExecStart=/home/zhaoxiongzhou/projects/llama.cpp/start-llama.sh
</span></span></span><span style=display:flex><span><span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74># 资源限制
</span></span></span><span style=display:flex><span><span style=color:#e6db74>CPUQuota=80%
</span></span></span><span style=display:flex><span><span style=color:#e6db74>MemoryLimit=2G
</span></span></span><span style=display:flex><span><span style=color:#e6db74>TasksMax=128
</span></span></span><span style=display:flex><span><span style=color:#e6db74>LimitNOFILE=65535
</span></span></span><span style=display:flex><span><span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74># 重启策略
</span></span></span><span style=display:flex><span><span style=color:#e6db74>Restart=always
</span></span></span><span style=display:flex><span><span style=color:#e6db74>RestartSec=10
</span></span></span><span style=display:flex><span><span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74>[Install]
</span></span></span><span style=display:flex><span><span style=color:#e6db74>WantedBy=multi-user.target
</span></span></span><span style=display:flex><span><span style=color:#e6db74>EOF</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># 重新加载 systemd 配置</span>
</span></span><span style=display:flex><span>    sudo systemctl daemon-reload
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 配置 Nginx 资源限制</span>
</span></span><span style=display:flex><span>configure_nginx<span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    log <span style=color:#e6db74>&#34;配置 Nginx 资源限制...&#34;</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#75715e># 修改 Nginx 配置</span>
</span></span><span style=display:flex><span>    sudo tee <span style=color:#e6db74>&#34;/etc/nginx/conf.d/resource_limits.conf&#34;</span> <span style=color:#e6db74>&lt;&lt; EOF
</span></span></span><span style=display:flex><span><span style=color:#e6db74># 工作进程限制
</span></span></span><span style=display:flex><span><span style=color:#e6db74>worker_processes auto;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>worker_rlimit_nofile 65535;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74># 连接限制
</span></span></span><span style=display:flex><span><span style=color:#e6db74>events {
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    worker_connections 1024;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    multi_accept on;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>}
</span></span></span><span style=display:flex><span><span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74># 客户端限制
</span></span></span><span style=display:flex><span><span style=color:#e6db74>http {
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    # 请求限制
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    limit_req_zone \$binary_remote_addr zone=one:10m rate=10r/s;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    # 连接限制
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    limit_conn_zone \$binary_remote_addr zone=addr:10m;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    server {
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        # 应用限制
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        location / {
</span></span></span><span style=display:flex><span><span style=color:#e6db74>            limit_req zone=one burst=5;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>            limit_conn addr 10;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        }
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    }
</span></span></span><span style=display:flex><span><span style=color:#e6db74>}
</span></span></span><span style=display:flex><span><span style=color:#e6db74>EOF</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 配置系统资源监控</span>
</span></span><span style=display:flex><span>configure_monitoring<span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    log <span style=color:#e6db74>&#34;配置资源监控...&#34;</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#75715e># 创建监控脚本</span>
</span></span><span style=display:flex><span>    cat &gt; ~/monitor_resources.sh <span style=color:#e6db74>&lt;&lt; EOF
</span></span></span><span style=display:flex><span><span style=color:#e6db74>#!/bin/bash
</span></span></span><span style=display:flex><span><span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74>while true; do
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    # CPU 使用率
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    CPU_USAGE=\$(top -bn1 | grep &#34;Cpu(s)&#34; | awk &#39;{print \$2}&#39;)
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    # 内存使用率
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    MEM_USAGE=\$(free | grep Mem | awk &#39;{print \$3/\$2 * 100.0}&#39;)
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    # 进程数
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    PROCESS_COUNT=\$(ps aux | wc -l)
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    # 检查限制
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    if (( \$(echo &#34;\$CPU_USAGE &gt; 80&#34; | bc -l) )); then
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        ~/send_notification.sh &#34;警告: CPU 使用率过高 (\${CPU_USAGE}%)&#34; &#34;high&#34;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    fi
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    if (( \$(echo &#34;\$MEM_USAGE &gt; 90&#34; | bc -l) )); then
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        ~/send_notification.sh &#34;警告: 内存使用率过高 (\${MEM_USAGE}%)&#34; &#34;high&#34;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    fi
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    if [ &#34;\$PROCESS_COUNT&#34; -gt 200 ]; then
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        ~/send_notification.sh &#34;警告: 进程数过多 (\$PROCESS_COUNT)&#34; &#34;high&#34;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    fi
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    sleep 60
</span></span></span><span style=display:flex><span><span style=color:#e6db74>done
</span></span></span><span style=display:flex><span><span style=color:#e6db74>EOF</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    chmod +x ~/monitor_resources.sh
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 应用配置</span>
</span></span><span style=display:flex><span>apply_configurations<span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    log <span style=color:#e6db74>&#34;应用资源限制配置...&#34;</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#75715e># 重启服务</span>
</span></span><span style=display:flex><span>    sudo systemctl restart nginx
</span></span><span style=display:flex><span>    sudo systemctl restart llama-server
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#75715e># 启动监控</span>
</span></span><span style=display:flex><span>    ~/monitor_resources.sh &amp;
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#75715e># 验证配置</span>
</span></span><span style=display:flex><span>    log <span style=color:#e6db74>&#34;验证配置...&#34;</span>
</span></span><span style=display:flex><span>    sudo nginx -t
</span></span><span style=display:flex><span>    sudo systemctl status llama-server
</span></span><span style=display:flex><span>    ulimit -a
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 主函数</span>
</span></span><span style=display:flex><span>main<span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    log <span style=color:#e6db74>&#34;开始配置资源限制...&#34;</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    configure_system_limits
</span></span><span style=display:flex><span>    configure_ai_service
</span></span><span style=display:flex><span>    configure_nginx
</span></span><span style=display:flex><span>    configure_monitoring
</span></span><span style=display:flex><span>    apply_configurations
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    log <span style=color:#e6db74>&#34;资源限制配置完成&#34;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 执行配置</span>
</span></span><span style=display:flex><span>main
</span></span></code></pre></div><h2 id=二十九自动化测试系统>二十九、自动化测试系统</h2><h3 id=1-集成测试脚本>1. 集成测试脚本</h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># 创建集成测试脚本</span>
</span></span><span style=display:flex><span>nano ~/integration_test.sh
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e>#!/bin/bash
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#75715e># ~/integration_test.sh</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 配置</span>
</span></span><span style=display:flex><span>TEST_DIR<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;/home/zhaoxiongzhou/tests&#34;</span>
</span></span><span style=display:flex><span>REPORT_DIR<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;/home/zhaoxiongzhou/test_reports&#34;</span>
</span></span><span style=display:flex><span>LOG_FILE<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;/var/log/integration_test.log&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 确保目录存在</span>
</span></span><span style=display:flex><span>mkdir -p <span style=color:#e6db74>&#34;</span>$TEST_DIR<span style=color:#e6db74>&#34;</span> <span style=color:#e6db74>&#34;</span>$REPORT_DIR<span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 日志函数</span>
</span></span><span style=display:flex><span>log<span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    echo <span style=color:#e6db74>&#34;[</span><span style=color:#66d9ef>$(</span>date <span style=color:#e6db74>&#39;+%Y-%m-%d %H:%M:%S&#39;</span><span style=color:#66d9ef>)</span><span style=color:#e6db74>] </span>$1<span style=color:#e6db74>&#34;</span> | tee -a <span style=color:#e6db74>&#34;</span>$LOG_FILE<span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 测试 Web 服务</span>
</span></span><span style=display:flex><span>test_web_service<span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    log <span style=color:#e6db74>&#34;测试 Web 服务...&#34;</span>
</span></span><span style=display:flex><span>    local result<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#75715e># 测试首页访问</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> curl -s -o /dev/null -w <span style=color:#e6db74>&#34;%{http_code}&#34;</span> http://localhost/ | grep -q <span style=color:#e6db74>&#34;200&#34;</span>; <span style=color:#66d9ef>then</span>
</span></span><span style=display:flex><span>        log <span style=color:#e6db74>&#34;首页访问测试通过&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>else</span>
</span></span><span style=display:flex><span>        log <span style=color:#e6db74>&#34;错误: 首页访问测试失败&#34;</span>
</span></span><span style=display:flex><span>        result<span style=color:#f92672>=</span><span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>fi</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#75715e># 测试静态资源</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> curl -s -o /dev/null -w <span style=color:#e6db74>&#34;%{http_code}&#34;</span> http://localhost/css/main.css | grep -q <span style=color:#e6db74>&#34;200&#34;</span>; <span style=color:#66d9ef>then</span>
</span></span><span style=display:flex><span>        log <span style=color:#e6db74>&#34;静态资源测试通过&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>else</span>
</span></span><span style=display:flex><span>        log <span style=color:#e6db74>&#34;错误: 静态资源测试失败&#34;</span>
</span></span><span style=display:flex><span>        result<span style=color:#f92672>=</span><span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>fi</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#75715e># 测试 404 页面</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> curl -s -o /dev/null -w <span style=color:#e6db74>&#34;%{http_code}&#34;</span> http://localhost/nonexistent | grep -q <span style=color:#e6db74>&#34;404&#34;</span>; <span style=color:#66d9ef>then</span>
</span></span><span style=display:flex><span>        log <span style=color:#e6db74>&#34;404 页面测试通过&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>else</span>
</span></span><span style=display:flex><span>        log <span style=color:#e6db74>&#34;错误: 404 页面测试失败&#34;</span>
</span></span><span style=display:flex><span>        result<span style=color:#f92672>=</span><span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>fi</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> $result
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 测试 AI 服务</span>
</span></span><span style=display:flex><span>test_ai_service<span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    log <span style=color:#e6db74>&#34;测试 AI 服务...&#34;</span>
</span></span><span style=display:flex><span>    local result<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#75715e># 测试服务可用性</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> curl -s -o /dev/null -w <span style=color:#e6db74>&#34;%{http_code}&#34;</span> http://localhost:8080/health | grep -q <span style=color:#e6db74>&#34;200&#34;</span>; <span style=color:#66d9ef>then</span>
</span></span><span style=display:flex><span>        log <span style=color:#e6db74>&#34;AI 服务健康检查通过&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>else</span>
</span></span><span style=display:flex><span>        log <span style=color:#e6db74>&#34;错误: AI 服务健康检查失败&#34;</span>
</span></span><span style=display:flex><span>        result<span style=color:#f92672>=</span><span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>fi</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#75715e># 测试模型响应</span>
</span></span><span style=display:flex><span>    local response<span style=color:#f92672>=</span><span style=color:#66d9ef>$(</span>curl -s -X POST <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>        -H <span style=color:#e6db74>&#34;Content-Type: application/json&#34;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>        -d <span style=color:#e6db74>&#39;{&#34;prompt&#34;: &#34;Hello&#34;, &#34;max_tokens&#34;: 10}&#39;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>        http://localhost:8080/completion<span style=color:#66d9ef>)</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> echo <span style=color:#e6db74>&#34;</span>$response<span style=color:#e6db74>&#34;</span> | grep -q <span style=color:#e6db74>&#34;text&#34;</span>; <span style=color:#66d9ef>then</span>
</span></span><span style=display:flex><span>        log <span style=color:#e6db74>&#34;AI 服务响应测试通过&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>else</span>
</span></span><span style=display:flex><span>        log <span style=color:#e6db74>&#34;错误: AI 服务响应测试失败&#34;</span>
</span></span><span style=display:flex><span>        result<span style=color:#f92672>=</span><span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>fi</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> $result
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 测试系统服务</span>
</span></span><span style=display:flex><span>test_system_services<span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    log <span style=color:#e6db74>&#34;测试系统服务...&#34;</span>
</span></span><span style=display:flex><span>    local result<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#75715e># 测试 Nginx 状态</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> systemctl is-active --quiet nginx; <span style=color:#66d9ef>then</span>
</span></span><span style=display:flex><span>        log <span style=color:#e6db74>&#34;Nginx 服务测试通过&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>else</span>
</span></span><span style=display:flex><span>        log <span style=color:#e6db74>&#34;错误: Nginx 服务测试失败&#34;</span>
</span></span><span style=display:flex><span>        result<span style=color:#f92672>=</span><span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>fi</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#75715e># 测试系统资源</span>
</span></span><span style=display:flex><span>    local cpu_usage<span style=color:#f92672>=</span><span style=color:#66d9ef>$(</span>top -bn1 | grep <span style=color:#e6db74>&#34;Cpu(s)&#34;</span> | awk <span style=color:#e6db74>&#39;{print $2}&#39;</span><span style=color:#66d9ef>)</span>
</span></span><span style=display:flex><span>    local mem_usage<span style=color:#f92672>=</span><span style=color:#66d9ef>$(</span>free | grep Mem | awk <span style=color:#e6db74>&#39;{print $3/$2 * 100.0}&#39;</span><span style=color:#66d9ef>)</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>[</span> <span style=color:#66d9ef>$(</span>echo <span style=color:#e6db74>&#34;</span>$cpu_usage<span style=color:#e6db74> &lt; 90&#34;</span> | bc -l<span style=color:#66d9ef>)</span> -eq <span style=color:#ae81ff>1</span> <span style=color:#f92672>]</span>; <span style=color:#66d9ef>then</span>
</span></span><span style=display:flex><span>        log <span style=color:#e6db74>&#34;CPU 使用率正常&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>else</span>
</span></span><span style=display:flex><span>        log <span style=color:#e6db74>&#34;警告: CPU 使用率过高&#34;</span>
</span></span><span style=display:flex><span>        result<span style=color:#f92672>=</span><span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>fi</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>[</span> <span style=color:#66d9ef>$(</span>echo <span style=color:#e6db74>&#34;</span>$mem_usage<span style=color:#e6db74> &lt; 90&#34;</span> | bc -l<span style=color:#66d9ef>)</span> -eq <span style=color:#ae81ff>1</span> <span style=color:#f92672>]</span>; <span style=color:#66d9ef>then</span>
</span></span><span style=display:flex><span>        log <span style=color:#e6db74>&#34;内存使用率正常&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>else</span>
</span></span><span style=display:flex><span>        log <span style=color:#e6db74>&#34;警告: 内存使用率过高&#34;</span>
</span></span><span style=display:flex><span>        result<span style=color:#f92672>=</span><span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>fi</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> $result
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 生成测试报告</span>
</span></span><span style=display:flex><span>generate_report<span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    local web_result<span style=color:#f92672>=</span>$1
</span></span><span style=display:flex><span>    local ai_result<span style=color:#f92672>=</span>$2
</span></span><span style=display:flex><span>    local system_result<span style=color:#f92672>=</span>$3
</span></span><span style=display:flex><span>    local report_file<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;</span>$REPORT_DIR<span style=color:#e6db74>/test_report_</span><span style=color:#66d9ef>$(</span>date +%Y%m%d_%H%M%S<span style=color:#66d9ef>)</span><span style=color:#e6db74>.md&#34;</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        echo <span style=color:#e6db74>&#34;# 集成测试报告&#34;</span>
</span></span><span style=display:flex><span>        echo <span style=color:#e6db74>&#34;## 测试时间: </span><span style=color:#66d9ef>$(</span>date <span style=color:#e6db74>&#39;+%Y-%m-%d %H:%M:%S&#39;</span><span style=color:#66d9ef>)</span><span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>        echo
</span></span><span style=display:flex><span>        echo <span style=color:#e6db74>&#34;## 测试结果摘要&#34;</span>
</span></span><span style=display:flex><span>        echo <span style=color:#e6db74>&#34;- Web 服务: </span><span style=color:#66d9ef>$(</span><span style=color:#f92672>[</span> $web_result -eq <span style=color:#ae81ff>0</span> <span style=color:#f92672>]</span> <span style=color:#f92672>&amp;&amp;</span> echo <span style=color:#e6db74>&#39;通过 ✅&#39;</span> <span style=color:#f92672>||</span> echo <span style=color:#e6db74>&#39;失败 ❌&#39;</span><span style=color:#66d9ef>)</span><span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>        echo <span style=color:#e6db74>&#34;- AI 服务: </span><span style=color:#66d9ef>$(</span><span style=color:#f92672>[</span> $ai_result -eq <span style=color:#ae81ff>0</span> <span style=color:#f92672>]</span> <span style=color:#f92672>&amp;&amp;</span> echo <span style=color:#e6db74>&#39;通过 ✅&#39;</span> <span style=color:#f92672>||</span> echo <span style=color:#e6db74>&#39;失败 ❌&#39;</span><span style=color:#66d9ef>)</span><span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>        echo <span style=color:#e6db74>&#34;- 系统服务: </span><span style=color:#66d9ef>$(</span><span style=color:#f92672>[</span> $system_result -eq <span style=color:#ae81ff>0</span> <span style=color:#f92672>]</span> <span style=color:#f92672>&amp;&amp;</span> echo <span style=color:#e6db74>&#39;通过 ✅&#39;</span> <span style=color:#f92672>||</span> echo <span style=color:#e6db74>&#39;失败 ❌&#39;</span><span style=color:#66d9ef>)</span><span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>        echo
</span></span><span style=display:flex><span>        echo <span style=color:#e6db74>&#34;## 详细日志&#34;</span>
</span></span><span style=display:flex><span>        echo <span style=color:#e6db74>&#39;```&#39;</span>
</span></span><span style=display:flex><span>        tail -n <span style=color:#ae81ff>50</span> <span style=color:#e6db74>&#34;</span>$LOG_FILE<span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>        echo <span style=color:#e6db74>&#39;```&#39;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span> &gt; <span style=color:#e6db74>&#34;</span>$report_file<span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    log <span style=color:#e6db74>&#34;测试报告已生成: </span>$report_file<span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 主函数</span>
</span></span><span style=display:flex><span>main<span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    log <span style=color:#e6db74>&#34;开始集成测试...&#34;</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    local web_result<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>    local ai_result<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>    local system_result<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#75715e># 执行测试</span>
</span></span><span style=display:flex><span>    test_web_service
</span></span><span style=display:flex><span>    web_result<span style=color:#f92672>=</span>$?
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    test_ai_service
</span></span><span style=display:flex><span>    ai_result<span style=color:#f92672>=</span>$?
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    test_system_services
</span></span><span style=display:flex><span>    system_result<span style=color:#f92672>=</span>$?
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#75715e># 生成报告</span>
</span></span><span style=display:flex><span>    generate_report $web_result $ai_result $system_result
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#75715e># 发送通知</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>[</span> $web_result -eq <span style=color:#ae81ff>0</span> <span style=color:#f92672>]</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#f92672>[</span> $ai_result -eq <span style=color:#ae81ff>0</span> <span style=color:#f92672>]</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#f92672>[</span> $system_result -eq <span style=color:#ae81ff>0</span> <span style=color:#f92672>]</span>; <span style=color:#66d9ef>then</span>
</span></span><span style=display:flex><span>        ~/send_notification.sh <span style=color:#e6db74>&#34;集成测试全部通过&#34;</span> <span style=color:#e6db74>&#34;normal&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>else</span>
</span></span><span style=display:flex><span>        ~/send_notification.sh <span style=color:#e6db74>&#34;集成测试存在失败项，请查看报告&#34;</span> <span style=color:#e6db74>&#34;high&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>fi</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#75715e># 返回总体结果</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>$((</span> web_result <span style=color:#f92672>+</span> ai_result <span style=color:#f92672>+</span> system_result <span style=color:#66d9ef>))</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 执行测试</span>
</span></span><span style=display:flex><span>main
</span></span></code></pre></div><h2 id=三十系统状态仪表板>三十、系统状态仪表板</h2><h3 id=1-状态监控页面生成脚本>1. 状态监控页面生成脚本</h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># 创建状态页面生成脚本</span>
</span></span><span style=display:flex><span>nano ~/generate_dashboard.sh
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e>#!/bin/bash
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#75715e># ~/generate_dashboard.sh</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 配置</span>
</span></span><span style=display:flex><span>DASHBOARD_DIR<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;/var/www/html/dashboard&#34;</span>
</span></span><span style=display:flex><span>REFRESH_INTERVAL<span style=color:#f92672>=</span><span style=color:#ae81ff>60</span>  <span style=color:#75715e># 页面刷新间隔（秒）</span>
</span></span><span style=display:flex><span>LOG_FILE<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;/var/log/dashboard.log&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 确保目录存在</span>
</span></span><span style=display:flex><span>sudo mkdir -p <span style=color:#e6db74>&#34;</span>$DASHBOARD_DIR<span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 日志函数</span>
</span></span><span style=display:flex><span>log<span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    echo <span style=color:#e6db74>&#34;[</span><span style=color:#66d9ef>$(</span>date <span style=color:#e6db74>&#39;+%Y-%m-%d %H:%M:%S&#39;</span><span style=color:#66d9ef>)</span><span style=color:#e6db74>] </span>$1<span style=color:#e6db74>&#34;</span> | tee -a <span style=color:#e6db74>&#34;</span>$LOG_FILE<span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 收集系统状态数据</span>
</span></span><span style=display:flex><span>collect_system_data<span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># CPU 信息</span>
</span></span><span style=display:flex><span>    CPU_USAGE<span style=color:#f92672>=</span><span style=color:#66d9ef>$(</span>top -bn1 | grep <span style=color:#e6db74>&#34;Cpu(s)&#34;</span> | awk <span style=color:#e6db74>&#39;{print $2}&#39;</span><span style=color:#66d9ef>)</span>
</span></span><span style=display:flex><span>    CPU_TEMP<span style=color:#f92672>=</span><span style=color:#66d9ef>$(</span>vcgencmd measure_temp | sed <span style=color:#e6db74>&#39;s/temp=//&#39;</span> | sed <span style=color:#e6db74>&#39;s/&#39;</span><span style=color:#e6db74>&#34;&#39;&#34;</span><span style=color:#e6db74>&#39;C//&#39;</span><span style=color:#66d9ef>)</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#75715e># 内存信息</span>
</span></span><span style=display:flex><span>    MEM_TOTAL<span style=color:#f92672>=</span><span style=color:#66d9ef>$(</span>free -m | awk <span style=color:#e6db74>&#39;/Mem:/ {print $2}&#39;</span><span style=color:#66d9ef>)</span>
</span></span><span style=display:flex><span>    MEM_USED<span style=color:#f92672>=</span><span style=color:#66d9ef>$(</span>free -m | awk <span style=color:#e6db74>&#39;/Mem:/ {print $3}&#39;</span><span style=color:#66d9ef>)</span>
</span></span><span style=display:flex><span>    MEM_USAGE<span style=color:#f92672>=</span><span style=color:#66d9ef>$(</span>awk <span style=color:#e6db74>&#34;BEGIN {printf \&#34;%.2f\&#34;, </span>$MEM_USED<span style=color:#e6db74>/</span>$MEM_TOTAL<span style=color:#e6db74>*100}&#34;</span><span style=color:#66d9ef>)</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#75715e># 磁盘信息</span>
</span></span><span style=display:flex><span>    DISK_USAGE<span style=color:#f92672>=</span><span style=color:#66d9ef>$(</span>df -h / | awk <span style=color:#e6db74>&#39;NR==2 {print $5}&#39;</span> | sed <span style=color:#e6db74>&#39;s/%//&#39;</span><span style=color:#66d9ef>)</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#75715e># 系统负载</span>
</span></span><span style=display:flex><span>    LOAD_AVG<span style=color:#f92672>=</span><span style=color:#66d9ef>$(</span>uptime | awk -F<span style=color:#e6db74>&#39;load average:&#39;</span> <span style=color:#e6db74>&#39;{print $2}&#39;</span> | xargs<span style=color:#66d9ef>)</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#75715e># 运行时间</span>
</span></span><span style=display:flex><span>    UPTIME<span style=color:#f92672>=</span><span style=color:#66d9ef>$(</span>uptime -p<span style=color:#66d9ef>)</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 收集服务状态</span>
</span></span><span style=display:flex><span>collect_service_data<span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># Nginx 状态</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> systemctl is-active --quiet nginx; <span style=color:#66d9ef>then</span>
</span></span><span style=display:flex><span>        NGINX_STATUS<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;运行中 ✅&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>else</span>
</span></span><span style=display:flex><span>        NGINX_STATUS<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;已停止 ❌&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>fi</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#75715e># AI 服务状态</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> pgrep -f llama-server &gt; /dev/null; <span style=color:#66d9ef>then</span>
</span></span><span style=display:flex><span>        AI_STATUS<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;运行中 ✅&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>else</span>
</span></span><span style=display:flex><span>        AI_STATUS<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;已停止 ❌&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>fi</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#75715e># 获取最近的日志</span>
</span></span><span style=display:flex><span>    RECENT_LOGS<span style=color:#f92672>=</span><span style=color:#66d9ef>$(</span>tail -n <span style=color:#ae81ff>10</span> /var/log/syslog | sed <span style=color:#e6db74>&#39;s/&lt;/\&amp;lt;/g&#39;</span> | sed <span style=color:#e6db74>&#39;s/&gt;/\&amp;gt;/g&#39;</span><span style=color:#66d9ef>)</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 生成状态页面</span>
</span></span><span style=display:flex><span>generate_dashboard<span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    local timestamp<span style=color:#f92672>=</span><span style=color:#66d9ef>$(</span>date <span style=color:#e6db74>&#39;+%Y-%m-%d %H:%M:%S&#39;</span><span style=color:#66d9ef>)</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    cat &gt; <span style=color:#e6db74>&#34;</span>$DASHBOARD_DIR<span style=color:#e6db74>/index.html&#34;</span> <span style=color:#e6db74>&lt;&lt; EOF
</span></span></span><span style=display:flex><span><span style=color:#e6db74>&lt;!DOCTYPE html&gt;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>&lt;html lang=&#34;zh&#34;&gt;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>&lt;head&gt;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    &lt;meta charset=&#34;UTF-8&#34;&gt;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    &lt;meta name=&#34;viewport&#34; content=&#34;width=device-width, initial-scale=1.0&#34;&gt;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    &lt;title&gt;系统状态仪表板&lt;/title&gt;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    &lt;meta http-equiv=&#34;refresh&#34; content=&#34;$REFRESH_INTERVAL&#34;&gt;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    &lt;style&gt;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        body {
</span></span></span><span style=display:flex><span><span style=color:#e6db74>            font-family: Arial, sans-serif;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>            margin: 20px;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>            background-color: #f5f5f5;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        }
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        .container {
</span></span></span><span style=display:flex><span><span style=color:#e6db74>            max-width: 1200px;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>            margin: 0 auto;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        }
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        .card {
</span></span></span><span style=display:flex><span><span style=color:#e6db74>            background: white;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>            border-radius: 8px;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>            padding: 20px;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>            margin-bottom: 20px;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        }
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        .grid {
</span></span></span><span style=display:flex><span><span style=color:#e6db74>            display: grid;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
</span></span></span><span style=display:flex><span><span style=color:#e6db74>            gap: 20px;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        }
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        .metric {
</span></span></span><span style=display:flex><span><span style=color:#e6db74>            text-align: center;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>            padding: 15px;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>            border-radius: 4px;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>            background: #f8f9fa;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        }
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        .metric h3 {
</span></span></span><span style=display:flex><span><span style=color:#e6db74>            margin: 0;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>            color: #666;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        }
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        .metric .value {
</span></span></span><span style=display:flex><span><span style=color:#e6db74>            font-size: 24px;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>            font-weight: bold;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>            margin: 10px 0;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        }
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        .status {
</span></span></span><span style=display:flex><span><span style=color:#e6db74>            display: flex;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>            justify-content: space-between;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>            align-items: center;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>            padding: 10px;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>            border-bottom: 1px solid #eee;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        }
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        .logs {
</span></span></span><span style=display:flex><span><span style=color:#e6db74>            background: #2b2b2b;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>            color: #fff;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>            padding: 15px;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>            border-radius: 4px;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>            font-family: monospace;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>            white-space: pre-wrap;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        }
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    &lt;/style&gt;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>&lt;/head&gt;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>&lt;body&gt;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    &lt;div class=&#34;container&#34;&gt;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        &lt;h1&gt;系统状态仪表板&lt;/h1&gt;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        &lt;p&gt;最后更新: $timestamp&lt;/p&gt;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        &lt;div class=&#34;card&#34;&gt;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>            &lt;h2&gt;系统资源&lt;/h2&gt;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>            &lt;div class=&#34;grid&#34;&gt;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>                &lt;div class=&#34;metric&#34;&gt;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>                    &lt;h3&gt;CPU 使用率&lt;/h3&gt;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>                    &lt;div class=&#34;value&#34;&gt;$CPU_USAGE%&lt;/div&gt;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>                &lt;/div&gt;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>                &lt;div class=&#34;metric&#34;&gt;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>                    &lt;h3&gt;CPU 温度&lt;/h3&gt;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>                    &lt;div class=&#34;value&#34;&gt;$CPU_TEMP&lt;/div&gt;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>                &lt;/div&gt;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>                &lt;div class=&#34;metric&#34;&gt;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>                    &lt;h3&gt;内存使用率&lt;/h3&gt;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>                    &lt;div class=&#34;value&#34;&gt;$MEM_USAGE%&lt;/div&gt;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>                &lt;/div&gt;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>                &lt;div class=&#34;metric&#34;&gt;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>                    &lt;h3&gt;磁盘使用率&lt;/h3&gt;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>                    &lt;div class=&#34;value&#34;&gt;$DISK_USAGE%&lt;/div&gt;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>                &lt;/div&gt;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>            &lt;/div&gt;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        &lt;/div&gt;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        &lt;div class=&#34;card&#34;&gt;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>            &lt;h2&gt;系统信息&lt;/h2&gt;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>            &lt;div class=&#34;status&#34;&gt;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>                &lt;span&gt;系统负载:&lt;/span&gt;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>                &lt;span&gt;$LOAD_AVG&lt;/span&gt;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>            &lt;/div&gt;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>            &lt;div class=&#34;status&#34;&gt;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>                &lt;span&gt;运行时间:&lt;/span&gt;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>                &lt;span&gt;$UPTIME&lt;/span&gt;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>            &lt;/div&gt;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        &lt;/div&gt;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        &lt;div class=&#34;card&#34;&gt;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>            &lt;h2&gt;服务状态&lt;/h2&gt;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>            &lt;div class=&#34;status&#34;&gt;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>                &lt;span&gt;Nginx 服务:&lt;/span&gt;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>                &lt;span&gt;$NGINX_STATUS&lt;/span&gt;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>            &lt;/div&gt;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>            &lt;div class=&#34;status&#34;&gt;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>                &lt;span&gt;AI 服务:&lt;/span&gt;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>                &lt;span&gt;$AI_STATUS&lt;/span&gt;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>            &lt;/div&gt;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        &lt;/div&gt;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        &lt;div class=&#34;card&#34;&gt;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>            &lt;h2&gt;最近日志&lt;/h2&gt;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>            &lt;div class=&#34;logs&#34;&gt;$RECENT_LOGS&lt;/div&gt;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        &lt;/div&gt;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    &lt;/div&gt;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>&lt;/body&gt;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>&lt;/html&gt;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>EOF</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># 设置权限</span>
</span></span><span style=display:flex><span>    sudo chown www-data:www-data <span style=color:#e6db74>&#34;</span>$DASHBOARD_DIR<span style=color:#e6db74>/index.html&#34;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 主函数</span>
</span></span><span style=display:flex><span>main<span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    log <span style=color:#e6db74>&#34;开始生成状态仪表板...&#34;</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#75715e># 收集数据</span>
</span></span><span style=display:flex><span>    collect_system_data
</span></span><span style=display:flex><span>    collect_service_data
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#75715e># 生成页面</span>
</span></span><span style=display:flex><span>    generate_dashboard
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    log <span style=color:#e6db74>&#34;状态仪表板已更新&#34;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 执行生成</span>
</span></span><span style=display:flex><span>main
</span></span></code></pre></div><h2 id=三十一系统备份与恢复完整方案>三十一、系统备份与恢复完整方案</h2><h3 id=1-完整备份脚本>1. 完整备份脚本</h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># 创建完整备份脚本</span>
</span></span><span style=display:flex><span>nano ~/full_backup.sh
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e>#!/bin/bash
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#75715e># ~/full_backup.sh</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 配置</span>
</span></span><span style=display:flex><span>BACKUP_ROOT<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;/mnt/backup_drive&#34;</span>
</span></span><span style=display:flex><span>BACKUP_DIR<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;</span>$BACKUP_ROOT<span style=color:#e6db74>/system_backups&#34;</span>
</span></span><span style=display:flex><span>EXCLUDE_FILE<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;/home/zhaoxiongzhou/backup_exclude.txt&#34;</span>
</span></span><span style=display:flex><span>LOG_FILE<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;/var/log/backup.log&#34;</span>
</span></span><span style=display:flex><span>RETENTION_DAYS<span style=color:#f92672>=</span><span style=color:#ae81ff>30</span>
</span></span><span style=display:flex><span>COMPRESSION_LEVEL<span style=color:#f92672>=</span><span style=color:#ae81ff>6</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 确保备份目录存在</span>
</span></span><span style=display:flex><span>mkdir -p <span style=color:#e6db74>&#34;</span>$BACKUP_DIR<span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 日志函数</span>
</span></span><span style=display:flex><span>log<span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    echo <span style=color:#e6db74>&#34;[</span><span style=color:#66d9ef>$(</span>date <span style=color:#e6db74>&#39;+%Y-%m-%d %H:%M:%S&#39;</span><span style=color:#66d9ef>)</span><span style=color:#e6db74>] </span>$1<span style=color:#e6db74>&#34;</span> | tee -a <span style=color:#e6db74>&#34;</span>$LOG_FILE<span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 检查备份环境</span>
</span></span><span style=display:flex><span>check_environment<span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    log <span style=color:#e6db74>&#34;检查备份环境...&#34;</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#75715e># 检查备份目标目录</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> ! mountpoint -q <span style=color:#e6db74>&#34;</span>$BACKUP_ROOT<span style=color:#e6db74>&#34;</span>; <span style=color:#66d9ef>then</span>
</span></span><span style=display:flex><span>        log <span style=color:#e6db74>&#34;错误: 备份驱动器未挂载&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>fi</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#75715e># 检查可用空间</span>
</span></span><span style=display:flex><span>    local available_space<span style=color:#f92672>=</span><span style=color:#66d9ef>$(</span>df -BG <span style=color:#e6db74>&#34;</span>$BACKUP_ROOT<span style=color:#e6db74>&#34;</span> | awk <span style=color:#e6db74>&#39;NR==2 {print $4}&#39;</span> | sed <span style=color:#e6db74>&#39;s/G//&#39;</span><span style=color:#66d9ef>)</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>[</span> <span style=color:#e6db74>&#34;</span>$available_space<span style=color:#e6db74>&#34;</span> -lt <span style=color:#ae81ff>10</span> <span style=color:#f92672>]</span>; <span style=color:#66d9ef>then</span>
</span></span><span style=display:flex><span>        log <span style=color:#e6db74>&#34;错误: 备份空间不足（小于 10GB）&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>fi</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#75715e># 创建排除文件</span>
</span></span><span style=display:flex><span>    cat &gt; <span style=color:#e6db74>&#34;</span>$EXCLUDE_FILE<span style=color:#e6db74>&#34;</span> <span style=color:#e6db74>&lt;&lt; EOF
</span></span></span><span style=display:flex><span><span style=color:#e6db74>/proc/*
</span></span></span><span style=display:flex><span><span style=color:#e6db74>/sys/*
</span></span></span><span style=display:flex><span><span style=color:#e6db74>/tmp/*
</span></span></span><span style=display:flex><span><span style=color:#e6db74>/run/*
</span></span></span><span style=display:flex><span><span style=color:#e6db74>/mnt/*
</span></span></span><span style=display:flex><span><span style=color:#e6db74>/media/*
</span></span></span><span style=display:flex><span><span style=color:#e6db74>/lost+found
</span></span></span><span style=display:flex><span><span style=color:#e6db74>/var/cache/*
</span></span></span><span style=display:flex><span><span style=color:#e6db74>/var/tmp/*
</span></span></span><span style=display:flex><span><span style=color:#e6db74>/var/log/*
</span></span></span><span style=display:flex><span><span style=color:#e6db74>/home/*/Downloads/*
</span></span></span><span style=display:flex><span><span style=color:#e6db74>/home/*/.cache/*
</span></span></span><span style=display:flex><span><span style=color:#e6db74>EOF</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 停止服务</span>
</span></span><span style=display:flex><span>stop_services<span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    log <span style=color:#e6db74>&#34;停止服务...&#34;</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#75715e># 停止 Nginx</span>
</span></span><span style=display:flex><span>    sudo systemctl stop nginx
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#75715e># 停止 AI 服务</span>
</span></span><span style=display:flex><span>    pkill llama-server
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#75715e># 等待服务完全停止</span>
</span></span><span style=display:flex><span>    sleep <span style=color:#ae81ff>5</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 启动服务</span>
</span></span><span style=display:flex><span>start_services<span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    log <span style=color:#e6db74>&#34;启动服务...&#34;</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#75715e># 启动 Nginx</span>
</span></span><span style=display:flex><span>    sudo systemctl start nginx
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#75715e># 启动 AI 服务</span>
</span></span><span style=display:flex><span>    ~/projects/llama.cpp/start-llama.sh
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#75715e># 验证服务状态</span>
</span></span><span style=display:flex><span>    sleep <span style=color:#ae81ff>10</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> ! systemctl is-active --quiet nginx; <span style=color:#66d9ef>then</span>
</span></span><span style=display:flex><span>        log <span style=color:#e6db74>&#34;警告: Nginx 服务未能正常启动&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>fi</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> ! pgrep -f llama-server &gt; /dev/null; <span style=color:#66d9ef>then</span>
</span></span><span style=display:flex><span>        log <span style=color:#e6db74>&#34;警告: AI 服务未能正常启动&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>fi</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 创建完整备份</span>
</span></span><span style=display:flex><span>create_full_backup<span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    local backup_date<span style=color:#f92672>=</span><span style=color:#66d9ef>$(</span>date +%Y%m%d_%H%M%S<span style=color:#66d9ef>)</span>
</span></span><span style=display:flex><span>    local backup_file<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;</span>$BACKUP_DIR<span style=color:#e6db74>/full_backup_</span><span style=color:#e6db74>${</span>backup_date<span style=color:#e6db74>}</span><span style=color:#e6db74>.tar.gz&#34;</span>
</span></span><span style=display:flex><span>    local manifest_file<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;</span>$BACKUP_DIR<span style=color:#e6db74>/backup_manifest_</span><span style=color:#e6db74>${</span>backup_date<span style=color:#e6db74>}</span><span style=color:#e6db74>.txt&#34;</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    log <span style=color:#e6db74>&#34;开始创建完整备份...&#34;</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#75715e># 创建文件清单</span>
</span></span><span style=display:flex><span>    log <span style=color:#e6db74>&#34;生成文件清单...&#34;</span>
</span></span><span style=display:flex><span>    find / -xdev -type f ! -path <span style=color:#e6db74>&#34;</span><span style=color:#66d9ef>$(</span>cat $EXCLUDE_FILE | tr <span style=color:#e6db74>&#39;\n&#39;</span> <span style=color:#e6db74>&#39;|&#39;</span><span style=color:#66d9ef>)</span><span style=color:#e6db74>&#34;</span> &gt; <span style=color:#e6db74>&#34;</span>$manifest_file<span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#75715e># 创建备份</span>
</span></span><span style=display:flex><span>    log <span style=color:#e6db74>&#34;创建系统备份...&#34;</span>
</span></span><span style=display:flex><span>    sudo tar -czf <span style=color:#e6db74>&#34;</span>$backup_file<span style=color:#e6db74>&#34;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>        --exclude-from<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;</span>$EXCLUDE_FILE<span style=color:#e6db74>&#34;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>        --one-file-system <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>        --preserve-permissions <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>        --numeric-owner <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>        --checkpoint<span style=color:#f92672>=</span><span style=color:#ae81ff>1000</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>        --checkpoint-action<span style=color:#f92672>=</span>dot <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>        -C / .
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#75715e># 验证备份</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> ! tar -tzf <span style=color:#e6db74>&#34;</span>$backup_file<span style=color:#e6db74>&#34;</span> &gt;/dev/null 2&gt;&amp;1; <span style=color:#66d9ef>then</span>
</span></span><span style=display:flex><span>        log <span style=color:#e6db74>&#34;错误: 备份文件验证失败&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>fi</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#75715e># 计算校验和</span>
</span></span><span style=display:flex><span>    log <span style=color:#e6db74>&#34;计算校验和...&#34;</span>
</span></span><span style=display:flex><span>    sha256sum <span style=color:#e6db74>&#34;</span>$backup_file<span style=color:#e6db74>&#34;</span> &gt; <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>${</span>backup_file<span style=color:#e6db74>}</span><span style=color:#e6db74>.sha256&#34;</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#75715e># 创建备份信息文件</span>
</span></span><span style=display:flex><span>    cat &gt; <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>${</span>backup_file<span style=color:#e6db74>}</span><span style=color:#e6db74>.info&#34;</span> <span style=color:#e6db74>&lt;&lt; EOF
</span></span></span><span style=display:flex><span><span style=color:#e6db74>备份时间: $(date)
</span></span></span><span style=display:flex><span><span style=color:#e6db74>系统版本: $(cat /etc/os-release | grep PRETTY_NAME)
</span></span></span><span style=display:flex><span><span style=color:#e6db74>内核版本: $(uname -r)
</span></span></span><span style=display:flex><span><span style=color:#e6db74>备份大小: $(du -h &#34;$backup_file&#34; | cut -f1)
</span></span></span><span style=display:flex><span><span style=color:#e6db74>文件数量: $(wc -l &lt; &#34;$manifest_file&#34;)
</span></span></span><span style=display:flex><span><span style=color:#e6db74>排除规则: $(cat &#34;$EXCLUDE_FILE&#34;)
</span></span></span><span style=display:flex><span><span style=color:#e6db74>EOF</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 清理旧备份</span>
</span></span><span style=display:flex><span>cleanup_old_backups<span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    log <span style=color:#e6db74>&#34;清理旧备份...&#34;</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    find <span style=color:#e6db74>&#34;</span>$BACKUP_DIR<span style=color:#e6db74>&#34;</span> -type f -name <span style=color:#e6db74>&#34;full_backup_*&#34;</span> -mtime +$RETENTION_DAYS -delete
</span></span><span style=display:flex><span>    find <span style=color:#e6db74>&#34;</span>$BACKUP_DIR<span style=color:#e6db74>&#34;</span> -type f -name <span style=color:#e6db74>&#34;backup_manifest_*&#34;</span> -mtime +$RETENTION_DAYS -delete
</span></span><span style=display:flex><span>    find <span style=color:#e6db74>&#34;</span>$BACKUP_DIR<span style=color:#e6db74>&#34;</span> -type f -name <span style=color:#e6db74>&#34;*.sha256&#34;</span> -mtime +$RETENTION_DAYS -delete
</span></span><span style=display:flex><span>    find <span style=color:#e6db74>&#34;</span>$BACKUP_DIR<span style=color:#e6db74>&#34;</span> -type f -name <span style=color:#e6db74>&#34;*.info&#34;</span> -mtime +$RETENTION_DAYS -delete
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 主函数</span>
</span></span><span style=display:flex><span>main<span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    log <span style=color:#e6db74>&#34;开始完整备份流程...&#34;</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#75715e># 检查环境</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> ! check_environment; <span style=color:#66d9ef>then</span>
</span></span><span style=display:flex><span>        log <span style=color:#e6db74>&#34;备份环境检查失败，终止备份&#34;</span>
</span></span><span style=display:flex><span>        ~/send_notification.sh <span style=color:#e6db74>&#34;系统备份失败：环境检查未通过&#34;</span> <span style=color:#e6db74>&#34;high&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>fi</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#75715e># 停止服务</span>
</span></span><span style=display:flex><span>    stop_services
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#75715e># 创建备份</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> create_full_backup; <span style=color:#66d9ef>then</span>
</span></span><span style=display:flex><span>        log <span style=color:#e6db74>&#34;备份创建成功&#34;</span>
</span></span><span style=display:flex><span>        ~/send_notification.sh <span style=color:#e6db74>&#34;系统完整备份已成功创建&#34;</span> <span style=color:#e6db74>&#34;normal&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>else</span>
</span></span><span style=display:flex><span>        log <span style=color:#e6db74>&#34;备份创建失败&#34;</span>
</span></span><span style=display:flex><span>        ~/send_notification.sh <span style=color:#e6db74>&#34;系统备份失败：备份创建过程出错&#34;</span> <span style=color:#e6db74>&#34;high&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>fi</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#75715e># 启动服务</span>
</span></span><span style=display:flex><span>    start_services
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#75715e># 清理旧备份</span>
</span></span><span style=display:flex><span>    cleanup_old_backups
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    log <span style=color:#e6db74>&#34;备份流程完成&#34;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 执行备份</span>
</span></span><span style=display:flex><span>main
</span></span></code></pre></div><h2 id=三十二系统恢复脚本>三十二、系统恢复脚本</h2><h3 id=1-系统恢复脚本-1>1. 系统恢复脚本</h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># 创建系统恢复脚本</span>
</span></span><span style=display:flex><span>nano ~/system_restore.sh
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e>#!/bin/bash
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#75715e># ~/system_restore.sh</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 配置</span>
</span></span><span style=display:flex><span>BACKUP_ROOT<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;/mnt/backup_drive&#34;</span>
</span></span><span style=display:flex><span>BACKUP_DIR<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;</span>$BACKUP_ROOT<span style=color:#e6db74>/system_backups&#34;</span>
</span></span><span style=display:flex><span>LOG_FILE<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;/var/log/restore.log&#34;</span>
</span></span><span style=display:flex><span>TEMP_DIR<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;/tmp/restore_temp&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 日志函数</span>
</span></span><span style=display:flex><span>log<span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    echo <span style=color:#e6db74>&#34;[</span><span style=color:#66d9ef>$(</span>date <span style=color:#e6db74>&#39;+%Y-%m-%d %H:%M:%S&#39;</span><span style=color:#66d9ef>)</span><span style=color:#e6db74>] </span>$1<span style=color:#e6db74>&#34;</span> | tee -a <span style=color:#e6db74>&#34;</span>$LOG_FILE<span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 验证备份文件</span>
</span></span><span style=display:flex><span>verify_backup<span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    local backup_file<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;</span>$1<span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>    log <span style=color:#e6db74>&#34;验证备份文件: </span>$backup_file<span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#75715e># 检查文件是否存在</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>[</span> ! -f <span style=color:#e6db74>&#34;</span>$backup_file<span style=color:#e6db74>&#34;</span> <span style=color:#f92672>]</span>; <span style=color:#66d9ef>then</span>
</span></span><span style=display:flex><span>        log <span style=color:#e6db74>&#34;错误: 备份文件不存在&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>fi</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#75715e># 检查校验和</span>
</span></span><span style=display:flex><span>    local checksum_file<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;</span><span style=color:#e6db74>${</span>backup_file<span style=color:#e6db74>}</span><span style=color:#e6db74>.sha256&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>[</span> -f <span style=color:#e6db74>&#34;</span>$checksum_file<span style=color:#e6db74>&#34;</span> <span style=color:#f92672>]</span>; <span style=color:#66d9ef>then</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> ! sha256sum -c <span style=color:#e6db74>&#34;</span>$checksum_file<span style=color:#e6db74>&#34;</span>; <span style=color:#66d9ef>then</span>
</span></span><span style=display:flex><span>            log <span style=color:#e6db74>&#34;错误: 备份文件校验和验证失败&#34;</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>fi</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>else</span>
</span></span><span style=display:flex><span>        log <span style=color:#e6db74>&#34;警告: 未找到校验和文件&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>fi</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#75715e># 测试归档完整性</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> ! tar -tzf <span style=color:#e6db74>&#34;</span>$backup_file<span style=color:#e6db74>&#34;</span> &gt;/dev/null 2&gt;&amp;1; <span style=color:#66d9ef>then</span>
</span></span><span style=display:flex><span>        log <span style=color:#e6db74>&#34;错误: 备份文件损坏&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>fi</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 准备恢复环境</span>
</span></span><span style=display:flex><span>prepare_environment<span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    log <span style=color:#e6db74>&#34;准备恢复环境...&#34;</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#75715e># 创建临时目录</span>
</span></span><span style=display:flex><span>    mkdir -p <span style=color:#e6db74>&#34;</span>$TEMP_DIR<span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#75715e># 停止所有服务</span>
</span></span><span style=display:flex><span>    log <span style=color:#e6db74>&#34;停止服务...&#34;</span>
</span></span><span style=display:flex><span>    sudo systemctl stop nginx
</span></span><span style=display:flex><span>    pkill llama-server
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#75715e># 等待服务停止</span>
</span></span><span style=display:flex><span>    sleep <span style=color:#ae81ff>5</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#75715e># 清理目标目录</span>
</span></span><span style=display:flex><span>    log <span style=color:#e6db74>&#34;清理目标目录...&#34;</span>
</span></span><span style=display:flex><span>    read -p <span style=color:#e6db74>&#34;警告: 这将清除系统文件。确定要继续吗？(y/n) &#34;</span> -n <span style=color:#ae81ff>1</span> -r
</span></span><span style=display:flex><span>    echo
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>[[</span> ! $REPLY <span style=color:#f92672>=</span>~ ^<span style=color:#f92672>[</span>Yy<span style=color:#f92672>]</span>$ <span style=color:#f92672>]]</span>; <span style=color:#66d9ef>then</span>
</span></span><span style=display:flex><span>        log <span style=color:#e6db74>&#34;用户取消操作&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>fi</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 执行恢复</span>
</span></span><span style=display:flex><span>perform_restore<span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    local backup_file<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;</span>$1<span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>    log <span style=color:#e6db74>&#34;开始恢复系统...&#34;</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#75715e># 创建恢复前的快照</span>
</span></span><span style=display:flex><span>    log <span style=color:#e6db74>&#34;创建当前系统快照...&#34;</span>
</span></span><span style=display:flex><span>    local snapshot_date<span style=color:#f92672>=</span><span style=color:#66d9ef>$(</span>date +%Y%m%d_%H%M%S<span style=color:#66d9ef>)</span>
</span></span><span style=display:flex><span>    local snapshot_file<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;</span>$BACKUP_DIR<span style=color:#e6db74>/pre_restore_snapshot_</span><span style=color:#e6db74>${</span>snapshot_date<span style=color:#e6db74>}</span><span style=color:#e6db74>.tar.gz&#34;</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    sudo tar -czf <span style=color:#e6db74>&#34;</span>$snapshot_file<span style=color:#e6db74>&#34;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>        --exclude-from<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;/home/zhaoxiongzhou/backup_exclude.txt&#34;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>        --one-file-system <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>        -C / .
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#75715e># 解压备份</span>
</span></span><span style=display:flex><span>    log <span style=color:#e6db74>&#34;解压备份文件...&#34;</span>
</span></span><span style=display:flex><span>    sudo tar -xzf <span style=color:#e6db74>&#34;</span>$backup_file<span style=color:#e6db74>&#34;</span> -C / <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>        --numeric-owner <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>        --preserve-permissions <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>        --checkpoint<span style=color:#f92672>=</span><span style=color:#ae81ff>1000</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>        --checkpoint-action<span style=color:#f92672>=</span>dot
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#75715e># 修复权限</span>
</span></span><span style=display:flex><span>    log <span style=color:#e6db74>&#34;修复文件权限...&#34;</span>
</span></span><span style=display:flex><span>    sudo chown -R www-data:www-data /var/www/
</span></span><span style=display:flex><span>    sudo chown -R zhaoxiongzhou:zhaoxiongzhou /home/zhaoxiongzhou/
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 恢复服务配置</span>
</span></span><span style=display:flex><span>restore_configurations<span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    log <span style=color:#e6db74>&#34;恢复服务配置...&#34;</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#75715e># 重新加载系统配置</span>
</span></span><span style=display:flex><span>    sudo systemctl daemon-reload
</span></span><span style=display:flex><span>    sudo sysctl --system
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#75715e># 重新配置网络</span>
</span></span><span style=display:flex><span>    sudo systemctl restart networking
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#75715e># 恢复防火墙规则</span>
</span></span><span style=display:flex><span>    sudo iptables-restore &lt; /etc/iptables/rules.v4
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 验证恢复</span>
</span></span><span style=display:flex><span>verify_restore<span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    log <span style=color:#e6db74>&#34;验证系统恢复...&#34;</span>
</span></span><span style=display:flex><span>    local status<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#75715e># 检查关键文件</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>for</span> file in <span style=color:#e6db74>&#34;/etc/nginx/nginx.conf&#34;</span> <span style=color:#e6db74>&#34;/etc/systemd/system/llama-server.service&#34;</span>; <span style=color:#66d9ef>do</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#f92672>[</span> ! -f <span style=color:#e6db74>&#34;</span>$file<span style=color:#e6db74>&#34;</span> <span style=color:#f92672>]</span>; <span style=color:#66d9ef>then</span>
</span></span><span style=display:flex><span>            log <span style=color:#e6db74>&#34;错误: 未找到关键文件 </span>$file<span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>            status<span style=color:#f92672>=</span><span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>fi</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>done</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#75715e># 启动服务</span>
</span></span><span style=display:flex><span>    sudo systemctl start nginx
</span></span><span style=display:flex><span>    ~/projects/llama.cpp/start-llama.sh
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#75715e># 验证服务状态</span>
</span></span><span style=display:flex><span>    sleep <span style=color:#ae81ff>10</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> ! systemctl is-active --quiet nginx; <span style=color:#66d9ef>then</span>
</span></span><span style=display:flex><span>        log <span style=color:#e6db74>&#34;错误: Nginx 服务未能正常启动&#34;</span>
</span></span><span style=display:flex><span>        status<span style=color:#f92672>=</span><span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>fi</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> ! pgrep -f llama-server &gt; /dev/null; <span style=color:#66d9ef>then</span>
</span></span><span style=display:flex><span>        log <span style=color:#e6db74>&#34;错误: AI 服务未能正常启动&#34;</span>
</span></span><span style=display:flex><span>        status<span style=color:#f92672>=</span><span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>fi</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> $status
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 清理恢复环境</span>
</span></span><span style=display:flex><span>cleanup<span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    log <span style=color:#e6db74>&#34;清理恢复环境...&#34;</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#75715e># 删除临时文件</span>
</span></span><span style=display:flex><span>    rm -rf <span style=color:#e6db74>&#34;</span>$TEMP_DIR<span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#75715e># 清理日志</span>
</span></span><span style=display:flex><span>    find /var/log -type f -name <span style=color:#e6db74>&#34;*.gz&#34;</span> -delete
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 主函数</span>
</span></span><span style=display:flex><span>main<span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    local backup_file
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#75715e># 列出可用备份</span>
</span></span><span style=display:flex><span>    echo <span style=color:#e6db74>&#34;可用的备份文件:&#34;</span>
</span></span><span style=display:flex><span>    ls -lh <span style=color:#e6db74>&#34;</span>$BACKUP_DIR<span style=color:#e6db74>&#34;</span>/full_backup_*.tar.gz
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#75715e># 选择备份文件</span>
</span></span><span style=display:flex><span>    read -p <span style=color:#e6db74>&#34;请输入要恢复的备份文件完整路径: &#34;</span> backup_file
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#75715e># 验证备份</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> ! verify_backup <span style=color:#e6db74>&#34;</span>$backup_file<span style=color:#e6db74>&#34;</span>; <span style=color:#66d9ef>then</span>
</span></span><span style=display:flex><span>        log <span style=color:#e6db74>&#34;备份验证失败，终止恢复&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>fi</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#75715e># 准备环境</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> ! prepare_environment; <span style=color:#66d9ef>then</span>
</span></span><span style=display:flex><span>        log <span style=color:#e6db74>&#34;环境准备失败，终止恢复&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>fi</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#75715e># 执行恢复</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> perform_restore <span style=color:#e6db74>&#34;</span>$backup_file<span style=color:#e6db74>&#34;</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>       restore_configurations <span style=color:#f92672>&amp;&amp;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>       verify_restore; <span style=color:#66d9ef>then</span>
</span></span><span style=display:flex><span>        log <span style=color:#e6db74>&#34;系统恢复成功完成&#34;</span>
</span></span><span style=display:flex><span>        ~/send_notification.sh <span style=color:#e6db74>&#34;系统恢复成功完成&#34;</span> <span style=color:#e6db74>&#34;normal&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>else</span>
</span></span><span style=display:flex><span>        log <span style=color:#e6db74>&#34;系统恢复失败&#34;</span>
</span></span><span style=display:flex><span>        ~/send_notification.sh <span style=color:#e6db74>&#34;系统恢复失败，需要手动检查&#34;</span> <span style=color:#e6db74>&#34;high&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>fi</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#75715e># 清理环境</span>
</span></span><span style=display:flex><span>    cleanup
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 执行恢复</span>
</span></span><span style=display:flex><span>main
</span></span></code></pre></div><h2 id=三十三系统迁移工具>三十三、系统迁移工具</h2><h3 id=1-系统迁移脚本>1. 系统迁移脚本</h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># 创建系统迁移脚本</span>
</span></span><span style=display:flex><span>nano ~/system_migration.sh
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e>#!/bin/bash
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#75715e># ~/system_migration.sh</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 配置</span>
</span></span><span style=display:flex><span>SOURCE_HOST<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;old-raspberry.local&#34;</span>
</span></span><span style=display:flex><span>TARGET_HOST<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;new-raspberry.local&#34;</span>
</span></span><span style=display:flex><span>MIGRATION_DIR<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;/mnt/migration&#34;</span>
</span></span><span style=display:flex><span>LOG_FILE<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;/var/log/migration.log&#34;</span>
</span></span><span style=display:flex><span>SSH_KEY<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;~/.ssh/migration_key&#34;</span>
</span></span><span style=display:flex><span>RSYNC_OPTS<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;-avz --progress --delete&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 日志函数</span>
</span></span><span style=display:flex><span>log<span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    echo <span style=color:#e6db74>&#34;[</span><span style=color:#66d9ef>$(</span>date <span style=color:#e6db74>&#39;+%Y-%m-%d %H:%M:%S&#39;</span><span style=color:#66d9ef>)</span><span style=color:#e6db74>] </span>$1<span style=color:#e6db74>&#34;</span> | tee -a <span style=color:#e6db74>&#34;</span>$LOG_FILE<span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 检查迁移环境</span>
</span></span><span style=display:flex><span>check_migration_env<span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    log <span style=color:#e6db74>&#34;检查迁移环境...&#34;</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#75715e># 检查 SSH 密钥</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>[</span> ! -f <span style=color:#e6db74>&#34;</span>$SSH_KEY<span style=color:#e6db74>&#34;</span> <span style=color:#f92672>]</span>; <span style=color:#66d9ef>then</span>
</span></span><span style=display:flex><span>        log <span style=color:#e6db74>&#34;生成 SSH 密钥...&#34;</span>
</span></span><span style=display:flex><span>        ssh-keygen -t ed25519 -f <span style=color:#e6db74>&#34;</span>$SSH_KEY<span style=color:#e6db74>&#34;</span> -N <span style=color:#e6db74>&#34;&#34;</span>
</span></span><span style=display:flex><span>        
</span></span><span style=display:flex><span>        <span style=color:#75715e># 复制密钥到目标主机</span>
</span></span><span style=display:flex><span>        ssh-copy-id -i <span style=color:#e6db74>&#34;</span>$SSH_KEY<span style=color:#e6db74>&#34;</span> <span style=color:#e6db74>&#34;zhaoxiongzhou@</span>$TARGET_HOST<span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>fi</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#75715e># 检查必要工具</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>for</span> tool in rsync ssh scp; <span style=color:#66d9ef>do</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> ! command -v $tool &amp;&gt;/dev/null; <span style=color:#66d9ef>then</span>
</span></span><span style=display:flex><span>            log <span style=color:#e6db74>&#34;错误: 未找到必要工具 </span>$tool<span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>fi</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>done</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#75715e># 检查目标主机连接</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> ! ssh -i <span style=color:#e6db74>&#34;</span>$SSH_KEY<span style=color:#e6db74>&#34;</span> <span style=color:#e6db74>&#34;zhaoxiongzhou@</span>$TARGET_HOST<span style=color:#e6db74>&#34;</span> <span style=color:#e6db74>&#34;echo &#39;Connection test&#39;&#34;</span> &amp;&gt;/dev/null; <span style=color:#66d9ef>then</span>
</span></span><span style=display:flex><span>        log <span style=color:#e6db74>&#34;错误: 无法连接到目标主机&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>fi</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 迁移配置文件</span>
</span></span><span style=display:flex><span>migrate_configs<span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    log <span style=color:#e6db74>&#34;迁移配置文件...&#34;</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#75715e># 创建配置目录</span>
</span></span><span style=display:flex><span>    ssh -i <span style=color:#e6db74>&#34;</span>$SSH_KEY<span style=color:#e6db74>&#34;</span> <span style=color:#e6db74>&#34;zhaoxiongzhou@</span>$TARGET_HOST<span style=color:#e6db74>&#34;</span> <span style=color:#e6db74>&#34;mkdir -p ~/configs_backup&#34;</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#75715e># 迁移 Nginx 配置</span>
</span></span><span style=display:flex><span>    rsync $RSYNC_OPTS -e <span style=color:#e6db74>&#34;ssh -i </span>$SSH_KEY<span style=color:#e6db74>&#34;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>        /etc/nginx/ <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>        <span style=color:#e6db74>&#34;zhaoxiongzhou@</span>$TARGET_HOST<span style=color:#e6db74>:~/configs_backup/nginx/&#34;</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#75715e># 迁移系统配置</span>
</span></span><span style=display:flex><span>    rsync $RSYNC_OPTS -e <span style=color:#e6db74>&#34;ssh -i </span>$SSH_KEY<span style=color:#e6db74>&#34;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>        /etc/sysctl.d/ <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>        <span style=color:#e6db74>&#34;zhaoxiongzhou@</span>$TARGET_HOST<span style=color:#e6db74>:~/configs_backup/sysctl/&#34;</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#75715e># 迁移服务配置</span>
</span></span><span style=display:flex><span>    rsync $RSYNC_OPTS -e <span style=color:#e6db74>&#34;ssh -i </span>$SSH_KEY<span style=color:#e6db74>&#34;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>        /etc/systemd/system/ <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>        <span style=color:#e6db74>&#34;zhaoxiongzhou@</span>$TARGET_HOST<span style=color:#e6db74>:~/configs_backup/systemd/&#34;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 迁移数据</span>
</span></span><span style=display:flex><span>migrate_data<span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    log <span style=color:#e6db74>&#34;迁移数据...&#34;</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#75715e># 迁移博客数据</span>
</span></span><span style=display:flex><span>    rsync $RSYNC_OPTS -e <span style=color:#e6db74>&#34;ssh -i </span>$SSH_KEY<span style=color:#e6db74>&#34;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>        ~/myblog/ <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>        <span style=color:#e6db74>&#34;zhaoxiongzhou@</span>$TARGET_HOST<span style=color:#e6db74>:~/myblog/&#34;</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#75715e># 迁移 AI 服务数据</span>
</span></span><span style=display:flex><span>    rsync $RSYNC_OPTS -e <span style=color:#e6db74>&#34;ssh -i </span>$SSH_KEY<span style=color:#e6db74>&#34;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>        ~/projects/llama.cpp/ <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>        <span style=color:#e6db74>&#34;zhaoxiongzhou@</span>$TARGET_HOST<span style=color:#e6db74>:~/projects/llama.cpp/&#34;</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#75715e># 迁移用户脚本</span>
</span></span><span style=display:flex><span>    rsync $RSYNC_OPTS -e <span style=color:#e6db74>&#34;ssh -i </span>$SSH_KEY<span style=color:#e6db74>&#34;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>        ~/*.sh <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>        <span style=color:#e6db74>&#34;zhaoxiongzhou@</span>$TARGET_HOST<span style=color:#e6db74>:~/&#34;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 迁移数据库</span>
</span></span><span style=display:flex><span>migrate_database<span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    log <span style=color:#e6db74>&#34;迁移数据库...&#34;</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#75715e># 导出数据库</span>
</span></span><span style=display:flex><span>    local dump_file<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;/tmp/database_dump.sql&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>[</span> -f <span style=color:#e6db74>&#34;/var/lib/mysql&#34;</span> <span style=color:#f92672>]</span>; <span style=color:#66d9ef>then</span>
</span></span><span style=display:flex><span>        mysqldump --all-databases &gt; <span style=color:#e6db74>&#34;</span>$dump_file<span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>        
</span></span><span style=display:flex><span>        <span style=color:#75715e># 传输到目标主机</span>
</span></span><span style=display:flex><span>        scp -i <span style=color:#e6db74>&#34;</span>$SSH_KEY<span style=color:#e6db74>&#34;</span> <span style=color:#e6db74>&#34;</span>$dump_file<span style=color:#e6db74>&#34;</span> <span style=color:#e6db74>&#34;zhaoxiongzhou@</span>$TARGET_HOST<span style=color:#e6db74>:/tmp/&#34;</span>
</span></span><span style=display:flex><span>        
</span></span><span style=display:flex><span>        <span style=color:#75715e># 在目标主机导入数据库</span>
</span></span><span style=display:flex><span>        ssh -i <span style=color:#e6db74>&#34;</span>$SSH_KEY<span style=color:#e6db74>&#34;</span> <span style=color:#e6db74>&#34;zhaoxiongzhou@</span>$TARGET_HOST<span style=color:#e6db74>&#34;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>            <span style=color:#e6db74>&#34;mysql &lt; /tmp/database_dump.sql&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>fi</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 配置目标系统</span>
</span></span><span style=display:flex><span>configure_target<span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    log <span style=color:#e6db74>&#34;配置目标系统...&#34;</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    ssh -i <span style=color:#e6db74>&#34;</span>$SSH_KEY<span style=color:#e6db74>&#34;</span> <span style=color:#e6db74>&#34;zhaoxiongzhou@</span>$TARGET_HOST<span style=color:#e6db74>&#34;</span> <span style=color:#e6db74>&#34;bash -s&#34;</span> <span style=color:#e6db74>&lt;&lt; &#39;EOF&#39;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        # 安装必要软件
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        sudo apt update
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        sudo apt install -y nginx mysql-server python3 pip
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        # 恢复配置
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        sudo cp -r ~/configs_backup/nginx/* /etc/nginx/
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        sudo cp -r ~/configs_backup/sysctl/* /etc/sysctl.d/
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        sudo cp -r ~/configs_backup/systemd/* /etc/systemd/system/
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        # 设置权限
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        sudo chown -R www-data:www-data /var/www/
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        sudo chmod +x ~/*.sh
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        # 重启服务
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        sudo systemctl daemon-reload
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        sudo systemctl restart nginx
</span></span></span><span style=display:flex><span><span style=color:#e6db74>EOF</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 验证迁移</span>
</span></span><span style=display:flex><span>verify_migration<span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    log <span style=color:#e6db74>&#34;验证迁移...&#34;</span>
</span></span><span style=display:flex><span>    local status<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#75715e># 检查服务状态</span>
</span></span><span style=display:flex><span>    ssh -i <span style=color:#e6db74>&#34;</span>$SSH_KEY<span style=color:#e6db74>&#34;</span> <span style=color:#e6db74>&#34;zhaoxiongzhou@</span>$TARGET_HOST<span style=color:#e6db74>&#34;</span> <span style=color:#e6db74>&#34;bash -s&#34;</span> <span style=color:#e6db74>&lt;&lt; &#39;EOF&#39;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        # 检查 Nginx
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        if ! systemctl is-active --quiet nginx; then
</span></span></span><span style=display:flex><span><span style=color:#e6db74>            echo &#34;错误: Nginx 服务未运行&#34;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>            exit 1
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        fi
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        # 检查文件
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        for dir in &#34;~/myblog&#34; &#34;~/projects/llama.cpp&#34;; do
</span></span></span><span style=display:flex><span><span style=color:#e6db74>            if [ ! -d &#34;$dir&#34; ]; then
</span></span></span><span style=display:flex><span><span style=color:#e6db74>                echo &#34;错误: 目录 $dir 不存在&#34;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>                exit 1
</span></span></span><span style=display:flex><span><span style=color:#e6db74>            fi
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        done
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        # 检查配置
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        if ! nginx -t &amp;&gt;/dev/null; then
</span></span></span><span style=display:flex><span><span style=color:#e6db74>            echo &#34;错误: Nginx 配置无效&#34;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>            exit 1
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        fi
</span></span></span><span style=display:flex><span><span style=color:#e6db74>EOF</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    status<span style=color:#f92672>=</span>$?
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> $status
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 主函数</span>
</span></span><span style=display:flex><span>main<span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    log <span style=color:#e6db74>&#34;开始系统迁移...&#34;</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#75715e># 检查环境</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> ! check_migration_env; <span style=color:#66d9ef>then</span>
</span></span><span style=display:flex><span>        log <span style=color:#e6db74>&#34;迁移环境检查失败&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>fi</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#75715e># 执行迁移</span>
</span></span><span style=display:flex><span>    migrate_configs
</span></span><span style=display:flex><span>    migrate_data
</span></span><span style=display:flex><span>    migrate_database
</span></span><span style=display:flex><span>    configure_target
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#75715e># 验证迁移</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> verify_migration; <span style=color:#66d9ef>then</span>
</span></span><span style=display:flex><span>        log <span style=color:#e6db74>&#34;系统迁移成功完成&#34;</span>
</span></span><span style=display:flex><span>        ~/send_notification.sh <span style=color:#e6db74>&#34;系统迁移成功完成&#34;</span> <span style=color:#e6db74>&#34;normal&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>else</span>
</span></span><span style=display:flex><span>        log <span style=color:#e6db74>&#34;系统迁移失败&#34;</span>
</span></span><span style=display:flex><span>        ~/send_notification.sh <span style=color:#e6db74>&#34;系统迁移失败，需要手动检查&#34;</span> <span style=color:#e6db74>&#34;high&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>fi</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 执行迁移</span>
</span></span><span style=display:flex><span>main
</span></span></code></pre></div><h2 id=三十四日志分析工具>三十四、日志分析工具</h2><h3 id=1-日志分析脚本>1. 日志分析脚本</h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># 创建日志分析脚本</span>
</span></span><span style=display:flex><span>nano ~/log_analyzer.sh
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e>#!/bin/bash
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#75715e># ~/log_analyzer.sh</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 配置</span>
</span></span><span style=display:flex><span>LOG_DIRS<span style=color:#f92672>=(</span>
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;/var/log&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;/var/log/nginx&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;/home/zhaoxiongzhou/logs&#34;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>REPORT_DIR<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;/home/zhaoxiongzhou/log_reports&#34;</span>
</span></span><span style=display:flex><span>LOG_FILE<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;/var/log/analyzer.log&#34;</span>
</span></span><span style=display:flex><span>ALERT_THRESHOLD<span style=color:#f92672>=</span><span style=color:#ae81ff>100</span>  <span style=color:#75715e># 错误日志阈值</span>
</span></span><span style=display:flex><span>RETENTION_DAYS<span style=color:#f92672>=</span><span style=color:#ae81ff>30</span>    <span style=color:#75715e># 报告保留天数</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 确保目录存在</span>
</span></span><span style=display:flex><span>mkdir -p <span style=color:#e6db74>&#34;</span>$REPORT_DIR<span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 日志函数</span>
</span></span><span style=display:flex><span>log<span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    echo <span style=color:#e6db74>&#34;[</span><span style=color:#66d9ef>$(</span>date <span style=color:#e6db74>&#39;+%Y-%m-%d %H:%M:%S&#39;</span><span style=color:#66d9ef>)</span><span style=color:#e6db74>] </span>$1<span style=color:#e6db74>&#34;</span> | tee -a <span style=color:#e6db74>&#34;</span>$LOG_FILE<span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 分析系统日志</span>
</span></span><span style=display:flex><span>analyze_system_logs<span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    log <span style=color:#e6db74>&#34;分析系统日志...&#34;</span>
</span></span><span style=display:flex><span>    local report_file<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;</span>$REPORT_DIR<span style=color:#e6db74>/system_log_report_</span><span style=color:#66d9ef>$(</span>date +%Y%m%d<span style=color:#66d9ef>)</span><span style=color:#e6db74>.md&#34;</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        echo <span style=color:#e6db74>&#34;# 系统日志分析报告&#34;</span>
</span></span><span style=display:flex><span>        echo <span style=color:#e6db74>&#34;## 生成时间: </span><span style=color:#66d9ef>$(</span>date <span style=color:#e6db74>&#39;+%Y-%m-%d %H:%M:%S&#39;</span><span style=color:#66d9ef>)</span><span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>        echo
</span></span><span style=display:flex><span>        echo <span style=color:#e6db74>&#34;## 系统错误统计&#34;</span>
</span></span><span style=display:flex><span>        echo <span style=color:#e6db74>&#34;### 严重错误&#34;</span>
</span></span><span style=display:flex><span>        echo <span style=color:#e6db74>&#39;```&#39;</span>
</span></span><span style=display:flex><span>        grep -i <span style=color:#e6db74>&#34;error\|critical\|emergency&#34;</span> /var/log/syslog | <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>            tail -n <span style=color:#ae81ff>50</span> | sort | uniq -c | sort -nr
</span></span><span style=display:flex><span>        echo <span style=color:#e6db74>&#39;```&#39;</span>
</span></span><span style=display:flex><span>        
</span></span><span style=display:flex><span>        echo <span style=color:#e6db74>&#34;### 认证失败&#34;</span>
</span></span><span style=display:flex><span>        echo <span style=color:#e6db74>&#39;```&#39;</span>
</span></span><span style=display:flex><span>        grep <span style=color:#e6db74>&#34;Failed password&#34;</span> /var/log/auth.log | <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>            awk <span style=color:#e6db74>&#39;{print $1,$2,$3,$11}&#39;</span> | sort | uniq -c | sort -nr | head -n <span style=color:#ae81ff>10</span>
</span></span><span style=display:flex><span>        echo <span style=color:#e6db74>&#39;```&#39;</span>
</span></span><span style=display:flex><span>        
</span></span><span style=display:flex><span>        echo <span style=color:#e6db74>&#34;### 系统重启记录&#34;</span>
</span></span><span style=display:flex><span>        echo <span style=color:#e6db74>&#39;```&#39;</span>
</span></span><span style=display:flex><span>        last reboot | head -n <span style=color:#ae81ff>5</span>
</span></span><span style=display:flex><span>        echo <span style=color:#e6db74>&#39;```&#39;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span> &gt; <span style=color:#e6db74>&#34;</span>$report_file<span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 分析 Nginx 访问日志</span>
</span></span><span style=display:flex><span>analyze_nginx_logs<span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    log <span style=color:#e6db74>&#34;分析 Nginx 访问日志...&#34;</span>
</span></span><span style=display:flex><span>    local report_file<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;</span>$REPORT_DIR<span style=color:#e6db74>/nginx_log_report_</span><span style=color:#66d9ef>$(</span>date +%Y%m%d<span style=color:#66d9ef>)</span><span style=color:#e6db74>.md&#34;</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        echo <span style=color:#e6db74>&#34;# Nginx 访问日志分析报告&#34;</span>
</span></span><span style=display:flex><span>        echo <span style=color:#e6db74>&#34;## 生成时间: </span><span style=color:#66d9ef>$(</span>date <span style=color:#e6db74>&#39;+%Y-%m-%d %H:%M:%S&#39;</span><span style=color:#66d9ef>)</span><span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>        echo
</span></span><span style=display:flex><span>        echo <span style=color:#e6db74>&#34;## 访问统计&#34;</span>
</span></span><span style=display:flex><span>        echo <span style=color:#e6db74>&#34;### 请求量最大的 IP&#34;</span>
</span></span><span style=display:flex><span>        echo <span style=color:#e6db74>&#39;```&#39;</span>
</span></span><span style=display:flex><span>        awk <span style=color:#e6db74>&#39;{print $1}&#39;</span> /var/log/nginx/access.log | sort | uniq -c | sort -nr | head -n <span style=color:#ae81ff>10</span>
</span></span><span style=display:flex><span>        echo <span style=color:#e6db74>&#39;```&#39;</span>
</span></span><span style=display:flex><span>        
</span></span><span style=display:flex><span>        echo <span style=color:#e6db74>&#34;### 访问量最大的页面&#34;</span>
</span></span><span style=display:flex><span>        echo <span style=color:#e6db74>&#39;```&#39;</span>
</span></span><span style=display:flex><span>        awk <span style=color:#e6db74>&#39;{print $7}&#39;</span> /var/log/nginx/access.log | sort | uniq -c | sort -nr | head -n <span style=color:#ae81ff>10</span>
</span></span><span style=display:flex><span>        echo <span style=color:#e6db74>&#39;```&#39;</span>
</span></span><span style=display:flex><span>        
</span></span><span style=display:flex><span>        echo <span style=color:#e6db74>&#34;### HTTP 状态码统计&#34;</span>
</span></span><span style=display:flex><span>        echo <span style=color:#e6db74>&#39;```&#39;</span>
</span></span><span style=display:flex><span>        awk <span style=color:#e6db74>&#39;{print $9}&#39;</span> /var/log/nginx/access.log | sort | uniq -c | sort -nr
</span></span><span style=display:flex><span>        echo <span style=color:#e6db74>&#39;```&#39;</span>
</span></span><span style=display:flex><span>        
</span></span><span style=display:flex><span>        echo <span style=color:#e6db74>&#34;### 每小时请求量统计&#34;</span>
</span></span><span style=display:flex><span>        echo <span style=color:#e6db74>&#39;```&#39;</span>
</span></span><span style=display:flex><span>        awk <span style=color:#e6db74>&#39;{print $4}&#39;</span> /var/log/nginx/access.log | cut -c 14-15 | sort | uniq -c | <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>            awk <span style=color:#e6db74>&#39;{printf(&#34;%s:00 - %s 请求\n&#34;, $2, $1)}&#39;</span>
</span></span><span style=display:flex><span>        echo <span style=color:#e6db74>&#39;```&#39;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span> &gt; <span style=color:#e6db74>&#34;</span>$report_file<span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 分析 AI 服务日志</span>
</span></span><span style=display:flex><span>analyze_ai_logs<span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    log <span style=color:#e6db74>&#34;分析 AI 服务日志...&#34;</span>
</span></span><span style=display:flex><span>    local report_file<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;</span>$REPORT_DIR<span style=color:#e6db74>/ai_log_report_</span><span style=color:#66d9ef>$(</span>date +%Y%m%d<span style=color:#66d9ef>)</span><span style=color:#e6db74>.md&#34;</span>
</span></span><span style=display:flex><span>    local ai_log<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;/home/zhaoxiongzhou/logs/llama.log&#34;</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>[</span> -f <span style=color:#e6db74>&#34;</span>$ai_log<span style=color:#e6db74>&#34;</span> <span style=color:#f92672>]</span>; <span style=color:#66d9ef>then</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            echo <span style=color:#e6db74>&#34;# AI 服务日志分析报告&#34;</span>
</span></span><span style=display:flex><span>            echo <span style=color:#e6db74>&#34;## 生成时间: </span><span style=color:#66d9ef>$(</span>date <span style=color:#e6db74>&#39;+%Y-%m-%d %H:%M:%S&#39;</span><span style=color:#66d9ef>)</span><span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>            echo
</span></span><span style=display:flex><span>            echo <span style=color:#e6db74>&#34;## 服务统计&#34;</span>
</span></span><span style=display:flex><span>            echo <span style=color:#e6db74>&#34;### 错误统计&#34;</span>
</span></span><span style=display:flex><span>            echo <span style=color:#e6db74>&#39;```&#39;</span>
</span></span><span style=display:flex><span>            grep -i <span style=color:#e6db74>&#34;error&#34;</span> <span style=color:#e6db74>&#34;</span>$ai_log<span style=color:#e6db74>&#34;</span> | tail -n <span style=color:#ae81ff>20</span>
</span></span><span style=display:flex><span>            echo <span style=color:#e6db74>&#39;```&#39;</span>
</span></span><span style=display:flex><span>            
</span></span><span style=display:flex><span>            echo <span style=color:#e6db74>&#34;### 性能统计&#34;</span>
</span></span><span style=display:flex><span>            echo <span style=color:#e6db74>&#34;#### 响应时间分布&#34;</span>
</span></span><span style=display:flex><span>            echo <span style=color:#e6db74>&#39;```&#39;</span>
</span></span><span style=display:flex><span>            grep <span style=color:#e6db74>&#34;response_time&#34;</span> <span style=color:#e6db74>&#34;</span>$ai_log<span style=color:#e6db74>&#34;</span> | <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>                awk <span style=color:#e6db74>&#39;{sum+=$NF; count++} END {print &#34;平均响应时间:&#34;, sum/count, &#34;ms&#34;}&#39;</span>
</span></span><span style=display:flex><span>            echo <span style=color:#e6db74>&#39;```&#39;</span>
</span></span><span style=display:flex><span>            
</span></span><span style=display:flex><span>            echo <span style=color:#e6db74>&#34;#### 内存使用统计&#34;</span>
</span></span><span style=display:flex><span>            echo <span style=color:#e6db74>&#39;```&#39;</span>
</span></span><span style=display:flex><span>            grep <span style=color:#e6db74>&#34;memory_usage&#34;</span> <span style=color:#e6db74>&#34;</span>$ai_log<span style=color:#e6db74>&#34;</span> | tail -n <span style=color:#ae81ff>10</span>
</span></span><span style=display:flex><span>            echo <span style=color:#e6db74>&#39;```&#39;</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span> &gt; <span style=color:#e6db74>&#34;</span>$report_file<span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>fi</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 生成安全报告</span>
</span></span><span style=display:flex><span>generate_security_report<span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    log <span style=color:#e6db74>&#34;生成安全报告...&#34;</span>
</span></span><span style=display:flex><span>    local report_file<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;</span>$REPORT_DIR<span style=color:#e6db74>/security_report_</span><span style=color:#66d9ef>$(</span>date +%Y%m%d<span style=color:#66d9ef>)</span><span style=color:#e6db74>.md&#34;</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        echo <span style=color:#e6db74>&#34;# 安全分析报告&#34;</span>
</span></span><span style=display:flex><span>        echo <span style=color:#e6db74>&#34;## 生成时间: </span><span style=color:#66d9ef>$(</span>date <span style=color:#e6db74>&#39;+%Y-%m-%d %H:%M:%S&#39;</span><span style=color:#66d9ef>)</span><span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>        echo
</span></span><span style=display:flex><span>        echo <span style=color:#e6db74>&#34;## 安全事件统计&#34;</span>
</span></span><span style=display:flex><span>        
</span></span><span style=display:flex><span>        echo <span style=color:#e6db74>&#34;### SSH 暴力破解尝试&#34;</span>
</span></span><span style=display:flex><span>        echo <span style=color:#e6db74>&#39;```&#39;</span>
</span></span><span style=display:flex><span>        grep <span style=color:#e6db74>&#34;Failed password&#34;</span> /var/log/auth.log | <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>            awk <span style=color:#e6db74>&#39;{print $11,$13}&#39;</span> | sort | uniq -c | sort -nr | head -n <span style=color:#ae81ff>10</span>
</span></span><span style=display:flex><span>        echo <span style=color:#e6db74>&#39;```&#39;</span>
</span></span><span style=display:flex><span>        
</span></span><span style=display:flex><span>        echo <span style=color:#e6db74>&#34;### 可疑 IP 访问&#34;</span>
</span></span><span style=display:flex><span>        echo <span style=color:#e6db74>&#39;```&#39;</span>
</span></span><span style=display:flex><span>        grep -i <span style=color:#e6db74>&#34;suspicious\|attack\|hack&#34;</span> /var/log/nginx/access.log | <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>            awk <span style=color:#e6db74>&#39;{print $1}&#39;</span> | sort | uniq -c | sort -nr
</span></span><span style=display:flex><span>        echo <span style=color:#e6db74>&#39;```&#39;</span>
</span></span><span style=display:flex><span>        
</span></span><span style=display:flex><span>        echo <span style=color:#e6db74>&#34;### 文件权限变更&#34;</span>
</span></span><span style=display:flex><span>        echo <span style=color:#e6db74>&#39;```&#39;</span>
</span></span><span style=display:flex><span>        find /etc -mtime -1 -type f -ls
</span></span><span style=display:flex><span>        echo <span style=color:#e6db74>&#39;```&#39;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span> &gt; <span style=color:#e6db74>&#34;</span>$report_file<span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 清理旧报告</span>
</span></span><span style=display:flex><span>cleanup_old_reports<span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    log <span style=color:#e6db74>&#34;清理旧报告...&#34;</span>
</span></span><span style=display:flex><span>    find <span style=color:#e6db74>&#34;</span>$REPORT_DIR<span style=color:#e6db74>&#34;</span> -type f -name <span style=color:#e6db74>&#34;*.md&#34;</span> -mtime +$RETENTION_DAYS -delete
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 生成摘要报告</span>
</span></span><span style=display:flex><span>generate_summary<span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    log <span style=color:#e6db74>&#34;生成摘要报告...&#34;</span>
</span></span><span style=display:flex><span>    local summary_file<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;</span>$REPORT_DIR<span style=color:#e6db74>/summary_</span><span style=color:#66d9ef>$(</span>date +%Y%m%d<span style=color:#66d9ef>)</span><span style=color:#e6db74>.md&#34;</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        echo <span style=color:#e6db74>&#34;# 日志分析摘要报告&#34;</span>
</span></span><span style=display:flex><span>        echo <span style=color:#e6db74>&#34;## 生成时间: </span><span style=color:#66d9ef>$(</span>date <span style=color:#e6db74>&#39;+%Y-%m-%d %H:%M:%S&#39;</span><span style=color:#66d9ef>)</span><span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>        echo
</span></span><span style=display:flex><span>        echo <span style=color:#e6db74>&#34;## 关键指标&#34;</span>
</span></span><span style=display:flex><span>        
</span></span><span style=display:flex><span>        <span style=color:#75715e># 错误统计</span>
</span></span><span style=display:flex><span>        local error_count<span style=color:#f92672>=</span><span style=color:#66d9ef>$(</span>grep -i <span style=color:#e6db74>&#34;error&#34;</span> /var/log/syslog | wc -l<span style=color:#66d9ef>)</span>
</span></span><span style=display:flex><span>        local nginx_error_count<span style=color:#f92672>=</span><span style=color:#66d9ef>$(</span>grep -i <span style=color:#e6db74>&#34;error&#34;</span> /var/log/nginx/error.log | wc -l<span style=color:#66d9ef>)</span>
</span></span><span style=display:flex><span>        
</span></span><span style=display:flex><span>        echo <span style=color:#e6db74>&#34;- 系统错误数: </span>$error_count<span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>        echo <span style=color:#e6db74>&#34;- Nginx 错误数: </span>$nginx_error_count<span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>        
</span></span><span style=display:flex><span>        <span style=color:#75715e># 安全事件</span>
</span></span><span style=display:flex><span>        local ssh_fails<span style=color:#f92672>=</span><span style=color:#66d9ef>$(</span>grep <span style=color:#e6db74>&#34;Failed password&#34;</span> /var/log/auth.log | wc -l<span style=color:#66d9ef>)</span>
</span></span><span style=display:flex><span>        echo <span style=color:#e6db74>&#34;- SSH 失败尝试: </span>$ssh_fails<span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>        
</span></span><span style=display:flex><span>        <span style=color:#75715e># 告警判断</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#f92672>[</span> $error_count -gt $ALERT_THRESHOLD <span style=color:#f92672>]</span>; <span style=color:#66d9ef>then</span>
</span></span><span style=display:flex><span>            ~/send_notification.sh <span style=color:#e6db74>&#34;警告: 系统错误数超过阈值&#34;</span> <span style=color:#e6db74>&#34;high&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>fi</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span> &gt; <span style=color:#e6db74>&#34;</span>$summary_file<span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 主函数</span>
</span></span><span style=display:flex><span>main<span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    log <span style=color:#e6db74>&#34;开始日志分析...&#34;</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#75715e># 执行分析</span>
</span></span><span style=display:flex><span>    analyze_system_logs
</span></span><span style=display:flex><span>    analyze_nginx_logs
</span></span><span style=display:flex><span>    analyze_ai_logs
</span></span><span style=display:flex><span>    generate_security_report
</span></span><span style=display:flex><span>    generate_summary
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#75715e># 清理旧报告</span>
</span></span><span style=display:flex><span>    cleanup_old_reports
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    log <span style=color:#e6db74>&#34;日志分析完成&#34;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 执行分析</span>
</span></span><span style=display:flex><span>main
</span></span></code></pre></div><h2 id=三十五系统优化工具>三十五、系统优化工具</h2><h3 id=1-系统优化脚本>1. 系统优化脚本</h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># 创建系统优化脚本</span>
</span></span><span style=display:flex><span>nano ~/system_optimize.sh
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e>#!/bin/bash
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#75715e># ~/system_optimize.sh</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 配置</span>
</span></span><span style=display:flex><span>LOG_FILE<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;/var/log/optimize.log&#34;</span>
</span></span><span style=display:flex><span>NGINX_CONF<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;/etc/nginx/nginx.conf&#34;</span>
</span></span><span style=display:flex><span>SYSCTL_CONF<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;/etc/sysctl.d/99-custom.conf&#34;</span>
</span></span><span style=display:flex><span>JOURNAL_CONF<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;/etc/systemd/journald.conf&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 日志函数</span>
</span></span><span style=display:flex><span>log<span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    echo <span style=color:#e6db74>&#34;[</span><span style=color:#66d9ef>$(</span>date <span style=color:#e6db74>&#39;+%Y-%m-%d %H:%M:%S&#39;</span><span style=color:#66d9ef>)</span><span style=color:#e6db74>] </span>$1<span style=color:#e6db74>&#34;</span> | tee -a <span style=color:#e6db74>&#34;</span>$LOG_FILE<span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 优化系统参数</span>
</span></span><span style=display:flex><span>optimize_system<span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    log <span style=color:#e6db74>&#34;优化系统参数...&#34;</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#75715e># 备份原始配置</span>
</span></span><span style=display:flex><span>    cp <span style=color:#e6db74>&#34;</span>$SYSCTL_CONF<span style=color:#e6db74>&#34;</span> <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>${</span>SYSCTL_CONF<span style=color:#e6db74>}</span><span style=color:#e6db74>.backup&#34;</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#75715e># 配置系统参数</span>
</span></span><span style=display:flex><span>    cat &gt; <span style=color:#e6db74>&#34;</span>$SYSCTL_CONF<span style=color:#e6db74>&#34;</span> <span style=color:#e6db74>&lt;&lt; EOF
</span></span></span><span style=display:flex><span><span style=color:#e6db74># 网络优化
</span></span></span><span style=display:flex><span><span style=color:#e6db74>net.core.somaxconn = 2048
</span></span></span><span style=display:flex><span><span style=color:#e6db74>net.core.netdev_max_backlog = 4096
</span></span></span><span style=display:flex><span><span style=color:#e6db74>net.ipv4.tcp_max_syn_backlog = 4096
</span></span></span><span style=display:flex><span><span style=color:#e6db74>net.ipv4.tcp_fin_timeout = 30
</span></span></span><span style=display:flex><span><span style=color:#e6db74>net.ipv4.tcp_keepalive_time = 1200
</span></span></span><span style=display:flex><span><span style=color:#e6db74>net.ipv4.tcp_max_tw_buckets = 5000
</span></span></span><span style=display:flex><span><span style=color:#e6db74>net.ipv4.tcp_fastopen = 3
</span></span></span><span style=display:flex><span><span style=color:#e6db74>net.ipv4.tcp_rmem = 4096 87380 16777216
</span></span></span><span style=display:flex><span><span style=color:#e6db74>net.ipv4.tcp_wmem = 4096 65536 16777216
</span></span></span><span style=display:flex><span><span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74># 文件系统优化
</span></span></span><span style=display:flex><span><span style=color:#e6db74>fs.file-max = 100000
</span></span></span><span style=display:flex><span><span style=color:#e6db74>fs.inotify.max_user_watches = 524288
</span></span></span><span style=display:flex><span><span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74># 内存优化
</span></span></span><span style=display:flex><span><span style=color:#e6db74>vm.swappiness = 10
</span></span></span><span style=display:flex><span><span style=color:#e6db74>vm.dirty_ratio = 60
</span></span></span><span style=display:flex><span><span style=color:#e6db74>vm.dirty_background_ratio = 2
</span></span></span><span style=display:flex><span><span style=color:#e6db74>EOF</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># 应用系统参数</span>
</span></span><span style=display:flex><span>    sysctl -p <span style=color:#e6db74>&#34;</span>$SYSCTL_CONF<span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 优化 Nginx 配置</span>
</span></span><span style=display:flex><span>optimize_nginx<span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    log <span style=color:#e6db74>&#34;优化 Nginx 配置...&#34;</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#75715e># 备份原始配置</span>
</span></span><span style=display:flex><span>    cp <span style=color:#e6db74>&#34;</span>$NGINX_CONF<span style=color:#e6db74>&#34;</span> <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>${</span>NGINX_CONF<span style=color:#e6db74>}</span><span style=color:#e6db74>.backup&#34;</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#75715e># 配置 Nginx</span>
</span></span><span style=display:flex><span>    cat &gt; <span style=color:#e6db74>&#34;</span>$NGINX_CONF<span style=color:#e6db74>&#34;</span> <span style=color:#e6db74>&lt;&lt; EOF
</span></span></span><span style=display:flex><span><span style=color:#e6db74>user www-data;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>worker_processes auto;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>worker_rlimit_nofile 100000;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74>events {
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    worker_connections 2048;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    multi_accept on;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    use epoll;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>}
</span></span></span><span style=display:flex><span><span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74>http {
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    # 基础设置
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    sendfile on;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    tcp_nopush on;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    tcp_nodelay on;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    keepalive_timeout 65;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    types_hash_max_size 2048;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    server_tokens off;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    # MIME 类型
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    include /etc/nginx/mime.types;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    default_type application/octet-stream;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    # 日志格式
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    log_format main &#39;\$remote_addr - \$remote_user [\$time_local] &#34;\$request&#34; &#39;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>                    &#39;\$status \$body_bytes_sent &#34;\$http_referer&#34; &#39;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>                    &#39;&#34;\$http_user_agent&#34; &#34;\$http_x_forwarded_for&#34;&#39;;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    # 缓冲区设置
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    client_body_buffer_size 128k;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    client_max_body_size 10m;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    client_header_buffer_size 1k;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    large_client_header_buffers 4 4k;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    # Gzip 压缩
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    gzip on;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    gzip_vary on;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    gzip_proxied any;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    gzip_comp_level 6;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    gzip_types text/plain text/css application/json application/javascript text/xml application/xml application/xml+rss text/javascript;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    # SSL 优化
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    ssl_protocols TLSv1.2 TLSv1.3;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    ssl_prefer_server_ciphers on;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    ssl_session_cache shared:SSL:10m;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    ssl_session_timeout 10m;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    # 包含其他配置
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    include /etc/nginx/conf.d/*.conf;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    include /etc/nginx/sites-enabled/*;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>}
</span></span></span><span style=display:flex><span><span style=color:#e6db74>EOF</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># 测试配置</span>
</span></span><span style=display:flex><span>    nginx -t <span style=color:#f92672>&amp;&amp;</span> systemctl restart nginx
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 优化系统服务</span>
</span></span><span style=display:flex><span>optimize_services<span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    log <span style=color:#e6db74>&#34;优化系统服务...&#34;</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#75715e># 禁用不必要的服务</span>
</span></span><span style=display:flex><span>    local unnecessary_services<span style=color:#f92672>=(</span>
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;bluetooth&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;cups&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;avahi-daemon&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>for</span> service in <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>${</span>unnecessary_services[@]<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span>; <span style=color:#66d9ef>do</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> systemctl is-active --quiet <span style=color:#e6db74>&#34;</span>$service<span style=color:#e6db74>&#34;</span>; <span style=color:#66d9ef>then</span>
</span></span><span style=display:flex><span>            systemctl stop <span style=color:#e6db74>&#34;</span>$service<span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>            systemctl disable <span style=color:#e6db74>&#34;</span>$service<span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>            log <span style=color:#e6db74>&#34;已禁用服务: </span>$service<span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>fi</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>done</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#75715e># 优化日志服务</span>
</span></span><span style=display:flex><span>    cat &gt; <span style=color:#e6db74>&#34;</span>$JOURNAL_CONF<span style=color:#e6db74>&#34;</span> <span style=color:#e6db74>&lt;&lt; EOF
</span></span></span><span style=display:flex><span><span style=color:#e6db74>[Journal]
</span></span></span><span style=display:flex><span><span style=color:#e6db74>SystemMaxUse=100M
</span></span></span><span style=display:flex><span><span style=color:#e6db74>SystemMaxFileSize=10M
</span></span></span><span style=display:flex><span><span style=color:#e6db74>RuntimeMaxUse=50M
</span></span></span><span style=display:flex><span><span style=color:#e6db74>RuntimeMaxFileSize=5M
</span></span></span><span style=display:flex><span><span style=color:#e6db74>EOF</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># 重启日志服务</span>
</span></span><span style=display:flex><span>    systemctl restart systemd-journald
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 优化文件系统</span>
</span></span><span style=display:flex><span>optimize_filesystem<span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    log <span style=color:#e6db74>&#34;优化文件系统...&#34;</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#75715e># 清理临时文件</span>
</span></span><span style=display:flex><span>    find /tmp -type f -atime +10 -delete
</span></span><span style=display:flex><span>    find /var/tmp -type f -atime +10 -delete
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#75715e># 清理日志</span>
</span></span><span style=display:flex><span>    find /var/log -type f -name <span style=color:#e6db74>&#34;*.gz&#34;</span> -delete
</span></span><span style=display:flex><span>    find /var/log -type f -name <span style=color:#e6db74>&#34;*.old&#34;</span> -delete
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#75715e># 优化日志轮转</span>
</span></span><span style=display:flex><span>    cat &gt; /etc/logrotate.d/custom <span style=color:#e6db74>&lt;&lt; EOF
</span></span></span><span style=display:flex><span><span style=color:#e6db74>/var/log/custom/*.log {
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    daily
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    rotate 7
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    compress
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    delaycompress
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    missingok
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    notifempty
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    create 640 root adm
</span></span></span><span style=display:flex><span><span style=color:#e6db74>}
</span></span></span><span style=display:flex><span><span style=color:#e6db74>EOF</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 优化内存使用</span>
</span></span><span style=display:flex><span>optimize_memory<span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    log <span style=color:#e6db74>&#34;优化内存使用...&#34;</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#75715e># 清理缓存</span>
</span></span><span style=display:flex><span>    sync; echo <span style=color:#ae81ff>3</span> &gt; /proc/sys/vm/drop_caches
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#75715e># 配置 swap 使用</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>[</span> -f /swapfile <span style=color:#f92672>]</span>; <span style=color:#66d9ef>then</span>
</span></span><span style=display:flex><span>        swapoff /swapfile
</span></span><span style=display:flex><span>        dd <span style=color:#66d9ef>if</span><span style=color:#f92672>=</span>/dev/zero of<span style=color:#f92672>=</span>/swapfile bs<span style=color:#f92672>=</span>1M count<span style=color:#f92672>=</span><span style=color:#ae81ff>2048</span>
</span></span><span style=display:flex><span>        chmod <span style=color:#ae81ff>600</span> /swapfile
</span></span><span style=display:flex><span>        mkswap /swapfile
</span></span><span style=display:flex><span>        swapon /swapfile
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>fi</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 验证优化</span>
</span></span><span style=display:flex><span>verify_optimization<span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    log <span style=color:#e6db74>&#34;验证系统优化...&#34;</span>
</span></span><span style=display:flex><span>    local status<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#75715e># 检查系统负载</span>
</span></span><span style=display:flex><span>    local load<span style=color:#f92672>=</span><span style=color:#66d9ef>$(</span>uptime | awk -F<span style=color:#e6db74>&#39;load average:&#39;</span> <span style=color:#e6db74>&#39;{print $2}&#39;</span> | cut -d, -f1<span style=color:#66d9ef>)</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>[</span> <span style=color:#66d9ef>$(</span>echo <span style=color:#e6db74>&#34;</span>$load<span style=color:#e6db74> &gt; 2&#34;</span> | bc -l<span style=color:#66d9ef>)</span> -eq <span style=color:#ae81ff>1</span> <span style=color:#f92672>]</span>; <span style=color:#66d9ef>then</span>
</span></span><span style=display:flex><span>        log <span style=color:#e6db74>&#34;警告: 系统负载较高 (</span>$load<span style=color:#e6db74>)&#34;</span>
</span></span><span style=display:flex><span>        status<span style=color:#f92672>=</span><span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>fi</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#75715e># 检查内存使用</span>
</span></span><span style=display:flex><span>    local mem_usage<span style=color:#f92672>=</span><span style=color:#66d9ef>$(</span>free | grep Mem | awk <span style=color:#e6db74>&#39;{print $3/$2 * 100.0}&#39;</span><span style=color:#66d9ef>)</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>[</span> <span style=color:#66d9ef>$(</span>echo <span style=color:#e6db74>&#34;</span>$mem_usage<span style=color:#e6db74> &gt; 90&#34;</span> | bc -l<span style=color:#66d9ef>)</span> -eq <span style=color:#ae81ff>1</span> <span style=color:#f92672>]</span>; <span style=color:#66d9ef>then</span>
</span></span><span style=display:flex><span>        log <span style=color:#e6db74>&#34;警告: 内存使用率过高 (</span>$mem_usage<span style=color:#e6db74>%)&#34;</span>
</span></span><span style=display:flex><span>        status<span style=color:#f92672>=</span><span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>fi</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#75715e># 检查服务状态</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> ! systemctl is-active --quiet nginx; <span style=color:#66d9ef>then</span>
</span></span><span style=display:flex><span>        log <span style=color:#e6db74>&#34;错误: Nginx 服务未正常运行&#34;</span>
</span></span><span style=display:flex><span>        status<span style=color:#f92672>=</span><span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>fi</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> $status
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 主函数</span>
</span></span><span style=display:flex><span>main<span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    log <span style=color:#e6db74>&#34;开始系统优化...&#34;</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    optimize_system
</span></span><span style=display:flex><span>    optimize_nginx
</span></span><span style=display:flex><span>    optimize_services
</span></span><span style=display:flex><span>    optimize_filesystem
</span></span><span style=display:flex><span>    optimize_memory
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> verify_optimization; <span style=color:#66d9ef>then</span>
</span></span><span style=display:flex><span>        log <span style=color:#e6db74>&#34;系统优化成功完成&#34;</span>
</span></span><span style=display:flex><span>        ~/send_notification.sh <span style=color:#e6db74>&#34;系统优化已完成&#34;</span> <span style=color:#e6db74>&#34;normal&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>else</span>
</span></span><span style=display:flex><span>        log <span style=color:#e6db74>&#34;系统优化完成，但存在警告&#34;</span>
</span></span><span style=display:flex><span>        ~/send_notification.sh <span style=color:#e6db74>&#34;系统优化完成，但需要检查&#34;</span> <span style=color:#e6db74>&#34;high&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>fi</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 执行优化</span>
</span></span><span style=display:flex><span>main
</span></span></code></pre></div><h2 id=三十六部署后检查清单>三十六、部署后检查清单</h2><h3 id=1-部署检查脚本>1. 部署检查脚本</h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># 创建部署检查脚本</span>
</span></span><span style=display:flex><span>nano ~/deployment_checklist.sh
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e>#!/bin/bash
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#75715e># ~/deployment_checklist.sh</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 配置</span>
</span></span><span style=display:flex><span>LOG_FILE<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;/var/log/deployment_check.log&#34;</span>
</span></span><span style=display:flex><span>REPORT_FILE<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;/home/zhaoxiongzhou/deployment_report.md&#34;</span>
</span></span><span style=display:flex><span>CHECK_INTERVAL<span style=color:#f92672>=</span><span style=color:#ae81ff>300</span>  <span style=color:#75715e># 检查间隔（秒）</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 日志函数</span>
</span></span><span style=display:flex><span>log<span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    echo <span style=color:#e6db74>&#34;[</span><span style=color:#66d9ef>$(</span>date <span style=color:#e6db74>&#39;+%Y-%m-%d %H:%M:%S&#39;</span><span style=color:#66d9ef>)</span><span style=color:#e6db74>] </span>$1<span style=color:#e6db74>&#34;</span> | tee -a <span style=color:#e6db74>&#34;</span>$LOG_FILE<span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 检查系统基础配置</span>
</span></span><span style=display:flex><span>check_system_basics<span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    log <span style=color:#e6db74>&#34;检查系统基础配置...&#34;</span>
</span></span><span style=display:flex><span>    local status<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        echo <span style=color:#e6db74>&#34;## 系统基础检查&#34;</span>
</span></span><span style=display:flex><span>        echo <span style=color:#e6db74>&#34;### 系统信息&#34;</span>
</span></span><span style=display:flex><span>        echo <span style=color:#e6db74>&#34;- 主机名: </span><span style=color:#66d9ef>$(</span>hostname<span style=color:#66d9ef>)</span><span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>        echo <span style=color:#e6db74>&#34;- 系统版本: </span><span style=color:#66d9ef>$(</span>cat /etc/os-release | grep PRETTY_NAME<span style=color:#66d9ef>)</span><span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>        echo <span style=color:#e6db74>&#34;- 内核版本: </span><span style=color:#66d9ef>$(</span>uname -r<span style=color:#66d9ef>)</span><span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>        echo <span style=color:#e6db74>&#34;- 运行时间: </span><span style=color:#66d9ef>$(</span>uptime -p<span style=color:#66d9ef>)</span><span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>        echo
</span></span><span style=display:flex><span>        echo <span style=color:#e6db74>&#34;### 资源使用&#34;</span>
</span></span><span style=display:flex><span>        echo <span style=color:#e6db74>&#34;- CPU 使用率: </span><span style=color:#66d9ef>$(</span>top -bn1 | grep <span style=color:#e6db74>&#34;Cpu(s)&#34;</span> | awk <span style=color:#e6db74>&#39;{print $2}&#39;</span><span style=color:#66d9ef>)</span><span style=color:#e6db74>%&#34;</span>
</span></span><span style=display:flex><span>        echo <span style=color:#e6db74>&#34;- 内存使用率: </span><span style=color:#66d9ef>$(</span>free | grep Mem | awk <span style=color:#e6db74>&#39;{print $3/$2 * 100.0}&#39;</span><span style=color:#66d9ef>)</span><span style=color:#e6db74>%&#34;</span>
</span></span><span style=display:flex><span>        echo <span style=color:#e6db74>&#34;- 磁盘使用率: </span><span style=color:#66d9ef>$(</span>df -h / | awk <span style=color:#e6db74>&#39;NR==2 {print $5}&#39;</span><span style=color:#66d9ef>)</span><span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>        echo
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span> &gt; <span style=color:#e6db74>&#34;</span>$REPORT_FILE<span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> $status
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 检查网络配置</span>
</span></span><span style=display:flex><span>check_network<span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    log <span style=color:#e6db74>&#34;检查网络配置...&#34;</span>
</span></span><span style=display:flex><span>    local status<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        echo <span style=color:#e6db74>&#34;### 网络配置&#34;</span>
</span></span><span style=display:flex><span>        echo <span style=color:#e6db74>&#34;#### IP 配置&#34;</span>
</span></span><span style=display:flex><span>        echo <span style=color:#e6db74>&#39;```&#39;</span>
</span></span><span style=display:flex><span>        ip addr show
</span></span><span style=display:flex><span>        echo <span style=color:#e6db74>&#39;```&#39;</span>
</span></span><span style=display:flex><span>        
</span></span><span style=display:flex><span>        echo <span style=color:#e6db74>&#34;#### 路由表&#34;</span>
</span></span><span style=display:flex><span>        echo <span style=color:#e6db74>&#39;```&#39;</span>
</span></span><span style=display:flex><span>        ip route
</span></span><span style=display:flex><span>        echo <span style=color:#e6db74>&#39;```&#39;</span>
</span></span><span style=display:flex><span>        
</span></span><span style=display:flex><span>        echo <span style=color:#e6db74>&#34;#### 开放端口&#34;</span>
</span></span><span style=display:flex><span>        echo <span style=color:#e6db74>&#39;```&#39;</span>
</span></span><span style=display:flex><span>        netstat -tuln
</span></span><span style=display:flex><span>        echo <span style=color:#e6db74>&#39;```&#39;</span>
</span></span><span style=display:flex><span>        
</span></span><span style=display:flex><span>        echo <span style=color:#e6db74>&#34;#### DNS 配置&#34;</span>
</span></span><span style=display:flex><span>        echo <span style=color:#e6db74>&#39;```&#39;</span>
</span></span><span style=display:flex><span>        cat /etc/resolv.conf
</span></span><span style=display:flex><span>        echo <span style=color:#e6db74>&#39;```&#39;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span> &gt;&gt; <span style=color:#e6db74>&#34;</span>$REPORT_FILE<span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> $status
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 检查服务配置</span>
</span></span><span style=display:flex><span>check_services<span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    log <span style=color:#e6db74>&#34;检查服务配置...&#34;</span>
</span></span><span style=display:flex><span>    local status<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        echo <span style=color:#e6db74>&#34;### 服务状态&#34;</span>
</span></span><span style=display:flex><span>        echo <span style=color:#e6db74>&#34;#### Nginx 配置&#34;</span>
</span></span><span style=display:flex><span>        echo <span style=color:#e6db74>&#39;```&#39;</span>
</span></span><span style=display:flex><span>        nginx -T
</span></span><span style=display:flex><span>        echo <span style=color:#e6db74>&#39;```&#39;</span>
</span></span><span style=display:flex><span>        
</span></span><span style=display:flex><span>        echo <span style=color:#e6db74>&#34;#### 服务运行状态&#34;</span>
</span></span><span style=display:flex><span>        echo <span style=color:#e6db74>&#39;```&#39;</span>
</span></span><span style=display:flex><span>        systemctl status nginx
</span></span><span style=display:flex><span>        systemctl status mysql
</span></span><span style=display:flex><span>        ps aux | grep llama-server
</span></span><span style=display:flex><span>        echo <span style=color:#e6db74>&#39;```&#39;</span>
</span></span><span style=display:flex><span>        
</span></span><span style=display:flex><span>        echo <span style=color:#e6db74>&#34;#### 服务日志检查&#34;</span>
</span></span><span style=display:flex><span>        echo <span style=color:#e6db74>&#39;```&#39;</span>
</span></span><span style=display:flex><span>        tail -n <span style=color:#ae81ff>20</span> /var/log/nginx/error.log
</span></span><span style=display:flex><span>        echo <span style=color:#e6db74>&#39;```&#39;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span> &gt;&gt; <span style=color:#e6db74>&#34;</span>$REPORT_FILE<span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> $status
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 检查安全配置</span>
</span></span><span style=display:flex><span>check_security<span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    log <span style=color:#e6db74>&#34;检查安全配置...&#34;</span>
</span></span><span style=display:flex><span>    local status<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        echo <span style=color:#e6db74>&#34;### 安全检查&#34;</span>
</span></span><span style=display:flex><span>        echo <span style=color:#e6db74>&#34;#### 防火墙规则&#34;</span>
</span></span><span style=display:flex><span>        echo <span style=color:#e6db74>&#39;```&#39;</span>
</span></span><span style=display:flex><span>        sudo iptables -L
</span></span><span style=display:flex><span>        echo <span style=color:#e6db74>&#39;```&#39;</span>
</span></span><span style=display:flex><span>        
</span></span><span style=display:flex><span>        echo <span style=color:#e6db74>&#34;#### SSH 配置&#34;</span>
</span></span><span style=display:flex><span>        echo <span style=color:#e6db74>&#39;```&#39;</span>
</span></span><span style=display:flex><span>        grep -v <span style=color:#e6db74>&#39;^#&#39;</span> /etc/ssh/sshd_config
</span></span><span style=display:flex><span>        echo <span style=color:#e6db74>&#39;```&#39;</span>
</span></span><span style=display:flex><span>        
</span></span><span style=display:flex><span>        echo <span style=color:#e6db74>&#34;#### 用户权限&#34;</span>
</span></span><span style=display:flex><span>        echo <span style=color:#e6db74>&#39;```&#39;</span>
</span></span><span style=display:flex><span>        ls -la /home/zhaoxiongzhou/
</span></span><span style=display:flex><span>        ls -la /var/www/
</span></span><span style=display:flex><span>        echo <span style=color:#e6db74>&#39;```&#39;</span>
</span></span><span style=display:flex><span>        
</span></span><span style=display:flex><span>        echo <span style=color:#e6db74>&#34;#### SSL 证书&#34;</span>
</span></span><span style=display:flex><span>        echo <span style=color:#e6db74>&#39;```&#39;</span>
</span></span><span style=display:flex><span>        openssl x509 -in /etc/nginx/ssl/server.crt -text -noout
</span></span><span style=display:flex><span>        echo <span style=color:#e6db74>&#39;```&#39;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span> &gt;&gt; <span style=color:#e6db74>&#34;</span>$REPORT_FILE<span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> $status
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 检查备份配置</span>
</span></span><span style=display:flex><span>check_backups<span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    log <span style=color:#e6db74>&#34;检查备份配置...&#34;</span>
</span></span><span style=display:flex><span>    local status<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        echo <span style=color:#e6db74>&#34;### 备份检查&#34;</span>
</span></span><span style=display:flex><span>        echo <span style=color:#e6db74>&#34;#### 备份配置&#34;</span>
</span></span><span style=display:flex><span>        echo <span style=color:#e6db74>&#39;```&#39;</span>
</span></span><span style=display:flex><span>        ls -lh /mnt/backup_drive/system_backups/
</span></span><span style=display:flex><span>        echo <span style=color:#e6db74>&#39;```&#39;</span>
</span></span><span style=display:flex><span>        
</span></span><span style=display:flex><span>        echo <span style=color:#e6db74>&#34;#### 最近备份状态&#34;</span>
</span></span><span style=display:flex><span>        echo <span style=color:#e6db74>&#39;```&#39;</span>
</span></span><span style=display:flex><span>        tail -n <span style=color:#ae81ff>20</span> /var/log/backup.log
</span></span><span style=display:flex><span>        echo <span style=color:#e6db74>&#39;```&#39;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span> &gt;&gt; <span style=color:#e6db74>&#34;</span>$REPORT_FILE<span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> $status
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 检查监控配置</span>
</span></span><span style=display:flex><span>check_monitoring<span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    log <span style=color:#e6db74>&#34;检查监控配置...&#34;</span>
</span></span><span style=display:flex><span>    local status<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        echo <span style=color:#e6db74>&#34;### 监控检查&#34;</span>
</span></span><span style=display:flex><span>        echo <span style=color:#e6db74>&#34;#### 监控脚本状态&#34;</span>
</span></span><span style=display:flex><span>        echo <span style=color:#e6db74>&#39;```&#39;</span>
</span></span><span style=display:flex><span>        ps aux | grep monitor
</span></span><span style=display:flex><span>        echo <span style=color:#e6db74>&#39;```&#39;</span>
</span></span><span style=display:flex><span>        
</span></span><span style=display:flex><span>        echo <span style=color:#e6db74>&#34;#### 告警配置&#34;</span>
</span></span><span style=display:flex><span>        echo <span style=color:#e6db74>&#39;```&#39;</span>
</span></span><span style=display:flex><span>        cat ~/send_notification.sh
</span></span><span style=display:flex><span>        echo <span style=color:#e6db74>&#39;```&#39;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span> &gt;&gt; <span style=color:#e6db74>&#34;</span>$REPORT_FILE<span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> $status
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 生成总结报告</span>
</span></span><span style=display:flex><span>generate_summary<span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    log <span style=color:#e6db74>&#34;生成总结报告...&#34;</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        echo <span style=color:#e6db74>&#34;## 部署检查总结&#34;</span>
</span></span><span style=display:flex><span>        echo <span style=color:#e6db74>&#34;### 检查时间: </span><span style=color:#66d9ef>$(</span>date <span style=color:#e6db74>&#39;+%Y-%m-%d %H:%M:%S&#39;</span><span style=color:#66d9ef>)</span><span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>        echo
</span></span><span style=display:flex><span>        echo <span style=color:#e6db74>&#34;### 主要发现&#34;</span>
</span></span><span style=display:flex><span>        echo <span style=color:#e6db74>&#34;1. 系统状态: </span><span style=color:#66d9ef>$(</span><span style=color:#f92672>[</span> $system_status -eq <span style=color:#ae81ff>0</span> <span style=color:#f92672>]</span> <span style=color:#f92672>&amp;&amp;</span> echo <span style=color:#e6db74>&#39;正常 ✅&#39;</span> <span style=color:#f92672>||</span> echo <span style=color:#e6db74>&#39;异常 ❌&#39;</span><span style=color:#66d9ef>)</span><span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>        echo <span style=color:#e6db74>&#34;2. 网络配置: </span><span style=color:#66d9ef>$(</span><span style=color:#f92672>[</span> $network_status -eq <span style=color:#ae81ff>0</span> <span style=color:#f92672>]</span> <span style=color:#f92672>&amp;&amp;</span> echo <span style=color:#e6db74>&#39;正常 ✅&#39;</span> <span style=color:#f92672>||</span> echo <span style=color:#e6db74>&#39;异常 ❌&#39;</span><span style=color:#66d9ef>)</span><span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>        echo <span style=color:#e6db74>&#34;3. 服务状态: </span><span style=color:#66d9ef>$(</span><span style=color:#f92672>[</span> $services_status -eq <span style=color:#ae81ff>0</span> <span style=color:#f92672>]</span> <span style=color:#f92672>&amp;&amp;</span> echo <span style=color:#e6db74>&#39;正常 ✅&#39;</span> <span style=color:#f92672>||</span> echo <span style=color:#e6db74>&#39;异常 ❌&#39;</span><span style=color:#66d9ef>)</span><span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>        echo <span style=color:#e6db74>&#34;4. 安全配置: </span><span style=color:#66d9ef>$(</span><span style=color:#f92672>[</span> $security_status -eq <span style=color:#ae81ff>0</span> <span style=color:#f92672>]</span> <span style=color:#f92672>&amp;&amp;</span> echo <span style=color:#e6db74>&#39;正常 ✅&#39;</span> <span style=color:#f92672>||</span> echo <span style=color:#e6db74>&#39;异常 ❌&#39;</span><span style=color:#66d9ef>)</span><span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>        echo <span style=color:#e6db74>&#34;5. 备份状态: </span><span style=color:#66d9ef>$(</span><span style=color:#f92672>[</span> $backup_status -eq <span style=color:#ae81ff>0</span> <span style=color:#f92672>]</span> <span style=color:#f92672>&amp;&amp;</span> echo <span style=color:#e6db74>&#39;正常 ✅&#39;</span> <span style=color:#f92672>||</span> echo <span style=color:#e6db74>&#39;异常 ❌&#39;</span><span style=color:#66d9ef>)</span><span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>        echo <span style=color:#e6db74>&#34;6. 监控状态: </span><span style=color:#66d9ef>$(</span><span style=color:#f92672>[</span> $monitoring_status -eq <span style=color:#ae81ff>0</span> <span style=color:#f92672>]</span> <span style=color:#f92672>&amp;&amp;</span> echo <span style=color:#e6db74>&#39;正常 ✅&#39;</span> <span style=color:#f92672>||</span> echo <span style=color:#e6db74>&#39;异常 ❌&#39;</span><span style=color:#66d9ef>)</span><span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>        echo
</span></span><span style=display:flex><span>        echo <span style=color:#e6db74>&#34;### 建议操作&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>[</span> $system_status -ne <span style=color:#ae81ff>0</span> <span style=color:#f92672>]</span> <span style=color:#f92672>&amp;&amp;</span> echo <span style=color:#e6db74>&#34;- 检查系统资源使用情况&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>[</span> $network_status -ne <span style=color:#ae81ff>0</span> <span style=color:#f92672>]</span> <span style=color:#f92672>&amp;&amp;</span> echo <span style=color:#e6db74>&#34;- 验证网络配置&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>[</span> $services_status -ne <span style=color:#ae81ff>0</span> <span style=color:#f92672>]</span> <span style=color:#f92672>&amp;&amp;</span> echo <span style=color:#e6db74>&#34;- 检查服务运行状态&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>[</span> $security_status -ne <span style=color:#ae81ff>0</span> <span style=color:#f92672>]</span> <span style=color:#f92672>&amp;&amp;</span> echo <span style=color:#e6db74>&#34;- 审查安全配置&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>[</span> $backup_status -ne <span style=color:#ae81ff>0</span> <span style=color:#f92672>]</span> <span style=color:#f92672>&amp;&amp;</span> echo <span style=color:#e6db74>&#34;- 确认备份是否正常&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>[</span> $monitoring_status -ne <span style=color:#ae81ff>0</span> <span style=color:#f92672>]</span> <span style=color:#f92672>&amp;&amp;</span> echo <span style=color:#e6db74>&#34;- 检查监控系统&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span> &gt;&gt; <span style=color:#e6db74>&#34;</span>$REPORT_FILE<span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 主函数</span>
</span></span><span style=display:flex><span>main<span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    log <span style=color:#e6db74>&#34;开始部署后检查...&#34;</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#75715e># 执行检查</span>
</span></span><span style=display:flex><span>    check_system_basics
</span></span><span style=display:flex><span>    system_status<span style=color:#f92672>=</span>$?
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    check_network
</span></span><span style=display:flex><span>    network_status<span style=color:#f92672>=</span>$?
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    check_services
</span></span><span style=display:flex><span>    services_status<span style=color:#f92672>=</span>$?
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    check_security
</span></span><span style=display:flex><span>    security_status<span style=color:#f92672>=</span>$?
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    check_backups
</span></span><span style=display:flex><span>    backup_status<span style=color:#f92672>=</span>$?
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    check_monitoring
</span></span><span style=display:flex><span>    monitoring_status<span style=color:#f92672>=</span>$?
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#75715e># 生成总结</span>
</span></span><span style=display:flex><span>    generate_summary
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#75715e># 发送通知</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>[</span> $system_status -eq <span style=color:#ae81ff>0</span> <span style=color:#f92672>]</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#f92672>[</span> $network_status -eq <span style=color:#ae81ff>0</span> <span style=color:#f92672>]</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>       <span style=color:#f92672>[</span> $services_status -eq <span style=color:#ae81ff>0</span> <span style=color:#f92672>]</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#f92672>[</span> $security_status -eq <span style=color:#ae81ff>0</span> <span style=color:#f92672>]</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>       <span style=color:#f92672>[</span> $backup_status -eq <span style=color:#ae81ff>0</span> <span style=color:#f92672>]</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#f92672>[</span> $monitoring_status -eq <span style=color:#ae81ff>0</span> <span style=color:#f92672>]</span>; <span style=color:#66d9ef>then</span>
</span></span><span style=display:flex><span>        ~/send_notification.sh <span style=color:#e6db74>&#34;部署检查完成：所有项目正常&#34;</span> <span style=color:#e6db74>&#34;normal&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>else</span>
</span></span><span style=display:flex><span>        ~/send_notification.sh <span style=color:#e6db74>&#34;部署检查完成：存在需要关注的项目&#34;</span> <span style=color:#e6db74>&#34;high&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>fi</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    log <span style=color:#e6db74>&#34;部署检查完成，报告已生成: </span>$REPORT_FILE<span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 执行检查</span>
</span></span><span style=display:flex><span>main
</span></span></code></pre></div><p>《树莓派服务部署与维护完整指南》总共包含了 36 个部分，涵盖了从系统部署到维护的各个方面。每个脚本都经过精心设计，可以独立运行，也可以互相配合使用。</p></article></div></div><footer class="flex justify-between items-center gap-2 px-4 py-12"><div><p>© 2024 - 2025 赵雄州的博客</p><p class=text-sm>🌱
<span class=text-base-content/60>Powered by <a class=hover:underline href=https://gohugo.io/ target=_blank>Hugo</a> with theme
<a class=hover:underline href=https://github.com/g1eny0ung/hugo-theme-dream target=_blank>Dream</a>.</span></p></div><div x-data="{ icons: [
    { name: 'moon', status: 'y' },
    { name: 'sunny', status: 'n' },
    { name: 'desktop', status: 'auto' }
  ] }" class="flex items-center h-[32px] px-2 gap-2 border border-base-content/30 rounded-full"><template x-for="icon in icons"><div role=button tabindex=0 :aria-label="'Select ' + icon.name + ' mode'" class="group inline-flex justify-center items-center p-1 rounded-full cursor-pointer hover:bg-primary" :class="$store.darkMode.icon() === icon.name && 'bg-primary'" @click=$store.darkMode.toggle(icon.status)><ion-icon :name="`${icon.name}-outline`" class=group-hover:text-primary-content :class="$store.darkMode.icon() === icon.name && 'text-primary-content'"></ion-icon></div></template></div></footer></div></div><div class=back><div class=container><div class="dream-grid dream-grid-about"><div class="w-full md:w-1/2 lg:w-1/3 xl:w-1/4 p-4 dream-column"><article class="card card-compact bg-base-100 hover:bg-base-content/10 shadow-xl dark:border dark:border-base-content/30"><div class=card-body><div class=card-title>About Me</div><div class="prose dark:prose-invert"><p>Hi, my name is Your Name.
This is my blog.</p></div></div></article></div></div><footer class="flex justify-between items-center gap-2 px-4 py-12"><div><p>© 2024 - 2025 赵雄州的博客</p><p class=text-sm>🌱
<span class=text-base-content/60>Powered by <a class=hover:underline href=https://gohugo.io/ target=_blank>Hugo</a> with theme
<a class=hover:underline href=https://github.com/g1eny0ung/hugo-theme-dream target=_blank>Dream</a>.</span></p></div><div x-data="{ icons: [
    { name: 'moon', status: 'y' },
    { name: 'sunny', status: 'n' },
    { name: 'desktop', status: 'auto' }
  ] }" class="flex items-center h-[32px] px-2 gap-2 border border-base-content/30 rounded-full"><template x-for="icon in icons"><div role=button tabindex=0 :aria-label="'Select ' + icon.name + ' mode'" class="group inline-flex justify-center items-center p-1 rounded-full cursor-pointer hover:bg-primary" :class="$store.darkMode.icon() === icon.name && 'bg-primary'" @click=$store.darkMode.toggle(icon.status)><ion-icon :name="`${icon.name}-outline`" class=group-hover:text-primary-content :class="$store.darkMode.icon() === icon.name && 'text-primary-content'"></ion-icon></div></template></div></footer></div></div></div></div><script>window.lightTheme=null,window.darkTheme=null</script><script src=https://cdn.jsdelivr.net/npm/imagesloaded@5.0.0/imagesloaded.pkgd.min.js integrity="sha256-htrLFfZJ6v5udOG+3kNLINIKh2gvoKqwEhHYfTTMICc=" crossorigin=anonymous></script><script src=https://cdn.jsdelivr.net/npm/masonry-layout@4.2.2/dist/masonry.pkgd.min.js integrity="sha256-Nn1q/fx0H7SNLZMQ5Hw5JLaTRZp0yILA/FRexe19VdI=" crossorigin=anonymous></script><script src=/js/grid.min.js></script><script src=/js/main.min.js></script><script type=module src=https://unpkg.com/ionicons@7.4.0/dist/ionicons/ionicons.esm.js></script><script nomodule src=https://unpkg.com/ionicons@7.4.0/dist/ionicons/ionicons.js></script></body></html>